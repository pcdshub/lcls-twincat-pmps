

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DUTs &mdash; pcdshub/lcls-twincat-pmps  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/tree.css?v=837a00b9" />
      <link rel="stylesheet" type="text/css" href="_static/width.css?v=ab210c7a" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=5929fcd5"></script>
      <script src="_static/doctools.js?v=9a2dae69"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="_static/docs-versions-menu.js?v=3d6a1aea"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Data Types" href="lcls-twincat-pmps_PMPS_epics.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            pcdshub/lcls-twincat-pmps
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">lcls-twincat-pmps</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-pmps_pragmas.html">Pragmas</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-pmps_nc.html">NC Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-pmps_ethercat.html">EtherCAT Terminals</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-pmps_boxes.html">Boxes</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-pmps_links.html">Links</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">PMPS</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-pmps_PMPS_summary.html">Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-pmps_PMPS_summary.html#pragmas">Pragmas</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-pmps_PMPS_summary.html#libraries">Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-pmps_PMPS_summary.html#symbols">Symbols</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-pmps_PMPS_epics.html">Data Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-pmps_PMPS_epics.html#database-records">Database Records</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">DUTs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#e-arbdosteststates">E_ArbDosTestStates</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-bptmstate">E_BPTMState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-bptmteststates">E_BPTMTestStates</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-mpsbeamclasses">E_MPSBeamClasses</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-mpsbeamrates">E_MPSBeamRates</a></li>
<li class="toctree-l2"><a class="reference internal" href="#k-apertures">K_Apertures</a></li>
<li class="toctree-l2"><a class="reference internal" href="#k-attenuators">K_Attenuators</a></li>
<li class="toctree-l2"><a class="reference internal" href="#k-stopper">K_Stopper</a></li>
<li class="toctree-l2"><a class="reference internal" href="#l-apertures">L_Apertures</a></li>
<li class="toctree-l2"><a class="reference internal" href="#l-attenuators">L_Attenuators</a></li>
<li class="toctree-l2"><a class="reference internal" href="#l-stopper">L_Stopper</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pmps-codes">PMPS_CODES</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-attenuatorstatus">ST_AttenuatorStatus</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-bp-arbinternal">ST_BP_ArbInternal</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-dbstateparams">ST_DbStateParams</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-device">ST_Device</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-devicestate">ST_DeviceState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-devicestateext">ST_DeviceStateExt</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-devicestatetable">ST_DeviceStateTable</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-ff">ST_FF</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-ffinfo">ST_FFInfo</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-ffoverride">ST_FFOverride</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-pmps-aperture">ST_PMPS_Aperture</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-pmps-attenuator">ST_PMPS_Attenuator</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-reactiveparams">ST_ReactiveParams</a></li>
<li class="toctree-l2"><a class="reference internal" href="#t-hashtableentry">T_HashTableEntry</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#gvls">GVLs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pmps-param">PMPS_PARAM</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pmps-tools">PMPS_TOOLS</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#pous">POUs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#apt-to-io">APT_TO_IO</a></li>
<li class="toctree-l2"><a class="reference internal" href="#att-to-io">ATT_TO_IO</a></li>
<li class="toctree-l2"><a class="reference internal" href="#beamparametertransitionmanager">BeamParameterTransitionManager</a></li>
<li class="toctree-l2"><a class="reference internal" href="#bp-to-io">BP_TO_IO</a></li>
<li class="toctree-l2"><a class="reference internal" href="#checkbounds">CheckBounds</a></li>
<li class="toctree-l2"><a class="reference internal" href="#checkdivdint">CheckDivDInt</a></li>
<li class="toctree-l2"><a class="reference internal" href="#checkdivlint">CheckDivLInt</a></li>
<li class="toctree-l2"><a class="reference internal" href="#checkdivlreal">CheckDivLReal</a></li>
<li class="toctree-l2"><a class="reference internal" href="#checkdivreal">CheckDivReal</a></li>
<li class="toctree-l2"><a class="reference internal" href="#checklrangesigned">CheckLRangeSigned</a></li>
<li class="toctree-l2"><a class="reference internal" href="#checklrangeunsigned">CheckLRangeUnsigned</a></li>
<li class="toctree-l2"><a class="reference internal" href="#checkpointer">CheckPointer</a></li>
<li class="toctree-l2"><a class="reference internal" href="#checkrangesigned">CheckRangeSigned</a></li>
<li class="toctree-l2"><a class="reference internal" href="#checkrangeunsigned">CheckRangeUnsigned</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-attenuatorok">F_AttenuatorOK</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-bpwithid">F_BPWithID</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-calculatephotonenergy">F_CalculatePhotonEnergy</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-devicestate-to-devicestateext">F_DeviceState_To_DeviceStateExt</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-differentbeamparams">F_DifferentBeamParams</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-evexcluderange">F_eVExcludeRange</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-evincluderange">F_eVIncludeRange</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-evrangecalculator">F_eVRangeCalculator</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-evwithinspec">F_eVWithinSpec</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-inittestbp">F_InitTestBP</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-pmps-json">F_PMPS_JSON</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-safebpcompare">F_SafeBPCompare</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-safebpcompare0rate">F_SafeBPCompare0Rate</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-setbeamparams">F_SetBeamParams</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-setgoodattstatus">F_SetGoodAttStatus</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-setstateparams">F_SetStateParams</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-validreqid">F_ValidReqID</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-acceleratorlinks">FB_AcceleratorLinks</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-arbiter">FB_Arbiter</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-arbiter-test">FB_Arbiter_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-arbitertosubsys-io">FB_ArbiterToSubSys_IO</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-arbtosubsys-test">FB_ArbToSubsys_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-attenuatorsimulator">FB_AttenuatorSimulator</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-beamclassfromepics">FB_BeamClassFromEPICS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-beamclassoutputs">FB_BeamClassOutputs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-beamclassoutputs-bcd">FB_BeamClassOutputs_BCD</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-beamclasswatcher">FB_BeamClassWatcher</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-beamparamassertionpool">FB_BeamParamAssertionPool</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-bpcontroldevice">FB_BPControlDevice</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-bprequestor">FB_BPRequestor</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-bptm-test">FB_BPTM_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ctls-outputs">FB_CTLS_Outputs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-diffbp-test">FB_DiffBP_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-dummyarbio">FB_DummyArbIO</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-dummyha">FB_DummyHA</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-evrangecalculator-test">FB_evRangeCalculator_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-evsimulator">FB_eVSimulator</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-evwithinspec-test">FB_eVWithinSpec_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-fastfault">FB_FastFault</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-fastfault-test">FB_FastFault_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-hardwareffoutput">FB_HardwareFFOutput</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-hgvpu">FB_Hgvpu</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-jsondoctosafebp">FB_JsonDocToSafeBP</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-jsonfiletojsondoc">FB_JsonFileToJsonDoc</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-kphotonenergy">FB_KPhotonEnergy</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-kstopper">FB_KStopper</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-kvetodevice">FB_KVetoDevice</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-lineardevicestatetable">FB_LinearDeviceStateTable</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-lineargovernor">FB_LinearGovernor</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-lphotonenergy">FB_LPhotonEnergy</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-lstopper">FB_LStopper</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-lvetodevice">FB_LVetoDevice</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-machinemodefromepics">FB_MachineModeFromEPICS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-machinesimulator">FB_MachineSimulator</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-photonenergy">FB_PhotonEnergy</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-photonenergywatcher">FB_PhotonEnergyWatcher</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-photonenergywatcher-test">FB_PhotonEnergyWatcher_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-presssensor-ffo">FB_PressSensor_FFO</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ratefromepics">FB_RateFromEPICS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-safebpcompare-test">FB_SafeBPCompare_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-solidattenuator">FB_SolidAttenuator</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-stopperwatcher">FB_StopperWatcher</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-subsystoarb-test">FB_SubsysToArb_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-subsystoarbiter-io">FB_SubSysToArbiter_IO</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-sxu">FB_SXU</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-tempsensor-ffo">FB_TempSensor_FFO</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-undulatorsegment">FB_UndulatorSegment</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-vetoarbiter">FB_VetoArbiter</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-vetoarbiter-test">FB_VetoArbiter_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-vetodevice">FB_VetoDevice</a></li>
<li class="toctree-l2"><a class="reference internal" href="#io-to-apt">IO_TO_APT</a></li>
<li class="toctree-l2"><a class="reference internal" href="#io-to-att">IO_TO_ATT</a></li>
<li class="toctree-l2"><a class="reference internal" href="#io-to-bp">IO_TO_BP</a></li>
<li class="toctree-l2"><a class="reference internal" href="#main">MAIN</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pe-ranges">PE_Ranges</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">pcdshub/lcls-twincat-pmps</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">DUTs</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/lcls-twincat-pmps_PMPS_source.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="duts">
<h1>DUTs<a class="headerlink" href="#duts" title="Link to this heading"></a></h1>
<section id="e-arbdosteststates">
<h2>E_ArbDosTestStates<a class="headerlink" href="#e-arbdosteststates" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_ArbDosTestStates</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">Init</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">SecondReq</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">WaitForAck</span> <span class="o">:=</span> <span class="mi">200</span><span class="p">,</span>
    <span class="n">WaitFor2ndAck</span> <span class="o">:=</span> <span class="mi">300</span><span class="p">,</span>
    <span class="n">RunAsserts</span> <span class="o">:=</span> <span class="mi">8000</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-arbdosteststates">E_ArbDosTestStates</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="e-bptmstate">
<h2>E_BPTMState<a class="headerlink" href="#e-bptmstate" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">E_BPTMState</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">Init</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">NewTarget</span> <span class="o">:=</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">RequestBP</span> <span class="o">:=</span> <span class="mi">1500</span><span class="p">,</span>
    <span class="n">WaitForBP</span> <span class="o">:=</span> <span class="mi">2500</span><span class="p">,</span>
    <span class="n">WaitingForTransitionAssertion</span> <span class="o">:=</span> <span class="mi">2000</span><span class="p">,</span>
    <span class="n">WaitingForFinalAssertion</span> <span class="o">:=</span> <span class="mi">3000</span><span class="p">,</span>
    <span class="n">Transitioning</span> <span class="o">:=</span> <span class="mi">4000</span><span class="p">,</span>
    <span class="n">WaitForFinalBP</span> <span class="o">:=</span> <span class="mi">5000</span><span class="p">,</span>
    <span class="n">CleaningUp</span> <span class="o">:=</span> <span class="mi">6000</span><span class="p">,</span>
    <span class="n">Idle</span> <span class="o">:=</span> <span class="mi">10000</span><span class="p">,</span>
    <span class="n">Done</span> <span class="o">:=</span> <span class="mi">8000</span><span class="p">,</span>
    <span class="n">Error</span> <span class="o">:=</span> <span class="mi">9000</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-bptmteststates">
<h2>E_BPTMTestStates<a class="headerlink" href="#e-bptmteststates" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_BPTMTestStates</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">Init</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">WaitingForValidID</span> <span class="o">:=</span> <span class="mi">50</span><span class="p">,</span>
    <span class="n">WaitingForTransitionAssertion</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">StalledAtTransition</span> <span class="o">:=</span> <span class="mi">150</span><span class="p">,</span>
    <span class="n">WaitingForFinalAssertion</span>    <span class="o">:=</span> <span class="mi">200</span><span class="p">,</span>
    <span class="n">WaitingForBeam</span> <span class="o">:=</span> <span class="mi">250</span><span class="p">,</span>
    <span class="n">Transitioning</span>    <span class="o">:=</span> <span class="mi">300</span><span class="p">,</span>
    <span class="n">CleaningUp</span>    <span class="o">:=</span> <span class="mi">400</span><span class="p">,</span>
    <span class="n">AnotherState</span> <span class="o">:=</span> <span class="mi">500</span><span class="p">,</span>
    <span class="n">Retry</span> <span class="o">:=</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">Done</span> <span class="o">:=</span> <span class="mi">8000</span><span class="p">,</span>
    <span class="n">Error</span> <span class="o">:=</span> <span class="mi">9000</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-mpsbeamclasses">
<h2>E_MPSBeamClasses<a class="headerlink" href="#e-mpsbeamclasses" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">E_MPSBeamClasses</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">Beam_Off</span>    <span class="o">:=</span>  <span class="mi">0</span><span class="p">,</span>
    <span class="n">Kicker_STBY</span> <span class="o">:=</span>  <span class="mi">1</span><span class="p">,</span>
    <span class="n">BC1Hz</span>       <span class="o">:=</span>  <span class="mi">2</span><span class="p">,</span>
    <span class="n">BC10Hz</span>      <span class="o">:=</span>  <span class="mi">3</span><span class="p">,</span>
    <span class="n">Diagnostic</span>  <span class="o">:=</span>  <span class="mi">4</span><span class="p">,</span>
    <span class="n">BC120Hz</span>     <span class="o">:=</span>  <span class="mi">5</span><span class="p">,</span>
    <span class="n">Tuning</span>      <span class="o">:=</span>  <span class="mi">6</span><span class="p">,</span>
    <span class="n">MAP_1</span>       <span class="o">:=</span>  <span class="mi">7</span><span class="p">,</span>
    <span class="n">MAP_5</span>       <span class="o">:=</span>  <span class="mi">8</span><span class="p">,</span>
    <span class="n">MAP_10</span>      <span class="o">:=</span>  <span class="mi">9</span><span class="p">,</span>
    <span class="n">MAP_25</span>      <span class="o">:=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">MAP_50</span>      <span class="o">:=</span> <span class="mi">11</span><span class="p">,</span>
    <span class="n">MAP_100</span>     <span class="o">:=</span> <span class="mi">12</span><span class="p">,</span>
    <span class="n">FULL</span>        <span class="o">:=</span> <span class="mi">13</span><span class="p">,</span>
    <span class="n">SPARE1</span>      <span class="o">:=</span> <span class="mi">14</span><span class="p">,</span>
    <span class="n">SPARE2</span>      <span class="o">:=</span> <span class="mi">15</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-mpsbeamrates">
<h2>E_MPSBeamRates<a class="headerlink" href="#e-mpsbeamrates" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">E_MPSBeamRates</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">MPSRateInvalid</span>            <span class="o">:=</span>  <span class="mi">0</span><span class="p">,</span>
    <span class="n">MPSRate0Hz</span>                <span class="o">:=</span>  <span class="mi">1</span><span class="p">,</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Previously</span> <span class="n">used</span> <span class="mi">2</span> <span class="ow">and</span> <span class="mi">3</span> <span class="k">for</span> <span class="n">single</span> <span class="n">shot</span> <span class="ow">and</span> <span class="n">burst</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">MPSRate1Hz</span>                <span class="o">:=</span>  <span class="mi">4</span><span class="p">,</span>
    <span class="n">MPSRate10Hz</span>               <span class="o">:=</span>  <span class="mi">5</span><span class="p">,</span>
    <span class="n">MPSRate30Hz</span>               <span class="o">:=</span>  <span class="mi">6</span><span class="p">,</span>
    <span class="n">MPSRate60Hz</span>               <span class="o">:=</span>  <span class="mi">7</span><span class="p">,</span>
    <span class="n">MPSRate120Hz</span>              <span class="o">:=</span>  <span class="mi">8</span><span class="p">,</span>
    <span class="n">MPSRateUnknown</span>            <span class="o">:=</span>  <span class="mi">9</span><span class="p">,</span>
    <span class="n">MPSRateSingleShot</span>         <span class="o">:=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">MPSRateBurstMode</span>          <span class="o">:=</span> <span class="mi">11</span><span class="p">,</span>
    <span class="n">MPSRateBurstModeNotActive</span> <span class="o">:=</span> <span class="mi">12</span><span class="p">,</span>
    <span class="n">MPSNumberOfBeamRates</span>      <span class="o">:=</span> <span class="mi">13</span><span class="p">,</span>
    <span class="n">MPSRateBurstInvalid</span>       <span class="o">:=</span> <span class="mi">14</span>
<span class="p">)</span><span class="n">UINT</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="k-apertures">
<h2>K_Apertures<a class="headerlink" href="#k-apertures" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;to_string&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">K_Apertures</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">SL1K0</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">SL2K0</span> <span class="o">:=</span> <span class="mi">2</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="k-attenuators">
<h2>K_Attenuators<a class="headerlink" href="#k-attenuators" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">K_Attenuators</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">AT1K0</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">//</span> <span class="n">FEE</span> <span class="n">Gas</span> <span class="n">Attenuator</span>
    <span class="n">AT1K4</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span> <span class="o">//</span> <span class="n">TMO</span> <span class="n">Solid</span> <span class="n">Attenuator</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">FEE</span>
    <span class="n">AT1K2</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">,</span> <span class="o">//</span> <span class="n">RIX</span> <span class="n">Solid</span> <span class="n">Attenuator</span>
    <span class="n">AT2K2</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">,</span> <span class="o">//</span> <span class="n">RIX</span> <span class="n">Solid</span> <span class="n">Attenuator</span>
    <span class="n">AT1K3</span> <span class="o">:=</span> <span class="mi">5</span> <span class="o">//</span> <span class="n">TXI</span> <span class="n">Solid</span> <span class="n">Attenuator</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="k-stopper">
<h2>K_Stopper<a class="headerlink" href="#k-stopper" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">K_Stopper</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">ST3K4</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">//</span> <span class="n">TMO</span> <span class="n">PPS</span> <span class="n">stopper</span> <span class="ow">in</span>
    <span class="n">ST1K2</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span> <span class="o">//</span> <span class="n">RIX</span> <span class="n">PPS</span> <span class="n">stopper</span> <span class="ow">in</span>
    <span class="n">MR1K1_IN</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">,</span> <span class="o">//</span> <span class="n">Monochromator</span> <span class="n">focus</span> <span class="n">optic</span> <span class="n">vertical</span> <span class="n">state</span>
    <span class="n">MR1K1_OUT</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">,</span> <span class="o">//</span> <span class="n">Monochromator</span> <span class="n">focus</span> <span class="n">optic</span> <span class="n">vertical</span> <span class="n">state</span>
    <span class="n">MR1K3_IN</span> <span class="o">:=</span> <span class="mi">5</span><span class="p">,</span> <span class="o">//</span> <span class="n">TXI</span> <span class="n">MR1K3</span> <span class="n">Offset</span> <span class="n">Mirror</span> <span class="n">horizontal</span> <span class="n">state</span>
    <span class="n">MR1K3_OUT</span> <span class="o">:=</span> <span class="mi">6</span><span class="p">,</span> <span class="o">//</span> <span class="n">TXI</span> <span class="n">MR1K3</span> <span class="n">Offset</span> <span class="n">Mirror</span> <span class="n">horizontal</span> <span class="n">state</span>
    <span class="n">ST4K4</span> <span class="o">:=</span> <span class="mi">7</span><span class="p">,</span> <span class="o">//</span><span class="n">TMO</span> <span class="n">ST4K4</span> <span class="n">Photon</span> <span class="n">Terminator</span> <span class="n">In</span> <span class="n">Limit</span> <span class="n">Switch</span>
    <span class="n">ST1K4</span> <span class="o">:=</span> <span class="mi">8</span><span class="p">,</span> <span class="o">//</span><span class="n">TMO</span> <span class="n">Photon</span> <span class="n">Stopper</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">FEE</span>
    <span class="n">ST1K3</span> <span class="o">:=</span><span class="mi">9</span><span class="p">,</span> <span class="o">//</span><span class="n">TXI</span> <span class="n">Kline</span> <span class="n">PPS</span> <span class="n">stopper</span> <span class="ow">in</span>
    <span class="n">MR2K3_IN</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">,</span> <span class="o">//</span> <span class="n">TXI</span> <span class="n">MR2K3</span> <span class="n">Offset</span> <span class="n">Mirror</span> <span class="n">state</span>
    <span class="n">MR2K3_OUT</span> <span class="o">:=</span> <span class="mi">11</span><span class="p">,</span> <span class="o">//</span> <span class="n">TXI</span> <span class="n">MR2K3</span> <span class="n">Offset</span> <span class="n">Mirror</span> <span class="n">horizontal</span> <span class="n">state</span>
    <span class="n">DEFAULT</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">MAX_VETO_DEVICES</span> <span class="o">//</span> <span class="n">DO</span> <span class="n">NOT</span> <span class="n">USE</span> <span class="n">FOR</span> <span class="n">ANYTHING</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="l-apertures">
<h2>L_Apertures<a class="headerlink" href="#l-apertures" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;to_string&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">L_Apertures</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">SL1L0</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">SL2L0</span> <span class="o">:=</span> <span class="mi">2</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="l-attenuators">
<h2>L_Attenuators<a class="headerlink" href="#l-attenuators" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;to_string&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">L_Attenuators</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">AT1L0</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">//</span> <span class="n">FEE</span> <span class="n">Combo</span> <span class="n">Gas</span><span class="o">/</span><span class="n">Solid</span> <span class="n">Attenuator</span>
    <span class="n">AT2L0</span> <span class="o">:=</span> <span class="mi">2</span> <span class="o">//</span> <span class="n">FEE</span> <span class="n">Solid</span> <span class="n">Attenuator</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="l-stopper">
<h2>L_Stopper<a class="headerlink" href="#l-stopper" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">L_Stopper</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">ST1L0</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">//</span> <span class="n">ST1</span>
    <span class="n">ST1L1</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span> <span class="o">//</span> <span class="n">TXI</span> <span class="n">PPS</span> <span class="n">Stopper</span> <span class="ow">in</span>
    <span class="n">MR1L0_L0</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">,</span> <span class="o">//</span> <span class="n">MR1L0</span> <span class="n">Pitch</span> <span class="n">state</span> <span class="n">delivery</span> <span class="n">to</span> <span class="n">L0</span> <span class="n">line</span>
    <span class="n">MR1L0_TXI</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">,</span> <span class="o">//</span><span class="n">MR1L0</span> <span class="n">Pitch</span> <span class="n">state</span> <span class="n">delivery</span> <span class="n">to</span> <span class="n">TXI</span> <span class="n">line</span>
    <span class="n">MR1L1_IN</span><span class="o">:=</span> <span class="mi">5</span><span class="p">,</span> <span class="o">//</span>  <span class="n">TXI</span> <span class="n">Offset</span> <span class="n">Mirror</span> <span class="n">horizontal</span> <span class="n">state</span>
    <span class="n">MR1L1_OUT</span><span class="o">:=</span> <span class="mi">6</span><span class="p">,</span> <span class="o">//</span> <span class="n">TXI</span> <span class="n">Offset</span> <span class="n">Mirror</span> <span class="n">horizontal</span> <span class="n">state</span>
    <span class="n">DEFAULT</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">MAX_VETO_DEVICES</span> <span class="o">//</span> <span class="n">DO</span> <span class="n">NOT</span> <span class="n">USE</span> <span class="n">FOR</span> <span class="n">ANYTHING</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="pmps-codes">
<h2>PMPS_CODES<a class="headerlink" href="#pmps-codes" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">PMPS_CODES</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">FAST_FAULT</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#1, // Generic fast fault</span>
    <span class="n">PEW_FAULT</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#7, // Fault occurs when the calculated machine photon energy (K value calculated by undulator gap, and electron energy) falls outside the permitted range.</span>

    <span class="o">//</span> <span class="n">Arbiter</span> <span class="n">codes</span>
    <span class="o">//////////////////////////////////</span>
        <span class="n">ARB_FULL</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#201, // Arbiter pool is full.</span>

    <span class="o">//</span><span class="n">BPTM</span> <span class="n">Codes</span>
    <span class="o">//////////////////////////////////</span>
        <span class="n">BadTargetID</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#300,</span>
        <span class="n">BadTransID</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#301,</span>
        <span class="n">TransAssrtFail</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#302,</span>
        <span class="n">FinalAssrtFail</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#303,</span>
        <span class="n">NoRoomInArb</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#304</span>
<span class="p">)</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-attenuatorstatus">
<h2>ST_AttenuatorStatus<a class="headerlink" href="#st-attenuatorstatus" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_AttenuatorStatus</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="n">AtTarget</span> <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span>     <span class="o">//</span><span class="mi">0</span>
    <span class="n">Moving</span> <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span>       <span class="o">//</span><span class="mi">1</span>
    <span class="n">LocalMode</span> <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span>    <span class="o">//</span><span class="mi">2</span>  <span class="p">(</span><span class="o">*</span> <span class="n">means</span> <span class="n">the</span> <span class="n">attenuator</span> <span class="n">ignores</span> <span class="n">PMPS</span> <span class="n">preemptive</span> <span class="n">requests</span> <span class="ow">and</span> <span class="n">operates</span> <span class="kn">from</span><span class="w"> </span><span class="nn">a</span> <span class="n">local</span> <span class="n">setpoint</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">PMPSMode</span> <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span>     <span class="o">//</span><span class="mi">3</span>  <span class="p">(</span><span class="o">*</span> <span class="n">means</span> <span class="n">the</span> <span class="n">attenuator</span> <span class="ow">is</span> <span class="n">only</span> <span class="n">taking</span> <span class="n">setpoints</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">pmps</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">OK</span> <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span>           <span class="o">//</span><span class="mi">4</span>
    <span class="n">Toggle</span> <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span>       <span class="o">//</span><span class="mi">5</span>  <span class="n">just</span> <span class="n">here</span> <span class="k">for</span> <span class="n">fun</span>
    <span class="n">Include</span> <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span>      <span class="o">//</span><span class="mi">6</span>  <span class="n">Consider</span> <span class="n">this</span> <span class="n">device</span> <span class="n">status</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-beamparams">
<h2>ST_BeamParams<a class="headerlink" href="#st-beamparams" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_BeamParams</span> <span class="p">:</span>
    <span class="n">STRUCT</span>
        <span class="p">(</span><span class="o">*</span>  <span class="n">Requested</span> <span class="n">pre</span><span class="o">-</span><span class="n">optic</span> <span class="n">attenuation</span> <span class="o">%</span>  <span class="o">*</span><span class="p">)</span>
        <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: Transmission</span>
            <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
            <span class="n">field</span><span class="p">:</span> <span class="n">HOPR</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">field</span><span class="p">:</span> <span class="n">LOPR</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">field</span><span class="p">:</span> <span class="n">PREC</span> <span class="mi">2</span><span class="p">;</span>
        <span class="s1">&#39;}</span>
        <span class="n">nTran</span> <span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">(</span><span class="o">*</span> <span class="n">Pulse</span><span class="o">-</span><span class="n">rate</span> <span class="o">*</span><span class="p">)</span>
        <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: Rate</span>
            <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
            <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">Hz</span>
        <span class="s1">&#39;}</span>
        <span class="n">nRate</span> <span class="p">:</span> <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">(</span><span class="o">*</span> <span class="n">Photon</span> <span class="n">energy</span> <span class="n">ranges</span> <span class="o">*</span><span class="p">)</span>
        <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: eVRanges</span>
            <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
            <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">eV</span><span class="s1">&#39;}</span>
        <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;displaymode&#39;</span> <span class="o">:=</span> <span class="s1">&#39;binary&#39;</span><span class="p">}</span>
        <span class="n">neVRange</span> <span class="p">:</span> <span class="n">DWORD</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
                 <span class="p">(</span><span class="o">*</span> <span class="n">Photon</span> <span class="n">energy</span>  <span class="o">*</span><span class="p">)</span>
        <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: PhotonEnergy</span>
            <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
            <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">eV</span><span class="s1">&#39;}</span>
        <span class="n">neV</span> <span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">(</span><span class="o">*</span> <span class="n">Beamclass</span> <span class="n">ranges</span> <span class="o">*</span><span class="p">)</span>
         <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: BeamClassRanges</span>
            <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="s1">&#39;}</span>
        <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;displaymode&#39;</span> <span class="o">:=</span> <span class="s1">&#39;binary&#39;</span><span class="p">}</span>
        <span class="n">nBCRange</span> <span class="p">:</span> <span class="n">WORD</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">(</span><span class="o">*</span> <span class="n">Beamclass</span> <span class="o">*</span><span class="p">)</span>
        <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: BeamClass</span>
            <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="s1">&#39;}</span>
        <span class="n">nBeamClass</span> <span class="p">:</span> <span class="n">USINT</span> <span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
        <span class="p">(</span><span class="o">*</span> <span class="n">Machine</span> <span class="n">Mode</span> <span class="o">*</span><span class="p">)</span>
        <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: MachineMode</span>
            <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="s1">&#39;}</span>
        <span class="n">nMachineMode</span><span class="p">:</span> <span class="n">USINT</span><span class="o">:=</span><span class="mi">3</span><span class="p">;</span>
        <span class="p">(</span><span class="o">*</span> <span class="n">Beamline</span> <span class="n">attenuators</span> <span class="o">*</span><span class="p">)</span>
        <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: AuxAtt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="s1">&#39;}</span>
        <span class="n">astAttenuators</span> <span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">AUX_ATTENUATORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PMPS_Attenuator</span><span class="p">;</span>

        <span class="p">(</span><span class="o">*</span> <span class="n">Stoppers</span> <span class="o">*</span><span class="p">)</span>
        <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: Veto</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="s1">&#39;}</span>
        <span class="n">aVetoDevices</span> <span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">MAX_VETO_DEVICES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BOOL</span><span class="p">;</span>

        <span class="p">(</span><span class="o">*</span> <span class="n">Apertures</span> <span class="o">*</span><span class="p">)</span>
        <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: Apt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="s1">&#39;}</span>
        <span class="n">astApertures</span> <span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">MAX_APERTURES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PMPS_Aperture</span> <span class="o">:=</span> <span class="p">[(</span><span class="n">Width</span><span class="o">:=</span><span class="mf">1E3</span><span class="p">,</span> <span class="n">Height</span><span class="o">:=</span><span class="mf">1E3</span><span class="p">),</span> <span class="p">(</span><span class="n">Width</span><span class="o">:=</span><span class="mf">1E3</span><span class="p">,</span> <span class="n">Height</span><span class="o">:=</span><span class="mf">1E3</span><span class="p">),(</span><span class="n">Width</span><span class="o">:=</span><span class="mf">1E3</span><span class="p">,</span> <span class="n">Height</span><span class="o">:=</span><span class="mf">1E3</span><span class="p">),(</span><span class="n">Width</span><span class="o">:=</span><span class="mf">1E3</span><span class="p">,</span> <span class="n">Height</span><span class="o">:=</span><span class="mf">1E3</span><span class="p">)];</span>

        <span class="o">//</span> <span class="n">Toggle</span> <span class="k">for</span> <span class="n">watchdog</span>
        <span class="n">xValidToggle</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
        <span class="o">//</span> <span class="n">Beam</span> <span class="n">parameter</span> <span class="nb">set</span> <span class="ow">is</span> <span class="n">valid</span> <span class="p">(</span><span class="k">if</span> <span class="n">readback</span><span class="p">),</span> <span class="ow">or</span> <span class="n">acknowledged</span> <span class="p">(</span><span class="k">if</span> <span class="n">request</span><span class="p">)</span>
        <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: Valid</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="s1">&#39;}</span>
        <span class="n">xValid</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
        <span class="o">//</span> <span class="n">Cohort</span> <span class="n">index</span><span class="o">.</span> <span class="n">Identifies</span> <span class="n">which</span> <span class="n">cohort</span> <span class="n">this</span> <span class="n">BP</span> <span class="nb">set</span> <span class="n">was</span> <span class="n">included</span> <span class="ow">in</span> <span class="n">arbitration</span>
        <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: Cohort</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
            <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Cohort</span> <span class="n">inc</span> <span class="n">on</span> <span class="n">each</span> <span class="n">arb</span> <span class="n">cycle</span>
        <span class="s1">&#39;}</span>
        <span class="n">nCohortInt</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
<li><p><a class="reference internal" href="#st-pmps-aperture">ST_PMPS_Aperture</a></p></li>
<li><p><a class="reference internal" href="#st-pmps-attenuator">ST_PMPS_Attenuator</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-bp-arbinternal">
<h2>ST_BP_ArbInternal<a class="headerlink" href="#st-bp-arbinternal" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_BP_ArbInternal</span> <span class="n">EXTENDS</span> <span class="n">ST_BeamParams</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: ID</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nId</span> <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: Live</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">LiveInTable</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: Device</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">sDevName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-dbstateparams">
<h2>ST_DbStateParams<a class="headerlink" href="#st-dbstateparams" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_DbStateParams</span> <span class="p">:</span>
     <span class="o">//</span> <span class="n">Defines</span> <span class="n">The</span> <span class="n">parameters</span> <span class="n">that</span> <span class="n">are</span> <span class="n">loaded</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">json</span> <span class="n">db</span> <span class="k">for</span> <span class="n">every</span> <span class="n">state</span> <span class="n">name</span>
<span class="n">STRUCT</span>
      <span class="o">//</span> <span class="n">PMPS</span> <span class="n">database</span> <span class="n">lookup</span> <span class="n">name</span> <span class="k">for</span> <span class="n">this</span> <span class="n">state</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PMPS_STATE</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">PMPS</span> <span class="n">Database</span> <span class="n">Lookup</span> <span class="n">Key</span>
    <span class="s1">&#39;}</span>
    <span class="n">sPmpsState</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Beam</span> <span class="n">parameters</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">this</span> <span class="n">state</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">BP</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">stBeamParams</span><span class="p">:</span> <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cst0RateBeam</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Set</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">once</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">library</span> <span class="n">has</span> <span class="n">loaded</span> <span class="n">a</span> <span class="n">valid</span> <span class="n">state</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">database</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PMPS_LOADED</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">PMPS</span> <span class="n">loaded</span> <span class="n">parameters</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">database</span><span class="o">.</span>
    <span class="s1">&#39;}</span>
    <span class="n">bBeamParamsLoaded</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

     <span class="o">//</span> <span class="n">Reactive</span> <span class="n">parameters</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">this</span> <span class="n">state</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ReParams</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">stReactiveParams</span> <span class="p">:</span> <span class="n">ST_ReactiveParams</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Transition</span> <span class="n">ID</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">this</span> <span class="n">state</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PMPS_ID</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Assertion</span> <span class="n">Request</span> <span class="n">ID</span>
    <span class="s1">&#39;}</span>
    <span class="n">nRequestAssertionID</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
<li><p><a class="reference internal" href="#st-reactiveparams">ST_ReactiveParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-device">
<h2>ST_Device<a class="headerlink" href="#st-device" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_Device</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="o">//</span><span class="n">IO</span>
    <span class="n">stAxis</span>  <span class="p">:</span>       <span class="n">AXIS_REF</span><span class="p">;</span>
    <span class="o">//</span><span class="n">The</span> <span class="n">following</span> <span class="n">limit</span> <span class="n">switches</span> <span class="n">must</span> <span class="n">be</span> <span class="n">TRUE</span> <span class="ow">or</span> <span class="n">high</span> <span class="p">(</span><span class="n">ie</span><span class="o">.</span> <span class="n">NC</span><span class="p">)</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">that</span> <span class="n">direction</span> <span class="n">of</span> <span class="n">motion</span>
    <span class="o">//</span><span class="n">The</span> <span class="n">EPICS</span> <span class="n">display</span> <span class="n">should</span> <span class="n">show</span> <span class="n">an</span> <span class="n">inverted</span> <span class="n">indicator</span> <span class="n">to</span> <span class="n">communicate</span> <span class="n">end</span> <span class="n">of</span> <span class="n">travel</span> <span class="n">reached</span>
    <span class="n">i_xLoLim</span>        <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Wire</span> <span class="n">normally</span><span class="o">-</span><span class="n">closed</span>
    <span class="n">i_xHiLim</span>        <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Wire</span> <span class="n">normally</span><span class="o">-</span><span class="n">closed</span>

    <span class="o">//</span><span class="n">Acuator</span> <span class="n">Parameters</span>
    <span class="n">lrUpperPositionLimit</span>    <span class="p">:</span>       <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">10000000000</span><span class="p">;</span> <span class="o">//</span><span class="n">Use</span> <span class="ow">in</span> <span class="n">conjuntion</span> <span class="k">with</span> <span class="n">limit</span> <span class="n">switches</span> <span class="ow">or</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">a</span> <span class="n">huge</span> <span class="n">number</span> <span class="n">to</span> <span class="n">ignore</span>
    <span class="n">lrLowerPositionLimit</span>    <span class="p">:</span>       <span class="n">LREAL</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">10000000000</span><span class="p">;</span> <span class="o">//</span><span class="n">Use</span> <span class="ow">in</span> <span class="n">conjuntion</span> <span class="k">with</span> <span class="n">limit</span> <span class="n">switches</span> <span class="ow">or</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">a</span> <span class="n">huge</span> <span class="n">number</span> <span class="n">to</span> <span class="n">ignore</span>

    <span class="n">xEnable</span> <span class="p">:</span>       <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="o">//</span><span class="n">Supervisory</span> <span class="n">System</span>

    <span class="o">//</span><span class="n">MPS</span> <span class="n">Override</span>
    <span class="n">xOverrideMPSLimits</span>      <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span> <span class="o">//</span><span class="n">Set</span> <span class="n">true</span> <span class="n">to</span> <span class="n">move</span> <span class="n">beyond</span> <span class="n">MPS</span> <span class="n">limits</span><span class="o">.</span> <span class="n">Note</span> <span class="n">this</span> <span class="n">will</span> <span class="n">trip</span> <span class="n">beam</span> <span class="n">off</span><span class="o">.</span>

    <span class="o">//</span><span class="n">Status</span> <span class="ow">and</span> <span class="n">Faults</span>
    <span class="n">xClearFaults</span>    <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>   <span class="o">//</span><span class="n">Rising</span> <span class="n">edge</span> <span class="n">tries</span> <span class="n">to</span> <span class="n">clear</span> <span class="n">faults</span> <span class="n">of</span> <span class="nb">all</span> <span class="n">kinds</span>

    <span class="n">xGovernorFault</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>   <span class="o">//</span><span class="n">Indicates</span> <span class="n">governor</span> <span class="ow">is</span> <span class="n">faulted</span>
    <span class="n">xGovernorOverridden</span>     <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Indicates</span> <span class="n">governor</span> <span class="ow">is</span> <span class="ow">in</span> <span class="n">override</span> <span class="n">mode</span>
    <span class="n">xSMFault</span>                <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>   <span class="o">//</span><span class="n">Indicates</span> <span class="n">component</span> <span class="n">state</span> <span class="n">machine</span> <span class="ow">is</span> <span class="n">faulted</span>

    <span class="o">//</span><span class="n">Device</span> <span class="n">States</span>
    <span class="n">StateTable</span>              <span class="p">:</span>       <span class="n">FB_LinearDeviceStateTable</span><span class="p">;</span>

    <span class="n">stTransitionState</span>       <span class="p">:</span>       <span class="n">ST_DeviceState</span><span class="p">;</span> <span class="o">//</span><span class="n">The</span> <span class="n">transition</span> <span class="n">state</span> <span class="n">might</span> <span class="n">have</span> <span class="n">non</span><span class="o">-</span><span class="n">zero</span> <span class="n">beam</span> <span class="n">parameters</span>
    <span class="n">nSafeState</span>                      <span class="p">:</span>       <span class="n">UDINT</span><span class="p">;</span> <span class="o">//</span><span class="n">State</span> <span class="n">where</span> <span class="n">the</span> <span class="n">device</span> <span class="ow">is</span> <span class="n">considered</span> <span class="n">safe</span>
    <span class="n">nTransitionState</span>        <span class="p">:</span>       <span class="n">UDINT</span><span class="p">;</span>

    <span class="n">nRequestedState</span> <span class="p">:</span>       <span class="n">UDINT</span><span class="p">;</span> <span class="o">//</span><span class="n">EPICS</span> <span class="n">control</span><span class="p">,</span> <span class="n">cleaned</span> <span class="p">(</span><span class="n">checked</span> <span class="n">against</span> <span class="n">array</span> <span class="n">limits</span><span class="p">)</span> <span class="ow">and</span> <span class="n">deposited</span> <span class="ow">in</span> <span class="n">nTargetState</span>
    <span class="n">nTargetState</span>    <span class="p">:</span>       <span class="n">UDINT</span><span class="p">;</span> <span class="o">//</span><span class="n">The</span> <span class="n">requested</span> <span class="n">state</span> <span class="n">should</span> <span class="n">be</span> <span class="n">deposited</span> <span class="n">here</span> <span class="n">after</span> <span class="n">cleaning</span>
    <span class="n">nActiveState</span>    <span class="p">:</span>       <span class="n">UDINT</span><span class="p">;</span> <span class="o">//</span><span class="n">The</span> <span class="n">last</span> <span class="n">successfully</span> <span class="n">reached</span> <span class="n">state</span>


<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-lineardevicestatetable">FB_LinearDeviceStateTable</a></p></li>
<li><p><a class="reference internal" href="#st-devicestate">ST_DeviceState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-devicestate">
<h2>ST_DeviceState<a class="headerlink" href="#st-devicestate" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_DeviceState</span> <span class="p">:</span>
<span class="n">STRUCT</span>

    <span class="o">//</span><span class="n">State</span> <span class="n">name</span>
    <span class="n">sStateName</span>      <span class="p">:</span>       <span class="n">STRING</span><span class="p">;</span>
    <span class="n">nStateRef</span>       <span class="p">:</span>       <span class="n">UDINT</span><span class="p">;</span> <span class="o">//</span><span class="n">Primary</span> <span class="n">key</span> <span class="n">of</span> <span class="n">device</span> <span class="n">state</span> <span class="n">database</span>

    <span class="o">//////////////////</span>
    <span class="o">//</span> <span class="n">This</span> <span class="n">stuff</span> <span class="n">may</span> <span class="n">belong</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">sub</span><span class="o">-</span><span class="k">class</span><span class="w"> </span><span class="nc">or</span> <span class="n">something</span>
    <span class="o">//</span><span class="n">Position</span>
    <span class="n">rPosition</span>       <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">//</span><span class="n">Center</span> <span class="n">of</span> <span class="n">the</span> <span class="n">state</span>
    <span class="o">//</span><span class="n">Tolerance</span>
    <span class="n">rTolerance</span> <span class="p">:</span>    <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">//+/-</span> <span class="n">amount</span>
    <span class="o">//////////////////</span>
    <span class="o">//</span><span class="n">Required</span> <span class="n">beam</span> <span class="n">parameters</span>
    <span class="n">stReqBeamParam</span>  <span class="p">:</span>       <span class="n">ST_BeamParams</span><span class="p">;</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-devicestateext">
<h2>ST_DeviceStateExt<a class="headerlink" href="#st-devicestateext" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">Use</span> <span class="n">when</span> <span class="n">working</span> <span class="k">with</span> <span class="n">states</span> <span class="ow">in</span> <span class="n">code</span>
<span class="o">//</span><span class="n">Extended</span> <span class="k">with</span> <span class="n">a</span> <span class="n">valid</span> <span class="n">boolean</span> <span class="n">to</span> <span class="n">indicate</span> <span class="n">the</span> <span class="n">structure</span> <span class="n">was</span> <span class="n">loaded</span>
<span class="o">//</span><span class="n">properly</span>
<span class="n">TYPE</span> <span class="n">ST_DeviceStateExt</span> <span class="n">EXTENDS</span> <span class="n">ST_DeviceState</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="n">xValid</span>  <span class="p">:</span>       <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-devicestate">ST_DeviceState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-devicestatetable">
<h2>ST_DeviceStateTable<a class="headerlink" href="#st-devicestatetable" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_DeviceStateTable</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="n">iDeviceID</span><span class="p">:</span><span class="n">DINT</span><span class="p">;</span>
    <span class="n">iStateID</span><span class="p">:</span><span class="n">DINT</span><span class="p">;</span>
    <span class="n">rTargetPosition</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="n">rTolerance</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="n">rTransmission</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="n">iBeamClass</span> <span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">iPulseRate</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">rPerPulseEnergy</span><span class="p">:</span><span class="n">REAL</span><span class="p">;</span>
    <span class="n">rUpper_eV</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="n">rLower_eV</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="n">rPhotonEnergy</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-ff">
<h2>ST_FF<a class="headerlink" href="#st-ff" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_FF</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Info</span>
     <span class="s1">&#39;}</span>
    <span class="n">Info</span> <span class="p">:</span> <span class="n">ST_FFInfo</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Ovrd</span>
     <span class="s1">&#39;}</span>
    <span class="n">Ovrd</span> <span class="p">:</span> <span class="n">ST_FFOverride</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">OK</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
    <span class="n">OK</span>   <span class="p">:</span>   <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Fault</span> <span class="n">logic</span> <span class="n">state</span>

    <span class="n">FaultAck</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Set</span> <span class="n">when</span> <span class="n">faulted</span><span class="p">,</span> <span class="n">reset</span> <span class="n">by</span> <span class="n">logger</span><span class="o">.</span>
    <span class="n">ClearAck</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">BeamPermitted</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
    <span class="n">BeamPermitted</span>   <span class="p">:</span>   <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Result</span> <span class="n">of</span> <span class="n">reset</span><span class="p">,</span> <span class="n">veto</span><span class="p">,</span> <span class="ow">and</span> <span class="n">fault</span> <span class="n">logic</span><span class="p">,</span> <span class="n">true</span> <span class="n">beam</span> <span class="n">off</span> <span class="n">boolean</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Reset</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">o</span>
     <span class="s1">&#39;}</span>
    <span class="n">Reset</span>   <span class="p">:</span>   <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">bsFF</span>    <span class="p">:</span>    <span class="n">RS</span><span class="p">;</span>
    <span class="n">rtReset</span>    <span class="p">:</span>    <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">ftCountFault</span> <span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-ffinfo">ST_FFInfo</a></p></li>
<li><p><a class="reference internal" href="#st-ffoverride">ST_FFOverride</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-ffinfo">
<h2>ST_FFInfo<a class="headerlink" href="#st-ffinfo" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>// These elements should be set at init and never changed.

TYPE ST_FFInfo :
STRUCT
    {attribute &#39;pytmc&#39; := &#39;
        pv: Path
        io: i
     &#39;}
    sPath   :    T_MaxString; // Full PLC path to FF object
    {attribute &#39;pytmc&#39; := &#39;
        pv: Desc
        io: i
     &#39;}
    Desc    :   T_MaxString; // Set at instantiation to a helpful description of the fast fault purpose
    {attribute &#39;pytmc&#39; := &#39;
        pv: DevName
        io: i
     &#39;}
    DevName :   T_MaxString; // Component name, used in diagnostic to help narrow down where beam faults are coming from
    {attribute &#39;pytmc&#39; := &#39;
        pv: TypeCode
        io: i
     &#39;}
    TypeCode    :   UINT; // Set at instantiation to fault class code

///////////////////////////////////////////
// Warning, this variable is effectively a VETO of the fast fault if set FALSE
// Do not alter the state of this variable unless you really know what you&#39;re doing.
///////////////////////////////////////////
    {attribute &#39;pytmc&#39; := &#39;
        pv: InUse
        io: i
     &#39;}
    InUse   :   BOOL := FALSE; // If this FF is currently in-use
///////////////////////////////////////////


    AutoReset   :   BOOL; // Automatically clear fast fault (latching vs non-latching)
    Vetoable  : BOOL := TRUE; // Can this fast fault be masked by the veto device input?

      {attribute &#39;pytmc&#39; := &#39;
        pv: InfoString
        io: i
     &#39;}
    InfoString : STRING;
END_STRUCT
END_TYPE
</pre></div>
</div>
</section>
<section id="st-ffoverride">
<h2>ST_FFOverride<a class="headerlink" href="#st-ffoverride" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_FFOverride</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Duration</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">o</span>
     <span class="s1">&#39;}</span>
    <span class="n">Duration</span> <span class="p">:</span> <span class="n">DINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">DINT</span> <span class="n">to</span> <span class="n">be</span> <span class="n">compatible</span> <span class="k">with</span> <span class="n">EPICS</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Expiration</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">o</span>
     <span class="s1">&#39;}</span>
    <span class="n">Expiration</span> <span class="p">:</span> <span class="n">DINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">DINT</span> <span class="n">to</span> <span class="n">be</span> <span class="n">compatible</span> <span class="k">with</span> <span class="n">EPICS</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">StartDT</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">o</span>
     <span class="s1">&#39;}</span>
    <span class="n">StartDT</span> <span class="p">:</span> <span class="n">DINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">DINT</span> <span class="n">to</span> <span class="n">be</span> <span class="n">compatible</span> <span class="k">with</span> <span class="n">EPICS</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Activate</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">o</span>
     <span class="s1">&#39;}</span>
    <span class="n">Activate</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Deactivate</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">o</span>
     <span class="s1">&#39;}</span>
    <span class="n">Deactivate</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ElapsedTime</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
    <span class="n">ElapsedTime</span> <span class="p">:</span> <span class="n">DINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">DINT</span> <span class="n">to</span> <span class="n">be</span> <span class="n">compatible</span> <span class="k">with</span> <span class="n">EPICS</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">RemainingTime</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
    <span class="n">RemainingTime</span> <span class="p">:</span> <span class="n">DINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">DINT</span> <span class="n">to</span> <span class="n">be</span> <span class="n">compatible</span> <span class="k">with</span> <span class="n">EPICS</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Active</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
    <span class="n">Active</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">Timer</span>    <span class="p">:</span>   <span class="n">TP</span><span class="p">;</span>
    <span class="n">OvrdActLogAck</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">OvrdExpLogAck</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">tOvrdActivate</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">tOvrdExpiring</span>  <span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-pmps-aperture">
<h2>ST_PMPS_Aperture<a class="headerlink" href="#st-pmps-aperture" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_PMPS_Aperture</span> <span class="n">EXTENDS</span> <span class="n">ST_PMPS_Aperture_IO</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="p">(</span><span class="o">*</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: Width</span>
            <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
            <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">mm</span><span class="s1">&#39;}</span>
    <span class="n">Width</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span> <span class="o">//</span> <span class="n">distance</span> <span class="n">between</span> <span class="n">horizontal</span> <span class="n">slits</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: Height</span>
            <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
            <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">mm</span><span class="s1">&#39;}</span>
    <span class="n">Height</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span> <span class="o">//</span> <span class="n">distance</span> <span class="n">between</span> <span class="n">vertical</span> <span class="n">slits</span> <span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: OK</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="s1">&#39;}</span>
    <span class="n">xOK</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">status</span> <span class="n">of</span> <span class="n">aperture</span><span class="p">,</span> <span class="n">false</span> <span class="k">if</span> <span class="n">error</span> <span class="ow">or</span> <span class="ow">in</span> <span class="n">motion</span>
    <span class="o">*</span><span class="p">)</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-pmps-attenuator">
<h2>ST_PMPS_Attenuator<a class="headerlink" href="#st-pmps-attenuator" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_PMPS_Attenuator</span> <span class="n">EXTENDS</span> <span class="n">ST_PMPS_Attenuator_IO</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="p">(</span><span class="o">*</span>
        <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: Att</span>
            <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
            <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="o">%</span>
        <span class="s1">&#39;}</span>
        <span class="n">nTran</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
        <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: OK</span>
            <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="s1">&#39;}</span>
        <span class="n">xAttOK</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">true</span> <span class="o">=</span> <span class="n">no</span> <span class="n">errors</span> <span class="ow">and</span> <span class="n">attenuator</span> <span class="ow">is</span> <span class="n">stable</span>
        <span class="o">*</span><span class="p">)</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-reactiveparams">
<h2>ST_ReactiveParams<a class="headerlink" href="#st-reactiveparams" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_ReactiveParams</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: TempSP</span>
            <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
            <span class="n">field</span><span class="p">:</span> <span class="n">PREC</span> <span class="mi">2</span><span class="p">;</span>
            <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="s2">&quot;C&quot;</span><span class="p">;</span>
        <span class="s1">&#39;}</span>
    <span class="n">nTempSP</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: PressSP</span>
            <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
            <span class="n">field</span><span class="p">:</span> <span class="n">PREC</span> <span class="mi">2</span><span class="p">;</span>
            <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="s2">&quot;TORR&quot;</span><span class="p">;</span>
        <span class="s1">&#39;}</span>
    <span class="n">nPressSP</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="t-hashtableentry">
<h2>T_HashTableEntry<a class="headerlink" href="#t-hashtableentry" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">T_HashTableEntry</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Key</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
    <span class="n">key</span> <span class="p">:</span> <span class="n">DWORD</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">value</span> <span class="p">:</span> <span class="n">PVOID</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
</section>
<section id="gvls">
<h1>GVLs<a class="headerlink" href="#gvls" title="Link to this heading"></a></h1>
<section id="pmps-gvl">
<h2>PMPS_GVL<a class="headerlink" href="#pmps-gvl" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="n">VAR_GLOBAL</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="o">@</span><span class="p">(</span><span class="n">PREFIX</span><span class="p">)</span><span class="n">RequestedBP</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">archive</span><span class="p">:</span> <span class="mi">1</span><span class="n">Hz</span> <span class="n">monitor</span>
    <span class="s1">&#39;}</span>
    <span class="n">stRequestedBeamParameters</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span> <span class="o">//</span><span class="n">Summarized</span> <span class="n">request</span> <span class="k">for</span> <span class="n">the</span> <span class="n">line</span><span class="p">,</span> <span class="k">as</span> <span class="n">recognized</span> <span class="n">by</span> <span class="n">the</span> <span class="n">line</span> <span class="n">arbiter</span> <span class="n">PLC</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="o">@</span><span class="p">(</span><span class="n">PREFIX</span><span class="p">)</span><span class="n">CurrentBP</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">archive</span><span class="p">:</span> <span class="mi">1</span><span class="n">Hz</span> <span class="n">monitor</span>
    <span class="s1">&#39;}</span>
    <span class="n">stCurrentBeamParameters</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span> <span class="o">//</span><span class="n">Currently</span> <span class="n">active</span> <span class="n">BP</span> <span class="nb">set</span><span class="p">,</span> <span class="n">broadcast</span> <span class="n">by</span> <span class="n">the</span> <span class="n">line</span> <span class="n">arbiter</span> <span class="n">PLC</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="o">@</span><span class="p">(</span><span class="n">PREFIX</span><span class="p">)</span><span class="n">eVRangeCnst</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">archive</span><span class="p">:</span> <span class="mi">1</span><span class="n">Hz</span> <span class="n">monitor</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Active</span> <span class="n">eV</span> <span class="n">Range</span> <span class="n">constants</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">eV</span>
    <span class="s1">&#39;}</span>
    <span class="n">g_areVBoundaries</span>    <span class="p">:</span>    <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">g_cBoundaries</span><span class="p">]</span>    <span class="n">OF</span>    <span class="n">REAL</span><span class="p">;</span>



    <span class="n">PERange</span> <span class="p">:</span> <span class="n">PE_Ranges</span><span class="p">;</span> <span class="o">//</span><span class="n">Included</span> <span class="n">to</span> <span class="n">place</span> <span class="n">the</span> <span class="n">ev</span> <span class="n">ranges</span> <span class="n">properly</span>
<span class="n">END_VAR</span>
<span class="n">VAR_GLOBAL</span> <span class="n">RETAIN</span>
    <span class="o">//</span> <span class="n">Statistics</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="o">@</span><span class="p">(</span><span class="n">PREFIX</span><span class="p">)</span><span class="n">SuccessfulPreemptions</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">SuccessfulPreemption</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">Any</span> <span class="n">time</span> <span class="n">BPTM</span> <span class="n">applies</span> <span class="n">a</span> <span class="n">new</span> <span class="n">BP</span> <span class="n">request</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">confirmed</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="o">@</span><span class="p">(</span><span class="n">PREFIX</span><span class="p">)</span><span class="n">AccumulatedFastFaults</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">AccumulatedFF</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">Any</span> <span class="n">time</span> <span class="n">a</span> <span class="n">FF</span> <span class="n">occurs</span>
    <span class="n">BP_jsonDoc</span>              <span class="p">:</span> <span class="n">SJsonValue</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_GLOBAL</span> <span class="n">CONSTANT</span>

    <span class="n">EXCLUDED_ASSERTION_ID</span>    <span class="p">:</span>    <span class="n">UDINT</span>    <span class="o">:=</span> <span class="mi">16</span><span class="c1">#FFFFFFFF; //An assertion ID that should always return &quot;not found&quot; in the assertion pool</span>
    <span class="n">VISIBLE_TEST_VELOCITY</span>    <span class="p">:</span>    <span class="n">LREAL</span>    <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">FAST_TEST_VELOCITY</span>        <span class="p">:</span>    <span class="n">LREAL</span>    <span class="o">:=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="n">MAX_DEVICE_STATES</span>        <span class="p">:</span>    <span class="n">UDINT</span>    <span class="o">:=</span> <span class="mi">300</span><span class="p">;</span>

    <span class="n">TRANS_SCALING_FACTOR</span> <span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="n">REAL</span><span class="c1">#1.0; // Scaling factor for fixed-point transmission</span>

    <span class="n">AUX_ATTENUATORS</span> <span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">16</span><span class="p">;</span> <span class="o">//</span> <span class="n">Maximum</span> <span class="c1"># of attenuators in the PMPS</span>
    <span class="n">MAX_VETO_DEVICES</span>   <span class="p">:</span>   <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">16</span><span class="p">;</span>
    <span class="n">stAttenuators</span> <span class="p">:</span> <span class="n">ST_PMPS_Attenuator</span> <span class="o">:=</span><span class="p">(</span><span class="n">nTran</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span><span class="n">xAttOK</span><span class="o">:=</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="o">@</span><span class="p">(</span><span class="n">PREFIX</span><span class="p">)</span><span class="n">FullBeamCnst</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">archive</span><span class="p">:</span> <span class="mi">1</span><span class="n">Hz</span> <span class="n">monitor</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Full</span> <span class="n">beam</span> <span class="n">constant</span>
    <span class="s1">&#39;}</span>
    <span class="n">cstFullBeam</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">nTran</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">neVRange</span> <span class="o">:=</span>  <span class="mi">2</span><span class="c1">#1111_1111_1111_1111_1111_1111_1111_1111,</span>
        <span class="n">nRate</span>    <span class="o">:=</span> <span class="n">UDINT</span><span class="c1">#1000000,</span>
        <span class="n">nBCRange</span> <span class="o">:=</span> <span class="mi">2</span><span class="c1">#0111_1111_1111_1111,</span>
        <span class="n">astApertures</span> <span class="o">:=</span> <span class="p">[(</span><span class="n">Width</span><span class="o">:=</span><span class="mf">1E3</span><span class="p">,</span> <span class="n">Height</span><span class="o">:=</span><span class="mf">1E3</span><span class="p">),</span> <span class="p">(</span><span class="n">Width</span><span class="o">:=</span><span class="mf">1E3</span><span class="p">,</span> <span class="n">Height</span><span class="o">:=</span><span class="mf">1E3</span><span class="p">),(</span><span class="n">Width</span><span class="o">:=</span><span class="mf">1E3</span><span class="p">,</span> <span class="n">Height</span><span class="o">:=</span><span class="mf">1E3</span><span class="p">),(</span><span class="n">Width</span><span class="o">:=</span><span class="mf">1E3</span><span class="p">,</span> <span class="n">Height</span><span class="o">:=</span><span class="mf">1E3</span><span class="p">)],</span>
        <span class="n">astAttenuators</span> <span class="o">:=</span>  <span class="p">[</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">AUX_ATTENUATORS</span><span class="p">(</span><span class="n">stAttenuators</span><span class="p">)]</span>

    <span class="p">);</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="o">@</span><span class="p">(</span><span class="n">PREFIX</span><span class="p">)</span><span class="mi">0</span><span class="n">RateBeamCnst</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">archive</span><span class="p">:</span> <span class="mi">1</span><span class="n">Hz</span> <span class="n">monitor</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="mi">0</span><span class="o">-</span><span class="n">rate</span> <span class="n">beam</span> <span class="n">constant</span>
    <span class="s1">&#39;}</span>
    <span class="n">cst0RateBeam</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="p">(</span> <span class="o">//</span> <span class="n">Use</span> <span class="k">for</span> <span class="n">transition</span> <span class="n">requests</span>
        <span class="n">nTran</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">neVRange</span> <span class="o">:=</span>  <span class="mi">2</span><span class="c1">#1111_1111_1111_1111_1111_1111_1111_1111,</span>
        <span class="n">nRate</span>    <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">nBCRange</span> <span class="o">:=</span> <span class="mi">2</span><span class="c1">#0000_0000_0000_0000,</span>
        <span class="n">astApertures</span> <span class="o">:=</span> <span class="p">[(</span><span class="n">Width</span><span class="o">:=</span><span class="mf">1E3</span><span class="p">,</span> <span class="n">Height</span><span class="o">:=</span><span class="mf">1E3</span><span class="p">),</span> <span class="p">(</span><span class="n">Width</span><span class="o">:=</span><span class="mf">1E3</span><span class="p">,</span> <span class="n">Height</span><span class="o">:=</span><span class="mf">1E3</span><span class="p">),(</span><span class="n">Width</span><span class="o">:=</span><span class="mf">1E3</span><span class="p">,</span> <span class="n">Height</span><span class="o">:=</span><span class="mf">1E3</span><span class="p">),(</span><span class="n">Width</span><span class="o">:=</span><span class="mf">1E3</span><span class="p">,</span> <span class="n">Height</span><span class="o">:=</span><span class="mf">1E3</span><span class="p">)],</span>
        <span class="n">astAttenuators</span> <span class="o">:=</span>  <span class="p">[</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">AUX_ATTENUATORS</span><span class="p">(</span><span class="n">stAttenuators</span><span class="p">)]</span>
    <span class="p">);</span>
   <span class="p">(</span><span class="o">*</span>  <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="o">@</span><span class="p">(</span><span class="n">PREFIX</span><span class="p">)</span><span class="n">SafeBeamCnst</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">archive</span><span class="p">:</span> <span class="mi">1</span><span class="n">Hz</span> <span class="n">monitor</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Safe</span> <span class="n">beam</span> <span class="n">constant</span>
    <span class="s1">&#39;}</span>
   <span class="n">cstSafeBeam</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">nTran</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">neVRange</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">nRate</span>    <span class="o">:=</span> <span class="mi">0</span>
    <span class="p">);</span><span class="o">*</span><span class="p">)</span>

    <span class="n">cnMaxStateArrayLen</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>


    <span class="n">MAX_APERTURES</span> <span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">;</span> <span class="o">//</span> <span class="n">Maximum</span> <span class="c1"># of power slits in the PMPS</span>
    <span class="p">{</span><span class="n">warning</span> <span class="n">disable</span> <span class="n">C0228</span><span class="p">}</span>
    <span class="n">DUMMY_AUX_ATT_ARRAY</span> <span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">AUX_ATTENUATORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PMPS_Attenuator</span><span class="p">;</span>
    <span class="p">{</span><span class="n">warning</span> <span class="n">restore</span> <span class="n">C0228</span><span class="p">}</span>



    <span class="n">g_cBoundaries</span>    <span class="p">:</span>    <span class="n">INT</span>    <span class="o">:=</span> <span class="mi">31</span><span class="p">;</span>


<span class="o">//////////////////////////</span>
<span class="o">//</span> <span class="n">L</span> <span class="n">Undulator</span> <span class="n">constants</span>
<span class="o">//////////////////////////</span>

<span class="o">///////////////////////////////////////</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="o">@</span><span class="p">(</span><span class="n">PREFIX</span><span class="p">)</span><span class="n">eVRangeHyst</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">archive</span><span class="p">:</span> <span class="mi">1</span><span class="n">Hz</span> <span class="n">monitor</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">eV</span> <span class="n">Range</span> <span class="n">hystersis</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">eV</span>
    <span class="s1">&#39;}</span>
    <span class="n">reVHyst</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">5</span><span class="p">;</span> <span class="o">//</span>


    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="o">@</span><span class="p">(</span><span class="n">PREFIX</span><span class="p">)</span><span class="n">L</span><span class="p">:</span><span class="n">eVRangeCnst</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">archive</span><span class="p">:</span> <span class="mi">1</span><span class="n">Hz</span> <span class="n">monitor</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">eV</span> <span class="n">Range</span> <span class="n">constants</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">eV</span>
    <span class="s1">&#39;}</span>
    <span class="n">g_areVBoundariesL</span>    <span class="p">:</span>    <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">g_cBoundaries</span><span class="p">]</span>    <span class="n">OF</span>    <span class="n">REAL</span>    <span class="o">:=</span> <span class="p">[</span>
    <span class="mf">1.0E3</span><span class="p">,</span>
    <span class="mf">1.7E3</span><span class="p">,</span>
    <span class="mf">2.1E3</span><span class="p">,</span>
    <span class="mf">2.5E3</span><span class="p">,</span>
    <span class="mf">3.8E3</span><span class="p">,</span>
    <span class="mf">4.0E3</span><span class="p">,</span>
    <span class="mf">5.0E3</span><span class="p">,</span>
    <span class="mf">7.0E3</span><span class="p">,</span>
    <span class="mf">7.5E3</span><span class="p">,</span>
    <span class="mf">7.7E3</span><span class="p">,</span>
    <span class="mf">8.9E3</span><span class="p">,</span>
    <span class="mf">10.0E3</span><span class="p">,</span>
    <span class="mf">11.1E3</span><span class="p">,</span>
    <span class="mf">12.0E3</span><span class="p">,</span>
    <span class="mf">13.0E3</span><span class="p">,</span>
    <span class="mf">13.5E3</span><span class="p">,</span>
    <span class="mf">14.0E3</span><span class="p">,</span>
    <span class="mf">16.9E3</span><span class="p">,</span>
    <span class="mf">18.0E3</span><span class="p">,</span>
    <span class="mf">20.0E3</span><span class="p">,</span>
    <span class="mf">22.0E3</span><span class="p">,</span>
    <span class="mf">24.0E3</span><span class="p">,</span>
    <span class="mf">25.0E3</span><span class="p">,</span>
    <span class="mf">25.5E3</span><span class="p">,</span>
    <span class="mf">26.0E3</span><span class="p">,</span>
    <span class="mf">27.0E3</span><span class="p">,</span>
    <span class="mf">28.0E3</span><span class="p">,</span>
    <span class="mf">28.5E3</span><span class="p">,</span>
    <span class="mf">29.0E3</span><span class="p">,</span>
    <span class="mf">30.0E3</span><span class="p">,</span>
    <span class="mf">60.0E3</span><span class="p">,</span>
    <span class="mf">90.0E3</span>
    <span class="p">];</span>


    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="o">@</span><span class="p">(</span><span class="n">PREFIX</span><span class="p">)</span><span class="n">K</span><span class="p">:</span><span class="n">eVRangeCnst</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">archive</span><span class="p">:</span> <span class="mi">1</span><span class="n">Hz</span> <span class="n">monitor</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">eV</span> <span class="n">Range</span> <span class="n">constants</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">eV</span>
    <span class="s1">&#39;}</span>
    <span class="n">g_areVBoundariesK</span>    <span class="p">:</span>    <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">g_cBoundaries</span><span class="p">]</span>    <span class="n">OF</span>    <span class="n">REAL</span>    <span class="o">:=</span> <span class="p">[</span>
    <span class="mi">100</span><span class="p">,</span>
    <span class="mi">250</span><span class="p">,</span>
    <span class="mi">270</span><span class="p">,</span>
    <span class="mi">350</span><span class="p">,</span>
    <span class="mi">400</span><span class="p">,</span>
    <span class="mi">450</span><span class="p">,</span>
    <span class="mi">480</span><span class="p">,</span>
    <span class="mi">530</span><span class="p">,</span>
    <span class="mi">680</span><span class="p">,</span>
    <span class="mi">730</span><span class="p">,</span>
    <span class="mi">850</span><span class="p">,</span>
    <span class="mf">1.10E3</span><span class="p">,</span>
    <span class="mf">1.15E3</span><span class="p">,</span>
    <span class="mf">1.25E3</span><span class="p">,</span>
    <span class="mf">1.45E3</span><span class="p">,</span>
    <span class="mf">1.50E3</span><span class="p">,</span>
    <span class="mf">1.55E3</span><span class="p">,</span>
    <span class="mf">1.65E3</span><span class="p">,</span>
    <span class="mf">1.70E3</span><span class="p">,</span>
    <span class="mf">1.75E3</span><span class="p">,</span>
    <span class="mf">1.82E3</span><span class="p">,</span>
    <span class="mf">1.85E3</span><span class="p">,</span>
    <span class="mf">2.00E3</span><span class="p">,</span>
    <span class="mf">2.20E3</span><span class="p">,</span>
    <span class="mf">2.50E3</span><span class="p">,</span>
    <span class="mf">2.80E3</span><span class="p">,</span>
    <span class="mf">3.00E3</span><span class="p">,</span>
    <span class="mf">3.15E3</span><span class="p">,</span>
    <span class="mf">3.50E3</span><span class="p">,</span>
    <span class="mf">4.00E3</span><span class="p">,</span>
    <span class="mf">5.30E3</span><span class="p">,</span>
    <span class="mf">7.00E3</span>
    <span class="p">];</span>


<span class="n">END_VAR</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#pe-ranges">PE_Ranges</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
<li><p><a class="reference internal" href="#st-pmps-attenuator">ST_PMPS_Attenuator</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="pmps-param">
<h2>PMPS_PARAM<a class="headerlink" href="#pmps-param" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="n">VAR_GLOBAL</span> <span class="n">CONSTANT</span>
    <span class="n">MAX_FAST_FAULTS</span> <span class="p">:</span>       <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">50</span><span class="p">;</span> <span class="o">//</span> <span class="n">Max</span> <span class="n">fast</span> <span class="n">faults</span> <span class="k">for</span> <span class="n">an</span> <span class="n">FFO</span>
    <span class="n">MAX_ASSERTIONS</span>    <span class="p">:</span>    <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span> <span class="o">//</span><span class="n">Maximum</span> <span class="n">number</span> <span class="n">of</span> <span class="n">BP</span> <span class="n">requests</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">arbiter</span>
    <span class="n">TRANS_MARGIN</span> <span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="n">REAL</span><span class="c1">#0.05; // Allowed % margin above requested transmission level in SafeBPCompare (0.0500 = 5deci% default). Note: change this value if scaling factor changes.</span>
<span class="n">END_VAR</span>
</pre></div>
</div>
</section>
<section id="pmps-tools">
<h2>PMPS_TOOLS<a class="headerlink" href="#pmps-tools" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="n">VAR_GLOBAL</span>
    <span class="n">fbJson</span> <span class="p">:</span> <span class="n">FB_JsonSaxWriter</span><span class="p">;</span>
<span class="n">END_VAR</span>
</pre></div>
</div>
</section>
</section>
<section id="pous">
<h1>POUs<a class="headerlink" href="#pous" title="Link to this heading"></a></h1>
<section id="apt-to-io">
<h2>APT_TO_IO<a class="headerlink" href="#apt-to-io" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">APT_TO_IO</span> <span class="p">:</span> <span class="n">ST_PMPS_Aperture_IO</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Apt</span> <span class="p">:</span> <span class="n">ST_PMPS_Aperture</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">APT_TO_IO</span><span class="o">.</span><span class="n">Height</span> <span class="o">:=</span> <span class="n">Apt</span><span class="o">.</span><span class="n">Height</span><span class="p">;</span>
<span class="n">APT_TO_IO</span><span class="o">.</span><span class="n">Width</span> <span class="o">:=</span> <span class="n">Apt</span><span class="o">.</span><span class="n">Width</span><span class="p">;</span>
<span class="n">APT_TO_IO</span><span class="o">.</span><span class="n">xOK</span> <span class="o">:=</span> <span class="n">Apt</span><span class="o">.</span><span class="n">xOK</span><span class="p">;</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-pmps-aperture">ST_PMPS_Aperture</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="att-to-io">
<h2>ATT_TO_IO<a class="headerlink" href="#att-to-io" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">ATT_TO_IO</span> <span class="p">:</span> <span class="n">ST_PMPS_Attenuator_IO</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Att</span> <span class="p">:</span> <span class="n">ST_PMPS_Attenuator</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">ATT_TO_IO</span><span class="o">.</span><span class="n">nTran</span> <span class="o">:=</span> <span class="n">Att</span><span class="o">.</span><span class="n">nTran</span><span class="p">;</span>
<span class="n">ATT_TO_IO</span><span class="o">.</span><span class="n">xAttOK</span> <span class="o">:=</span> <span class="n">Att</span><span class="o">.</span><span class="n">xAttOK</span><span class="p">;</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-pmps-attenuator">ST_PMPS_Attenuator</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="beamparametertransitionmanager">
<h2>BeamParameterTransitionManager<a class="headerlink" href="#beamparametertransitionmanager" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span>
<span class="n">Implements</span> <span class="n">the</span> <span class="n">procedure</span> <span class="k">for</span> <span class="n">safely</span> <span class="n">transitioning</span> <span class="n">between</span> <span class="n">device</span> <span class="n">states</span><span class="o">.</span>

<span class="n">NOTE</span><span class="p">:</span>
<span class="n">The</span> <span class="n">BPTM</span> <span class="n">will</span> <span class="n">throw</span> <span class="n">an</span> <span class="n">error</span> <span class="k">if</span> <span class="n">the</span> <span class="n">arbiter</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">have</span> <span class="n">enough</span> <span class="n">space</span> <span class="k">for</span> <span class="n">the</span> <span class="n">transition</span> <span class="ow">and</span> <span class="n">new</span> <span class="n">final</span> <span class="n">assertion</span><span class="o">.</span>

 <span class="o">*</span><span class="p">)</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_check&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">BeamParameterTransitionManager</span>
<span class="n">VAR_IN_OUT</span>

    <span class="n">fbArbiter</span>    <span class="p">:</span>    <span class="n">FB_Arbiter</span><span class="p">;</span> <span class="o">//</span><span class="n">Connect</span> <span class="n">to</span> <span class="n">local</span> <span class="n">arbiter</span>

<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_sDeviceName</span>   <span class="p">:</span>       <span class="n">STRING</span><span class="o">:=</span><span class="s1">&#39;Device&#39;</span><span class="p">;</span> <span class="o">//</span> <span class="n">Name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">device</span> <span class="n">requesting</span> <span class="n">the</span> <span class="n">transition</span>

    <span class="n">i_TransitionAssertionID</span>    <span class="p">:</span>    <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">//</span> <span class="n">Must</span> <span class="ow">not</span> <span class="n">be</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">EXCLUDED_ID</span>
    <span class="n">i_stTransitionAssertion</span> <span class="p">:</span> <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cst0RateBeam</span><span class="p">;</span> <span class="o">//</span><span class="n">Assertion</span> <span class="n">required</span> <span class="n">during</span> <span class="n">transition</span> <span class="p">(</span><span class="n">always</span> <span class="n">safer</span> <span class="n">than</span> <span class="n">anything</span> <span class="n">inbetween</span><span class="p">)</span>

    <span class="n">i_nRequestedAssertionID</span>    <span class="p">:</span>    <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">//</span> <span class="n">Must</span> <span class="ow">not</span> <span class="n">be</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">EXCLUDED_ID</span>
    <span class="n">i_stRequestedAssertion</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="p">(</span> <span class="n">nTran</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">neVRange</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nRate</span>  <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nBCRange</span> <span class="o">:=</span><span class="mi">0</span><span class="p">);</span><span class="o">//</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstSafeBeam</span><span class="p">;</span> <span class="o">//</span><span class="n">Requested</span> <span class="n">assertion</span><span class="p">,</span> <span class="n">change</span> <span class="n">whenever</span>

    <span class="n">i_xMoving</span>    <span class="p">:</span>    <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span> <span class="o">//</span><span class="n">Provide</span> <span class="n">rising</span> <span class="n">edge</span> <span class="n">when</span> <span class="n">device</span> <span class="n">begins</span> <span class="n">moving</span> <span class="o">&lt;</span><span class="n">remove</span><span class="o">&gt;</span>
    <span class="n">i_xDoneMoving</span>    <span class="p">:</span>    <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span> <span class="o">//</span><span class="n">Provide</span> <span class="n">rising</span> <span class="n">edge</span> <span class="n">when</span> <span class="n">device</span> <span class="ow">is</span> <span class="n">done</span> <span class="k">with</span> <span class="n">a</span> <span class="n">move</span>

    <span class="n">stCurrentBeamParameters</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstFullBeam</span><span class="p">;</span> <span class="o">//</span><span class="n">Connect</span> <span class="n">to</span> <span class="n">current</span> <span class="n">beam</span> <span class="n">parameters</span>

    <span class="o">//</span> <span class="n">Rising</span> <span class="n">edge</span> <span class="n">to</span> <span class="n">cycle</span> <span class="n">back</span> <span class="n">through</span> <span class="n">the</span> <span class="n">BPTM</span> <span class="n">process</span><span class="o">.</span> <span class="n">Use</span> <span class="k">if</span> <span class="n">something</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">process</span> <span class="n">timed</span> <span class="n">out</span> <span class="ow">or</span> <span class="n">failed</span><span class="o">.</span> <span class="n">This</span> <span class="n">will</span> <span class="n">interrupt</span> <span class="n">a</span> <span class="n">current</span> <span class="n">process</span>
    <span class="n">bRetry</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>

    <span class="n">q_xTransitionAuthorized</span>    <span class="p">:</span>    <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span> <span class="o">//</span><span class="n">Rising</span> <span class="n">edge</span> <span class="n">indicating</span> <span class="n">the</span> <span class="n">device</span> <span class="ow">is</span> <span class="n">safe</span> <span class="n">to</span> <span class="n">move</span><span class="p">,</span> <span class="n">use</span> <span class="k">as</span> <span class="nb">input</span> <span class="n">to</span> <span class="n">move</span> <span class="n">execute</span> <span class="p">(</span><span class="n">which</span> <span class="n">requires</span> <span class="n">a</span> <span class="n">rising</span> <span class="n">edge</span><span class="p">)</span>

    <span class="n">bError</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Set</span> <span class="k">if</span> <span class="n">some</span> <span class="n">issue</span> <span class="n">occurs</span> <span class="n">within</span> <span class="n">the</span> <span class="n">bptm</span>
    <span class="n">nErrId</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">Set</span> <span class="n">to</span> <span class="n">non</span><span class="o">-</span><span class="n">zero</span> <span class="n">to</span> <span class="n">help</span> <span class="n">understand</span> <span class="n">the</span> <span class="n">error</span><span class="o">.</span>

    <span class="n">bDone</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">nTargetAssertionID</span>    <span class="p">:</span>    <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">stTargetAssertion</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span> <span class="o">//</span> <span class="n">Target</span> <span class="n">assertion</span>
    <span class="n">nCurrentAssertionID</span>    <span class="p">:</span>    <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>  <span class="o">//</span> <span class="n">ID</span> <span class="n">of</span> <span class="n">last</span> <span class="nb">set</span> <span class="n">state</span> <span class="p">(</span><span class="n">zero</span> <span class="n">until</span> <span class="n">a</span> <span class="n">state</span> <span class="ow">is</span> <span class="n">reached</span><span class="p">)</span>

    <span class="n">xNewBP</span>    <span class="p">:</span>    <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">xTranBP</span>    <span class="p">:</span>    <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">xFinalBPInArb</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">xFinalBP</span>    <span class="p">:</span>    <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">eBPTMState</span> <span class="p">:</span> <span class="n">E_BPTMState</span> <span class="o">:=</span> <span class="n">Init</span><span class="p">;</span>
    <span class="n">ePrevState</span> <span class="p">:</span> <span class="n">E_BPTMState</span> <span class="o">:=</span> <span class="n">Init</span><span class="p">;</span>

    <span class="n">xEntry</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">rTransition</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">xNewTarget</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">bTransAssertionFailed</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bFinalAssertionFailed</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">LogStrBuffer</span> <span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">LogBuffSize</span><span class="p">]</span> <span class="n">OF</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">LogBuffIdx</span> <span class="p">:</span> <span class="n">FB_Index</span> <span class="o">:=</span> <span class="p">(</span><span class="n">LowerLimit</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">UpperLimit</span><span class="o">:=</span><span class="n">LogBuffSize</span><span class="p">);</span>

    <span class="n">nAssrtAttempt</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span> <span class="o">//</span> <span class="n">Number</span> <span class="n">of</span> <span class="n">times</span> <span class="n">we</span> <span class="n">have</span> <span class="n">tried</span> <span class="n">asserting</span> <span class="n">a</span> <span class="n">BP</span> <span class="nb">set</span>

    <span class="n">rtRetry</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>

    <span class="n">rtError</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>

    <span class="n">ffTimeout</span> <span class="p">:</span> <span class="n">FB_FastFault</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">i_Desc</span> <span class="o">:=</span> <span class="s1">&#39;Preemptive requests timed out in BPTM&#39;</span><span class="p">,</span>
        <span class="n">i_TypeCode</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#A,</span>
        <span class="n">i_xAutoReset</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">);</span>

    <span class="n">rtDoneMoving</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">bLatchDoneMoving</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">bFirstMove</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">LogBuffSize</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">40</span><span class="p">;</span>
    <span class="n">cMaxAttempts</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">The</span> <span class="n">thought</span> <span class="n">here</span> <span class="ow">is</span><span class="p">,</span> <span class="n">a</span> <span class="n">BPTM</span> <span class="n">needs</span> <span class="n">at</span> <span class="n">most</span> <span class="mi">2</span> <span class="n">arbiter</span> <span class="n">slots</span> <span class="n">to</span> <span class="n">complete</span> <span class="n">a</span> <span class="n">transition</span><span class="o">.</span>
    <span class="n">If</span> <span class="n">we</span><span class="s1">&#39;re at capacity, it means some BPTM before this one has begun a transition,</span>
    <span class="ow">and</span> <span class="n">will</span> <span class="n">require</span> <span class="n">at</span> <span class="n">least</span> <span class="n">one</span> <span class="n">more</span> <span class="n">arbiter</span> <span class="n">spot</span> <span class="n">to</span> <span class="n">complete</span><span class="o">.</span>
    <span class="o">*</span><span class="p">)</span>
    <span class="n">cReqArbCapacity</span> <span class="p">:</span> <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Logic</span> <span class="k">for</span> <span class="n">retry</span> <span class="n">button</span>
<span class="n">rtRetry</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bRetry</span><span class="p">);</span>
<span class="n">bRetry</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Logic</span> <span class="k">for</span> <span class="n">catching</span> <span class="n">Move</span> <span class="n">Done</span> <span class="n">rising</span> <span class="n">edge</span>
<span class="n">rtDoneMoving</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">i_xDoneMoving</span><span class="p">);</span>
<span class="n">bLatchDoneMoving</span> <span class="n">S</span><span class="o">=</span> <span class="n">rtDoneMoving</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Logic</span> <span class="k">for</span> <span class="n">interrupting</span> <span class="n">BPTM</span> <span class="ow">and</span> <span class="n">changing</span> <span class="n">requests</span>
<span class="n">IF</span> <span class="n">nTargetAssertionID</span> <span class="o">&lt;&gt;</span> <span class="n">i_nRequestedAssertionID</span> <span class="n">OR</span> <span class="n">rtRetry</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>

    <span class="n">bError</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nErrID</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">bDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Execute</span> <span class="n">exit</span> <span class="n">actions</span> <span class="n">before</span> <span class="n">transition</span> <span class="n">back</span> <span class="n">to</span> <span class="n">NewTarget</span>
    <span class="n">CASE</span> <span class="n">eBPTMState</span> <span class="n">OF</span>
        <span class="n">Transitioning</span><span class="p">:</span>
            <span class="n">DeauthorizeTransition</span><span class="p">();</span>
        <span class="o">//</span><span class="n">CleaningUp</span><span class="p">:</span>
    <span class="n">END_CASE</span>

    <span class="n">eBPTMState</span> <span class="o">:=</span> <span class="n">E_BPTMState</span><span class="o">.</span><span class="n">NewTarget</span><span class="p">;</span>
    <span class="n">xEntry</span> <span class="o">:=</span> <span class="n">eBPTMState</span> <span class="o">&lt;&gt;</span> <span class="n">ePrevState</span><span class="p">;</span>

<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">xEntry</span> <span class="n">THEN</span> <span class="n">nAssrtAttempt</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">END_IF</span>

<span class="n">rtError</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bError</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">rtError</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">eBPTMState</span> <span class="o">:=</span> <span class="n">E_BPTMState</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">States</span>
<span class="n">CASE</span> <span class="n">eBPTMState</span> <span class="n">OF</span>
    <span class="n">NewTarget</span><span class="p">:</span>
        <span class="n">IF</span> <span class="n">xEntry</span> <span class="n">THEN</span>
            <span class="n">NewTarget_ENTRY</span><span class="p">();</span>
        <span class="n">ELSIF</span> <span class="n">xNewBP</span> <span class="n">THEN</span>
            <span class="n">eBPTMState</span> <span class="o">:=</span> <span class="n">E_BPTMState</span><span class="o">.</span><span class="n">RequestBP</span><span class="p">;</span>
        <span class="n">ELSE</span>
            <span class="n">SetNewTarget</span><span class="p">();</span>
        <span class="n">END_IF</span>

    <span class="n">RequestBP</span><span class="p">:</span>
        <span class="n">IF</span> <span class="n">PMPS_PARAM</span><span class="o">.</span><span class="n">MAX_ASSERTIONS</span> <span class="o">-</span> <span class="n">fbArbiter</span><span class="o">.</span><span class="n">nEntryCount</span> <span class="o">&gt;=</span> <span class="n">cReqArbCapacity</span> <span class="n">THEN</span>
            <span class="n">AssertTransitionBP</span><span class="p">();</span>
            <span class="n">AssertFinalBP</span><span class="p">();</span>
            <span class="n">eBPTMState</span> <span class="o">:=</span> <span class="n">E_BPTMState</span><span class="o">.</span><span class="n">WaitForBP</span><span class="p">;</span>
        <span class="n">ELSE</span>
            <span class="n">LogActions</span><span class="p">(</span><span class="s1">&#39;Arbiter at capacity, leaving space for other BPTM to finish.&#39;</span><span class="p">);</span>
            <span class="n">nErrId</span> <span class="o">:=</span> <span class="n">PMPS_CODES</span><span class="o">.</span><span class="n">NoRoomInArb</span><span class="p">;</span>
            <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">END_IF</span>

    <span class="n">WaitForBP</span><span class="p">:</span>
        <span class="n">WaitingForTransitionAssertion_DO</span><span class="p">();</span>
        <span class="n">WaitingForFinalAssertion_DO</span><span class="p">();</span>
        <span class="n">IF</span> <span class="n">xTranBP</span> <span class="n">AND</span> <span class="n">xFinalBPInArb</span> <span class="n">THEN</span> <span class="n">eBPTMState</span> <span class="o">:=</span> <span class="n">E_BPTMState</span><span class="o">.</span><span class="n">Transitioning</span><span class="p">;</span> <span class="n">END_IF</span>

    <span class="n">Transitioning</span><span class="p">:</span>
        <span class="n">IF</span> <span class="n">xEntry</span> <span class="n">THEN</span>
            <span class="n">AuthorizeTransition</span><span class="p">();</span>
        <span class="n">ELSIF</span> <span class="n">bLatchDoneMoving</span> <span class="n">OR</span> <span class="p">(</span><span class="n">bFirstMove</span> <span class="n">AND</span> <span class="n">i_xDoneMoving</span><span class="p">)</span> <span class="n">THEN</span>
            <span class="n">DeauthorizeTransition</span><span class="p">();</span>
            <span class="n">eBPTMState</span> <span class="o">:=</span> <span class="n">E_BPTMState</span><span class="o">.</span><span class="n">WaitForFinalBP</span><span class="p">;</span>
        <span class="n">END_IF</span>

    <span class="n">WaitForFinalBP</span><span class="p">:</span>
        <span class="n">xFinalBP</span> <span class="o">:=</span> <span class="n">F_SafeBPCompare</span><span class="p">(</span><span class="n">stCurrentBeamParameters</span><span class="p">,</span> <span class="n">stTargetAssertion</span><span class="p">);</span>
        <span class="n">IF</span> <span class="n">xFinalBP</span> <span class="n">THEN</span>
            <span class="n">eBPTMState</span> <span class="o">:=</span> <span class="n">E_BPTMState</span><span class="o">.</span><span class="n">CleaningUp</span><span class="p">;</span>
        <span class="n">END_IF</span>

    <span class="n">CleaningUp</span><span class="p">:</span>
        <span class="n">IF</span> <span class="n">xEntry</span> <span class="n">THEN</span>
            <span class="n">RemoveTransitionAssertion</span><span class="p">();</span>
        <span class="n">ELSE</span>
            <span class="n">eBPTMState</span> <span class="o">:=</span> <span class="n">E_BPTMState</span><span class="o">.</span><span class="n">Done</span><span class="p">;</span>
        <span class="n">END_IF</span>

    <span class="n">Done</span><span class="p">:</span>
        <span class="n">bDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">bFirstMove</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">LogActions</span><span class="p">(</span><span class="s1">&#39;Returning to idle&#39;</span><span class="p">);</span>
        <span class="n">eBPTMState</span> <span class="o">:=</span> <span class="n">E_BPTMState</span><span class="o">.</span><span class="n">Idle</span><span class="p">;</span>

    <span class="n">Error</span><span class="p">:</span>
        <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">eBPTMState</span> <span class="o">:=</span> <span class="n">E_BPTMState</span><span class="o">.</span><span class="n">Idle</span><span class="p">;</span>
<span class="n">END_CASE</span>

<span class="n">xEntry</span> <span class="o">:=</span> <span class="n">ePrevState</span> <span class="o">&lt;&gt;</span> <span class="n">eBPTMState</span><span class="p">;</span>
<span class="n">ePrevState</span> <span class="o">:=</span> <span class="n">eBPTMState</span><span class="p">;</span>

<span class="n">bDone</span> <span class="n">R</span><span class="o">=</span> <span class="n">bError</span><span class="p">;</span>
<span class="n">bBusy</span> <span class="n">R</span><span class="o">=</span> <span class="n">bError</span> <span class="n">OR</span> <span class="n">bDone</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">AssertFinalBP</span><span class="p">:</span>
<span class="o">//</span><span class="n">q_stFinalAssertion</span> <span class="o">:=</span> <span class="n">stTargetAssertion</span><span class="p">;</span>

<span class="o">//</span><span class="n">Clearing</span> <span class="n">previous</span> <span class="n">target</span> <span class="n">parameters</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">considered</span> <span class="n">safe</span> <span class="n">at</span> <span class="n">this</span> <span class="n">step</span> <span class="k">as</span> <span class="n">the</span> <span class="n">transition</span>
<span class="n">state</span> <span class="n">beam</span> <span class="n">parameters</span> <span class="n">should</span> <span class="n">always</span> <span class="n">be</span> <span class="n">safer</span> <span class="n">than</span> <span class="n">the</span>
<span class="n">current</span> <span class="ow">or</span> <span class="n">target</span> <span class="n">state</span> <span class="n">beam</span> <span class="n">parameters</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">nCurrentAssertionID</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">LogActions</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Removing previous request: &#39;</span><span class="p">,</span> <span class="n">DWORD_TO_HEXSTR</span><span class="p">(</span><span class="n">nCurrentAssertionID</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">false</span><span class="p">))</span> <span class="p">);</span>
    <span class="n">fbArbiter</span><span class="o">.</span><span class="n">RemoveRequest</span><span class="p">(</span> <span class="n">nCurrentAssertionID</span> <span class="p">);</span>
<span class="n">END_IF</span>

<span class="n">LogActions</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Asserting target req.: &#39;</span><span class="p">,</span> <span class="n">DWORD_TO_HEXSTR</span><span class="p">(</span><span class="n">nTargetAssertionID</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">false</span><span class="p">))</span> <span class="p">);</span>

<span class="o">//</span><span class="n">Asserting</span> <span class="n">target</span> <span class="n">parameters</span>
<span class="n">bFinalAssertionFailed</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">fbArbiter</span><span class="o">.</span><span class="n">AddRequest</span><span class="p">(</span>
    <span class="n">nTargetAssertionID</span><span class="p">,</span>
    <span class="n">stTargetAssertion</span><span class="p">,</span>
    <span class="n">i_sDeviceName</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">bFinalAssertionFailed</span> <span class="n">THEN</span>
    <span class="n">LogActions</span><span class="p">(</span><span class="s1">&#39;Assert final failed. &#39;</span><span class="p">);</span>
    <span class="n">nAssrtAttempt</span> <span class="o">:=</span> <span class="n">nAssrtAttempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">nAssrtAttempt</span> <span class="o">&gt;</span> <span class="n">cMaxAttempts</span> <span class="n">THEN</span>
        <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">nErrID</span> <span class="o">:=</span> <span class="n">PMPS_CODES</span><span class="o">.</span><span class="n">FinalAssrtFail</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">ELSE</span>
    <span class="o">//</span> <span class="n">Remembering</span> <span class="n">final</span> <span class="n">assertionID</span> <span class="k">for</span> <span class="n">removal</span> <span class="n">later</span>
    <span class="n">nCurrentAssertionID</span> <span class="o">:=</span> <span class="n">nTargetAssertionID</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">AssertTransitionBP</span><span class="p">:</span>
<span class="n">LogActions</span><span class="p">(</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Removing transition id: &#39;</span><span class="p">,</span> <span class="n">DWORD_TO_STRING</span><span class="p">(</span><span class="n">i_TransitionAssertionID</span><span class="p">))</span> <span class="p">);</span>
<span class="n">fbArbiter</span><span class="o">.</span><span class="n">RemoveRequest</span><span class="p">(</span><span class="n">i_TransitionAssertionID</span><span class="p">);</span>

<span class="n">LogActions</span><span class="p">(</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Requesting transition id: &#39;</span><span class="p">,</span> <span class="n">DWORD_TO_STRING</span><span class="p">(</span><span class="n">i_TransitionAssertionID</span><span class="p">))</span> <span class="p">);</span>
<span class="n">bTransAssertionFailed</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">fbArbiter</span><span class="o">.</span><span class="n">AddRequest</span><span class="p">(</span>
    <span class="n">i_TransitionAssertionID</span><span class="p">,</span>
    <span class="n">i_stTransitionAssertion</span><span class="p">,</span>
    <span class="n">i_sDeviceName</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">bTransAssertionFailed</span> <span class="n">THEN</span>
    <span class="n">LogActions</span><span class="p">(</span><span class="s1">&#39;Assert trans. failed. &#39;</span><span class="p">);</span>
    <span class="n">nAssrtAttempt</span> <span class="o">:=</span> <span class="n">nAssrtAttempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">nAssrtAttempt</span> <span class="o">&gt;</span> <span class="n">cMaxAttempts</span> <span class="n">THEN</span>
        <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">nErrID</span> <span class="o">:=</span> <span class="n">PMPS_CODES</span><span class="o">.</span><span class="n">TransAssrtFail</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">AuthorizeTransition</span><span class="p">:</span>
<span class="n">q_xTransitionAuthorized</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="n">bLatchDoneMoving</span> <span class="n">R</span><span class="o">=</span> <span class="n">q_xTransitionAuthorized</span><span class="p">;</span>

<span class="n">LogActions</span><span class="p">(</span><span class="s1">&#39;Authorizing transition&#39;</span><span class="p">);</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">DeauthorizeTransition</span><span class="p">:</span>
<span class="n">q_xTransitionAuthorized</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">LogActions</span><span class="p">(</span><span class="s1">&#39;Deauthorizing transition&#39;</span><span class="p">);</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">NewTarget_ENTRY</span><span class="p">:</span>
<span class="n">xNewBP</span> <span class="o">:=</span> <span class="kc">False</span><span class="p">;</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">RemoveTransitionAssertion</span><span class="p">:</span>
<span class="o">//</span><span class="n">q_stTransitionAssertion</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstFullBeam</span><span class="p">;</span>

<span class="o">//</span><span class="n">Removing</span> <span class="n">transition</span> <span class="n">assertion</span>
<span class="n">fbArbiter</span><span class="o">.</span><span class="n">RemoveRequest</span><span class="p">(</span> <span class="n">i_TransitionAssertionID</span> <span class="p">);</span>

<span class="n">LogActions</span><span class="p">(</span><span class="s1">&#39;Removing transition req&#39;</span><span class="p">);</span>

<span class="o">//</span><span class="n">TODO</span> <span class="n">add</span> <span class="n">something</span> <span class="n">to</span> <span class="n">verify</span> <span class="n">removal</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">RequestBP_DO</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Request</span> <span class="n">BP</span> <span class="n">atomically</span> <span class="n">so</span> <span class="n">we</span> <span class="n">know</span> <span class="n">we</span><span class="s1">&#39;ll finish the BPTM cycle</span>
<span class="n">IF</span> <span class="n">fbArbiter</span><span class="o">.</span><span class="n">nEntryCount</span> <span class="o">&lt;</span> <span class="n">cReqArbCapacity</span> <span class="n">THEN</span>

    <span class="n">LogActions</span><span class="p">(</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Removing transition id: &#39;</span><span class="p">,</span> <span class="n">DWORD_TO_STRING</span><span class="p">(</span><span class="n">i_TransitionAssertionID</span><span class="p">))</span> <span class="p">);</span>
    <span class="n">fbArbiter</span><span class="o">.</span><span class="n">RemoveRequest</span><span class="p">(</span><span class="n">i_TransitionAssertionID</span><span class="p">);</span>

    <span class="n">LogActions</span><span class="p">(</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Requesting transition id: &#39;</span><span class="p">,</span> <span class="n">DWORD_TO_STRING</span><span class="p">(</span><span class="n">i_TransitionAssertionID</span><span class="p">))</span> <span class="p">);</span>
    <span class="n">bTransAssertionFailed</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">fbArbiter</span><span class="o">.</span><span class="n">AddRequest</span><span class="p">(</span>
        <span class="n">i_TransitionAssertionID</span><span class="p">,</span>
        <span class="n">i_stTransitionAssertion</span><span class="p">,</span>
        <span class="n">i_sDeviceName</span>
    <span class="p">);</span>

    <span class="n">IF</span> <span class="n">bTransAssertionFailed</span> <span class="n">THEN</span>
        <span class="n">LogActions</span><span class="p">(</span><span class="s1">&#39;Assert trans. failed. &#39;</span><span class="p">);</span>
        <span class="n">nAssrtAttempt</span> <span class="o">:=</span> <span class="n">nAssrtAttempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">IF</span> <span class="n">nAssrtAttempt</span> <span class="o">&gt;</span> <span class="n">cMaxAttempts</span> <span class="n">THEN</span>
            <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">nErrID</span> <span class="o">:=</span> <span class="n">PMPS_CODES</span><span class="o">.</span><span class="n">TransAssrtFail</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>



<span class="n">ELSE</span>
    <span class="n">LogActions</span><span class="p">(</span><span class="s1">&#39;Arbiter at capacity, leaving space for other BPTM to finish.&#39;</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">SetNewTarget</span><span class="p">:</span>
<span class="n">IF</span> <span class="n">F_ValidReqID</span><span class="p">(</span><span class="n">i_nRequestedAssertionID</span><span class="p">)</span> <span class="n">AND</span>
    <span class="n">F_ValidReqID</span><span class="p">(</span><span class="n">i_TransitionAssertionID</span><span class="p">)</span> <span class="n">THEN</span>

    <span class="n">stTargetAssertion</span> <span class="o">:=</span> <span class="n">i_stRequestedAssertion</span><span class="p">;</span>
    <span class="n">nTargetAssertionID</span> <span class="o">:=</span> <span class="n">i_nRequestedAssertionID</span><span class="p">;</span>

    <span class="n">LogActions</span><span class="p">(</span><span class="s1">&#39;New target set&#39;</span><span class="p">);</span>

    <span class="n">xNewBP</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="n">ELSE</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">F_ValidReqID</span><span class="p">(</span><span class="n">i_nRequestedAssertionID</span><span class="p">)</span> <span class="n">THEN</span>

        <span class="n">nErrID</span> <span class="o">:=</span> <span class="n">PMPS_CODES</span><span class="o">.</span><span class="n">BadTargetID</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">F_ValidReqID</span><span class="p">(</span><span class="n">i_TransitionAssertionID</span><span class="p">)</span> <span class="n">THEN</span>
        <span class="n">nErrID</span> <span class="o">:=</span> <span class="n">PMPS_CODES</span><span class="o">.</span><span class="n">BadTransID</span><span class="p">;</span>
    <span class="n">END_IF</span>
    <span class="n">LogActions</span><span class="p">(</span><span class="s1">&#39;Error in set new target&#39;</span><span class="p">);</span>
    <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">WaitingForFinalAssertion_DO</span><span class="p">:</span>
<span class="o">//</span><span class="n">Final</span> <span class="n">Assertion</span> <span class="n">Verification</span>

<span class="n">xFinalBPInArb</span> <span class="o">:=</span> <span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">(</span> <span class="n">i_nRequestedAssertionID</span><span class="p">);;</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">WaitingForFinalAssertion_EXIT</span><span class="p">:</span>
<span class="o">//</span><span class="n">Set</span> <span class="n">this</span> <span class="nb">bool</span> <span class="n">false</span> <span class="n">so</span> <span class="n">we</span> <span class="n">can</span> <span class="n">get</span> <span class="n">a</span> <span class="n">rising</span> <span class="n">edge</span> <span class="n">on</span> <span class="n">the</span> <span class="nb">next</span> <span class="k">try</span>
<span class="n">xFinalBP</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">WaitingForTransitionAssertion_DO</span><span class="p">:</span>
<span class="o">//</span><span class="n">Transition</span> <span class="n">Assertion</span> <span class="n">Verification</span>
<span class="n">xTranBP</span>    <span class="o">:=</span> <span class="n">F_SafeBPCompare0Rate</span><span class="p">(</span><span class="n">stCurrentBeamParameters</span><span class="p">,</span> <span class="n">i_stTransitionAssertion</span><span class="p">)</span> <span class="n">AND</span>
    <span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">(</span><span class="n">i_TransitionAssertionID</span><span class="p">);</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">WaitingForTransitionAssertion_EXIT</span><span class="p">:</span>
<span class="n">xTranBP</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_ACTION</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_check&#39;</span><span class="p">}</span>
<span class="n">METHOD</span> <span class="n">LogActions</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">LogStr</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">LogStrBuffer</span><span class="p">[</span><span class="n">LogBuffIdx</span><span class="o">.</span><span class="n">IncVal</span><span class="p">()]</span> <span class="o">:=</span> <span class="n">LogStr</span><span class="p">;</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-bptmstate">E_BPTMState</a></p></li>
<li><p><a class="reference internal" href="#fb-arbiter">FB_Arbiter</a></p></li>
<li><p><a class="reference internal" href="#fb-fastfault">FB_FastFault</a></p></li>
<li><p><a class="reference internal" href="#f-safebpcompare">F_SafeBPCompare</a></p></li>
<li><p><a class="reference internal" href="#f-safebpcompare0rate">F_SafeBPCompare0Rate</a></p></li>
<li><p><a class="reference internal" href="#f-validreqid">F_ValidReqID</a></p></li>
<li><p><a class="reference internal" href="#pmps-codes">PMPS_CODES</a></p></li>
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
<li><p><a class="reference internal" href="#pmps-param">PMPS_PARAM</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="bp-to-io">
<h2>BP_TO_IO<a class="headerlink" href="#bp-to-io" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_check&#39;</span><span class="p">}</span>
<span class="n">FUNCTION</span> <span class="n">BP_TO_IO</span> <span class="p">:</span> <span class="n">ST_BeamParams_IO</span>
<span class="n">VAR_INPUT</span>
    <span class="n">BP</span> <span class="p">:</span> <span class="n">ST_BeamParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">idx</span> <span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">FOR</span> <span class="n">idx</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">AUX_ATTENUATORS</span> <span class="n">DO</span>
    <span class="n">BP_TO_IO</span><span class="o">.</span><span class="n">astAttenuators</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ATT_TO_IO</span><span class="p">(</span><span class="n">BP</span><span class="o">.</span><span class="n">astAttenuators</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
<span class="n">END_FOR</span>

<span class="n">FOR</span> <span class="n">idx</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">MAX_APERTURES</span> <span class="n">DO</span>
    <span class="n">BP_TO_IO</span><span class="o">.</span><span class="n">astApertures</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">:=</span> <span class="n">APT_TO_IO</span><span class="p">(</span><span class="n">BP</span><span class="o">.</span><span class="n">astApertures</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
<span class="n">END_FOR</span>

<span class="n">BP_TO_IO</span><span class="o">.</span><span class="n">aVetoDevices</span> <span class="o">:=</span> <span class="n">BP</span><span class="o">.</span><span class="n">aVetoDevices</span><span class="p">;</span>
<span class="n">BP_TO_IO</span><span class="o">.</span><span class="n">nTran</span> <span class="o">:=</span> <span class="n">BP</span><span class="o">.</span><span class="n">nTran</span><span class="p">;</span>
<span class="n">BP_TO_IO</span><span class="o">.</span><span class="n">nCohortInt</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="n">BP</span><span class="o">.</span><span class="n">nCohortInt</span><span class="p">);</span>
<span class="n">BP_TO_IO</span><span class="o">.</span><span class="n">neVRange</span> <span class="o">:=</span> <span class="n">BP</span><span class="o">.</span><span class="n">neVRange</span><span class="p">;</span>
<span class="n">BP_TO_IO</span><span class="o">.</span><span class="n">neV</span> <span class="o">:=</span> <span class="n">BP</span><span class="o">.</span><span class="n">neV</span><span class="p">;</span>
<span class="n">BP_TO_IO</span><span class="o">.</span><span class="n">nBCRange</span> <span class="o">:=</span> <span class="n">BP</span><span class="o">.</span><span class="n">nBCRange</span><span class="p">;</span>
<span class="n">BP_TO_IO</span><span class="o">.</span><span class="n">nBeamClass</span> <span class="o">:=</span> <span class="n">BP</span><span class="o">.</span><span class="n">nBeamClass</span><span class="p">;</span>
<span class="n">BP_TO_IO</span><span class="o">.</span><span class="n">nMachineMode</span> <span class="o">:=</span> <span class="n">BP</span><span class="o">.</span><span class="n">nMachineMode</span><span class="p">;</span>
<span class="n">BP_TO_IO</span><span class="o">.</span><span class="n">nRate</span> <span class="o">:=</span> <span class="n">BP</span><span class="o">.</span><span class="n">nRate</span><span class="p">;</span>
<span class="n">BP_TO_IO</span><span class="o">.</span><span class="n">xValid</span> <span class="o">:=</span> <span class="n">BP</span><span class="o">.</span><span class="n">xValid</span><span class="p">;</span>
<span class="n">BP_TO_IO</span><span class="o">.</span><span class="n">xValidToggle</span> <span class="o">:=</span> <span class="n">BP</span><span class="o">.</span><span class="n">xValidToggle</span><span class="p">;</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#apt-to-io">APT_TO_IO</a></p></li>
<li><p><a class="reference internal" href="#att-to-io">ATT_TO_IO</a></p></li>
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="checkbounds">
<h2>CheckBounds<a class="headerlink" href="#checkbounds" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">DO</span> <span class="n">NOT</span> <span class="n">EDIT</span>
<span class="n">FUNCTION</span> <span class="n">CheckBounds</span> <span class="p">:</span> <span class="n">DINT</span>
<span class="n">VAR_INPUT</span>
    <span class="n">index</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">Only</span> <span class="n">an</span> <span class="n">Implementation</span> <span class="n">suggestion</span>
<span class="p">{</span><span class="n">noflow</span><span class="p">}</span>
<span class="n">IF</span>  <span class="n">index</span> <span class="o">&lt;</span> <span class="n">lower</span> <span class="n">THEN</span>
    <span class="n">CheckBounds</span> <span class="o">:=</span> <span class="n">lower</span><span class="p">;</span>
<span class="n">ELSIF</span>  <span class="n">index</span> <span class="o">&gt;</span> <span class="n">upper</span> <span class="n">THEN</span>
    <span class="n">CheckBounds</span> <span class="o">:=</span> <span class="n">upper</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">CheckBounds</span> <span class="o">:=</span> <span class="n">index</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="p">{</span><span class="n">flow</span><span class="p">}</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
<section id="checkdivdint">
<h2>CheckDivDInt<a class="headerlink" href="#checkdivdint" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">DO</span> <span class="n">NOT</span> <span class="n">EDIT</span>
<span class="n">FUNCTION</span> <span class="n">CheckDivDInt</span> <span class="p">:</span> <span class="n">DINT</span>
<span class="n">VAR_INPUT</span>
    <span class="n">divisor</span><span class="p">:</span><span class="n">DINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">Only</span> <span class="n">an</span> <span class="n">Implementation</span> <span class="n">suggestion</span>
<span class="p">{</span><span class="n">noflow</span><span class="p">}</span>
<span class="n">IF</span> <span class="n">divisor</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">CheckDivDInt</span><span class="o">:=</span><span class="mi">1</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">CheckDivDInt</span><span class="o">:=</span><span class="n">divisor</span><span class="p">;</span>
<span class="n">END_IF</span><span class="p">;</span>
<span class="p">{</span><span class="n">flow</span><span class="p">}</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
<section id="checkdivlint">
<h2>CheckDivLInt<a class="headerlink" href="#checkdivlint" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">DO</span> <span class="n">NOT</span> <span class="n">EDIT</span>
<span class="n">FUNCTION</span> <span class="n">CheckDivLInt</span> <span class="p">:</span> <span class="n">LINT</span>
<span class="n">VAR_INPUT</span>
    <span class="n">divisor</span><span class="p">:</span><span class="n">LINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">Only</span> <span class="n">an</span> <span class="n">Implementation</span> <span class="n">suggestion</span>
<span class="p">{</span><span class="n">noflow</span><span class="p">}</span>
<span class="n">IF</span> <span class="n">divisor</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">CheckDivLInt</span><span class="o">:=</span><span class="mi">1</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">CheckDivLInt</span><span class="o">:=</span><span class="n">divisor</span><span class="p">;</span>
<span class="n">END_IF</span><span class="p">;</span>
<span class="p">{</span><span class="n">flow</span><span class="p">}</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
<section id="checkdivlreal">
<h2>CheckDivLReal<a class="headerlink" href="#checkdivlreal" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">DO</span> <span class="n">NOT</span> <span class="n">EDIT</span>
<span class="n">FUNCTION</span> <span class="n">CheckDivLReal</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">divisor</span><span class="p">:</span><span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">Only</span> <span class="n">an</span> <span class="n">Implementation</span> <span class="n">suggestion</span>
<span class="p">{</span><span class="n">noflow</span><span class="p">}</span>
<span class="n">IF</span> <span class="n">divisor</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">CheckDivLReal</span><span class="o">:=</span><span class="mi">1</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">CheckDivLReal</span><span class="o">:=</span><span class="n">divisor</span><span class="p">;</span>
<span class="n">END_IF</span><span class="p">;</span>
<span class="p">{</span><span class="n">flow</span><span class="p">}</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
<section id="checkdivreal">
<h2>CheckDivReal<a class="headerlink" href="#checkdivreal" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">DO</span> <span class="n">NOT</span> <span class="n">EDIT</span>
<span class="n">FUNCTION</span> <span class="n">CheckDivReal</span> <span class="p">:</span> <span class="n">REAL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">divisor</span><span class="p">:</span><span class="n">REAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">Only</span> <span class="n">an</span> <span class="n">Implementation</span> <span class="n">suggestion</span>
<span class="p">{</span><span class="n">noflow</span><span class="p">}</span>
<span class="n">IF</span> <span class="n">divisor</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">CheckDivReal</span><span class="o">:=</span><span class="mi">1</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">CheckDivReal</span><span class="o">:=</span><span class="n">divisor</span><span class="p">;</span>
<span class="n">END_IF</span><span class="p">;</span>
<span class="p">{</span><span class="n">flow</span><span class="p">}</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
<section id="checklrangesigned">
<h2>CheckLRangeSigned<a class="headerlink" href="#checklrangesigned" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">DO</span> <span class="n">NOT</span> <span class="n">EDIT</span>
<span class="n">FUNCTION</span> <span class="n">CheckLRangeSigned</span> <span class="p">:</span> <span class="n">LINT</span>
<span class="n">VAR_INPUT</span>
    <span class="n">value</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">:</span> <span class="n">LINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">Only</span> <span class="n">an</span> <span class="n">Implementation</span> <span class="n">suggestion</span>
<span class="p">{</span><span class="n">noflow</span><span class="p">}</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">lower</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">CheckLRangeSigned</span> <span class="o">:=</span> <span class="n">lower</span><span class="p">;</span>
<span class="n">ELSIF</span><span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">upper</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">CheckLRangeSigned</span> <span class="o">:=</span> <span class="n">upper</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">CheckLRangeSigned</span> <span class="o">:=</span> <span class="n">value</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">{</span><span class="n">flow</span><span class="p">}</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
<section id="checklrangeunsigned">
<h2>CheckLRangeUnsigned<a class="headerlink" href="#checklrangeunsigned" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">DO</span> <span class="n">NOT</span> <span class="n">EDIT</span>
<span class="n">FUNCTION</span> <span class="n">CheckLRangeUnsigned</span> <span class="p">:</span> <span class="n">ULINT</span>
<span class="n">VAR_INPUT</span>
    <span class="n">value</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">:</span> <span class="n">ULINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">Only</span> <span class="n">an</span> <span class="n">Implementation</span> <span class="n">suggestion</span>
<span class="p">{</span><span class="n">noflow</span><span class="p">}</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">lower</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">CheckLRangeUnsigned</span> <span class="o">:=</span> <span class="n">lower</span><span class="p">;</span>
<span class="n">ELSIF</span><span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">upper</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">CheckLRangeUnsigned</span> <span class="o">:=</span> <span class="n">upper</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">CheckLRangeUnsigned</span> <span class="o">:=</span> <span class="n">value</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="p">{</span><span class="n">flow</span><span class="p">}</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
<section id="checkpointer">
<h2>CheckPointer<a class="headerlink" href="#checkpointer" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">DO</span> <span class="n">NOT</span> <span class="n">EDIT</span>
<span class="n">FUNCTION</span> <span class="n">CheckPointer</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">BYTE</span>
<span class="n">VAR_INPUT</span>
    <span class="n">ptToTest</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">BYTE</span><span class="p">;</span> <span class="o">//</span> <span class="n">Destination</span> <span class="n">address</span> <span class="n">of</span> <span class="n">the</span> <span class="n">pointer</span>
    <span class="n">iSize</span> <span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>                   <span class="o">//</span> <span class="n">Size</span> <span class="n">of</span> <span class="n">the</span> <span class="nb">type</span> <span class="n">the</span> <span class="n">pointer</span> <span class="n">points</span> <span class="n">to</span><span class="o">.</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="p">:</span> <span class="mi">20</span> <span class="k">for</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">0..9</span><span class="p">]</span> <span class="n">OF</span> <span class="n">INT</span><span class="p">)</span>
    <span class="n">iGran</span> <span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>                   <span class="o">//</span> <span class="n">Granularity</span> <span class="n">of</span> <span class="n">the</span> <span class="n">pointer</span> <span class="n">access</span><span class="o">.</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">size</span> <span class="n">of</span> <span class="n">the</span> <span class="n">biggest</span> <span class="n">non</span><span class="o">-</span><span class="n">structured</span> <span class="n">data</span> <span class="nb">type</span> <span class="ow">in</span> <span class="n">the</span> <span class="nb">type</span> <span class="n">the</span> <span class="n">pointer</span> <span class="n">points</span> <span class="n">to</span><span class="o">.</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="p">:</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">0..9</span><span class="p">]</span> <span class="n">OF</span> <span class="n">INT</span><span class="p">)</span>
    <span class="n">bWrite</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                   <span class="o">//</span> <span class="n">Indicates</span> <span class="n">read</span> <span class="ow">or</span> <span class="n">write</span> <span class="n">Access</span><span class="o">.</span> <span class="n">TRUE</span> <span class="o">=</span> <span class="n">write</span> <span class="n">access</span><span class="o">.</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">No</span> <span class="n">standard</span> <span class="n">way</span> <span class="n">of</span> <span class="n">implementation</span><span class="o">.</span> <span class="n">Fill</span> <span class="n">your</span> <span class="n">own</span> <span class="n">code</span> <span class="n">here</span>
<span class="n">CheckPointer</span> <span class="o">:=</span> <span class="n">ptToTest</span><span class="p">;</span>
<span class="p">{</span><span class="n">flow</span><span class="p">}</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
<section id="checkrangesigned">
<h2>CheckRangeSigned<a class="headerlink" href="#checkrangesigned" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">DO</span> <span class="n">NOT</span> <span class="n">EDIT</span>
<span class="n">FUNCTION</span> <span class="n">CheckRangeSigned</span> <span class="p">:</span> <span class="n">DINT</span>
<span class="n">VAR_INPUT</span>
    <span class="n">value</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">Only</span> <span class="n">an</span> <span class="n">Implementation</span> <span class="n">suggestion</span>
<span class="p">{</span><span class="n">noflow</span><span class="p">}</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">lower</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">CheckRangeSigned</span> <span class="o">:=</span> <span class="n">lower</span><span class="p">;</span>
<span class="n">ELSIF</span><span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">upper</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">CheckRangeSigned</span> <span class="o">:=</span> <span class="n">upper</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">CheckRangeSigned</span> <span class="o">:=</span> <span class="n">value</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="p">{</span><span class="n">flow</span><span class="p">}</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
<section id="checkrangeunsigned">
<h2>CheckRangeUnsigned<a class="headerlink" href="#checkrangeunsigned" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">DO</span> <span class="n">NOT</span> <span class="n">EDIT</span>
<span class="n">FUNCTION</span> <span class="n">CheckRangeUnsigned</span> <span class="p">:</span> <span class="n">UDINT</span>
<span class="n">VAR_INPUT</span>
    <span class="n">value</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">Only</span> <span class="n">an</span> <span class="n">Implementation</span> <span class="n">suggestion</span>
<span class="p">{</span><span class="n">noflow</span><span class="p">}</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">lower</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">CheckRangeUnsigned</span> <span class="o">:=</span> <span class="n">lower</span><span class="p">;</span>
<span class="n">ELSIF</span><span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">upper</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">CheckRangeUnsigned</span> <span class="o">:=</span> <span class="n">upper</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">CheckRangeUnsigned</span> <span class="o">:=</span> <span class="n">value</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="p">{</span><span class="n">flow</span><span class="p">}</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
<section id="f-attenuatorok">
<h2>F_AttenuatorOK<a class="headerlink" href="#f-attenuatorok" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span>
<span class="n">Indicates</span> <span class="k">if</span> <span class="n">the</span> <span class="n">attenuator</span> <span class="n">can</span> <span class="n">be</span> <span class="n">considered</span> <span class="n">safe</span> <span class="k">for</span> <span class="n">a</span> <span class="n">device</span><span class="p">,</span>
<span class="n">given</span> <span class="n">its</span> <span class="n">status</span> <span class="n">word</span><span class="o">.</span>

<span class="n">In</span> <span class="n">local</span> <span class="n">mode</span><span class="p">,</span> <span class="n">the</span> <span class="n">atteunator</span> <span class="n">ignores</span> <span class="n">PMPS</span> <span class="n">requests</span><span class="p">,</span> <span class="n">following</span> <span class="n">a</span> <span class="n">local</span>
<span class="n">setpoint</span><span class="o">.</span> <span class="n">In</span> <span class="n">this</span> <span class="n">mode</span><span class="p">,</span> <span class="n">a</span> <span class="n">device</span> <span class="n">cannot</span> <span class="n">trust</span> <span class="n">that</span> <span class="n">the</span> <span class="n">attenuator</span> <span class="n">will</span> <span class="ow">not</span>
<span class="n">increase</span> <span class="n">transmission</span> <span class="n">beyond</span> <span class="n">its</span> <span class="n">own</span> <span class="n">setpoint</span><span class="o">.</span> <span class="n">Therefore</span> <span class="nb">any</span>
<span class="n">indication</span> <span class="n">of</span> <span class="n">a</span> <span class="n">changing</span> <span class="n">transmission</span> <span class="n">should</span> <span class="n">cause</span> <span class="n">a</span> <span class="n">fault</span><span class="o">.</span>

<span class="n">In</span> <span class="n">PMPS</span> <span class="n">mode</span><span class="p">,</span> <span class="k">if</span> <span class="n">a</span> <span class="n">device</span> <span class="n">has</span> <span class="n">submitted</span> <span class="n">a</span> <span class="n">preemptive</span> <span class="n">request</span> <span class="ow">and</span> <span class="n">received</span>
<span class="n">acknowledgement</span><span class="p">,</span> <span class="n">then</span> <span class="n">the</span> <span class="n">transmission</span> <span class="n">setpoint</span> <span class="n">will</span> <span class="n">be</span> <span class="n">governed</span> <span class="n">at</span> <span class="n">least</span>
<span class="n">by</span> <span class="n">that</span> <span class="n">device</span><span class="s1">&#39;s setpoint. Therefore, the attenuator may be moving without</span>
<span class="n">generating</span> <span class="n">a</span> <span class="n">fault</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION</span> <span class="n">F_AttenuatorOK</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">xStatus</span> <span class="p">:</span> <span class="n">WORD</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">xStatus</span><span class="mf">.2</span> <span class="n">THEN</span> <span class="o">//</span> <span class="n">Local</span> <span class="n">mode</span>
    <span class="n">F_AttenuatorOK</span> <span class="o">:=</span> <span class="n">xStatus</span><span class="mf">.0</span> <span class="ow">and</span> <span class="n">NOT</span> <span class="n">xStatus</span><span class="mf">.1</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">xStatus</span><span class="mf">.3</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">xStatus</span><span class="mf">.2</span> <span class="n">THEN</span> <span class="o">//</span> <span class="n">PMPS</span> <span class="n">mode</span>
    <span class="n">F_AttenuatorOK</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">F_AttenuatorOK</span> <span class="o">:=</span> <span class="n">xStatus</span><span class="mf">.4</span> <span class="n">AND</span> <span class="n">F_AttenuatorOK</span><span class="p">;</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
<section id="f-bpwithid">
<h2>F_BPWithID<a class="headerlink" href="#f-bpwithid" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">F_BPWithID</span> <span class="p">:</span> <span class="n">ST_BP_ArbInternal</span>
<span class="n">VAR_INPUT</span>
    <span class="n">BP</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">ST_BeamParams</span><span class="p">;</span>
    <span class="n">ID</span> <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">BpInt</span> <span class="p">:</span> <span class="n">ST_BP_ArbInternal</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">MEMCPY</span><span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">F_BPWithID</span><span class="p">),</span> <span class="n">ADR</span><span class="p">(</span><span class="n">BP</span><span class="p">),</span> <span class="n">SIZEOF</span><span class="p">(</span><span class="n">BP</span><span class="p">));</span>
<span class="n">F_BPWithID</span><span class="o">.</span><span class="n">nId</span> <span class="o">:=</span> <span class="n">ID</span><span class="p">;</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-bp-arbinternal">ST_BP_ArbInternal</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="f-calculatephotonenergy">
<h2>F_CalculatePhotonEnergy<a class="headerlink" href="#f-calculatephotonenergy" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">F_CalculatePhotonEnergy</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR_INPUT</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Electron</span> <span class="n">energy</span> <span class="ow">in</span> <span class="n">GeV</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">fElectronEnergy_GeV</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Undulator</span> <span class="n">period</span> <span class="ow">in</span> <span class="n">mm</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">fUndulatorPeriod_mm</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Unitless</span> <span class="n">undulator</span> <span class="n">K</span> <span class="n">parameter</span> <span class="o">/</span> <span class="n">strength</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">fUndulatorStrength</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">fDenominator</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">GeV</span> <span class="p">[</span><span class="n">electron</span> <span class="n">rest</span> <span class="n">mass</span><span class="o">/</span><span class="n">energy</span><span class="p">]</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">m_e</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">0.0005109989461</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Js</span> <span class="p">[</span><span class="n">Planck</span><span class="s1">&#39;s constant] *)</span>
    <span class="n">h</span>       <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">6.62607004E-34</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">C</span> <span class="p">[</span><span class="n">electron</span> <span class="n">charge</span><span class="p">]</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">e</span>       <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">1.6021766208E-19</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">m</span><span class="o">/</span><span class="n">s</span><span class="p">,</span> <span class="n">speed</span> <span class="n">of</span> <span class="n">light</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">c</span>       <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">299792458</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>

<span class="n">Reference</span> <span class="n">Python</span> <span class="n">implementation</span>

<span class="k">def</span><span class="w"> </span><span class="nf">calculate_photon_energy</span><span class="p">(</span><span class="n">electron_energy</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculate photon energy, in eV.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    electron_energy : float</span>
<span class="sd">        Electron energy in GeV</span>

<span class="sd">    period : float</span>
<span class="sd">        Undulator period, in mm</span>

<span class="sd">    k : float</span>
<span class="sd">        Undulator K parameter (strength), unitless</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">m_e</span> <span class="o">=</span> <span class="mf">0.0005109989461</span>  <span class="c1"># GeV [electron rest mass/energy]</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mf">6.62607004e-34</span>  <span class="c1"># Js [Planck&#39;s constant]</span>
    <span class="n">e</span> <span class="o">=</span> <span class="mf">1.6021766208e-19</span>  <span class="c1"># C [electron charge]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">299792458</span>  <span class="c1"># m/s, speed of light</span>
    <span class="k">return</span> <span class="p">((</span><span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="n">electron_energy</span> <span class="o">/</span> <span class="n">m_e</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">h</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span> <span class="o">/</span>
            <span class="p">(</span><span class="n">e</span> <span class="o">*</span> <span class="n">period</span> <span class="o">*</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">k</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)))</span>

<span class="o">*</span><span class="p">)</span>
<span class="n">fDenominator</span> <span class="o">:=</span> <span class="p">(</span><span class="n">e</span> <span class="o">*</span> <span class="n">fUndulatorPeriod_mm</span> <span class="o">*</span> <span class="mf">1E-3</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">EXPT</span><span class="p">(</span><span class="n">fUndulatorStrength</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">));</span>
<span class="n">F_CalculatePhotonEnergy</span> <span class="o">:=</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">EXPT</span><span class="p">(</span><span class="n">fElectronEnergy_GeV</span> <span class="o">/</span> <span class="n">m_e</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">h</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span> <span class="o">/</span> <span class="n">MAX</span><span class="p">(</span><span class="n">fDenominator</span><span class="p">,</span> <span class="mf">4.94065645841247E-324</span><span class="p">);</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
<section id="f-devicestate-to-devicestateext">
<h2>F_DeviceState_To_DeviceStateExt<a class="headerlink" href="#f-devicestate-to-devicestateext" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">F_DeviceState_To_DeviceStateExt</span> <span class="p">:</span> <span class="n">ST_DeviceStateExt</span>
<span class="n">VAR_INPUT</span>
    <span class="n">stDeviceState</span>    <span class="p">:</span>    <span class="n">ST_DeviceState</span><span class="p">;</span>
    <span class="n">xValid</span>    <span class="p">:</span>    <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">F_DeviceState_To_DeviceStateExt</span><span class="o">.</span><span class="n">nStateRef</span> <span class="o">:=</span> <span class="n">stDeviceState</span><span class="o">.</span><span class="n">nStateRef</span><span class="p">;</span>
<span class="n">F_DeviceState_To_DeviceStateExt</span><span class="o">.</span><span class="n">rPosition</span>    <span class="o">:=</span>    <span class="n">stDeviceState</span><span class="o">.</span><span class="n">rPosition</span><span class="p">;</span>
<span class="n">F_DeviceState_To_DeviceStateExt</span><span class="o">.</span><span class="n">rTolerance</span>    <span class="o">:=</span>    <span class="n">stDeviceState</span><span class="o">.</span><span class="n">rTolerance</span><span class="p">;</span>
<span class="n">F_DeviceState_To_DeviceStateExt</span><span class="o">.</span><span class="n">sStateName</span>    <span class="o">:=</span> <span class="n">stDeviceState</span><span class="o">.</span><span class="n">sStateName</span><span class="p">;</span>
<span class="n">F_DeviceState_To_DeviceStateExt</span><span class="o">.</span><span class="n">stReqBeamParam</span>    <span class="o">:=</span> <span class="n">stDeviceState</span><span class="o">.</span><span class="n">stReqBeamParam</span><span class="p">;</span>
<span class="n">F_DeviceState_To_DeviceStateExt</span><span class="o">.</span><span class="n">xValid</span> <span class="o">:=</span> <span class="n">xValid</span><span class="p">;</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-devicestate">ST_DeviceState</a></p></li>
<li><p><a class="reference internal" href="#st-devicestateext">ST_DeviceStateExt</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="f-differentbeamparams">
<h2>F_DifferentBeamParams<a class="headerlink" href="#f-differentbeamparams" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(*Compares BeamParam1 to BeamParam2, if any parameters of BeamParam1 are different than BeamParam2
the result will be true. *)
{attribute &#39;no_check&#39;}
FUNCTION F_DifferentBeamParams : BOOL
VAR_INPUT
    BeamParam1    :    ST_BeamParams;
    BeamParam2    :    ST_BeamParams;
END_VAR
VAR
    xAttOK: BOOL := FALSE;
    xPPmjOK: BOOL := FALSE;
    xEvOK: BOOL := FALSE;
    xRateOK: BOOL := FALSE;
    xaStopper : BOOL := FALSE;
    xaAtt : BOOL := FALSE;
    xaApt : BOOL := FALSE;
    xBCOK : BOOL := FALSE;

    idx : UINT;


END_VAR
xAttOK := BeamParam1.nTran &lt;&gt; BeamParam2.nTran;
xEvOK := BeamParam1.neVRange &lt;&gt; BeamParam2.neVRange;
xRateOK     := BeamParam1.nRate &lt;&gt; BeamParam2.nRate;
xBCOK       := BeamParam1.nBCRange &lt;&gt; BeamParam2.nBCRange;// OR BeamParam1.nBeamClass &lt;&gt; BeamParam2.nBeamClass ; //Is this right?


//ast Attenuators
FOR idx:=1 TO PMPS_GVL.AUX_ATTENUATORS DO
    xaAtt S= (BeamParam1.astAttenuators[idx].nTran &lt;&gt; BeamParam2.astAttenuators[idx].nTran);
END_FOR

// Stoppers
FOR idx:=1 TO PMPS_GVL.MAX_VETO_DEVICES DO
    xaStopper S= (BeamParam1.aVetoDevices[idx] &lt;&gt; BeamParam2.aVetoDevices[idx]);
END_FOR

// ast Apertures
FOR idx:=1 TO PMPS_GVL.MAX_APERTURES DO
    xaApt S= (BeamParam1.astApertures[idx].Height &lt;&gt; BeamParam2.astApertures[idx].Height) OR
            (BeamParam1.astApertures[idx].Width &lt;&gt; BeamParam2.astApertures[idx].Width);
END_FOR


F_DifferentBeamParams := xAttOK OR xPPmjOK OR xEvOK OR xRateOK OR xaStopper OR xaAtt OR xaApt OR xBCOK;

END_FUNCTION
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="f-evexcluderange">
<h2>F_eVExcludeRange<a class="headerlink" href="#f-evexcluderange" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">F_eVExcludeRange</span> <span class="p">:</span> <span class="n">DWORD</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Given</span> <span class="n">an</span> <span class="n">lower</span> <span class="ow">and</span> <span class="n">upper</span> <span class="n">end</span> <span class="n">of</span> <span class="n">an</span> <span class="n">exclusion</span> <span class="nb">range</span><span class="p">,</span> <span class="k">return</span> <span class="n">the</span> <span class="n">corresponding</span> <span class="n">eV</span> <span class="n">bitmask</span><span class="o">.</span>

    <span class="n">eVs</span> <span class="n">between</span> <span class="n">fLower</span> <span class="ow">and</span> <span class="n">fUpper</span> <span class="n">will</span> <span class="n">be</span> <span class="n">considered</span> <span class="n">unsafe</span><span class="p">,</span> <span class="ow">and</span> <span class="n">eVs</span> <span class="n">outside</span> <span class="n">of</span> <span class="n">this</span> <span class="nb">range</span> <span class="n">will</span> <span class="n">be</span>
    <span class="n">considered</span> <span class="n">safe</span><span class="p">,</span> <span class="k">with</span> <span class="n">the</span> <span class="n">exception</span> <span class="n">of</span> <span class="n">the</span> <span class="n">endpoints</span> <span class="ow">and</span> <span class="n">values</span> <span class="n">near</span> <span class="n">the</span> <span class="n">endpoints</span> <span class="k">if</span> <span class="n">they</span> <span class="n">land</span>
    <span class="n">far</span> <span class="kn">from</span><span class="w"> </span><span class="nn">an</span> <span class="n">eV</span> <span class="n">boundary</span><span class="o">.</span>

    <span class="n">Call</span> <span class="n">this</span> <span class="ow">in</span> <span class="n">your</span> <span class="n">init</span> <span class="n">cycle</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">up</span> <span class="n">your</span> <span class="n">eV</span> <span class="n">bitmasks</span> <span class="k">for</span> <span class="n">more</span> <span class="n">readable</span> <span class="n">code</span>
    <span class="n">that</span> <span class="ow">is</span> <span class="n">also</span> <span class="n">more</span> <span class="n">resiliant</span> <span class="n">to</span> <span class="n">eV</span> <span class="nb">range</span> <span class="n">definition</span> <span class="n">adjustments</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="n">fLower</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="n">fUpper</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">F_eVExcludeRange</span> <span class="o">:=</span> <span class="n">F_eVIncludeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fLower</span><span class="p">)</span> <span class="n">OR</span> <span class="n">F_eVIncludeRange</span><span class="p">(</span><span class="n">fUpper</span><span class="p">,</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_areVBoundaries</span><span class="p">[</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_cBoundaries</span><span class="p">]);</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#f-evincluderange">F_eVIncludeRange</a></p></li>
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="f-evincluderange">
<h2>F_eVIncludeRange<a class="headerlink" href="#f-evincluderange" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">F_eVIncludeRange</span> <span class="p">:</span> <span class="n">DWORD</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Given</span> <span class="n">an</span> <span class="n">lower</span> <span class="ow">and</span> <span class="n">upper</span> <span class="n">end</span> <span class="n">of</span> <span class="n">an</span> <span class="n">inclusion</span> <span class="nb">range</span><span class="p">,</span> <span class="k">return</span> <span class="n">the</span> <span class="n">corresponding</span> <span class="n">eV</span> <span class="n">bitmask</span><span class="o">.</span>

    <span class="n">eVs</span> <span class="n">between</span> <span class="n">fLower</span> <span class="ow">and</span> <span class="n">fUpper</span> <span class="n">will</span> <span class="n">be</span> <span class="n">considered</span> <span class="n">safe</span><span class="p">,</span> <span class="k">with</span> <span class="n">the</span> <span class="n">exception</span> <span class="n">of</span> <span class="n">the</span> <span class="n">endpoints</span> <span class="ow">and</span> <span class="n">values</span>
    <span class="n">near</span> <span class="n">the</span> <span class="n">endpoints</span> <span class="k">if</span> <span class="n">they</span> <span class="n">land</span> <span class="n">far</span> <span class="kn">from</span><span class="w"> </span><span class="nn">an</span> <span class="n">eV</span> <span class="n">boundary</span><span class="o">.</span>

    <span class="n">Call</span> <span class="n">this</span> <span class="ow">in</span> <span class="n">your</span> <span class="n">init</span> <span class="n">cycle</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">up</span> <span class="n">your</span> <span class="n">eV</span> <span class="n">bitmasks</span> <span class="k">for</span> <span class="n">more</span> <span class="n">readable</span> <span class="n">code</span>
    <span class="n">that</span> <span class="ow">is</span> <span class="n">also</span> <span class="n">more</span> <span class="n">resiliant</span> <span class="n">to</span> <span class="n">eV</span> <span class="nb">range</span> <span class="n">definition</span> <span class="n">adjustments</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="n">fLower</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="n">fUpper</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nBitmask</span><span class="p">:</span> <span class="n">DWORD</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">nIndex</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">nBit</span><span class="p">:</span> <span class="n">USINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">fPrev</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">FOR</span> <span class="n">nIndex</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_cBoundaries</span> <span class="n">DO</span>
    <span class="n">IF</span> <span class="n">fLower</span> <span class="o">&lt;=</span> <span class="n">fPrev</span> <span class="n">AND</span> <span class="n">fUpper</span> <span class="o">&gt;=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_areVBoundaries</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span> <span class="n">THEN</span>
        <span class="n">nBitmask</span> <span class="o">:=</span> <span class="n">nBitmask</span> <span class="o">+</span> <span class="n">SHL</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nBit</span><span class="p">);</span>
    <span class="n">END_IF</span>
    <span class="n">fPrev</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_areVBoundaries</span><span class="p">[</span><span class="n">nIndex</span><span class="p">];</span>
    <span class="n">nBit</span> <span class="o">:=</span> <span class="n">nBit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">END_FOR</span>

<span class="n">F_eVIncludeRange</span> <span class="o">:=</span> <span class="n">nBitmask</span><span class="p">;</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="f-evrangecalculator">
<h2>F_eVRangeCalculator<a class="headerlink" href="#f-evrangecalculator" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span>
<span class="n">A</span><span class="o">.</span> <span class="n">Wallace</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">8</span><span class="o">-</span><span class="mi">8</span>

<span class="n">Provides</span> <span class="n">bit</span> <span class="nb">range</span> <span class="n">of</span> <span class="n">eV</span><span class="o">.</span>

<span class="n">LastWord</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">(</span><span class="n">Result</span><span class="p">)</span>
<span class="o">----------------------------------</span>
<span class="n">reV</span> <span class="o">=</span> <span class="mi">300</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0000_0000_0000_0010</span><span class="p">)</span>
<span class="n">reV</span> <span class="o">=</span> <span class="mi">301</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0000_0000_0000_0100</span><span class="p">)</span>

<span class="n">LastWord</span> <span class="o">=</span> <span class="mi">0000_0000_0000_0010</span> <span class="p">(</span><span class="n">Result</span><span class="p">)</span>
<span class="o">----------------------------------</span>
<span class="n">reV</span> <span class="o">=</span> <span class="mi">300</span> <span class="o">+</span> <span class="o">&lt;</span><span class="n">rHyst</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0000_0000_0000_0110</span><span class="p">)</span>
<span class="n">reV</span> <span class="o">=</span> <span class="mi">300</span> <span class="o">+</span> <span class="o">&gt;</span><span class="n">rHyst</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0000_0000_0000_0100</span><span class="p">)</span>

<span class="o">*</span><span class="p">)</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_check&#39;</span><span class="p">}</span>
<span class="n">FUNCTION</span> <span class="n">F_eVRangeCalculator</span> <span class="p">:</span> <span class="n">DWORD</span> <span class="o">//</span> <span class="n">Bit</span><span class="o">-</span><span class="nb">range</span> <span class="n">of</span> <span class="n">current</span> <span class="n">photon</span> <span class="n">energy</span>
<span class="n">VAR_INPUT</span>
    <span class="n">reV</span>    <span class="p">:</span>    <span class="n">REAL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Photon</span> <span class="n">energy</span> <span class="p">(</span><span class="n">keV</span><span class="p">)</span>
    <span class="n">LastWord</span>    <span class="p">:</span>    <span class="n">DWORD</span><span class="p">;</span> <span class="o">//</span> <span class="n">Range</span> <span class="n">word</span> <span class="n">of</span> <span class="n">previous</span> <span class="n">cycle</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nIndex</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">RangeWord</span><span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
    <span class="n">rPreviousBoundary</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">MaxEv</span>    <span class="p">:</span>    <span class="n">REAL</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_areVBoundaries</span><span class="p">[</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_cBoundaries</span><span class="p">];</span>

    <span class="n">Boundaries</span> <span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_cBoundaries</span><span class="p">]</span> <span class="n">OF</span> <span class="n">REAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">{</span><span class="n">IF</span> <span class="n">defined</span> <span class="p">(</span><span class="n">L</span><span class="p">)}</span>
    <span class="n">Boundaries</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_areVBoundariesL</span><span class="p">;</span>
<span class="p">{</span><span class="n">ELSIF</span> <span class="n">defined</span> <span class="p">(</span><span class="n">K</span><span class="p">)}</span>
    <span class="n">Boundaries</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_areVBoundariesK</span><span class="p">;</span>
<span class="p">{</span><span class="n">END_IF</span><span class="p">}</span>

<span class="n">MaxEv</span> <span class="o">:=</span> <span class="n">Boundaries</span><span class="p">[</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_cBoundaries</span><span class="p">];</span>

<span class="n">IF</span> <span class="n">reV</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="n">OR</span> <span class="n">reV</span> <span class="o">&gt;</span> <span class="n">MaxEv</span> <span class="n">THEN</span> <span class="n">F_eVRangeCalculator</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#FFFF_FFFF; RETURN; END_IF // Failsafe</span>

<span class="n">FOR</span> <span class="n">nIndex</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_cBoundaries</span> <span class="n">DO</span>

    <span class="o">//</span> <span class="n">If</span> <span class="n">previously</span> <span class="n">active</span> <span class="n">then</span> <span class="n">check</span> <span class="k">if</span> <span class="n">it</span> <span class="n">should</span> <span class="n">be</span> <span class="n">cleared</span>
    <span class="n">IF</span> <span class="n">LastWord</span><span class="mf">.0</span> <span class="n">THEN</span>
        <span class="o">//</span> <span class="n">Hysteresis</span> <span class="n">condition</span>
        <span class="n">IF</span> <span class="p">(</span><span class="n">reV</span> <span class="o">&gt;</span> <span class="n">MIN</span><span class="p">(</span><span class="n">Boundaries</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span> <span class="o">+</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">reVHyst</span><span class="p">,</span> <span class="n">MaxEv</span><span class="p">)</span> <span class="p">)</span> <span class="n">OR</span>
        <span class="p">(</span><span class="n">reV</span> <span class="o">&lt;</span> <span class="n">MAX</span><span class="p">(</span><span class="n">rPreviousBoundary</span> <span class="o">-</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">reVHyst</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span> <span class="n">THEN</span>
            <span class="n">RangeWord</span><span class="mf">.0</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">//</span> <span class="n">If</span> <span class="n">out</span> <span class="n">of</span> <span class="nb">range</span> <span class="n">of</span> <span class="n">hys</span><span class="o">.</span> <span class="n">mark</span> <span class="n">inactive</span>
        <span class="n">ELSE</span>
            <span class="n">RangeWord</span><span class="mf">.0</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">ELSE</span> <span class="o">//</span> <span class="n">Check</span> <span class="k">if</span> <span class="n">we</span> <span class="n">should</span> <span class="n">mark</span> <span class="k">as</span> <span class="n">active</span>
        <span class="n">IF</span> <span class="p">(</span><span class="n">reV</span> <span class="o">&lt;=</span> <span class="n">Boundaries</span><span class="p">[</span><span class="n">nIndex</span><span class="p">])</span> <span class="n">AND</span>
        <span class="p">(</span><span class="n">reV</span> <span class="o">&gt;</span> <span class="n">rPreviousBoundary</span><span class="p">)</span> <span class="n">OR</span>
         <span class="p">(</span><span class="n">nIndex</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">AND</span> <span class="n">reV</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">)</span> <span class="n">THEN</span>
            <span class="n">RangeWord</span><span class="mf">.0</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>

    <span class="o">//</span> <span class="n">Catch</span> <span class="k">if</span> <span class="n">the</span> <span class="n">hysteresis</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">too</span> <span class="n">large</span> <span class="k">for</span> <span class="n">the</span> <span class="nb">range</span>
    <span class="n">IF</span> <span class="n">rPreviousBoundary</span> <span class="o">+</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">reVHyst</span> <span class="o">&gt;=</span> <span class="n">Boundaries</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span> <span class="n">THEN</span>
        <span class="n">RangeWord</span><span class="mf">.0</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="o">//</span> <span class="n">Setting</span> <span class="n">the</span> <span class="n">bit</span> <span class="n">true</span> <span class="n">here</span> <span class="k">as</span> <span class="n">a</span> <span class="n">failsafe</span>
        <span class="o">//&lt;</span><span class="n">TODO</span><span class="o">&gt;</span> <span class="n">Add</span> <span class="n">major</span> <span class="n">error</span> <span class="ow">or</span> <span class="n">warning</span> <span class="n">here</span>
    <span class="n">END_IF</span>

    <span class="n">rPreviousBoundary</span> <span class="o">:=</span> <span class="n">Boundaries</span><span class="p">[</span><span class="n">nIndex</span><span class="p">];</span>
    <span class="o">//</span> <span class="n">Shift</span> <span class="n">to</span> <span class="nb">next</span> <span class="n">bit</span>
    <span class="n">RangeWord</span> <span class="o">:=</span> <span class="n">ROR</span><span class="p">(</span><span class="n">RangeWord</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">LastWord</span> <span class="o">:=</span> <span class="n">SHR</span><span class="p">(</span><span class="n">LastWord</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="n">END_FOR</span>

<span class="n">F_eVRangeCalculator</span> <span class="o">:=</span> <span class="n">RangeWord</span><span class="p">;</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="f-evwithinspec">
<h2>F_eVWithinSpec<a class="headerlink" href="#f-evwithinspec" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">reV</span> <span class="n">must</span> <span class="n">be</span> <span class="n">within</span> <span class="n">permitted</span> <span class="nb">range</span><span class="o">.</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_check&#39;</span><span class="p">}</span>
<span class="n">FUNCTION</span> <span class="n">F_eVWithinSpec</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">reV</span>    <span class="p">:</span>    <span class="n">REAL</span><span class="p">;</span>    <span class="o">//</span><span class="n">Photon</span> <span class="n">energy</span> <span class="n">to</span> <span class="n">check</span> <span class="k">if</span> <span class="n">within</span> <span class="n">permitted</span> <span class="nb">range</span>
    <span class="n">nPermittedRange</span>    <span class="p">:</span>    <span class="n">DWORD</span><span class="p">;</span> <span class="o">//</span><span class="n">Permitted</span> <span class="nb">range</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span><span class="n">Holding</span> <span class="n">register</span> <span class="k">for</span> <span class="n">permitted</span> <span class="n">ranges</span>
    <span class="n">nPermittedRangeHolding</span>    <span class="p">:</span>    <span class="n">DWORD</span><span class="p">;</span>
    <span class="o">//</span><span class="n">For</span> <span class="n">loop</span> <span class="n">counter</span>
    <span class="n">nIndex</span>    <span class="p">:</span>    <span class="n">INT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Lower</span> <span class="n">boundary</span> <span class="k">for</span> <span class="nb">range</span> <span class="n">check</span>
    <span class="n">rPreviousBoundary</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">Boundaries</span><span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_cBoundaries</span><span class="p">]</span> <span class="n">OF</span> <span class="n">REAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">How</span> <span class="n">this</span> <span class="n">works</span><span class="p">:</span>
<span class="n">The</span> <span class="n">within</span> <span class="nb">range</span> <span class="nb">bool</span> <span class="ow">is</span> <span class="n">initialized</span> <span class="n">to</span> <span class="n">false</span><span class="o">.</span>
<span class="n">Load</span> <span class="n">the</span> <span class="n">word</span> <span class="n">representation</span> <span class="n">of</span> <span class="n">ranges</span> <span class="n">into</span> <span class="n">a</span> <span class="n">holding</span> <span class="n">register</span><span class="o">.</span>
<span class="n">If</span> <span class="n">the</span> <span class="n">bit</span> <span class="n">at</span> <span class="n">position</span> <span class="n">zero</span> <span class="n">of</span> <span class="n">the</span> <span class="n">holding</span> <span class="n">register</span> <span class="ow">is</span> <span class="n">true</span><span class="p">,</span> <span class="ow">and</span> <span class="n">the</span> <span class="nb">input</span> <span class="n">eV</span> <span class="ow">is</span>
<span class="n">below</span> <span class="n">the</span> <span class="n">boundary</span> <span class="n">at</span> <span class="n">the</span> <span class="n">index</span> <span class="n">position</span> <span class="n">of</span> <span class="n">the</span> <span class="n">boundary</span> <span class="n">array</span><span class="p">,</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">previous</span> <span class="n">boundary</span>
<span class="p">(</span><span class="n">which</span> <span class="n">initializes</span> <span class="n">at</span> <span class="mi">0</span><span class="p">),</span> <span class="n">then</span> <span class="n">the</span> <span class="n">within</span> <span class="nb">range</span> <span class="nb">bool</span> <span class="ow">is</span> <span class="nb">set</span><span class="o">.</span>
<span class="n">Then</span><span class="p">,</span> <span class="n">we</span> <span class="n">stash</span> <span class="n">the</span> <span class="n">upper</span> <span class="n">boundary</span> <span class="k">as</span> <span class="n">the</span> <span class="n">lower</span> <span class="n">boundary</span> <span class="k">for</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">comparison</span><span class="p">,</span>
<span class="ow">and</span> <span class="n">shift</span> <span class="n">the</span> <span class="n">holding</span> <span class="n">register</span> <span class="n">right</span><span class="p">,</span> <span class="n">which</span> <span class="n">moves</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">bit</span> <span class="n">to</span> <span class="n">the</span> <span class="n">zero</span> <span class="n">position</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>

<span class="p">{</span><span class="n">IF</span> <span class="n">defined</span> <span class="p">(</span><span class="n">L</span><span class="p">)}</span>
    <span class="n">Boundaries</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_areVBoundariesL</span><span class="p">;</span>
<span class="p">{</span><span class="n">ELSIF</span> <span class="n">defined</span> <span class="p">(</span><span class="n">K</span><span class="p">)}</span>
    <span class="n">Boundaries</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_areVBoundariesK</span><span class="p">;</span>
<span class="p">{</span><span class="n">END_IF</span><span class="p">}</span>

<span class="n">nPermittedRangeHolding</span> <span class="o">:=</span> <span class="n">nPermittedRange</span><span class="p">;</span>

<span class="n">FOR</span> <span class="n">nIndex</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_cBoundaries</span> <span class="n">DO</span>

    <span class="n">F_eVWithinSpec</span> <span class="n">S</span><span class="o">=</span> <span class="n">nPermittedRangeHolding</span><span class="mf">.0</span> <span class="n">AND</span><span class="p">(</span>
        <span class="p">(</span><span class="n">reV</span> <span class="o">&lt;=</span> <span class="n">Boundaries</span><span class="p">[</span><span class="n">nIndex</span><span class="p">])</span> <span class="n">AND</span>
        <span class="p">(</span><span class="n">reV</span> <span class="o">&gt;=</span> <span class="n">rPreviousBoundary</span><span class="p">)</span> <span class="p">);</span>

    <span class="n">IF</span> <span class="n">F_eVWithinSpec</span> <span class="n">THEN</span> <span class="n">RETURN</span><span class="p">;</span> <span class="n">END_IF</span>

    <span class="n">rPreviousBoundary</span> <span class="o">:=</span> <span class="n">Boundaries</span><span class="p">[</span><span class="n">nIndex</span><span class="p">];</span>
    <span class="n">nPermittedRangeHolding</span> <span class="o">:=</span> <span class="n">SHR</span><span class="p">(</span><span class="n">nPermittedRangeHolding</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">END_FOR</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="f-inittestbp">
<h2>F_InitTestBP<a class="headerlink" href="#f-inittestbp" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Establishes</span> <span class="n">a</span> <span class="n">BP</span> <span class="nb">set</span> <span class="k">for</span> <span class="n">testing</span><span class="o">.</span>
<span class="o">//</span> <span class="n">Specifically</span> <span class="n">this</span> <span class="n">means</span> <span class="n">a</span> <span class="n">BP</span> <span class="n">that</span> <span class="n">has</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">status</span> <span class="n">bits</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">an</span> <span class="n">OK</span> <span class="n">state</span>
<span class="n">FUNCTION</span> <span class="n">F_InitTestBP</span> <span class="p">:</span> <span class="n">ST_BeamParams</span>
<span class="n">VAR_INPUT</span>
    <span class="n">BP</span> <span class="p">:</span> <span class="n">ST_BeamParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>


<span class="n">END_FUNCTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="f-pmps-json">
<h2>F_PMPS_JSON<a class="headerlink" href="#f-pmps-json" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">F_PMPS_JSON</span> <span class="p">:</span> <span class="n">STRING</span>
<span class="n">VAR_INPUT</span>
    <span class="n">sDevName</span> <span class="p">:</span> <span class="n">STRING</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="n">sPath</span> <span class="p">:</span> <span class="n">STRING</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="n">nTypeCode</span> <span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>

<span class="n">END_VAR</span>
<span class="n">PMPS_TOOLS</span><span class="o">.</span><span class="n">fbJson</span><span class="o">.</span><span class="n">StartObject</span><span class="p">();</span>
<span class="n">PMPS_TOOLS</span><span class="o">.</span><span class="n">fbJson</span><span class="o">.</span><span class="n">AddKey</span><span class="p">(</span><span class="s1">&#39;pmps_typecode&#39;</span><span class="p">);</span>
<span class="n">PMPS_TOOLS</span><span class="o">.</span><span class="n">fbJson</span><span class="o">.</span><span class="n">AddUdint</span><span class="p">(</span><span class="n">nTypeCode</span><span class="p">);</span>
<span class="n">PMPS_TOOLS</span><span class="o">.</span><span class="n">fbJson</span><span class="o">.</span><span class="n">AddKey</span><span class="p">(</span><span class="s1">&#39;pmps_path&#39;</span><span class="p">);</span>
<span class="n">PMPS_TOOLS</span><span class="o">.</span><span class="n">fbJson</span><span class="o">.</span><span class="n">AddString</span><span class="p">(</span><span class="n">sPath</span><span class="p">);</span>
<span class="n">PMPS_TOOLS</span><span class="o">.</span><span class="n">fbJson</span><span class="o">.</span><span class="n">AddKey</span><span class="p">(</span><span class="s1">&#39;pmps_device_name&#39;</span><span class="p">);</span>
<span class="n">PMPS_TOOLS</span><span class="o">.</span><span class="n">fbJson</span><span class="o">.</span><span class="n">AddString</span><span class="p">(</span><span class="n">sDevName</span><span class="p">);</span>
<span class="n">PMPS_TOOLS</span><span class="o">.</span><span class="n">fbJson</span><span class="o">.</span><span class="n">EndObject</span><span class="p">();</span>
<span class="n">F_PMPS_JSON</span> <span class="o">:=</span> <span class="n">PMPS_TOOLS</span><span class="o">.</span><span class="n">fbJson</span><span class="o">.</span><span class="n">GetDocument</span><span class="p">();</span>
<span class="n">PMPS_TOOLS</span><span class="o">.</span><span class="n">fbJson</span><span class="o">.</span><span class="n">ResetDocument</span><span class="p">();</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#pmps-tools">PMPS_TOOLS</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="f-safebpcompare">
<h2>F_SafeBPCompare<a class="headerlink" href="#f-safebpcompare" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span><span class="n">Compares</span> <span class="n">BeamParam1</span> <span class="n">to</span> <span class="n">BeamParam2</span><span class="p">:</span> <span class="k">if</span> <span class="n">the</span> <span class="n">parameters</span> <span class="n">of</span> <span class="n">BeamParam1</span> <span class="n">are</span> <span class="n">more</span> <span class="n">conservative</span> <span class="n">than</span> <span class="n">BeamParam2</span>
<span class="n">the</span> <span class="n">result</span> <span class="n">will</span> <span class="n">be</span> <span class="n">true</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>
<span class="o">//</span> <span class="n">Does</span> <span class="ow">not</span> <span class="n">consider</span> <span class="n">status</span><span class="o">.</span> <span class="n">Status</span> <span class="n">must</span> <span class="n">be</span> <span class="n">evaluated</span> <span class="n">elsewhere</span><span class="o">.</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_check&#39;</span><span class="p">}</span>
<span class="n">FUNCTION</span> <span class="n">F_SafeBPCompare</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">BeamParam1</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span> <span class="o">//</span><span class="n">Must</span> <span class="n">be</span> <span class="n">more</span> <span class="n">conservative</span> <span class="n">than</span> <span class="mi">2</span>
    <span class="n">BeamParam2</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span> <span class="n">Internal</span> <span class="n">Attenuation</span> <span class="n">OK</span> <span class="n">boolean</span>
    <span class="n">xAttOK</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Internal</span> <span class="n">Per</span><span class="o">-</span><span class="n">pulse</span> <span class="n">energy</span> <span class="n">OK</span> <span class="n">boolean</span>
    <span class="n">xPPmjOK</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Internal</span> <span class="n">photon</span> <span class="n">energy</span> <span class="n">OK</span> <span class="n">boolean</span>
    <span class="n">xEvOK</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Internal</span> <span class="n">Beam</span> <span class="n">Rate</span> <span class="n">OK</span> <span class="n">boolean</span>
    <span class="n">xRateOK</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Internal</span> <span class="n">Beam</span> <span class="n">Class</span> <span class="n">Range</span> <span class="n">OK</span> <span class="n">boolean</span>
    <span class="n">xBCOK</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">idx</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">xAuxAttOK</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">xAuxAprtOK</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="n">Att1</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">ST_PMPS_Attenuator</span><span class="p">;</span>
    <span class="n">Att2</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">ST_PMPS_Attenuator</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">xAttOK</span> <span class="o">:=</span> <span class="n">BeamParam1</span><span class="o">.</span><span class="n">nTran</span> <span class="o">&lt;=</span> <span class="n">MIN</span><span class="p">(</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">TRANS_SCALING_FACTOR</span><span class="p">,</span> <span class="p">(</span><span class="n">BeamParam2</span><span class="o">.</span><span class="n">nTran</span> <span class="o">*</span><span class="p">(</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">TRANS_SCALING_FACTOR</span><span class="o">+</span><span class="n">PMPS_PARAM</span><span class="o">.</span><span class="n">TRANS_MARGIN</span><span class="p">))</span><span class="o">/</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">TRANS_SCALING_FACTOR</span> <span class="p">);</span>
<span class="n">xEvOK</span> <span class="o">:=</span> <span class="p">(</span><span class="n">BeamParam1</span><span class="o">.</span><span class="n">neVRange</span> <span class="n">AND</span> <span class="n">BeamParam2</span><span class="o">.</span><span class="n">neVRange</span><span class="p">)</span> <span class="o">=</span> <span class="n">BeamParam1</span><span class="o">.</span><span class="n">neVRange</span><span class="p">;</span>
<span class="n">xRateOK</span>    <span class="o">:=</span> <span class="p">(</span><span class="n">BeamParam1</span><span class="o">.</span><span class="n">nRate</span> <span class="o">&lt;=</span> <span class="n">BeamParam2</span><span class="o">.</span><span class="n">nRate</span><span class="p">)</span> <span class="n">OR</span> <span class="p">(</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">stCurrentBeamParameters</span><span class="o">.</span><span class="n">nMachineMode</span> <span class="o">=</span><span class="mi">1</span><span class="p">);</span> <span class="o">//</span><span class="n">ignore</span> <span class="ow">in</span> <span class="n">SC</span> <span class="n">mode</span>
<span class="n">xBCOK</span> <span class="o">:=</span> <span class="p">((</span><span class="n">BeamParam1</span><span class="o">.</span><span class="n">nBCRange</span> <span class="n">AND</span> <span class="n">BeamParam2</span><span class="o">.</span><span class="n">nBCRange</span><span class="p">)</span> <span class="o">=</span> <span class="n">BeamParam1</span><span class="o">.</span><span class="n">nBCRange</span><span class="p">)</span> <span class="n">OR</span> <span class="p">(</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">stCurrentBeamParameters</span><span class="o">.</span><span class="n">nMachineMode</span> <span class="o">=</span><span class="mi">0</span><span class="p">);</span> <span class="o">//</span><span class="n">ignore</span> <span class="ow">in</span> <span class="n">NC</span> <span class="n">mode</span><span class="p">;</span>

<span class="n">FOR</span> <span class="n">idx</span><span class="o">:=</span><span class="mi">1</span> <span class="n">to</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">AUX_ATTENUATORS</span> <span class="n">DO</span>
    <span class="n">Att1</span> <span class="n">REF</span><span class="o">=</span> <span class="n">BeamParam1</span><span class="o">.</span><span class="n">astAttenuators</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
    <span class="n">Att2</span> <span class="n">REF</span><span class="o">=</span> <span class="n">BeamParam2</span><span class="o">.</span><span class="n">astAttenuators</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
    <span class="n">xAuxAttOK</span> <span class="n">R</span><span class="o">=</span> <span class="p">(</span> <span class="n">Att1</span><span class="o">.</span><span class="n">nTran</span> <span class="o">&gt;</span> <span class="n">MIN</span><span class="p">(</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">TRANS_SCALING_FACTOR</span><span class="p">,</span> <span class="p">(</span> <span class="p">(</span><span class="n">Att2</span><span class="o">.</span><span class="n">nTran</span> <span class="o">*</span><span class="p">(</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">TRANS_SCALING_FACTOR</span><span class="o">+</span><span class="n">PMPS_PARAM</span><span class="o">.</span><span class="n">TRANS_MARGIN</span><span class="p">))</span><span class="o">/</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">TRANS_SCALING_FACTOR</span> <span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
<span class="n">END_FOR</span>

<span class="n">FOR</span> <span class="n">idx</span><span class="o">:=</span><span class="mi">1</span> <span class="n">to</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">MAX_APERTURES</span> <span class="n">DO</span>
    <span class="n">xAuxAprtOK</span> <span class="n">R</span><span class="o">=</span> <span class="n">BeamParam1</span><span class="o">.</span><span class="n">astApertures</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">Height</span> <span class="o">&gt;</span> <span class="n">BeamParam2</span><span class="o">.</span><span class="n">astApertures</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">Height</span> <span class="n">OR</span>
    <span class="n">BeamParam1</span><span class="o">.</span><span class="n">astApertures</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">Width</span> <span class="o">&gt;</span> <span class="n">BeamParam2</span><span class="o">.</span><span class="n">astApertures</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">Width</span><span class="p">;</span>
<span class="n">END_FOR</span>

<span class="n">F_SafeBPCompare</span> <span class="o">:=</span> <span class="n">xAttOK</span> <span class="n">AND</span> <span class="n">xEvOK</span> <span class="n">AND</span> <span class="n">xRateOK</span> <span class="n">AND</span> <span class="n">xAuxAprtOK</span> <span class="n">AND</span> <span class="n">xAuxAttOK</span> <span class="n">AND</span> <span class="n">xBCOK</span><span class="p">;</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
<li><p><a class="reference internal" href="#pmps-param">PMPS_PARAM</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
<li><p><a class="reference internal" href="#st-pmps-attenuator">ST_PMPS_Attenuator</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="f-safebpcompare0rate">
<h2>F_SafeBPCompare0Rate<a class="headerlink" href="#f-safebpcompare0rate" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span><span class="n">Compares</span> <span class="n">BeamParam1</span> <span class="n">to</span> <span class="n">BeamParam2</span><span class="p">:</span> <span class="k">if</span> <span class="n">the</span> <span class="n">parameters</span> <span class="n">of</span> <span class="n">BeamParam1</span> <span class="n">are</span> <span class="n">more</span> <span class="n">conservative</span> <span class="n">than</span> <span class="n">BeamParam2</span>
<span class="n">the</span> <span class="n">result</span> <span class="n">will</span> <span class="n">be</span> <span class="n">true</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">When</span> <span class="n">the</span> <span class="n">Mode</span> <span class="n">PV</span> <span class="ow">is</span> <span class="ow">in</span> <span class="n">Cu</span> <span class="mi">0</span><span class="o">-</span><span class="n">rate</span> <span class="n">means</span> <span class="n">this</span> <span class="n">function</span> <span class="n">will</span> <span class="k">return</span> <span class="n">true</span> <span class="n">regardless</span> <span class="n">of</span> <span class="n">other</span> <span class="n">conditions</span> <span class="k">if</span> <span class="n">the</span> <span class="n">beam</span> <span class="n">rate</span>
<span class="ow">is</span> <span class="n">zero</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">When</span> <span class="n">the</span> <span class="n">Mode</span> <span class="n">PV</span> <span class="ow">is</span> <span class="ow">in</span> <span class="n">SC</span> <span class="mi">0</span><span class="o">-</span><span class="n">bc</span> <span class="n">means</span> <span class="n">this</span> <span class="n">function</span> <span class="n">will</span> <span class="k">return</span> <span class="n">true</span> <span class="n">regardless</span> <span class="n">of</span> <span class="n">other</span> <span class="n">conditions</span> <span class="k">if</span> <span class="n">the</span> <span class="n">beam</span> <span class="k">class</span>
<span class="nc">is</span> <span class="n">zero</span> <span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION</span> <span class="n">F_SafeBPCompare0Rate</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">BeamParam1</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span> <span class="o">//</span><span class="n">Must</span> <span class="n">be</span> <span class="n">more</span> <span class="n">conservative</span> <span class="n">than</span> <span class="mi">2</span>
    <span class="n">BeamParam2</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>

    <span class="o">//</span> <span class="n">Beam</span><span class="o">-</span><span class="n">rate</span> <span class="ow">is</span> <span class="n">zero</span><span class="p">,</span> <span class="n">masks</span> <span class="nb">all</span> <span class="n">others</span> <span class="n">considerations</span><span class="o">.</span>
    <span class="n">xZeroRate</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Beam</span> <span class="k">class</span><span class="w"> </span><span class="nc">is</span> <span class="n">zero</span> <span class="n">i</span><span class="o">.</span><span class="n">e</span> <span class="n">beam</span> <span class="n">off</span><span class="p">,</span> <span class="n">masks</span> <span class="nb">all</span> <span class="n">other</span> <span class="n">considerations</span><span class="o">.</span>
    <span class="n">xZeroBC</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">xZeroRate</span>  <span class="o">:=</span> <span class="p">(</span><span class="n">BeamParam1</span><span class="o">.</span><span class="n">nRate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">stCurrentBeamParameters</span><span class="o">.</span><span class="n">nMachineMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">xZeroBC</span>  <span class="o">:=</span> <span class="p">(</span><span class="n">BeamParam1</span><span class="o">.</span><span class="n">nBCRange</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">stCurrentBeamParameters</span><span class="o">.</span><span class="n">nMachineMode</span> <span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="n">F_SafeBPCompare0Rate</span> <span class="o">:=</span> <span class="p">(</span><span class="n">xZeroRate</span> <span class="n">OR</span> <span class="n">xZeroBC</span><span class="p">)</span> <span class="n">OR</span> <span class="n">F_SafeBPCompare</span><span class="p">(</span><span class="n">BeamParam1</span><span class="p">,</span> <span class="n">BeamParam2</span><span class="p">);</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#f-safebpcompare">F_SafeBPCompare</a></p></li>
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="f-setbeamparams">
<h2>F_SetBeamParams<a class="headerlink" href="#f-setbeamparams" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">F_SetBeamParams</span> <span class="p">:</span> <span class="n">ST_BeamParams</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTran</span>    <span class="p">:</span>    <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">neVRange</span>    <span class="p">:</span>    <span class="n">DWORD</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">nRate</span>    <span class="p">:</span>    <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">nBCRange</span> <span class="p">:</span> <span class="n">WORD</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">astAuxAtt</span> <span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">AUX_ATTENUATORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PMPS_Attenuator</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">BeamParams</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">BeamParams</span><span class="o">.</span><span class="n">nTran</span> <span class="o">:=</span> <span class="n">LIMIT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nTran</span><span class="p">,</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">TRANS_SCALING_FACTOR</span><span class="p">);</span>
<span class="n">BeamParams</span><span class="o">.</span><span class="n">astAttenuators</span> <span class="o">:=</span> <span class="n">astAuxAtt</span><span class="p">;</span>
<span class="n">BeamParams</span><span class="o">.</span><span class="n">neVRange</span> <span class="o">:=</span> <span class="n">neVRange</span><span class="p">;</span>
<span class="n">BeamParams</span><span class="o">.</span><span class="n">nRate</span>    <span class="o">:=</span> <span class="n">MIN</span><span class="p">(</span><span class="n">nRate</span><span class="p">,</span><span class="mi">1000000</span><span class="p">);</span>
<span class="n">BeamParams</span><span class="o">.</span><span class="n">nBCRange</span> <span class="o">:=</span> <span class="n">MIN</span><span class="p">(</span><span class="n">nBCRange</span><span class="p">,</span><span class="mi">32767</span><span class="p">);</span>

<span class="n">F_SetBeamParams</span>    <span class="o">:=</span> <span class="n">BeamParams</span><span class="p">;</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
<li><p><a class="reference internal" href="#st-pmps-attenuator">ST_PMPS_Attenuator</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="f-setgoodattstatus">
<h2>F_SetGoodAttStatus<a class="headerlink" href="#f-setgoodattstatus" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">Use</span> <span class="k">for</span> <span class="n">testing</span> <span class="n">purposes</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">the</span> <span class="n">attenuator</span> <span class="n">status</span> <span class="n">to</span> <span class="n">a</span> <span class="n">good</span> <span class="n">state</span>
<span class="n">FUNCTION</span> <span class="n">F_SetGoodAttStatus</span> <span class="p">:</span> <span class="n">UINT</span>
<span class="n">VAR_INPUT</span>
    <span class="n">xStatus</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">xStatus</span><span class="mf">.0</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">xStatus</span><span class="mf">.3</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">xStatus</span><span class="mf">.4</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
<section id="f-setstateparams">
<h2>F_SetStateParams<a class="headerlink" href="#f-setstateparams" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">F_SetStateParams</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nStateRef</span>    <span class="p">:</span>    <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">rPosition</span>    <span class="p">:</span>    <span class="n">REAL</span><span class="p">;</span>
    <span class="n">rTolerance</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="n">stBeamParams</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Table</span>    <span class="p">:</span>    <span class="n">FB_LinearDeviceStateTable</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">stDeviceState</span>    <span class="p">:</span>    <span class="n">ST_DeviceState</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">stDeviceState</span><span class="o">.</span><span class="n">nStateRef</span> <span class="o">:=</span> <span class="n">nStateRef</span><span class="p">;</span>
<span class="n">stDeviceState</span><span class="o">.</span><span class="n">rPosition</span> <span class="o">:=</span> <span class="n">rPosition</span><span class="p">;</span>
<span class="n">stDeviceState</span><span class="o">.</span><span class="n">rTolerance</span> <span class="o">:=</span> <span class="n">rTolerance</span><span class="p">;</span>
<span class="n">stDeviceState</span><span class="o">.</span><span class="n">stReqBeamParam</span> <span class="o">:=</span> <span class="n">stBeamParams</span><span class="p">;</span>

<span class="n">Table</span><span class="o">.</span><span class="n">A_Add</span><span class="p">(</span>
    <span class="n">key</span> <span class="o">:=</span> <span class="n">nStateRef</span><span class="p">,</span>
    <span class="n">putValue</span> <span class="o">:=</span> <span class="n">stDeviceState</span>
<span class="p">);</span>

<span class="n">F_SetStateParams</span> <span class="o">:=</span> <span class="n">Table</span><span class="o">.</span><span class="n">bOk</span><span class="p">;</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-lineardevicestatetable">FB_LinearDeviceStateTable</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
<li><p><a class="reference internal" href="#st-devicestate">ST_DeviceState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="f-validreqid">
<h2>F_ValidReqID<a class="headerlink" href="#f-validreqid" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">F_ValidReqID</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">ReqID</span> <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">F_ValidReqID</span> <span class="o">:=</span> <span class="n">ReqID</span> <span class="o">&lt;&gt;</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">EXCLUDED_ASSERTION_ID</span> <span class="n">AND</span> <span class="n">ReqID</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-acceleratorlinks">
<h2>FB_AcceleratorLinks<a class="headerlink" href="#fb-acceleratorlinks" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_AcceleratorLinks</span>
<span class="n">VAR_INPUT</span>

<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>


<span class="n">VAR</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">eEnrg</span><span class="p">:</span><span class="n">Hgvpu</span>
        <span class="n">link</span><span class="p">:</span> <span class="n">BEND</span><span class="p">:</span><span class="n">DMPH</span><span class="p">:</span><span class="mi">400</span><span class="p">:</span><span class="n">BACT</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">GeV</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbHgvpuElectronEnergy</span> <span class="p">:</span> <span class="n">FB_LREALFromEPICS</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">eEnrg</span><span class="p">:</span><span class="n">SXU</span>
        <span class="n">link</span><span class="p">:</span> <span class="n">BEND</span><span class="p">:</span><span class="n">DMPS</span><span class="p">:</span><span class="mi">400</span><span class="p">:</span><span class="n">BACT</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">GeV</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbSxuElectronEnergy</span> <span class="p">:</span> <span class="n">FB_LREALFromEPICS</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">fbHgvpuElectronEnergy</span><span class="p">();</span>
<span class="n">fbSxuElectronEnergy</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-arbiter">
<h2>FB_Arbiter<a class="headerlink" href="#fb-arbiter" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(* FB Arbiter
A. Wallace 2020-6-26

The arbiter primary objectives are:
- Provide a simple interface for devices to request beam parameter sets
- Provide a way for devices to verify their BPS is active in the arbiter
- Provide a way for devices remove their requests from evaluation
- Evaluate all active beam parameter requests registered with the aribiter,
to determine the safest combination of all sets, provide this set as an output.
- Do all of this with minimal overhead

To these ends, the arbiter uses a hash-table, the rows being a state-id as the key, and a corresponding
 beam parameter set to be evaluated against all the other sets (or rows), in the table.

The hash table can be thought of as an array on steriods, they are worth reading about, suffice to say
the hash table will tell you when you reach the end of all the entries, and enables us to find entries quickly.

These features efficiently address the addition, removal, and verification of beam parameter sets listed in the above requirements.
*)
{attribute &#39;reflection&#39;}
FUNCTION_BLOCK FB_Arbiter IMPLEMENTS I_HigherAuthority, I_LowerAuthority
VAR
    nRequestsCount : UDINT; // How many requests are currently in the arbiter

    {attribute &#39;pytmc&#39; := &#39;
        pv: AP
        io: i
        field: DESC Assertion Pool
     &#39;}
    fbBPAssertionPool    :    FB_BeamParamAssertionPool; //Table of active beam parameter assertions

    xRequestMade : BOOL; // Arbiter has confirmed its request has made it into the beam parameter request

    {attribute &#39;pytmc&#39; := &#39;
        pv: ArbiterID
        io: i
        field: DESC Arbiter ID for elev. req.
     &#39;}
    nArbiterID : UDINT; // Arbiter ID, used for making higher-level BP requests

    nNextCohort : UDINT := 1; // The cohort ID any new requests will adopt, will become ReqInProgCohort at the start of the next acknowledgement cycle
    nAckInProgCohort : UDINT := 0; // The cohort ID currently being acknowledged, will become nActiveCohort after acknowledgement from HA
    {attribute &#39;pytmc&#39; := &#39;
        pv: CohortCounter
        io: i
        field: DESC Intrnl cohort counter
     &#39;}
    nActiveCohort : UDINT := 0; // Requests with cohorts &lt;= to this value will be considered active in CheckRequest

    bStartNewAckRequest : BOOL; // Set by an add or remove method call, triggers an ack cycle
    bAckInProgress : BOOL; // Set by ElevateReq when there is a new ack request and reset when the ack cycle is complete

    // The following IDs are set by the last BP request that was most conservative
    // ie. other requests may limit the parameter, but this one is the most recent to limit it
    idTransmission : DWORD; // ID of BP limiting transmission
    idRate : DWORD; // ID of BP limiting rate

    {attribute &#39;instance-path&#39;}
    {attribute &#39;noinit&#39;}
    sPath    :    T_MaxString;

    sArbName : T_MaxString;

    InfoStringFmtr : FB_FormatString;

    bVerbose : BOOL := FALSE;
END_VAR
VAR_INPUT
END_VAR
VAR_OUTPUT
    {attribute &#39;pytmc&#39; := &#39;
        pv: ArbitratedBP
        io: i
        field: DESC Arbitrated BP
     &#39;}
    q_stBeamParams    :    ST_BeamParams := PMPS_GVL.cstFullBeam; //Updated on each cycle of the arbiter FB with the current arbitrated beam parameter set

    q_xStateIDFound    :    BOOL; //Set true if a state-id is found in the assertion pool after calling A_VerifyAssertion
END_VAR


END_FUNCTION_BLOCK

// Adds a request to the arbiter pool.
// Returns true if the request was successfully added, false if not enough space or a request with the same ID is already present.
METHOD AddRequest : BOOL
VAR_INPUT
    nReqID    :    DWORD; // Unique ID within aribter for the request. Make sure this is unique for every device + state combination
    stReqBP        :    ST_BeamParams; //Requested beam params
    sDevName: STRING; // Name of the device making the request
END_VAR
VAR
    BP_Int : ST_BP_ArbInternal;
END_VAR
VAR_INST
    fbLog : FB_LogMessage;
END_VAR
// If the request is already in the pool, then skip the rest.
// This is flawed, needs to update the request if it&#39;s already in the pool, despite having the same ID
IF THIS^.CheckRequestInPool(nReqID)
    OR nReqID = PMPS_GVL.EXCLUDED_ASSERTION_ID
    OR nReqID = 0 THEN
    AddRequest := FALSE;
    RETURN;
END_IF


stReqBP.nCohortInt := nNextCohort; // Set the cohort number for this BP request.

// Pack the ID with the request
MEMCPY(ADR(BP_Int), ADR(stReqBP), SIZEOF(stReqBP));
BP_Int.nId := nReqID;
BP_Int.LiveInTable := TRUE;
BP_Int.sDevName := sDevName;

THIS^.fbBPAssertionPool.A_Add(
    key := nReqID,
    putValue := BP_Int
);


IF NOT THIS^.fbBPAssertionPool.bOk THEN
    fbLog(sMsg:=CONCAT(&#39;Addition to arbiter assertion pool failed &#39;, DWORD_TO_HEXSTR(nReqID, 4, FALSE)),
            eSevr:=TcEventSeverity.Warning,
            eSubsystem:=E_Subsystem.MPS,
            sJson := F_PMPS_JSON(
                        sArbName,
                        sPath,
                        PMPS_CODES.ARB_FULL));
ELSIF THIS^.fbBPAssertionPool.bOk AND bVerbose THEN
    fbLog(sMsg:=CONCAT(&#39;Added to pool &#39;,DWORD_TO_HEXSTR(nReqID, 4, FALSE)),
            eSevr:=TcEventSeverity.Verbose,
            eSubsystem:=E_Subsystem.MPS);
END_IF
// New request, make sure the ack cycle request flag is set
bStartNewAckRequest S= THIS^.fbBPAssertionPool.bOk;

AddRequest := THIS^.fbBPAssertionPool.bOk;

nRequestsCount := nEntryCount;
END_METHOD

// Kernel of the arbiter
// Logic for determining which beam parameter is the most conservative across all request sets.
{attribute &#39;no_check&#39;}
METHOD INTERNAL ArbitrateBP : ST_BP_ArbInternal
VAR_INPUT
    stBP1    :    ST_BP_ArbInternal;
    stBP2    :    ST_BP_ArbInternal;
END_VAR
VAR
    idx : UINT := 1;
    bcBitmask : WORD:=0;
END_VAR
//&lt;TODO&gt;Add something here to register the key that won for each param

//Attenuation
ArbitrateBP.nTran := MIN(stBP1.nTran, stBP2.nTran);

FOR idx := 1 TO PMPS_GVL.AUX_ATTENUATORS DO
    ArbitrateBP.astAttenuators[idx].nTran := MIN(stBP1.astAttenuators[idx].nTran, stBP2.astAttenuators[idx].nTran);
END_FOR

//Apertures
FOR idx := 1 TO PMPS_GVL.MAX_APERTURES DO
    IF stBP1.astApertures[idx].Height = 0 OR stBP2.astApertures[idx].Height =0 THEN
        ArbitrateBP.astApertures[idx].Height := MAX(stBP1.astApertures[idx].Height, stBP2.astApertures[idx].Height);
    ELSE
        ArbitrateBP.astApertures[idx].Height := MIN(stBP1.astApertures[idx].Height, stBP2.astApertures[idx].Height);
    END_IF

    IF stBP1.astApertures[idx].Width = 0 OR stBP2.astApertures[idx].Width =0 THEN
        ArbitrateBP.astApertures[idx].Width := MAX(stBP1.astApertures[idx].Width, stBP2.astApertures[idx].Width);
    ELSE
        ArbitrateBP.astApertures[idx].Width := MIN(stBP1.astApertures[idx].Width, stBP2.astApertures[idx].Width);
    END_IF
END_FOR

//Photon energy ranges
ArbitrateBP.neVRange := stBP1.neVRange AND stBP2.neVRange;

//Beam Class ranges
ArbitrateBP.nBCRange := stBP1.nBCRange AND stBP2.nBCRange;

//Beam Class
//Assert the highest allowed beamclass
IF (ArbitrateBP.nBCRange = 0) THEN ArbitrateBP.nBeamClass := 0; END_IF
FOR idx:=1 TO 15 BY 1 DO
    IF (idx =1 ) THEN bcBitmask :=1; END_IF
    IF (ArbitrateBP.nBCRange AND bcBitmask) = bcBitmask THEN
        ArbitrateBP.nBeamClass := TO_USINT(idx);
    END_IF
    bcBitmask := ROL(bcBitmask,1);
END_FOR


//Rate
ArbitrateBP.nRate := MIN(stBP1.nRate, stBP2.nRate);
END_METHOD

(* Checks request ID is included in arbitration all the way to the accelerator interface
Use like so:
IF fbArbiter.CheckRequest(nStateIDAssertionToCheck) AND (other logic) THEN:
    Request is found and active in arbitration,. Do something.
ELSE:
    Request was not found, or is not yet included in arbitration. Don&#39;t do something/ wait.

*)
METHOD CheckRequest : BOOL
VAR_INPUT
    nReqID    :    DWORD;
END_VAR
VAR
    BP : ST_BeamParams;
END_VAR
fbBPAssertionPool.A_Lookup(key := nReqID);

// Verify BP is acknowledged
BP := fbBPAssertionPool.getValue;

// This logic:
// Did we find the assertion in the pool?
// Is the assertion cohort number less than the current cohort and greater than zero?
// Is the Aribter itself active in arbitration?
CheckRequest := fbBPAssertionPool.bOk AND
                BP.nCohortInt &lt;= nActiveCohort AND
                BP.nCohortInt &gt; 0;
END_METHOD

// Verify request is at least in the local arbiter
// Does not verify request has been included in arbitration.
// Use CheckRequest instead.
METHOD CheckRequestInPool : BOOL
VAR_INPUT
    nReqID    :    DWORD;
END_VAR
THIS^.fbBPAssertionPool.A_Lookup(key := nReqID);

CheckRequestInPool := THIS^.fbBPAssertionPool.bOk;
END_METHOD

// &lt;Arbiter Internal&gt;
// Elevates the arbitrated BP set to something above.
// Could be another arbiter, or a BP requester/ IO,
// or an FB that locks in a specific portion of the BP set.
METHOD ElevateRequest : BOOL
VAR_INPUT
    HigherAuthority : I_HigherAuthority;
END_VAR
(*
This method should only be used with one higher level component.
*)

// Complete previous ack cycle
IF bAckInProgress THEN
    IF HigherAuthority.CheckRequest(nReqID := nArbiterID) THEN
        nActiveCohort := nAckInProgCohort;
        bAckInProgress := FALSE;
    END_IF
END_IF

// Kick off another ack cycle
IF bStartNewAckRequest AND NOT bAckInProgress THEN
    nAckInProgCohort := nNextCohort;
    HigherAuthority.RemoveRequest(nReqID:= nArbiterID);
    bAckInProgress := HigherAuthority.RequestBP(nReqID := nArbiterID, stReqBP := GetArbitratedBP());
    IF bAckInProgress THEN
        bStartNewAckRequest := FALSE;
        nNextCohort := nNextCohort + 1;
    END_IF
END_IF
END_METHOD

METHOD FB_init : BOOL
VAR_INPUT
    bInitRetains : BOOL; // if TRUE, the retain variables are initialized (warm start / cold start)
    bInCopyCode : BOOL;  // if TRUE, the instance afterwards gets moved into the copy code (online change)
    nID : DWORD := PMPS_GVL.EXCLUDED_ASSERTION_ID; // Arbiter ID, must be globally unique cannot be zero or 16#FFFF
END_VAR
nArbiterID := nId;
fbBPAssertionPool.A_Reset();

sArbName := CONCAT(&#39;Arbiter ID: 0x&#39;, DWORD_TO_HEXSTR(nID, 4, FALSE));
END_METHOD

// Executes Arbitration between all requested beam parameter sets
METHOD INTERNAL GetArbitratedBP : ST_BeamParams
VAR_INPUT
END_VAR
VAR
    getPosPtr    : POINTER TO T_HashTableEntry := 0;
    getBPStructInt    :    ST_BP_ArbInternal;
    stOutputBP    :    ST_BP_ArbInternal; //Holding struct for arbitration process
END_VAR
VAR_INST
    xFirstPass : BOOL := TRUE;
    fbGetCurTaskIdx : GETCURTASKINDEX;
    LastCycleCount : UDINT;
    fbLogMessage : FB_LogMessage;
END_VAR
//Arbitrate
(*
This step cycles through every hash table entry, comparing
the beam parameters from each assertion to what we&#39;re planning
to assert.

The safer of the two parameters is kept so at the end we may
have a mix of beam parameters, the composition being safe for
all asserters.

*)

THIS^.fbBPAssertionPool.A_GetFirst( putPosPtr := 0, getPosPtr=&gt;getPosPtr, getValue=&gt;getBPStructInt );
IF THIS^.fbBPAssertionPool.bOk THEN //If the table is empty (not OK), we are left with the default stOutputBP set above.

    //The first entry in the hash table is taken as the setting to arbitrate against
    stOutputBP := getBPStructInt;

    REPEAT
        THIS^.fbBPAssertionPool.A_GetNext( putPosPtr := THIS^.fbBPAssertionPool.getPosPtr, getPosPtr=&gt;getPosPtr, getValue=&gt;getBPStructInt );
        IF THIS^.fbBPAssertionPool.bOk THEN
            stOutputBP := ArbitrateBP(stOutputBP, getBPStructInt);
        END_IF
    UNTIL NOT fbBPAssertionPool.bOk
    END_REPEAT
ELSE
    //Full beam if there are no arbitration requests
    MEMCPY(ADR(stOutputBP), ADR(PMPS_GVL.cstFullBeam), SIZEOF(PMPS_GVL.cstFullBeam));
END_IF

MEMCPY(ADR(q_stBeamParams),ADR(stOutputBP), SIZEOF(q_stBeamParams));

GetArbitratedBP := stOutputBP;

GetArbitratedBP.xValidToggle := NOT GetArbitratedBP.xValidToggle;

xFirstPass := FALSE;
END_METHOD

(* Removes request from abritration. *)
METHOD RemoveRequest : BOOL
VAR_INPUT
    nReqId    :    DWORD;
END_VAR
VAR_INST
    fbLog : FB_LogMessage;
END_VAR
VAR CONSTANT
    BP_Int : ST_BP_ArbInternal := (nId:=0, LiveInTable:=FALSE);
END_VAR
IF nReqId &lt;&gt; PMPS_GVL.EXCLUDED_ASSERTION_ID AND CheckRequestInPool(nReqId) THEN
    // Include an A_Add action here to
    // update this entry with a dummy filler (ID = 0, LiveInTable= False)
    // before removing it since this hash
    // table needs to be viewed with a diagnostic
    // and so the entries need to appear clean.
    THIS^.fbBPAssertionPool.A_Add(key := nReqID, putValue := BP_Int);
    THIS^.fbBPAssertionPool.A_Remove(key := nReqId);

    IF bVerbose THEN
        IF THIS^.fbBPAssertionPool.bOk THEN
                fbLog(sMsg:=CONCAT(&#39;Removed from pool: &#39;, DWORD_TO_HEXSTR(nReqID,4,FALSE)),
                eSevr:=TcEventSeverity.Verbose,
                eSubsystem:=E_Subsystem.MPS);
        ELSE
            fbLog(sMsg:=CONCAT(&#39;Failed to remove from pool: &#39;, DWORD_TO_HEXSTR(nReqID,4,FALSE)),
                eSevr:=TcEventSeverity.Warning,
                eSubsystem:=E_Subsystem.MPS);
        END_IF
    END_IF

    // With any new request reset the internal arbiter &quot;done&quot; flag
    bStartNewAckRequest S= THIS^.fbBPAssertionPool.bOk;

    RemoveRequest := THIS^.fbBPAssertionPool.bOk;

    nRequestsCount := nEntryCount;

END_IF
END_METHOD

METHOD RequestBP : BOOL
VAR_INPUT
    (*StateID of state requesting beam parameter set*)
    nReqID  : DWORD;
    (*Requested beam params*)
    stReqBP : ST_BeamParams;
END_VAR
RequestBP := AddRequest(nReqID := nReqID, stReqBP := stReqBP, sDevName:=sArbName);
END_METHOD

// How many entries are in the arbiter now
PROPERTY nEntryCount : UDINT
VAR
END_VAR
fbBPAssertionPool.A_Count();
IF fbBPAssertionPool.bOk THEN
    nEntryCount := fbBPAssertionPool.nCount ;
END_IF
END_PROPERTY

PROPERTY nLowerAuthorityID : DWORD
VAR
END_VAR
nLowerAuthorityID := nArbiterID;
END_PROPERTY
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-beamparamassertionpool">FB_BeamParamAssertionPool</a></p></li>
<li><p><a class="reference internal" href="#f-pmps-json">F_PMPS_JSON</a></p></li>
<li><p><a class="reference internal" href="#pmps-codes">PMPS_CODES</a></p></li>
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
<li><p><a class="reference internal" href="#st-bp-arbinternal">ST_BP_ArbInternal</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
<li><p><a class="reference internal" href="#t-hashtableentry">T_HashTableEntry</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-arbiter-test">
<h2>FB_Arbiter_Test<a class="headerlink" href="#fb-arbiter-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;call_after_init&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_Arbiter_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Arbitration</span><span class="p">();</span>
<span class="n">RequestCheckRemoveBP</span><span class="p">();</span>
<span class="n">FullArbitrationStack</span><span class="p">();</span>
<span class="n">StackArbiters</span><span class="p">();</span>
<span class="n">RemoveReq</span><span class="p">();</span>
<span class="n">DoS</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">ArbiterCapacity</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nId</span>    <span class="p">:</span>    <span class="n">DWORD</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">stReq</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="p">(</span><span class="n">nTran</span><span class="o">:=</span><span class="mi">12</span><span class="p">);</span>

    <span class="n">nRandID</span> <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
    <span class="n">testReq</span> <span class="p">:</span> <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="p">(</span><span class="n">neVRange</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#FFEE, nRate:=33);</span>

    <span class="n">idx</span> <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbArbCapacityTest</span>    <span class="p">:</span>    <span class="n">FB_Arbiter</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="n">Cycle</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">CycleLimit</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">SysID</span> <span class="p">:</span> <span class="n">DWORD</span> <span class="o">:=</span> <span class="mi">42</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;Arbiter Capcity&#39;</span><span class="p">);</span>
    <span class="o">//</span> <span class="n">Fill</span> <span class="n">the</span> <span class="n">arbiter</span>
    <span class="n">FOR</span> <span class="n">idx</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">PMPS_PARAM</span><span class="o">.</span><span class="n">MAX_ASSERTIONS</span> <span class="n">DO</span>
        <span class="n">fbArbCapacityTest</span><span class="o">.</span><span class="n">AddRequest</span><span class="p">(</span><span class="n">nReqID</span> <span class="o">:=</span> <span class="n">idx</span><span class="p">,</span> <span class="n">stReqBP</span> <span class="o">:=</span> <span class="n">testReq</span><span class="p">,</span> <span class="n">sDevName</span><span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Device #&#39;</span><span class="p">,</span> <span class="n">TO_STRING</span><span class="p">(</span><span class="n">idx</span><span class="p">)));</span>
    <span class="n">END_FOR</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">Arbitration</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>

     <span class="n">nTranReqID</span>    <span class="p">:</span>    <span class="n">UDINT</span>    <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">stAttReqBP</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstFullBeam</span><span class="p">;</span>

    <span class="n">nPPEReqID</span>    <span class="p">:</span>    <span class="n">UDINT</span>    <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">stPPEReqBP</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstFullBeam</span><span class="p">;</span>

    <span class="n">nEVReqID</span>    <span class="p">:</span>    <span class="n">UDINT</span>    <span class="o">:=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">stEVReqBP</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstFullBeam</span><span class="p">;</span>

    <span class="n">nRateReqID</span>    <span class="p">:</span>    <span class="n">UDINT</span>    <span class="o">:=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">stRateReqBP</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstFullBeam</span><span class="p">;</span>

    <span class="n">nBCRangeReqID</span> <span class="p">:</span> <span class="n">UDINT</span>    <span class="o">:=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="n">stBCReqBP</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstFullBeam</span><span class="p">;</span>

    <span class="n">stArbitratedBP</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span><span class="o">//</span> <span class="o">:=</span>  <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstFullBeam</span><span class="p">;;</span>
    <span class="n">stExpectedBP</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstFullBeam</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbArbiter</span>    <span class="p">:</span>    <span class="n">FB_Arbiter</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;Arbitration&#39;</span><span class="p">);</span>

<span class="n">stAttReqBP</span><span class="o">.</span><span class="n">nTran</span> <span class="o">:=</span> <span class="mf">0.50</span><span class="p">;</span>
<span class="n">stEVReqBP</span><span class="o">.</span><span class="n">neVRange</span> <span class="o">:=</span> <span class="mi">2</span><span class="c1">#1111_1111_1111_1111_1111_1100_1111_1111;</span>
<span class="n">stRateReqBP</span><span class="o">.</span><span class="n">nRate</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">stBCReqBP</span><span class="o">.</span><span class="n">nBCRange</span> <span class="o">:=</span> <span class="mi">2</span><span class="c1">#0111_0000_0000_0000;</span>
<span class="n">stBCReqBP</span><span class="o">.</span><span class="n">nBeamClass</span> <span class="o">:=</span> <span class="mi">15</span><span class="p">;</span>

<span class="n">stExpectedBP</span><span class="o">.</span><span class="n">nTran</span>     <span class="o">:=</span> <span class="n">stAttReqBP</span><span class="o">.</span><span class="n">nTran</span><span class="p">;</span>
<span class="n">stExpectedBP</span><span class="o">.</span><span class="n">neVRange</span> <span class="o">:=</span> <span class="n">stEVReqBP</span><span class="o">.</span><span class="n">neVRange</span><span class="p">;</span>
<span class="n">stExpectedBP</span><span class="o">.</span><span class="n">nRate</span> <span class="o">:=</span> <span class="n">stRateReqBP</span><span class="o">.</span><span class="n">nRate</span><span class="p">;</span>
<span class="n">stExpectedBP</span><span class="o">.</span><span class="n">nBCRange</span> <span class="o">:=</span> <span class="n">stBCReqBP</span><span class="o">.</span><span class="n">nBCRange</span><span class="p">;</span>
<span class="n">stExpectedBP</span><span class="o">.</span><span class="n">nBeamClass</span> <span class="o">:=</span> <span class="n">stBCReqBP</span><span class="o">.</span><span class="n">nBeamClass</span><span class="p">;</span>


<span class="o">//</span><span class="n">Load</span> <span class="n">arbiter</span> <span class="k">with</span> <span class="n">beam</span> <span class="n">parameter</span> <span class="n">sets</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">AddRequest</span><span class="p">(</span><span class="n">nTranReqID</span><span class="p">,</span> <span class="n">stAttReqBP</span><span class="p">,</span> <span class="n">sDevName</span><span class="o">:=</span> <span class="s1">&#39;Device&#39;</span> <span class="p">),</span>
                    <span class="s1">&#39;Safest attenuation request failed to load&#39;</span><span class="p">);</span>

<span class="o">//</span><span class="n">Load</span> <span class="n">arbiter</span> <span class="k">with</span> <span class="n">beam</span> <span class="n">parameter</span> <span class="n">sets</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">AddRequest</span><span class="p">(</span><span class="n">nPPEReqID</span><span class="p">,</span> <span class="n">stPPEReqBP</span><span class="p">,</span> <span class="n">sDevName</span><span class="o">:=</span> <span class="s1">&#39;Device&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;Safest PPE request failed to load&#39;</span><span class="p">);</span>

<span class="o">//</span><span class="n">Load</span> <span class="n">arbiter</span> <span class="k">with</span> <span class="n">beam</span> <span class="n">parameter</span> <span class="n">sets</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">AddRequest</span><span class="p">(</span><span class="n">nEVReqID</span><span class="p">,</span> <span class="n">stEVReqBP</span><span class="p">,</span> <span class="n">sDevName</span><span class="o">:=</span> <span class="s1">&#39;Device&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;Safest stEVReqBP request failed to load&#39;</span><span class="p">);</span>

<span class="o">//</span><span class="n">Load</span> <span class="n">arbiter</span> <span class="k">with</span> <span class="n">beam</span> <span class="n">parameter</span> <span class="n">sets</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">AddRequest</span><span class="p">(</span><span class="n">nRateReqID</span><span class="p">,</span> <span class="n">stRateReqBP</span><span class="p">,</span> <span class="n">sDevName</span><span class="o">:=</span> <span class="s1">&#39;Device&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;Safest stRateReqBP request failed to load&#39;</span><span class="p">);</span>

<span class="o">//</span><span class="n">Load</span> <span class="n">arbiter</span> <span class="k">with</span> <span class="n">beam</span> <span class="n">parameter</span> <span class="n">sets</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">AddRequest</span><span class="p">(</span><span class="n">nBCRangeReqID</span><span class="p">,</span> <span class="n">stBCReqBP</span><span class="p">,</span> <span class="n">sDevName</span><span class="o">:=</span> <span class="s1">&#39;Device&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;Safest stBCReqBP request failed to load&#39;</span><span class="p">);</span>

<span class="n">stArbitratedBP</span> <span class="o">:=</span> <span class="n">fbArbiter</span><span class="o">.</span><span class="n">GetArbitratedBP</span><span class="p">();</span>

<span class="n">AssertFalse</span><span class="p">(</span><span class="n">F_DifferentBeamParams</span><span class="p">(</span><span class="n">stExpectedBP</span><span class="p">,</span> <span class="n">stArbitratedBP</span><span class="p">),</span>
                <span class="s1">&#39;Arbitrated BP does not match expected.&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">DoS</span>
<span class="n">VAR</span>



    <span class="n">nOrigReqID</span> <span class="p">:</span> <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">30</span><span class="p">;</span>
    <span class="n">nSecondReqID</span> <span class="p">:</span> <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">35</span><span class="p">;</span>

    <span class="n">nPeskyReqID</span> <span class="p">:</span> <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">40</span><span class="p">;</span>


<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">DosArb</span> <span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

    <span class="n">DummyHA</span> <span class="p">:</span> <span class="n">FB_DummyHA</span> <span class="o">:=</span> <span class="p">(</span><span class="n">ReqAcknowledged</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span> <span class="o">//</span> <span class="n">Set</span> <span class="n">req</span> <span class="n">ack</span> <span class="n">false</span> <span class="n">to</span> <span class="n">start</span> <span class="n">so</span> <span class="n">we</span> <span class="n">can</span> <span class="n">control</span> <span class="n">when</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">verified</span>
    <span class="n">nTimeoutCounter</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bInit</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bSecond</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">eDosTestCases</span> <span class="p">:</span> <span class="n">E_ArbDosTestStates</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
        <span class="n">nTimeoutCounterMAX</span> <span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">50</span><span class="p">;</span>
        <span class="n">nWaitCount</span> <span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
        <span class="n">nWait2ndCount</span> <span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="n">nWaitCount</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;DoS&#39;</span><span class="p">);</span>

<span class="n">CASE</span> <span class="n">eDosTestCases</span> <span class="n">OF</span>
    <span class="n">E_ArbDosTestStates</span><span class="o">.</span><span class="n">Init</span><span class="p">:</span> <span class="o">//</span> <span class="n">Init</span><span class="p">,</span> <span class="n">first</span> <span class="n">request</span>
        <span class="n">DosArb</span><span class="o">.</span><span class="n">AddRequest</span><span class="p">(</span><span class="n">nOrigReqID</span><span class="p">,</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cst0RateBeam</span><span class="p">,</span> <span class="n">sDevName</span><span class="o">:=</span> <span class="s1">&#39;Device&#39;</span><span class="p">);</span>
        <span class="n">eDosTestCases</span> <span class="o">:=</span> <span class="n">E_ArbDosTestStates</span><span class="o">.</span><span class="n">SecondReq</span><span class="p">;</span>

    <span class="n">E_ArbDosTestStates</span><span class="o">.</span><span class="n">SecondReq</span><span class="p">:</span> <span class="o">//</span> <span class="n">Add</span> <span class="n">second</span> <span class="n">request</span>
        <span class="n">DosArb</span><span class="o">.</span><span class="n">AddRequest</span><span class="p">(</span><span class="n">nSecondReqID</span><span class="p">,</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cst0RateBeam</span><span class="p">,</span> <span class="n">sDevName</span><span class="o">:=</span> <span class="s1">&#39;Device&#39;</span><span class="p">);</span>
        <span class="n">eDosTestCases</span> <span class="o">:=</span> <span class="n">E_ArbDosTestStates</span><span class="o">.</span><span class="n">WaitForAck</span><span class="p">;</span>

    <span class="n">E_ArbDosTestStates</span><span class="o">.</span><span class="n">WaitForAck</span><span class="p">:</span>
        <span class="n">IF</span> <span class="n">nTimeoutCounter</span> <span class="o">&gt;</span> <span class="n">nWaitCount</span> <span class="n">THEN</span>
            <span class="n">DummyHA</span><span class="o">.</span><span class="n">ReqAcknowledged</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">eDosTestCases</span> <span class="o">:=</span> <span class="n">E_ArbDosTestStates</span><span class="o">.</span><span class="n">WaitFor2ndAck</span><span class="p">;</span>
        <span class="n">END_IF</span>

    <span class="n">E_ArbDosTestStates</span><span class="o">.</span><span class="n">WaitFor2ndAck</span><span class="p">:</span>
        <span class="n">DummyHA</span><span class="o">.</span><span class="n">ReqAcknowledged</span> <span class="o">:=</span> <span class="kc">False</span><span class="p">;</span>
        <span class="n">IF</span> <span class="n">nTimeoutCounter</span> <span class="o">&gt;</span> <span class="n">nWait2ndCount</span> <span class="n">THEN</span>
            <span class="n">DummyHA</span><span class="o">.</span><span class="n">ReqAcknowledged</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">eDosTestCases</span> <span class="o">:=</span> <span class="n">E_ArbDosTestStates</span><span class="o">.</span><span class="n">RunAsserts</span><span class="p">;</span>
        <span class="n">END_IF</span>

<span class="n">END_CASE</span>

<span class="n">DosArb</span><span class="o">.</span><span class="n">ElevateRequest</span><span class="p">(</span><span class="n">DummyHA</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Pesky</span> <span class="n">request</span> <span class="n">always</span> <span class="n">adding</span> <span class="ow">and</span> <span class="n">removing</span>
<span class="n">DosArb</span><span class="o">.</span><span class="n">RemoveRequest</span><span class="p">(</span><span class="n">nPeskyReqID</span><span class="p">);</span>
<span class="n">DosArb</span><span class="o">.</span><span class="n">AddRequest</span><span class="p">(</span><span class="n">nPeskyReqID</span><span class="p">,</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cst0RateBeam</span><span class="p">,</span> <span class="n">sDevName</span><span class="o">:=</span> <span class="s1">&#39;Device&#39;</span><span class="p">);</span>


<span class="n">nTimeoutCounter</span> <span class="o">:=</span> <span class="n">nTimeoutCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">nTimeoutCounter</span> <span class="o">&gt;</span> <span class="n">nTimeoutCounterMAX</span> <span class="ow">or</span> <span class="n">eDosTestCases</span> <span class="o">=</span> <span class="n">E_ArbDosTestStates</span><span class="o">.</span><span class="n">RunAsserts</span> <span class="n">THEN</span>
    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">DosArb</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">(</span><span class="n">nOrigReqID</span><span class="p">),</span> <span class="s1">&#39;Original request still not accepted&#39;</span><span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">DosArb</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">(</span><span class="n">nSecondReqID</span><span class="p">),</span> <span class="s1">&#39;Second request still not accepted&#39;</span><span class="p">);</span>

    <span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="s1">&#39;DoS&#39;</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_check&#39;</span><span class="p">}</span>
<span class="n">METHOD</span> <span class="n">FullArbitrationStack</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nId</span>    <span class="p">:</span>    <span class="n">DWORD</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">stReq</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="p">(</span><span class="n">nTran</span><span class="o">:=</span><span class="mi">12</span><span class="p">);</span>

    <span class="n">nIdDoS</span> <span class="p">:</span> <span class="n">DWORD</span> <span class="o">:=</span> <span class="mi">13</span><span class="p">;</span>
    <span class="n">stDoSReq</span> <span class="p">:</span> <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstFullBeam</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbArbiter</span>    <span class="p">:</span>    <span class="n">FB_Arbiter</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="n">fbHigherArb</span> <span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

    <span class="n">fbSubSysToArb</span> <span class="p">:</span> <span class="n">FB_SubSysToArbiter_IO</span><span class="p">;</span> <span class="o">//</span> <span class="n">Subsystem</span> <span class="n">interface</span> <span class="k">with</span> <span class="n">beamline</span> <span class="n">arbiter</span> <span class="n">PLC</span>
    <span class="n">pBPR</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_BeamParams_IO</span><span class="p">;</span>

    <span class="n">fbArbToSubSys</span> <span class="p">:</span> <span class="n">FB_ArbiterToSubSys_IO</span> <span class="o">:=</span> <span class="p">(</span><span class="n">RequestingSystemID</span><span class="o">:=</span><span class="mi">42</span><span class="p">);</span> <span class="o">//</span> <span class="n">Beamline</span> <span class="n">arbiter</span> <span class="n">PLC</span> <span class="n">interface</span> <span class="k">with</span> <span class="n">subsystems</span>
    <span class="n">pBPC</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_BeamParams_IO</span><span class="p">;</span>

    <span class="n">fbBPR</span> <span class="p">:</span> <span class="n">FB_BPRequestor</span><span class="p">;</span> <span class="o">//</span> <span class="n">Use</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">arbiter</span> <span class="n">PLC</span> <span class="n">to</span> <span class="n">apply</span> <span class="n">an</span> <span class="n">arbitrated</span> <span class="n">beam</span> <span class="n">parameter</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">the</span> <span class="n">accelerator</span> <span class="n">interface</span>

    <span class="n">FFO</span> <span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span> <span class="o">//</span> <span class="n">Dummy</span> <span class="n">FFO</span> <span class="ow">not</span> <span class="n">important</span> <span class="k">for</span> <span class="n">these</span> <span class="n">tests</span>

    <span class="n">Cycle</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">CycleLimit</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">SysID</span> <span class="p">:</span> <span class="n">DWORD</span> <span class="o">:=</span> <span class="mi">42</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">simulates</span> <span class="n">a</span> <span class="n">synchronous</span> <span class="n">cycle</span> <span class="n">between</span> <span class="n">the</span> <span class="n">subsystem</span> <span class="ow">and</span> <span class="n">arbiter</span> <span class="n">PLC</span> <span class="n">cycles</span><span class="o">.</span> <span class="n">Ie</span><span class="o">.</span> <span class="n">phase</span> <span class="ow">is</span> <span class="n">locked</span><span class="p">,</span> <span class="ow">and</span> <span class="n">cycle</span> <span class="n">time</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">same</span><span class="o">.</span> <span class="n">This</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">always</span> <span class="n">the</span> <span class="n">case</span><span class="p">,</span> <span class="n">so</span> <span class="n">these</span> <span class="n">tests</span> <span class="n">should</span> <span class="n">be</span>
<span class="o">//</span> <span class="n">trusted</span> <span class="k">with</span> <span class="n">a</span> <span class="n">grain</span> <span class="n">of</span> <span class="n">salt</span><span class="o">.</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;FullStack&#39;</span><span class="p">);</span>



<span class="n">CASE</span> <span class="n">Cycle</span> <span class="n">OF</span>

<span class="mi">0</span><span class="p">:</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequestInPool</span><span class="p">(</span><span class="n">nID</span><span class="p">)</span> <span class="n">THEN</span>
        <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">AddRequest</span><span class="p">(</span><span class="n">nId</span><span class="p">,</span> <span class="n">stReq</span><span class="p">,</span><span class="s1">&#39;Device&#39;</span><span class="p">),</span> <span class="s1">&#39;Arbiter returned false from AddRequest&#39;</span><span class="p">);</span> <span class="o">//</span> <span class="n">some</span> <span class="n">device</span> <span class="n">asking</span> <span class="n">its</span> <span class="n">local</span> <span class="n">arbiter</span> <span class="k">for</span> <span class="n">some</span> <span class="n">beam</span> <span class="n">parameters</span>
    <span class="n">END_IF</span>

    <span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;JustEnteredRequest&#39;</span><span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">(</span><span class="n">nId</span><span class="p">),</span>
        <span class="s1">&#39;Check should fail. Request not arbitrated yet.&#39;</span><span class="p">);</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>

<span class="mi">8000</span><span class="p">:</span>
    <span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="s1">&#39;FullStack&#39;</span><span class="p">);</span>

<span class="n">END_CASE</span>


<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;VerifyBPRHasBP&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">fbHigherArb</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">(</span><span class="n">SysID</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span><span class="n">F_DifferentBeamParams</span><span class="p">(</span><span class="n">stReq</span><span class="p">,</span> <span class="n">fbBPR</span><span class="o">.</span><span class="n">q_ReqBP</span><span class="p">),</span>
        <span class="s1">&#39;Beam parameters not fully propagated to BPR at highest level&#39;</span><span class="p">);</span>
        <span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="s1">&#39;VerifyBPRHasBP&#39;</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;ArbToSubsysPropagation&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">fbArbToSubSys</span><span class="o">.</span><span class="n">nActiveCohort</span> <span class="o">=</span> <span class="n">fbArbToSubSys</span><span class="o">.</span><span class="n">nRequestedCohort</span>
    <span class="n">AND</span> <span class="n">fbArbToSubSys</span><span class="o">.</span><span class="n">nActiveCohort</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbHigherArb</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">(</span><span class="n">SysID</span><span class="p">),</span>
        <span class="s1">&#39;Active cohort = Requested cohort before higher arbiter confirmed request was active&#39;</span><span class="p">);</span>
    <span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="s1">&#39;ArbToSubsysPropagation&#39;</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;SubsysToArbPropagation&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">(</span><span class="n">nId</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbSubSysToArb</span><span class="o">.</span><span class="n">nActiveCohort</span> <span class="o">&gt;=</span> <span class="n">fbSubSysToArb</span><span class="o">.</span><span class="n">nRequestCohort</span><span class="p">,</span>
        <span class="s1">&#39;Request validated before higher level confirmation&#39;</span><span class="p">);</span>
    <span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="s1">&#39;SubsysToArbPropagation&#39;</span><span class="p">);</span>
<span class="n">END_IF</span>


<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;VerifyIncludedAtAllLevels&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">(</span><span class="n">nId</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbHigherArb</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">(</span><span class="n">fbArbToSubSys</span><span class="o">.</span><span class="n">RequestingSystemID</span><span class="p">),</span> <span class="s1">&#39;HigherArb is not yet included in arbitration&#39;</span><span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbSubSysToArb</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">nLowerAuthorityID</span><span class="p">),</span> <span class="s1">&#39;Local Arb is not yet included in arbitration&#39;</span><span class="p">);</span>
    <span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="s1">&#39;VerifyIncludedAtAllLevels&#39;</span><span class="p">);</span>
<span class="n">END_IF</span>


<span class="o">///////////////////////////////////////</span>
<span class="o">//</span><span class="n">Sub</span> <span class="n">system</span> <span class="n">cycle</span>
<span class="n">fbSubSysToArb</span><span class="p">(</span><span class="n">Arbiter</span> <span class="o">:=</span> <span class="n">fbArbiter</span><span class="p">,</span> <span class="n">fbFFHWO</span> <span class="o">:=</span> <span class="n">FFO</span><span class="p">);</span>
<span class="o">//</span><span class="n">END</span> <span class="n">of</span> <span class="n">sub</span> <span class="n">system</span> <span class="n">cycle</span>
<span class="o">///////////////////////////////////////</span>

<span class="o">//</span><span class="n">Ethercat</span> <span class="n">transfer</span> <span class="n">simulation</span>
<span class="o">//</span> <span class="n">Transfer</span> <span class="n">of</span> <span class="n">requested</span> <span class="n">BP</span> <span class="n">to</span> <span class="n">arbiter</span> <span class="n">PLC</span>
<span class="n">pBPR</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbArbToSubSys</span><span class="o">.</span><span class="n">i_RequestedBP</span><span class="p">);</span>
<span class="n">pBPR</span><span class="o">^</span> <span class="o">:=</span> <span class="n">fbSubSysToArb</span><span class="o">.</span><span class="n">q_stRequestedBP</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Transfer</span> <span class="n">of</span> <span class="n">current</span> <span class="n">BP</span> <span class="n">to</span> <span class="n">sub</span> <span class="n">system</span> <span class="n">PLC</span>
<span class="n">pBPC</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSubSysToArb</span><span class="o">.</span><span class="n">i_stCurrentBP</span><span class="p">);</span>
<span class="n">pBPC</span><span class="o">^</span> <span class="o">:=</span> <span class="n">fbArbToSubSys</span><span class="o">.</span><span class="n">o_CurrentBP</span><span class="p">;</span>

<span class="o">//////////////////////////////////////</span>
<span class="o">//</span><span class="n">Start</span> <span class="n">of</span> <span class="n">arbiter</span> <span class="n">plc</span> <span class="n">cycle</span>
<span class="o">//</span><span class="n">Arb</span> <span class="n">io</span> <span class="n">collects</span> <span class="n">sub</span> <span class="n">system</span> <span class="n">status</span>
<span class="n">fbArbToSubSys</span><span class="p">(</span><span class="n">Arbiter</span> <span class="o">:=</span> <span class="n">fbHigherArb</span><span class="p">,</span> <span class="n">fbFFHWO</span> <span class="o">:=</span> <span class="n">FFO</span><span class="p">);</span> <span class="o">//</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">making</span> <span class="n">a</span> <span class="n">request</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">higher</span> <span class="n">arb</span>
<span class="o">//</span><span class="n">BPR</span> <span class="n">collects</span> <span class="n">arbiter</span> <span class="n">summation</span>
<span class="n">fbBPR</span><span class="p">(</span><span class="n">Arbiter</span> <span class="o">:=</span> <span class="n">fbHigherArb</span><span class="p">);</span> <span class="o">//</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">getting</span> <span class="n">the</span> <span class="n">arbitrated</span> <span class="n">BP</span>




<span class="n">IF</span> <span class="n">CycleLimit</span> <span class="o">&gt;</span> <span class="n">Cycle</span> <span class="n">THEN</span>
    <span class="n">Cycle</span> <span class="o">:=</span> <span class="n">Cycle</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">Cycle</span> <span class="o">:=</span> <span class="mi">8000</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">RemoveReq</span>
<span class="n">VAR</span>

    <span class="n">Arb</span> <span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

    <span class="n">DummyHA</span> <span class="p">:</span> <span class="n">FB_DummyHA</span><span class="p">;</span>

    <span class="n">Result</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">Arb</span><span class="o">.</span><span class="n">AddRequest</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cst0RateBeam</span><span class="p">,</span> <span class="s1">&#39;Device&#39;</span><span class="p">);</span>

<span class="n">Arb</span><span class="o">.</span><span class="n">ElevateRequest</span><span class="p">(</span><span class="n">DummyHA</span><span class="p">);</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;Remove Req&#39;</span><span class="p">);</span>
    <span class="n">Result</span> <span class="o">:=</span> <span class="n">Arb</span><span class="o">.</span><span class="n">RemoveRequest</span><span class="p">(</span><span class="mi">77</span><span class="p">);</span>

    <span class="n">AssertFalse</span><span class="p">(</span> <span class="n">Result</span><span class="p">,</span> <span class="s1">&#39;RemoveReq returned true, with nothing to remove&#39;</span><span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span> <span class="n">Arb</span><span class="o">.</span><span class="n">bStartNewAckRequest</span> <span class="p">,</span> <span class="s1">&#39;StartNewAckRequest is set. Something is wrong&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">RequestCheckRemoveBP</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>

    <span class="n">nId</span>    <span class="p">:</span>    <span class="n">DWORD</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">stReq</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbArbiter</span>    <span class="p">:</span>    <span class="n">FB_Arbiter</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;RequestBP&#39;</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">AddRequest</span><span class="p">(</span><span class="n">nId</span><span class="p">,</span> <span class="n">stReq</span><span class="p">,</span> <span class="s1">&#39;Device&#39;</span><span class="p">),</span>
    <span class="s1">&#39;Request failed&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;DuplicateID&#39;</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">AddRequest</span><span class="p">(</span><span class="n">nId</span><span class="p">,</span> <span class="n">stReq</span><span class="p">,</span> <span class="s1">&#39;Device&#39;</span><span class="p">),</span>
    <span class="s1">&#39;Duplicate request accepted, not good.&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;CheckBP&#39;</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">(</span><span class="n">nId</span><span class="p">),</span>
    <span class="s1">&#39;Check should fail. Request not arbitrated yet.&#39;</span><span class="p">);</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;CheckBPArbitrated&#39;</span><span class="p">);</span>
<span class="n">WRITE_PROTECTED_ULINT</span><span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">nActiveCohort</span><span class="p">),</span> <span class="n">fbArbiter</span><span class="o">.</span><span class="n">nNextCohort</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">(</span><span class="n">nId</span><span class="p">),</span>
    <span class="s1">&#39;Check should pass.&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;IDDoesNotExist&#39;</span><span class="p">);</span>

<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">(</span><span class="n">nId</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
    <span class="s1">&#39;Check returned true when ID does not exist&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;RemoveBP&#39;</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">RemoveRequest</span><span class="p">(</span><span class="n">nId</span><span class="p">),</span>
    <span class="s1">&#39;Remove failed&#39;</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">(</span><span class="n">nId</span><span class="p">),</span>
    <span class="s1">&#39;Remove did not remove request&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;NoRequestsFullBeam&#39;</span><span class="p">);</span>

<span class="n">AssertFalse</span><span class="p">(</span><span class="n">F_DifferentBeamParams</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">GetArbitratedBP</span><span class="p">(),</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstFullBeam</span><span class="p">),</span> <span class="s1">&#39;Arbitrated beam should be full with all requests removed&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">StackArbiters</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nId</span>    <span class="p">:</span>    <span class="n">DWORD</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">stReq</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="p">(</span><span class="n">nTran</span><span class="o">:=</span><span class="mi">12</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbArbiter</span>    <span class="p">:</span>    <span class="n">FB_Arbiter</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="n">fbHigherArb</span> <span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

    <span class="n">ArbBP</span> <span class="p">:</span> <span class="n">ST_BeamParams</span><span class="p">;</span>

    <span class="n">Cycle</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">CycleLimit</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">SysID</span> <span class="p">:</span> <span class="n">DWORD</span> <span class="o">:=</span> <span class="mi">42</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;StackingArbiters&#39;</span><span class="p">);</span>
<span class="n">fbArbiter</span><span class="o">.</span><span class="n">AddRequest</span><span class="p">(</span><span class="n">nReqID</span><span class="o">:=</span><span class="n">nId</span><span class="p">,</span> <span class="n">stReqBP</span><span class="o">:=</span><span class="n">stReq</span><span class="p">,</span> <span class="n">sDevName</span> <span class="o">:=</span><span class="s1">&#39;Device&#39;</span><span class="p">);</span>

<span class="n">fbArbiter</span><span class="o">.</span><span class="n">ElevateRequest</span><span class="p">(</span><span class="n">fbHigherArb</span><span class="p">);</span>

<span class="n">ArbBP</span> <span class="o">:=</span> <span class="n">fbHigherArb</span><span class="o">.</span><span class="n">GetArbitratedBP</span><span class="p">();</span>

<span class="n">AssertTrue</span><span class="p">(</span><span class="n">ArbBP</span><span class="o">.</span><span class="n">nTran</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;We should see the transmission number here&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-arbdosteststates">E_ArbDosTestStates</a></p></li>
<li><p><a class="reference internal" href="#fb-arbiter">FB_Arbiter</a></p></li>
<li><p><a class="reference internal" href="#fb-arbitertosubsys-io">FB_ArbiterToSubSys_IO</a></p></li>
<li><p><a class="reference internal" href="#fb-bprequestor">FB_BPRequestor</a></p></li>
<li><p><a class="reference internal" href="#fb-dummyha">FB_DummyHA</a></p></li>
<li><p><a class="reference internal" href="#fb-hardwareffoutput">FB_HardwareFFOutput</a></p></li>
<li><p><a class="reference internal" href="#fb-subsystoarbiter-io">FB_SubSysToArbiter_IO</a></p></li>
<li><p><a class="reference internal" href="#f-differentbeamparams">F_DifferentBeamParams</a></p></li>
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
<li><p><a class="reference internal" href="#pmps-param">PMPS_PARAM</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-arbitertosubsys-io">
<h2>FB_ArbiterToSubSys_IO<a class="headerlink" href="#fb-arbitertosubsys-io" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(* Exchanges preemption requests and current beam state with subsystems in arbiter
network.

2019-12-2, A. Wallace

Use in conjunction with FB_SubSysToArbiter_IO.

This FB runs in the beamline arbiter PLC (BAP). There should be one of these for every
subsystem interfaced to the BAP. Each subsystem PLC should run a sibling FB_SubSysToArbiter_IO FB.

This FB and its subordinate communicate through the ethercat connection between the subsystem PLC and the BAP.

A beam parameter set request is sent from the subsystem to this PLC, and includes a cohort number.

This cohort number (i_RequestedBP.nCohortInt) is compared to a local cohort number (nRequestedCohort).
A request from the subsystem to update or modify its current request is indicated by an increase in the
i_RequestedBP.nCohortInt value. Then this function block updates the local arbiter request for the subsystem
and awaits confirmation. Once the new request is confirmed in the preemptive system this function block increments
the ActiveCohort value to match the nRequestedCohort. ActiveCohort is also relayed back to the subsystem
as the active cohort value in the o_CurrentBP set. The subsystem then knows its request has been heard,
and can carry out its own acknowledgement to its various requestors.

Things to note:
If a subsystem has any new or changed preemptive requests you should see the cohort value increment a bit.
If the cohort number is incrementing out of control, it usually means the subsysetm has some preemptive
request loop (two arbiters elevating to each other), or there is a RequestAdd, RequestRemove loop.

*)
FUNCTION_BLOCK FB_ArbiterToSubSys_IO
VAR_INPUT
    RequestingSystemID      :       DWORD := PMPS_GVL.EXCLUDED_ASSERTION_ID; // System ID for making requests to the supreme arbiter
    sName : STRING := &#39;ArbiterToSubSys&#39;;
    Reset : BOOL;
END_VAR
VAR_OUTPUT
END_VAR
VAR_IN_OUT
    Arbiter : FB_Arbiter;
    fbFFHWO : FB_HardwareFFOutput;
END_VAR
VAR

    i_RequestedBP AT %I*    :       ST_BeamParams_IO; // Requested BP from subsystem
    {attribute &#39;pytmc&#39; := &#39;
        pv: RequestedBP:FromSubSys
    &#39;}
    RequestedBP: ST_BeamParams;

    o_CurrentBP AT %Q* : ST_BeamParams_IO; // Current BP set

    // EL6692 Diagnostics
    i_Connected AT %I* : BOOL; // SYNC Inputs^External device not connected !!! Doesn&#39;t really work.
    {attribute &#39;pytmc&#39; := &#39;pv: WcState
        io: i
        field: DESC Working counter state.
        field: ZNAM OK
        field: ONAM Error&#39;}
    i_WcState AT %I* : BOOL := TRUE; // WcState^WcState
    {attribute &#39;pytmc&#39; := &#39;pv: TxPDO_state
        io: i
        field: DESC PDO Transmission is OK
        field: ZNAM OK
        field: ONAM Error&#39;}
    i_TxPDOState AT %I* : BOOL := TRUE; // SYNC Inputs^TxPDO state
    {attribute &#39;pytmc&#39; := &#39;pv: TxPDO_toggle
        io: i
        field: DESC PDO Transmission is OK
        field: ZNAM OK
        field: ONAM Error&#39;}
    i_TxPDOToggle AT %I* : BOOL; // TxPDO toggle

    // Fast faults
    ffPMPSIO_Disconnect : FB_FastFault := (i_Desc:=&#39;Issue w/ arbiter interface to subsystem, verify subsystem is OK, or ethercat connection.&#39;); // Fast fault for ethercat issues
    nActiveCohort : UDINT := 0; // Active cohort. Updated to the req. number from the sub system after request is confirmed.
    nRequestedCohort : UDINT := 0;
    rtToggle : R_TRIG;


END_VAR
// Incoming request from subsystem PLC
RequestedBP := IO_TO_BP(i_RequestedBP);

// Update Arbiter with our request
rtToggle(CLK:= i_RequestedBP.xValid); // If interface resumes, reset/catch up
// xValid will go false if the PLC program on the other side is stopped. Ironically the ethercat interface continues happily.
// If subsystem cohort has incremented, update beam parameter request with our arbiter
IF rtToggle.Q THEN
    nActiveCohort := 0;
END_IF

IF i_RequestedBP.nCohortInt &gt; nRequestedCohort OR rtToggle.Q THEN
    Arbiter.RemoveRequest(RequestingSystemID);
    Arbiter.AddRequest(RequestingSystemID, RequestedBP,sName);
    nRequestedCohort := i_RequestedBP.nCohortInt;
END_IF


// Check if latest request is acknowledged by this arbiter
// Acknowledgement happens after an arbitration cycle, which means if RequestedCohort just incremented
// due to a new request, CheckRequest will be false.
IF Arbiter.CheckRequest(RequestingSystemID) THEN
    nActiveCohort := nRequestedCohort; // If it is, then the active cohort is set to the requested cohort number.
END_IF

// Sending current beam parameter set to subsystems
o_CurrentBP := BP_TO_IO(PMPS_GVL.stCurrentBeamParameters);
o_CurrentBP.nCohortInt := nActiveCohort;


//////////////////////////////////////
// Verifying the ethercat interface health
/////////////////////////////////////
// Both of these values should be 0 for a fully valid exchange
ffPMPSIO_Disconnect.i_xOK := NOT i_WcState AND NOT i_TxPDOState;

ffPMPSIO_Disconnect(
    io_fbFFHWO := fbFFHWO,
    i_xReset := Reset,
    i_DevName := sName,
    i_TypeCode:=5);

END_FUNCTION_BLOCK
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#bp-to-io">BP_TO_IO</a></p></li>
<li><p><a class="reference internal" href="#fb-arbiter">FB_Arbiter</a></p></li>
<li><p><a class="reference internal" href="#fb-fastfault">FB_FastFault</a></p></li>
<li><p><a class="reference internal" href="#fb-hardwareffoutput">FB_HardwareFFOutput</a></p></li>
<li><p><a class="reference internal" href="#fb-subsystoarbiter-io">FB_SubSysToArbiter_IO</a></p></li>
<li><p><a class="reference internal" href="#io-to-bp">IO_TO_BP</a></p></li>
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-arbtosubsys-test">
<h2>FB_ArbToSubsys_Test<a class="headerlink" href="#fb-arbtosubsys-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;call_after_init&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_ArbToSubsys_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">BasicFunction</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_check&#39;</span><span class="p">}</span>
<span class="n">METHOD</span> <span class="n">BasicFunction</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">SysID</span> <span class="p">:</span> <span class="n">DWORD</span> <span class="o">:=</span> <span class="mi">42</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nId</span>    <span class="p">:</span>    <span class="n">DWORD</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">stReq</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="p">(</span><span class="n">nTran</span><span class="o">:=</span><span class="mi">12</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbArbiter</span>    <span class="p">:</span>    <span class="n">FB_Arbiter</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="n">pBPR</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_BeamParams_IO</span><span class="p">;</span>

    <span class="n">stBPRIO</span> <span class="p">:</span> <span class="n">ST_BeamParams_IO</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">nCohortInt</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">nTran</span> <span class="o">:=</span> <span class="mi">35</span><span class="p">);</span> <span class="o">//</span> <span class="n">Simulates</span> <span class="n">subsystem</span> <span class="n">BP</span> <span class="n">request</span>

    <span class="n">fbArbToSubSys</span> <span class="p">:</span> <span class="n">FB_ArbiterToSubSys_IO</span> <span class="o">:=</span> <span class="p">(</span><span class="n">RequestingSystemID</span><span class="o">:=</span><span class="mi">42</span><span class="p">);</span> <span class="o">//</span> <span class="n">Beamline</span> <span class="n">arbiter</span> <span class="n">PLC</span> <span class="n">interface</span> <span class="k">with</span> <span class="n">subsystems</span>
    <span class="n">pBPC</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_BeamParams_IO</span><span class="p">;</span>

    <span class="n">fbBPR</span> <span class="p">:</span> <span class="n">FB_BPRequestor</span><span class="p">;</span> <span class="o">//</span> <span class="n">Use</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">arbiter</span> <span class="n">PLC</span> <span class="n">to</span> <span class="n">apply</span> <span class="n">an</span> <span class="n">arbitrated</span> <span class="n">beam</span> <span class="n">parameter</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">the</span> <span class="n">accelerator</span> <span class="n">interface</span>

    <span class="n">FFO</span> <span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span> <span class="o">//</span> <span class="n">Dummy</span> <span class="n">FFO</span> <span class="ow">not</span> <span class="n">important</span> <span class="k">for</span> <span class="n">these</span> <span class="n">tests</span>

    <span class="n">Cycle</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">CycleLimit</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Simulate</span> <span class="n">an</span> <span class="n">initial</span> <span class="n">cycle</span> <span class="k">with</span> <span class="n">no</span> <span class="n">new</span> <span class="n">requests</span> <span class="n">coming</span> <span class="ow">in</span>
<span class="n">fbBPR</span><span class="p">(</span><span class="n">Arbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">);</span>
<span class="n">fbArbToSubSys</span><span class="p">(</span><span class="n">Arbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span> <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">FFO</span><span class="p">);</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;Init&#39;</span><span class="p">);</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>

<span class="o">//</span><span class="n">Ethercat</span> <span class="n">transfer</span> <span class="n">simulation</span>
<span class="o">//</span> <span class="n">Transfer</span> <span class="n">of</span> <span class="n">requested</span> <span class="n">BP</span> <span class="n">to</span> <span class="n">arbiter</span> <span class="n">PLC</span>
<span class="n">pBPR</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbArbToSubSys</span><span class="o">.</span><span class="n">i_RequestedBP</span><span class="p">);</span>
<span class="n">pBPR</span><span class="o">^</span> <span class="o">:=</span> <span class="n">stBPRIO</span><span class="p">;</span>

<span class="o">///////////////////////////////////////</span>
<span class="o">//</span><span class="n">Sub</span> <span class="n">system</span> <span class="n">cycle</span>
<span class="n">fbBPR</span><span class="p">(</span><span class="n">Arbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">);</span>
<span class="n">fbArbToSubSys</span><span class="p">(</span><span class="n">Arbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span> <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">FFO</span><span class="p">);</span>
<span class="o">//</span><span class="n">END</span> <span class="n">of</span> <span class="n">sub</span> <span class="n">system</span> <span class="n">cycle</span>
<span class="o">///////////////////////////////////////</span>


<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;New request&#39;</span><span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbToSubSys</span><span class="o">.</span><span class="n">nRequestedCohort</span> <span class="o">=</span> <span class="n">fbArbToSubSys</span><span class="o">.</span><span class="n">i_RequestedBP</span><span class="o">.</span><span class="n">nCohortInt</span><span class="p">,</span> <span class="s1">&#39;ReqCohort and qBP Cohort do not match, and they should&#39;</span><span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequestInPool</span><span class="p">(</span><span class="n">SysID</span><span class="p">),</span> <span class="s1">&#39;ArbToSubSys request should be in arbiter pool now&#39;</span><span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbToSubSys</span><span class="o">.</span><span class="n">nActiveCohort</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Active cohort should remain the initial value until the current request is active in higher arbitration&#39;</span><span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbToSubSys</span><span class="o">.</span><span class="n">o_CurrentBP</span><span class="o">.</span><span class="n">nCohortInt</span> <span class="o">=</span> <span class="n">fbArbToSubSys</span><span class="o">.</span><span class="n">nActiveCohort</span><span class="p">,</span> <span class="s1">&#39;Cohort being sent to sub system remains unincremented&#39;</span><span class="p">);</span>
<span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="s1">&#39;New request&#39;</span><span class="p">);</span>


<span class="o">///////////////////////////////////////</span>
<span class="o">//</span><span class="n">Sub</span> <span class="n">system</span> <span class="n">cycle</span>
<span class="n">fbBPR</span><span class="p">(</span><span class="n">Arbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">);</span>
<span class="n">fbArbToSubSys</span><span class="p">(</span><span class="n">Arbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span> <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">FFO</span><span class="p">);</span>
<span class="o">//</span><span class="n">END</span> <span class="n">of</span> <span class="n">sub</span> <span class="n">system</span> <span class="n">cycle</span>
<span class="o">///////////////////////////////////////</span>

<span class="o">///////////////////////////////////////</span>
<span class="o">//</span><span class="n">Sub</span> <span class="n">system</span> <span class="n">cycle</span>
<span class="n">fbBPR</span><span class="p">(</span><span class="n">Arbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">);</span>
<span class="n">fbArbToSubSys</span><span class="p">(</span><span class="n">Arbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span> <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">FFO</span><span class="p">);</span>
<span class="o">//</span><span class="n">END</span> <span class="n">of</span> <span class="n">sub</span> <span class="n">system</span> <span class="n">cycle</span>
<span class="o">///////////////////////////////////////</span>

<span class="o">///////////////////////////////////////</span>
<span class="o">//</span><span class="n">Sub</span> <span class="n">system</span> <span class="n">cycle</span>
<span class="n">fbBPR</span><span class="p">(</span><span class="n">Arbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">);</span>
<span class="n">fbArbToSubSys</span><span class="p">(</span><span class="n">Arbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span> <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">FFO</span><span class="p">);</span>
<span class="o">//</span><span class="n">END</span> <span class="n">of</span> <span class="n">sub</span> <span class="n">system</span> <span class="n">cycle</span>
<span class="o">///////////////////////////////////////</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;Request has become active&#39;</span><span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbToSubSys</span><span class="o">.</span><span class="n">nRequestedCohort</span> <span class="o">=</span> <span class="n">fbArbToSubSys</span><span class="o">.</span><span class="n">nActiveCohort</span><span class="p">,</span> <span class="s1">&#39;ReqCohort and qBP Cohort do not match, and they should&#39;</span><span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">(</span><span class="n">SysID</span><span class="p">),</span> <span class="s1">&#39;ArbToSubSys request should be in arbiter pool now&#39;</span><span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbToSubSys</span><span class="o">.</span><span class="n">nActiveCohort</span> <span class="o">=</span> <span class="n">stBPRIO</span><span class="o">.</span><span class="n">nCohortInt</span><span class="p">,</span> <span class="s1">&#39;Active cohort should remain the initial value until the current request is active in higher arbitration&#39;</span><span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbBPR</span><span class="o">.</span><span class="n">q_ReqBP</span><span class="o">.</span><span class="n">nTran</span> <span class="o">=</span> <span class="n">stBPRIO</span><span class="o">.</span><span class="n">nTran</span><span class="p">,</span> <span class="s1">&#39;BPR and requested BP should match&#39;</span><span class="p">);</span>
<span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="s1">&#39;Request has become active&#39;</span><span class="p">);</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-arbiter">FB_Arbiter</a></p></li>
<li><p><a class="reference internal" href="#fb-arbitertosubsys-io">FB_ArbiterToSubSys_IO</a></p></li>
<li><p><a class="reference internal" href="#fb-bprequestor">FB_BPRequestor</a></p></li>
<li><p><a class="reference internal" href="#fb-hardwareffoutput">FB_HardwareFFOutput</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-attenuatorsimulator">
<h2>FB_AttenuatorSimulator<a class="headerlink" href="#fb-attenuatorsimulator" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_AttenuatorSimulator</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_rRequestedAttenuation</span>    <span class="p">:</span>    <span class="n">REAL</span><span class="p">;</span>
    <span class="n">i_stBPReadback</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">q_xFault</span>    <span class="p">:</span>    <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_rCurrentAttenuation</span>    <span class="p">:</span>    <span class="n">REAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Arbiter</span>    <span class="p">:</span>    <span class="n">FB_Arbiter</span><span class="p">;</span> <span class="o">//</span><span class="n">Higher</span> <span class="n">level</span> <span class="n">arbiter</span> <span class="kn">from</span><span class="w"> </span><span class="nn">which</span> <span class="n">upstream</span> <span class="n">attenuation</span> <span class="n">can</span> <span class="n">be</span> <span class="n">requested</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">tonDelay</span>    <span class="p">:</span>    <span class="n">TON</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">PT</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#3S</span>
        <span class="p">);</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Really</span> <span class="n">basic</span> <span class="n">delay</span>
<span class="n">tonDelay</span><span class="p">(</span><span class="n">IN</span> <span class="o">:=</span> <span class="n">i_rRequestedAttenuation</span> <span class="o">&lt;&gt;</span> <span class="n">q_rCurrentAttenuation</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">tonDelay</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">q_rCurrentAttenuation</span> <span class="o">:=</span> <span class="n">i_rRequestedAttenuation</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-arbiter">FB_Arbiter</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-beamclassfromepics">
<h2>FB_BeamClassFromEPICS<a class="headerlink" href="#fb-beamclassfromepics" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_BeamClassFromEPICS</span>

<span class="p">(</span><span class="o">*</span>
<span class="n">enum</span> <span class="n">MPSBeamClass</span> <span class="p">{</span>
    <span class="n">Beam</span> <span class="n">Off</span>    <span class="o">=</span>  <span class="mi">0</span><span class="p">,</span>
    <span class="n">Kicker</span> <span class="n">STBY</span> <span class="o">=</span>  <span class="mi">1</span><span class="p">,</span>
    <span class="n">BC1Hz</span>       <span class="o">=</span>  <span class="mi">2</span><span class="p">,</span>
    <span class="n">BC10Hz</span>      <span class="o">=</span>  <span class="mi">3</span><span class="p">,</span>
    <span class="n">Diagnostic</span>  <span class="o">=</span>  <span class="mi">4</span><span class="p">,</span>
    <span class="n">BC120Hz</span>     <span class="o">=</span>  <span class="mi">5</span><span class="p">,</span>
    <span class="n">Tuning</span>      <span class="o">=</span>  <span class="mi">6</span><span class="p">,</span>
    <span class="mi">1</span><span class="o">%</span> <span class="n">MAP</span>      <span class="o">=</span>  <span class="mi">7</span><span class="p">,</span>
    <span class="mi">5</span><span class="o">%</span> <span class="n">MAP</span>      <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="mi">10</span><span class="o">%</span> <span class="n">MAP</span>     <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
    <span class="mi">25</span><span class="o">%</span> <span class="n">MAP</span>     <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="mi">50</span><span class="o">%</span> <span class="n">MAP</span>     <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
    <span class="mi">100</span><span class="o">%</span> <span class="n">MAP</span>    <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
    <span class="n">FULL</span>        <span class="o">=</span> <span class="mi">13</span><span class="p">,</span>
    <span class="n">SPARE</span>       <span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
    <span class="n">SPARE</span>       <span class="o">=</span> <span class="mi">15</span>
<span class="p">}</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">VAR_IN_OUT</span>
    <span class="n">BP</span> <span class="p">:</span> <span class="n">ST_BeamParams</span><span class="p">;</span>
    <span class="n">fbMPS_BeamClass</span> <span class="p">:</span> <span class="n">FB_LREALFromEPICS</span><span class="p">;</span>
    <span class="n">FFO</span> <span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">xError</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>


    <span class="n">ffBeamClassReadBack</span> <span class="p">:</span> <span class="n">FB_FastFault</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">i_DevName</span> <span class="o">:=</span> <span class="s1">&#39;Arbiter&#39;</span><span class="p">,</span>
        <span class="n">i_Desc</span> <span class="o">:=</span> <span class="s1">&#39;Issue with beam class readback from Accelerator. Gateway or EPICS connection. Must be fixed.&#39;</span><span class="p">,</span>
        <span class="n">i_TypeCode</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#213,</span>
        <span class="n">i_xAutoReset</span><span class="o">:=</span><span class="kc">True</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">cFailSafeBC</span> <span class="p">:</span> <span class="n">USINT</span> <span class="o">:=</span> <span class="mi">16</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">fbMPS_BeamClass</span><span class="p">();</span>

<span class="n">IF</span> <span class="n">fbMPS_BeamClass</span><span class="o">.</span><span class="n">bValid</span> <span class="n">THEN</span>
    <span class="n">BP</span><span class="o">.</span><span class="n">nBeamClass</span> <span class="o">:=</span> <span class="n">LREAL_TO_USINT</span><span class="p">(</span><span class="n">fbMPS_BeamClass</span><span class="o">.</span><span class="n">fValue</span><span class="p">);</span>
<span class="n">ELSE</span>
    <span class="n">BP</span><span class="o">.</span><span class="n">nBeamClass</span> <span class="o">:=</span> <span class="n">cFailSafeBC</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">BP</span><span class="o">.</span><span class="n">nBCRange</span> <span class="o">:=</span> <span class="n">TO_WORD</span><span class="p">(</span><span class="n">BP</span><span class="o">.</span><span class="n">nBeamClass</span><span class="p">);</span>

<span class="n">ffBeamClassReadback</span><span class="p">(</span><span class="n">i_xOK</span><span class="o">:=</span><span class="n">fbMPS_BeamClass</span><span class="o">.</span><span class="n">bValid</span><span class="p">,</span> <span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">FFO</span><span class="p">);</span>

<span class="n">BP</span><span class="o">.</span><span class="n">xValid</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">fbMPS_BeamClass</span><span class="o">.</span><span class="n">bValid</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-fastfault">FB_FastFault</a></p></li>
<li><p><a class="reference internal" href="#fb-hardwareffoutput">FB_HardwareFFOutput</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-beamclassoutputs">
<h2>FB_BeamClassOutputs<a class="headerlink" href="#fb-beamclassoutputs" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(*
Sets the beam class assertion lines for a given beam class.
*)
{attribute &#39;no_check&#39;}
FUNCTION_BLOCK FB_BeamClassOutputs
VAR_INPUT
    BP : ST_BeamParams;
END_VAR
VAR_OUTPUT
END_VAR
VAR
    nBeamClass   :    BYTE;
    wBeamClass    :    BYTE;

    InitCounter: BYTE;
    counter    :    INT;

    // Beam class lines are restricted to 8 channels in the current design, since
    // there are no plans to use all 16. Channels 1-7 may be allocated to any other
    // beam classes so long as they are ordered least to greatest.
    // Channel 8 is reserved for full beam.
    {attribute &#39;pytmc&#39; := &#39;pv: BeamClassChannel
        io: i
        field: DESC Hardwire channel state&#39;}
        epicsBitmap : WORD;

    {attribute &#39;TcLinkTo&#39; := &#39;[1] := TIIB[PMPS_Premp]^Channel 1^Output;
                              [2] := TIIB[PMPS_Premp]^Channel 2^Output;
                              [3] := TIIB[PMPS_Premp]^Channel 3^Output;
                              [4] := TIIB[PMPS_Premp]^Channel 4^Output;

                              [5] := TIIB[PMPS_Premp]^Channel 5^Output;
                              [6] := TIIB[PMPS_Premp]^Channel 6^Output;
                              [7] := TIIB[PMPS_Premp]^Channel 7^Output;
                              [8] := TIIB[PMPS_Premp]^Channel 8^Output;&#39;} // 8 - Full beam
    q_BC_ASSERTION_LINES    AT    %Q*    : ARRAY [1..MAX_BEAM_CLASS_LINES] OF    BOOL;
END_VAR
VAR CONSTANT
    //Limited to total of 6 digital outputs
    MAX_BEAM_CLASS_LINES : BYTE := 8;
    BC_1HZ : BYTE := 1;
    BC_10HZ : BYTE := 2;
    BC_FULL : BYTE := 16;
END_VAR
// Determine BC
IF BP.nRate &gt;= 120 THEN
    nBeamClass := BC_FULL;
ELSIF BP.nRate &gt;= 10 THEN
    nBeamClass := BC_10HZ;
ELSIF BP.nRate &gt;= 1 THEN
    nBeamClass := BC_1HZ;
ELSE
    nBeamClass := 0;
END_IF


//Assert Beam Class
////////////////////////////////////
//0x0 = 0000 0000 0000 0000
//0x1 = 0000 0000 0000 0001
//0xF = 1111 1111 1111 1111

//Initialize BC lines to zero on every pass
FOR InitCounter := 1 TO MAX_BEAM_CLASS_LINES DO
    q_BC_ASSERTION_LINES[InitCounter] := FALSE;
END_FOR

//Set BC lines according to beam class
//A BC of 0x0 would pass over this loop, setting none of the lines high
// , as FOR loops check the initialized variable at the top to see if it&#39;s &gt;
// than the &quot;TO&quot; variable.
FOR wBeamClass:=1 TO MIN(MAX_BEAM_CLASS_LINES-1, nBeamClass) DO
    q_BC_ASSERTION_LINES[wBeamClass] := TRUE;
END_FOR

q_BC_ASSERTION_LINES[8] := nBeamClass = 16; //Set channel 8 true if BC is 16


// Readbacks for EPICS
epicsBitmap.0 := q_BC_ASSERTION_LINES[1];
epicsBitmap.1 := q_BC_ASSERTION_LINES[2];
epicsBitmap.2 := q_BC_ASSERTION_LINES[3];
epicsBitmap.3 := q_BC_ASSERTION_LINES[4];

epicsBitmap.4 := q_BC_ASSERTION_LINES[5];
epicsBitmap.5 := q_BC_ASSERTION_LINES[6];
epicsBitmap.6 := q_BC_ASSERTION_LINES[7];
epicsBitmap.7 := q_BC_ASSERTION_LINES[8];

END_FUNCTION_BLOCK
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-beamclassoutputs-bcd">
<h2>FB_BeamClassOutputs_BCD<a class="headerlink" href="#fb-beamclassoutputs-bcd" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(*
Sets the beam class assertion lines for a given beam class.
*)
{attribute &#39;no_check&#39;}
FUNCTION_BLOCK FB_BeamClassOutputs_BCD
VAR_INPUT
    BP : ST_BeamParams;
END_VAR
VAR_OUTPUT
END_VAR
VAR
    nBeamClass   :    BYTE;
    wBeamClass    :    BYTE;

    InitCounter: BYTE;
    counter    :    INT;

    // Beam class lines are restricted to 4 channels in the current design.
    // There are 16 possible beamclasses with 0 -15 with 0 no beam.
    // First out put is the LSB and bit 4 is MSB
    {attribute &#39;pytmc&#39; := &#39;pv: BeamClassChannel
        io: i
        field: DESC Hardwire channel state&#39;}
        epicsBitmap : WORD;

    {attribute &#39;TcLinkTo&#39; := &#39;[1] := TIIB[PMPS_Premp]^Channel 1^Output;
                              [2] := TIIB[PMPS_Premp]^Channel 2^Output;
                              [3] := TIIB[PMPS_Premp]^Channel 3^Output;
                              [4] := TIIB[PMPS_Premp]^Channel 4^Output;&#39;}
    q_BC_ASSERTION_LINES    AT    %Q*    : ARRAY [1..MAX_BEAM_CLASS_LINES] OF    BOOL;
END_VAR
VAR CONSTANT
    //Limited to total of 4 digital outputs
    MAX_BEAM_CLASS_LINES : BYTE := 4;

END_VAR
//Initialize BC lines to zero on every pass
FOR InitCounter := 1 TO MAX_BEAM_CLASS_LINES DO
    q_BC_ASSERTION_LINES[InitCounter] := FALSE;
END_FOR

//Set BC lines according to beam class
// There are 4 digital outputs the BC is going to be a BCD
q_BC_ASSERTION_LINES[1] := BP.nBeamClass.0;
q_BC_ASSERTION_LINES[2] := BP.nBeamClass.1;
q_BC_ASSERTION_LINES[3] := BP.nBeamClass.2;
q_BC_ASSERTION_LINES[4] := BP.nBeamClass.3;

// Readbacks for EPICS
epicsBitmap.0 := q_BC_ASSERTION_LINES[1];
epicsBitmap.1 := q_BC_ASSERTION_LINES[2];
epicsBitmap.2 := q_BC_ASSERTION_LINES[3];
epicsBitmap.3 := q_BC_ASSERTION_LINES[4];

END_FUNCTION_BLOCK
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-beamclasswatcher">
<h2>FB_BeamClassWatcher<a class="headerlink" href="#fb-beamclasswatcher" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span>
<span class="n">M</span><span class="o">.</span> <span class="n">Ghaly</span>
<span class="n">The</span> <span class="n">Beam</span> <span class="k">class</span><span class="w"> </span><span class="nc">watcher</span> <span class="n">ensures</span> <span class="n">the</span> <span class="n">current</span> <span class="ow">and</span> <span class="n">target</span> <span class="n">beam</span> <span class="k">class</span><span class="w"> </span><span class="nc">is</span> <span class="n">within</span>
<span class="n">the</span> <span class="n">arbirated</span> <span class="n">bounds</span><span class="o">.</span>


<span class="n">The</span> <span class="n">abritrated</span> <span class="n">bounds</span> <span class="n">come</span> <span class="kn">from</span><span class="w"> </span><span class="nn">a</span> <span class="n">simple</span> <span class="n">AND</span> <span class="n">of</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">permitted</span> <span class="n">beam</span> <span class="k">class</span><span class="w"> </span><span class="nc">ranges</span><span class="o">.</span> <span class="n">See</span>
<span class="n">the</span> <span class="n">arbitrate</span> <span class="n">action</span> <span class="n">of</span> <span class="n">the</span> <span class="n">arbiter</span> <span class="n">FB</span><span class="o">.</span> <span class="n">It</span> <span class="n">also</span> <span class="n">reads</span> <span class="n">a</span> <span class="n">PV</span> <span class="ow">and</span> <span class="n">ensures</span> <span class="n">that</span> <span class="n">the</span> <span class="n">asserted</span> <span class="n">Beam</span> <span class="n">Class</span>
<span class="ow">is</span> <span class="n">the</span> <span class="n">same</span> <span class="k">as</span> <span class="n">the</span> <span class="n">PV</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">ATCA</span> <span class="n">crate</span>

<span class="n">Note</span><span class="p">,</span> <span class="n">this</span> <span class="n">protection</span> <span class="n">logic</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">account</span> <span class="k">for</span> <span class="n">beam</span><span class="o">-</span><span class="n">off</span> <span class="n">when</span> <span class="n">determining</span> <span class="n">fast</span><span class="o">-</span><span class="n">fault</span>
<span class="n">status</span><span class="o">.</span> <span class="n">If</span> <span class="n">a</span> <span class="n">device</span> <span class="ow">is</span> <span class="n">requesting</span> <span class="n">a</span> <span class="n">limited</span> <span class="nb">range</span> <span class="n">of</span> <span class="n">BC</span><span class="p">,</span> <span class="n">this</span> <span class="n">request</span> <span class="n">must</span> <span class="n">be</span> <span class="n">honored</span><span class="p">,</span>
<span class="n">regardless</span> <span class="n">of</span> <span class="n">current</span> <span class="n">beam</span><span class="o">-</span><span class="n">rate</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;reflection&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_BeamClassWatcher</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_stCurrentBeamParams</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span> <span class="o">//</span><span class="n">Link</span> <span class="n">to</span> <span class="k">global</span> <span class="n">beam</span> <span class="n">params</span>
    <span class="n">i_stMachineTargetBeamParams</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span> <span class="o">//</span><span class="n">Link</span> <span class="n">to</span> <span class="k">global</span> <span class="n">machine</span> <span class="n">target</span> <span class="n">beam</span> <span class="n">params</span>
    <span class="n">i_stRequestedBeamParams</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span> <span class="o">//</span><span class="n">Link</span> <span class="n">to</span> <span class="n">arbiter</span> <span class="n">output</span> <span class="ow">or</span> <span class="n">beam</span> <span class="n">param</span><span class="o">.</span> <span class="n">requestor</span>
    <span class="o">//</span><span class="n">Auto</span> <span class="n">Reset</span> <span class="n">fault</span>
    <span class="n">i_xAutoReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">sName</span> <span class="p">:</span> <span class="n">STRING</span> <span class="o">:=</span> <span class="s1">&#39;BeamClassWatcher&#39;</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">io_fbFFHWO</span>    <span class="p">:</span>    <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">xBeamClassWithinBounds</span>    <span class="p">:</span>    <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fbFF</span>    <span class="p">:</span>    <span class="n">FB_FastFault</span> <span class="o">:=</span><span class="p">(</span>
        <span class="n">i_DevName</span> <span class="o">:=</span> <span class="n">sName</span><span class="p">,</span>
        <span class="n">i_Desc</span> <span class="o">:=</span> <span class="s1">&#39;Fault occurs when the asserted beamclass or pv beam class falls outside the permitted range.&#39;</span><span class="p">,</span>
        <span class="n">i_TypeCode</span> <span class="o">:=</span> <span class="mi">7</span> <span class="p">);</span>

   <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ResidualBeamClass</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">archive</span><span class="p">:</span> <span class="mi">1</span><span class="n">Hz</span> <span class="n">monitor</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">bc</span><span class="o">-</span><span class="n">bitmask</span>
    <span class="s1">&#39;}</span>
    <span class="n">bcResidual</span> <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>

    <span class="n">fbLog</span> <span class="p">:</span> <span class="n">FB_LogMessage</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">eSubSystem</span> <span class="o">:=</span> <span class="n">E_Subsystem</span><span class="o">.</span><span class="n">MPS</span><span class="p">,</span>
        <span class="n">eSevr</span> <span class="o">:=</span> <span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span>
        <span class="p">);</span>
    <span class="n">bLogOneShot</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">sDevName</span> <span class="p">:</span> <span class="n">T_MaxString</span> <span class="o">:=</span> <span class="s1">&#39;Beam Class Watcher&#39;</span><span class="p">;</span>

    <span class="n">fbGetHN</span> <span class="p">:</span> <span class="n">FB_GetHostName</span><span class="p">;</span>
    <span class="n">bInit</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;instance-path&#39;</span><span class="p">}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;noinit&#39;</span><span class="p">}</span>
    <span class="n">sPath</span>    <span class="p">:</span>    <span class="n">T_MaxString</span><span class="p">;</span>

    <span class="n">fbStr</span> <span class="p">:</span> <span class="n">FB_FormatString</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">sOut</span> <span class="o">:=</span> <span class="s1">&#39;Non-zero beam class residual: %32b; Req: %32b; Act: %32b&#39;</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">fbGetHN</span><span class="p">(</span><span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>
    <span class="n">bInit</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">fbGetHN</span><span class="o">.</span><span class="n">bBusy</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">xBeamClassWithinBounds</span> <span class="o">:=</span> <span class="p">(</span><span class="n">i_stCurrentBeamParams</span><span class="o">.</span><span class="n">nBCRange</span> <span class="n">AND</span> <span class="n">i_stRequestedBeamParams</span><span class="o">.</span><span class="n">nBCRange</span><span class="p">)</span> <span class="o">=</span> <span class="n">i_stCurrentBeamParams</span><span class="o">.</span><span class="n">nBCRange</span>
                    <span class="n">AND</span>  <span class="p">(</span><span class="n">i_stCurrentBeamParams</span><span class="o">.</span><span class="n">nBeamClass</span> <span class="o">&lt;=</span> <span class="n">i_stRequestedBeamParams</span><span class="o">.</span><span class="n">nBeamClass</span><span class="p">);</span>

<span class="n">bcResidual</span> <span class="o">:=</span> <span class="p">(</span><span class="n">i_stCurrentBeamParams</span><span class="o">.</span><span class="n">nBCRange</span> <span class="n">XOR</span> <span class="n">i_stRequestedBeamParams</span><span class="o">.</span><span class="n">nBCRange</span><span class="p">)</span> <span class="n">AND</span> <span class="n">i_stCurrentBeamParams</span><span class="o">.</span><span class="n">nBCRange</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">bcResidual</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">AND</span> <span class="n">bLogOneShot</span> <span class="n">THEN</span>
    <span class="n">fbLog</span><span class="o">.</span><span class="n">sJson</span> <span class="o">:=</span> <span class="n">F_PMPS_JSON</span><span class="p">(</span>
        <span class="n">CONCAT</span><span class="p">(</span><span class="n">fbGetHN</span><span class="o">.</span><span class="n">sHostName</span><span class="p">,</span> <span class="n">sDevName</span><span class="p">),</span>
        <span class="n">sPath</span><span class="p">,</span>
        <span class="n">PMPS_CODES</span><span class="o">.</span><span class="n">PEW_FAULT</span><span class="p">);</span>

    <span class="n">fbStr</span><span class="o">.</span><span class="n">arg1</span> <span class="o">:=</span> <span class="n">F_DWORD</span><span class="p">(</span><span class="n">bcResidual</span><span class="p">);</span>
    <span class="n">fbStr</span><span class="o">.</span><span class="n">arg2</span> <span class="o">:=</span> <span class="n">F_WORD</span><span class="p">(</span><span class="n">i_stCurrentBeamParams</span><span class="o">.</span><span class="n">nBCRange</span><span class="p">);</span>
    <span class="n">fbStr</span><span class="o">.</span><span class="n">arg3</span> <span class="o">:=</span> <span class="n">F_WORD</span><span class="p">(</span><span class="n">i_stRequestedBeamParams</span><span class="o">.</span><span class="n">nBCRange</span><span class="p">);</span>

    <span class="n">fbStr</span><span class="p">();</span>

    <span class="n">fbLog</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="n">fbStr</span><span class="o">.</span><span class="n">sOut</span><span class="p">);</span>
    <span class="n">bLogOneShot</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">bcResidual</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">bLogOneShot</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbFF</span><span class="p">(</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">xBeamClassWithinBounds</span> <span class="n">OR</span> <span class="p">(</span><span class="n">i_stCurrentBeamParams</span><span class="o">.</span><span class="n">nMachineMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">io_fbFFHWO</span> <span class="o">:=</span> <span class="n">io_fbFFHWO</span><span class="p">,</span> <span class="n">i_xAutoReset</span> <span class="o">:=</span> <span class="n">i_xAutoReset</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-fastfault">FB_FastFault</a></p></li>
<li><p><a class="reference internal" href="#fb-hardwareffoutput">FB_HardwareFFOutput</a></p></li>
<li><p><a class="reference internal" href="#f-pmps-json">F_PMPS_JSON</a></p></li>
<li><p><a class="reference internal" href="#pmps-codes">PMPS_CODES</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-beamparamassertionpool">
<h2>FB_BeamParamAssertionPool<a class="headerlink" href="#fb-beamparamassertionpool" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="n">implements</span> <span class="n">simple</span> <span class="n">database</span><span class="o">.</span> <span class="n">Data</span> <span class="n">element</span> <span class="n">values</span> <span class="n">are</span> <span class="n">stored</span> <span class="ow">in</span> <span class="n">the</span> <span class="nb">hash</span> <span class="n">table</span><span class="o">.</span>  <span class="o">*</span><span class="p">)</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_check&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_BeamParamAssertionPool</span>
<span class="n">VAR_INPUT</span>
    <span class="n">key</span>         <span class="p">:</span> <span class="n">DWORD</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;(</span><span class="o">*</span> <span class="n">Entry</span> <span class="n">key</span><span class="p">:</span> <span class="n">used</span> <span class="n">by</span> <span class="n">A_Lookup</span><span class="p">,</span> <span class="n">A_Remove</span> <span class="n">method</span><span class="p">,</span> <span class="n">the</span> <span class="n">key</span> <span class="n">variable</span> <span class="ow">is</span> <span class="n">also</span> <span class="n">used</span> <span class="n">by</span> <span class="n">A_Add</span> <span class="n">method</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">putPosPtr</span>    <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">T_HashTableEntry</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;(</span><span class="o">*</span> <span class="n">Hash</span> <span class="n">table</span> <span class="n">entry</span> <span class="n">position</span> <span class="n">pointer</span> <span class="p">(</span><span class="n">used</span> <span class="n">by</span> <span class="n">A_Find</span><span class="p">,</span> <span class="n">A_GetNext</span><span class="p">,</span> <span class="n">A_GetPrev</span><span class="p">)</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">putValue</span>     <span class="p">:</span> <span class="n">ST_BP_ArbInternal</span><span class="p">;(</span><span class="o">*</span> <span class="n">Hash</span> <span class="n">table</span> <span class="n">entry</span> <span class="n">value</span> <span class="p">(</span><span class="n">used</span> <span class="n">by</span> <span class="n">A_AddHead</span><span class="p">,</span> <span class="n">A_AddTail</span><span class="p">,</span> <span class="n">A_Find</span> <span class="p">)</span><span class="o">*</span><span class="p">)</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">bOk</span>            <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;(</span><span class="o">*</span> <span class="n">TRUE</span> <span class="o">=</span> <span class="n">Success</span><span class="p">,</span> <span class="n">FALSE</span> <span class="o">=</span> <span class="n">Failed</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">getPosPtr</span>    <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">T_HashTableEntry</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;(</span><span class="o">*</span> <span class="n">Returned</span> <span class="nb">hash</span> <span class="n">table</span> <span class="n">entry</span> <span class="n">position</span> <span class="n">pointer</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">getValue</span>     <span class="p">:</span> <span class="n">ST_BP_ArbInternal</span><span class="p">;(</span><span class="o">*</span> <span class="n">Returned</span> <span class="nb">hash</span> <span class="n">table</span> <span class="n">entry</span> <span class="n">value</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">nCount</span>        <span class="p">:</span> <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;(</span><span class="o">*</span> <span class="n">Hash</span> <span class="n">table</span> <span class="n">size</span> <span class="p">(</span><span class="n">number</span> <span class="n">of</span> <span class="n">used</span> <span class="n">entries</span><span class="p">,</span> <span class="n">used</span> <span class="n">by</span> <span class="n">A_Count</span><span class="p">)</span> <span class="o">*</span><span class="p">)</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Entry</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
    <span class="n">epicsDataPool</span>    <span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">PMPS_PARAM</span><span class="o">.</span><span class="n">MAX_ASSERTIONS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_BP_ArbInternal</span><span class="p">;(</span><span class="o">*</span> <span class="n">Structured</span> <span class="n">data</span> <span class="n">element</span> <span class="n">pool</span> <span class="k">for</span> <span class="n">display</span> <span class="ow">in</span> <span class="n">EPICS</span><span class="o">*</span><span class="p">)</span>
    <span class="n">dataPool</span>    <span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">PMPS_PARAM</span><span class="o">.</span><span class="n">MAX_ASSERTIONS</span><span class="o">*</span><span class="mi">3</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_BP_ArbInternal</span><span class="p">;(</span><span class="o">*</span> <span class="n">Structured</span> <span class="n">data</span> <span class="n">element</span> <span class="n">pool</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">entries</span>        <span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">PMPS_PARAM</span><span class="o">.</span><span class="n">MAX_ASSERTIONS</span><span class="o">*</span><span class="mi">3</span><span class="p">]</span> <span class="n">OF</span> <span class="n">T_HashTableEntry</span><span class="p">;(</span><span class="o">*</span> <span class="n">Max</span><span class="o">.</span> <span class="n">number</span> <span class="n">of</span> <span class="nb">hash</span> <span class="n">table</span> <span class="n">entries</span><span class="o">.</span> <span class="n">The</span> <span class="n">value</span> <span class="n">of</span> <span class="n">table</span> <span class="n">entry</span> <span class="o">=</span> <span class="mi">32</span> <span class="n">bit</span> <span class="n">integer</span> <span class="p">(</span><span class="n">pointer</span> <span class="n">to</span> <span class="n">dataPool</span><span class="o">-</span><span class="n">array</span><span class="o">-</span><span class="n">entry</span><span class="p">)</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">fbTable</span>     <span class="p">:</span> <span class="n">FB_HashTableCtrl</span><span class="p">;(</span><span class="o">*</span> <span class="n">basic</span> <span class="nb">hash</span> <span class="n">table</span> <span class="n">control</span> <span class="n">function</span> <span class="n">block</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">hTable</span>         <span class="p">:</span> <span class="n">T_HHASHTABLE</span><span class="p">;(</span><span class="o">*</span> <span class="nb">hash</span> <span class="n">table</span> <span class="n">handle</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">pRefPtr</span>        <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_BP_ArbInternal</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">indexOfElem</span>    <span class="p">:</span> <span class="n">ULINT</span><span class="p">;(</span><span class="o">*</span> <span class="n">Integer</span> <span class="n">value</span> <span class="p">(</span><span class="nb">max</span><span class="o">.</span> <span class="n">size</span><span class="p">:</span> <span class="n">x86</span><span class="o">=&gt;</span><span class="mi">32</span><span class="n">bit</span><span class="p">,</span> <span class="n">x64</span><span class="o">=&gt;</span><span class="mi">64</span><span class="n">bit</span><span class="p">)</span><span class="o">*</span><span class="p">)</span>
    <span class="n">cstSafeBeam</span> <span class="p">:</span><span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="p">(</span> <span class="n">nTran</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">neVRange</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nRate</span>  <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nBCRange</span> <span class="o">:=</span><span class="mi">0</span><span class="p">);</span><span class="o">//</span> <span class="n">MG</span>
<span class="n">END_VAR</span>
<span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">A_Add</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Adds</span> <span class="n">entry</span> <span class="n">to</span> <span class="n">the</span> <span class="n">table</span> <span class="o">*</span><span class="p">)</span>
<span class="n">MEMSET</span><span class="p">(</span> <span class="n">ADR</span><span class="p">(</span> <span class="n">getValue</span> <span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SIZEOF</span><span class="p">(</span> <span class="n">getValue</span> <span class="p">)</span> <span class="p">);</span>
<span class="n">getPosPtr</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">fbTable</span><span class="o">.</span><span class="n">A_Add</span><span class="p">(</span> <span class="n">hTable</span> <span class="o">:=</span> <span class="n">hTable</span><span class="p">,</span> <span class="n">key</span> <span class="o">:=</span> <span class="n">key</span><span class="p">,</span> <span class="n">putValue</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">cstSafeBeam</span><span class="p">)(</span><span class="o">*</span> <span class="n">we</span> <span class="n">will</span> <span class="nb">set</span> <span class="n">this</span> <span class="n">value</span> <span class="n">later</span> <span class="o">*</span><span class="p">),</span> <span class="n">getPosPtr</span><span class="o">=&gt;</span><span class="n">getPosPtr</span><span class="p">,</span> <span class="n">bOk</span><span class="o">=&gt;</span><span class="n">bOk</span> <span class="p">);(</span><span class="o">*</span> <span class="n">Add</span> <span class="n">new</span> <span class="n">element</span> <span class="n">to</span> <span class="n">the</span> <span class="n">table</span><span class="p">,</span> <span class="n">getPosPtr</span> <span class="n">points</span> <span class="n">to</span> <span class="n">the</span> <span class="n">new</span> <span class="n">entry</span> <span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">fbTable</span><span class="o">.</span><span class="n">bOk</span> <span class="n">THEN</span><span class="p">(</span><span class="o">*</span> <span class="n">Success</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">fbTable</span><span class="o">.</span><span class="n">A_GetIndexAtPosPtr</span><span class="p">(</span> <span class="n">hTable</span> <span class="o">:=</span> <span class="n">hTable</span><span class="p">,</span> <span class="n">putPosPtr</span> <span class="o">:=</span> <span class="n">getPosPtr</span><span class="p">,</span> <span class="n">getValue</span> <span class="o">=&gt;</span><span class="n">indexOfElem</span><span class="p">,</span> <span class="n">bOk</span><span class="o">=&gt;</span><span class="n">bOk</span> <span class="p">);(</span><span class="o">*</span> <span class="n">Get</span> <span class="n">array</span> <span class="n">index</span> <span class="n">of</span> <span class="n">getPosPtr</span> <span class="n">entry</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">IF</span> <span class="n">fbTable</span><span class="o">.</span><span class="n">bOk</span> <span class="n">THEN</span><span class="p">(</span><span class="o">*</span> <span class="n">Success</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">pRefPtr</span>     <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span> <span class="n">dataPool</span><span class="p">[</span><span class="n">indexOfElem</span><span class="p">]</span> <span class="p">);(</span><span class="o">*</span> <span class="n">Get</span> <span class="n">pointer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">data</span> <span class="n">element</span> <span class="o">*</span><span class="p">)</span>

        <span class="n">pRefPtr</span><span class="o">^</span> <span class="o">:=</span> <span class="n">putValue</span><span class="p">;(</span><span class="o">*</span> <span class="n">copy</span> <span class="n">application</span> <span class="n">value</span> <span class="o">*</span><span class="p">)</span>

        <span class="n">fbTable</span><span class="o">.</span><span class="n">A_Add</span><span class="p">(</span> <span class="n">hTable</span> <span class="o">:=</span> <span class="n">hTable</span><span class="p">,</span> <span class="n">key</span> <span class="o">:=</span> <span class="n">key</span><span class="p">,</span> <span class="n">putValue</span> <span class="o">:=</span> <span class="n">pRefPtr</span><span class="p">,</span> <span class="n">bOk</span><span class="o">=&gt;</span><span class="n">bOk</span> <span class="p">);(</span><span class="o">*</span> <span class="n">Assign</span> <span class="n">the</span> <span class="n">entry</span> <span class="n">value</span> <span class="o">=</span> <span class="n">pointer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">data</span> <span class="n">element</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">IF</span> <span class="n">fbTable</span><span class="o">.</span><span class="n">bOk</span> <span class="n">THEN</span><span class="p">(</span><span class="o">*</span> <span class="n">Success</span> <span class="o">*</span><span class="p">)</span>
            <span class="n">getValue</span> <span class="o">:=</span> <span class="n">putValue</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">DataPoolToEpics</span><span class="p">();</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">A_Count</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Count</span> <span class="n">number</span> <span class="n">of</span> <span class="n">used</span> <span class="n">entries</span> <span class="o">*</span><span class="p">)</span>
<span class="n">nCount</span> <span class="o">:=</span> <span class="n">hTable</span><span class="o">.</span><span class="n">nCount</span><span class="p">;</span>
<span class="n">bOk</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">A_GetFirst</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Get</span> <span class="n">first</span> <span class="n">entry</span> <span class="n">position</span> <span class="n">pointer</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">*</span><span class="p">)</span>
<span class="n">MEMSET</span><span class="p">(</span> <span class="n">ADR</span><span class="p">(</span> <span class="n">getValue</span> <span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SIZEOF</span><span class="p">(</span> <span class="n">getValue</span> <span class="p">)</span> <span class="p">);</span>
<span class="n">getPosPtr</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">fbTable</span><span class="o">.</span><span class="n">A_GetFirst</span><span class="p">(</span> <span class="n">hTable</span> <span class="o">:=</span> <span class="n">hTable</span><span class="p">,</span> <span class="n">putPosPtr</span> <span class="o">:=</span> <span class="n">putPosPtr</span><span class="p">,</span> <span class="n">getValue</span><span class="o">=&gt;</span><span class="n">pRefPtr</span><span class="p">,</span> <span class="n">getPosPtr</span><span class="o">=&gt;</span><span class="n">getPosPtr</span><span class="p">,</span> <span class="n">bOk</span><span class="o">=&gt;</span><span class="n">bOk</span> <span class="p">);</span>
<span class="n">IF</span> <span class="n">fbTable</span><span class="o">.</span><span class="n">bOk</span> <span class="n">THEN</span>
    <span class="n">getValue</span> <span class="o">:=</span> <span class="n">pRefPtr</span><span class="o">^</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">A_GetNext</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Get</span> <span class="nb">next</span> <span class="n">entry</span> <span class="n">position</span> <span class="n">pointer</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">*</span><span class="p">)</span>
<span class="n">MEMSET</span><span class="p">(</span> <span class="n">ADR</span><span class="p">(</span> <span class="n">getValue</span> <span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SIZEOF</span><span class="p">(</span> <span class="n">getValue</span> <span class="p">)</span> <span class="p">);</span>
<span class="n">getPosPtr</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">bOk</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">putPosPtr</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbTable</span><span class="o">.</span><span class="n">A_GetNext</span><span class="p">(</span> <span class="n">hTable</span> <span class="o">:=</span> <span class="n">hTable</span><span class="p">,</span> <span class="n">putPosPtr</span> <span class="o">:=</span> <span class="n">putPosPtr</span><span class="p">,</span> <span class="n">getValue</span><span class="o">=&gt;</span><span class="n">pRefPtr</span><span class="p">,</span> <span class="n">getPosPtr</span><span class="o">=&gt;</span><span class="n">getPosPtr</span><span class="p">,</span> <span class="n">bOk</span><span class="o">=&gt;</span><span class="n">bOk</span> <span class="p">);</span>
<span class="n">IF</span> <span class="n">fbTable</span><span class="o">.</span><span class="n">bOk</span> <span class="n">THEN</span>
    <span class="n">getValue</span> <span class="o">:=</span> <span class="n">pRefPtr</span><span class="o">^</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">A_Lookup</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Lookup</span> <span class="k">for</span> <span class="n">entry</span> <span class="n">by</span> <span class="n">key</span>  <span class="o">*</span><span class="p">)</span>
<span class="n">MEMSET</span><span class="p">(</span> <span class="n">ADR</span><span class="p">(</span> <span class="n">getValue</span> <span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SIZEOF</span><span class="p">(</span> <span class="n">getValue</span> <span class="p">)</span> <span class="p">);</span>
<span class="n">getPosPtr</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">fbTable</span><span class="o">.</span><span class="n">A_Lookup</span><span class="p">(</span> <span class="n">key</span> <span class="o">:=</span> <span class="n">key</span><span class="p">,</span> <span class="n">hTable</span> <span class="o">:=</span> <span class="n">hTable</span><span class="p">,</span> <span class="n">putPosPtr</span> <span class="o">:=</span> <span class="n">putPosPtr</span><span class="p">,</span> <span class="n">getValue</span><span class="o">=&gt;</span><span class="n">pRefPtr</span><span class="p">,</span> <span class="n">getPosPtr</span><span class="o">=&gt;</span><span class="n">getPosPtr</span><span class="p">,</span> <span class="n">bOk</span><span class="o">=&gt;</span><span class="n">bOk</span> <span class="p">);</span>
<span class="n">IF</span> <span class="n">fbTable</span><span class="o">.</span><span class="n">bOk</span> <span class="n">THEN</span>
    <span class="n">getValue</span> <span class="o">:=</span> <span class="n">pRefPtr</span><span class="o">^</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">A_Remove</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Search</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">and</span> <span class="n">remove</span> <span class="n">it</span> <span class="o">*</span><span class="p">)</span>
<span class="n">MEMSET</span><span class="p">(</span> <span class="n">ADR</span><span class="p">(</span> <span class="n">getValue</span> <span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SIZEOF</span><span class="p">(</span> <span class="n">getValue</span> <span class="p">)</span> <span class="p">);</span>
<span class="n">getPosPtr</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">fbTable</span><span class="o">.</span><span class="n">A_Remove</span><span class="p">(</span> <span class="n">key</span> <span class="o">:=</span> <span class="n">key</span><span class="p">,</span> <span class="n">hTable</span> <span class="o">:=</span> <span class="n">hTable</span><span class="p">,</span> <span class="n">putPosPtr</span> <span class="o">:=</span> <span class="n">putPosPtr</span><span class="p">,</span> <span class="n">getValue</span><span class="o">=&gt;</span><span class="n">pRefPtr</span><span class="p">,</span> <span class="n">getPosPtr</span><span class="o">=&gt;</span><span class="n">getPosPtr</span><span class="p">,</span> <span class="n">bOk</span><span class="o">=&gt;</span><span class="n">bOk</span> <span class="p">);</span>
<span class="n">IF</span> <span class="n">fbTable</span><span class="o">.</span><span class="n">bOk</span> <span class="n">THEN</span>
    <span class="n">getValue</span> <span class="o">:=</span> <span class="n">pRefPtr</span><span class="o">^</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">DataPoolToEpics</span><span class="p">();</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">A_Reset</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Reset</span><span class="o">/</span><span class="n">initialize</span> <span class="n">linked</span> <span class="nb">list</span> <span class="o">*</span><span class="p">)</span>
<span class="n">MEMSET</span><span class="p">(</span> <span class="n">ADR</span><span class="p">(</span> <span class="n">getValue</span> <span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SIZEOF</span><span class="p">(</span> <span class="n">getValue</span> <span class="p">)</span> <span class="p">);</span>
<span class="n">getPosPtr</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">bOk</span> <span class="o">:=</span> <span class="n">F_CreateHashTableHnd</span><span class="p">(</span> <span class="n">ADR</span><span class="p">(</span> <span class="n">entries</span> <span class="p">),</span> <span class="n">SIZEOF</span><span class="p">(</span> <span class="n">entries</span> <span class="p">),</span> <span class="n">hTable</span> <span class="p">);(</span><span class="o">*</span> <span class="n">Intialize</span> <span class="n">table</span> <span class="n">handle</span> <span class="o">*</span><span class="p">)</span>
<span class="n">fbTable</span><span class="o">.</span><span class="n">A_Reset</span><span class="p">(</span> <span class="n">hTable</span> <span class="o">:=</span> <span class="n">hTable</span><span class="p">,</span> <span class="n">bOk</span><span class="o">=&gt;</span><span class="n">bOk</span> <span class="p">);</span>
<span class="n">nCount</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">DataPoolToEpics</span><span class="p">:</span>
<span class="n">MEMCPY</span><span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">epicsDataPool</span><span class="p">),</span> <span class="n">ADR</span><span class="p">(</span><span class="n">dataPool</span><span class="p">),</span> <span class="p">(</span><span class="n">PMPS_PARAM</span><span class="o">.</span><span class="n">MAX_ASSERTIONS</span><span class="p">)</span> <span class="o">*</span> <span class="n">SIZEOF</span><span class="p">(</span><span class="n">ST_BP_ArbInternal</span><span class="p">));</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#pmps-param">PMPS_PARAM</a></p></li>
<li><p><a class="reference internal" href="#st-bp-arbinternal">ST_BP_ArbInternal</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
<li><p><a class="reference internal" href="#t-hashtableentry">T_HashTableEntry</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-bpcontroldevice">
<h2>FB_BPControlDevice<a class="headerlink" href="#fb-bpcontroldevice" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span>
<span class="n">Used</span> <span class="n">to</span> <span class="n">request</span> <span class="n">a</span> <span class="n">beam</span> <span class="n">parameter</span> <span class="nb">set</span> <span class="kn">from</span><span class="w"> </span><span class="nn">EPICS.</span>

<span class="n">Technically</span> <span class="n">just</span> <span class="n">one</span> <span class="n">of</span> <span class="n">these</span> <span class="ow">is</span> <span class="n">needed</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">entire</span>
<span class="n">PMPS</span> <span class="k">for</span> <span class="n">a</span> <span class="n">line</span><span class="o">.</span>

<span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_BPControlDevice</span>
<span class="n">VAR_INPUT</span>
        <span class="p">(</span><span class="o">*</span>  <span class="n">Requested</span> <span class="n">pre</span><span class="o">-</span><span class="n">optic</span> <span class="n">attenuation</span> <span class="o">%</span>  <span class="o">*</span><span class="p">)</span>
        <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: ReqBP:Transmission</span>
            <span class="n">io</span><span class="p">:</span> <span class="n">o</span>
            <span class="n">field</span><span class="p">:</span> <span class="n">HOPR</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">field</span><span class="p">:</span> <span class="n">LOPR</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">field</span><span class="p">:</span> <span class="n">PREC</span> <span class="mi">2</span><span class="p">;</span>
        <span class="s1">&#39;}</span>
        <span class="n">nTran</span> <span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">TRANS_SCALING_FACTOR</span><span class="p">;</span>
        <span class="p">(</span><span class="o">*</span> <span class="n">Pulse</span><span class="o">-</span><span class="n">rate</span> <span class="o">*</span><span class="p">)</span>
        <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: ReqBP:Rate</span>
            <span class="n">io</span><span class="p">:</span> <span class="n">o</span>
            <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">Hz</span>
        <span class="s1">&#39;}</span>
        <span class="n">nRate</span> <span class="p">:</span> <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
        <span class="p">(</span><span class="o">*</span> <span class="n">Photon</span> <span class="n">energy</span> <span class="n">ranges</span> <span class="o">*</span><span class="p">)</span>
        <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: ReqBP:PhotonEnergyRanges</span>
            <span class="n">io</span><span class="p">:</span> <span class="n">o</span>
            <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">eV</span><span class="s1">&#39;}</span>
        <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;displaymode&#39;</span> <span class="o">:=</span> <span class="s1">&#39;binary&#39;</span><span class="p">}</span>
        <span class="n">neVRange</span> <span class="p">:</span> <span class="n">DWORD</span> <span class="o">:=</span> <span class="mi">4294967295</span><span class="p">;</span>
        <span class="p">(</span><span class="o">*</span> <span class="n">Beamclass</span> <span class="n">ranges</span> <span class="o">*</span><span class="p">)</span>
         <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: ReqBP:BeamClassRanges</span>
            <span class="n">io</span><span class="p">:</span> <span class="n">o</span><span class="s1">&#39;}</span>
        <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;displaymode&#39;</span> <span class="o">:=</span> <span class="s1">&#39;binary&#39;</span><span class="p">}</span>
        <span class="n">nBCRange</span> <span class="p">:</span> <span class="n">WORD</span> <span class="o">:=</span> <span class="mi">32767</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Arbiter</span> <span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">EpicsReqBP</span> <span class="p">:</span> <span class="n">ST_BeamParams</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ReqBP</span><span class="p">:</span><span class="n">Apply</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">o</span>
    <span class="s1">&#39;}</span>
    <span class="n">bApply</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">nControlDeviceID</span> <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
    <span class="n">sControlDeviceName</span><span class="p">:</span> <span class="n">STRING</span><span class="o">:=</span> <span class="s1">&#39;BP Control Device&#39;</span><span class="p">;</span>
    <span class="n">rtApply</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">EpicsReqBP</span><span class="o">.</span><span class="n">nTran</span> <span class="o">:=</span> <span class="n">nTran</span><span class="p">;</span>
<span class="n">EpicsReqBP</span><span class="o">.</span><span class="n">neVRange</span> <span class="o">:=</span> <span class="n">neVRange</span><span class="p">;</span>
<span class="n">EpicsReqBP</span><span class="o">.</span><span class="n">nRate</span> <span class="o">:=</span> <span class="n">nRate</span><span class="p">;</span>
<span class="n">EpicsReqBP</span><span class="o">.</span><span class="n">nBCRange</span> <span class="o">:=</span> <span class="n">nBCRange</span><span class="p">;</span>

<span class="n">rtApply</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bApply</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtApply</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">Arbiter</span><span class="o">.</span><span class="n">RemoveRequest</span><span class="p">(</span><span class="n">nControlDeviceID</span><span class="p">);</span>
    <span class="n">Arbiter</span><span class="o">.</span><span class="n">AddRequest</span><span class="p">(</span><span class="n">nControlDeviceID</span><span class="p">,</span> <span class="n">EpicsReqBP</span><span class="p">,</span> <span class="n">sControlDeviceName</span><span class="p">);</span>
    <span class="n">bApply</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">FB_init</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bInitRetains</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="k">if</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">the</span> <span class="n">retain</span> <span class="n">variables</span> <span class="n">are</span> <span class="n">initialized</span> <span class="p">(</span><span class="n">warm</span> <span class="n">start</span> <span class="o">/</span> <span class="n">cold</span> <span class="n">start</span><span class="p">)</span>
    <span class="n">bInCopyCode</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>  <span class="o">//</span> <span class="k">if</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">the</span> <span class="n">instance</span> <span class="n">afterwards</span> <span class="n">gets</span> <span class="n">moved</span> <span class="n">into</span> <span class="n">the</span> <span class="n">copy</span> <span class="n">code</span> <span class="p">(</span><span class="n">online</span> <span class="n">change</span><span class="p">)</span>
    <span class="n">nID</span> <span class="p">:</span> <span class="n">DWORD</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">EXCLUDED_ASSERTION_ID</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">nControlDeviceID</span><span class="o">:=</span> <span class="n">nID</span><span class="p">;</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-arbiter">FB_Arbiter</a></p></li>
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-bprequestor">
<h2>FB_BPRequestor<a class="headerlink" href="#fb-bprequestor" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">BP</span> <span class="n">Requestor</span>
<span class="n">Elevates</span> <span class="n">the</span> <span class="n">BP</span> <span class="n">request</span> <span class="kn">from</span><span class="w"> </span><span class="nn">an</span> <span class="n">arbiter</span> <span class="n">to</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">stRequestedBP</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_BPRequestor</span> <span class="n">IMPLEMENTS</span> <span class="n">I_HigherAuthority</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">q_ReqBP</span> <span class="p">:</span> <span class="n">ST_BeamParams</span><span class="p">;</span> <span class="o">//</span> <span class="n">Arbitrated</span> <span class="n">BP</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Arbiter</span> <span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">;</span>
    <span class="o">//</span><span class="n">FFO</span> <span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">ReqBP</span> <span class="p">:</span> <span class="n">ST_BeamParams</span><span class="p">;</span>
    <span class="n">nCohort</span> <span class="p">:</span> <span class="n">ULINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">Current</span> <span class="n">cohort</span><span class="p">,</span> <span class="n">inc</span><span class="o">.</span> <span class="mi">1</span> <span class="n">cycle</span> <span class="n">after</span> <span class="n">IO</span> <span class="ow">is</span> <span class="n">updated</span>
    <span class="n">nRequestCohort</span> <span class="p">:</span> <span class="n">ULINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">Cohort</span> <span class="n">number</span> <span class="n">recorded</span> <span class="n">at</span> <span class="n">the</span> <span class="n">time</span> <span class="n">of</span> <span class="n">the</span> <span class="n">request</span><span class="o">.</span>
<span class="n">END_VAR</span>
<span class="n">Arbiter</span><span class="o">.</span><span class="n">ElevateRequest</span><span class="p">(</span><span class="n">THIS</span><span class="o">^</span><span class="p">);</span> <span class="o">//</span> <span class="n">Executes</span> <span class="n">arbitration</span> <span class="ow">and</span> <span class="n">retrieves</span> <span class="n">ReqBP</span>

<span class="n">IF</span> <span class="n">nRequestCohort</span> <span class="o">&gt;=</span> <span class="n">nCohort</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Update</span> <span class="n">requested</span> <span class="n">BP</span> <span class="nb">set</span>
    <span class="n">q_ReqBP</span> <span class="o">:=</span> <span class="n">ReqBP</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Note</span><span class="p">:</span> <span class="n">we</span> <span class="n">may</span> <span class="n">do</span> <span class="n">more</span> <span class="n">here</span> <span class="n">someday</span><span class="o">...</span> <span class="n">perhaps</span> <span class="nb">all</span> <span class="n">of</span> <span class="n">the</span> <span class="n">output</span> <span class="n">control</span>
    <span class="o">//</span> <span class="n">will</span> <span class="n">reside</span> <span class="ow">in</span> <span class="n">here</span><span class="p">,</span> <span class="ow">and</span> <span class="n">be</span> <span class="n">solely</span> <span class="n">controlled</span> <span class="n">by</span> <span class="n">this</span> <span class="n">block</span><span class="o">.</span> <span class="n">For</span> <span class="n">now</span>
    <span class="o">//</span> <span class="n">I</span> <span class="n">am</span> <span class="n">going</span> <span class="n">to</span> <span class="n">adopt</span> <span class="n">a</span> <span class="n">flat</span> <span class="n">management</span> <span class="n">structure</span><span class="o">.</span>
    <span class="o">//</span> <span class="n">Start</span> <span class="n">a</span> <span class="n">new</span> <span class="n">cohort</span>
    <span class="n">nCohort</span> <span class="o">:=</span> <span class="n">nCohort</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="o">//</span> <span class="n">Returns</span> <span class="n">true</span> <span class="n">when</span> <span class="n">outputs</span> <span class="n">to</span> <span class="n">MPS</span> <span class="n">are</span> <span class="n">updated</span>
<span class="n">METHOD</span> <span class="n">CheckRequest</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nReqID</span>  <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">xFirstTime</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nId</span> <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">nRequestCohort</span> <span class="n">will</span> <span class="n">be</span> <span class="o">&lt;</span> <span class="n">nCohort</span> <span class="n">after</span> <span class="n">output</span> <span class="n">control</span>
<span class="n">function</span> <span class="n">blocks</span> <span class="n">have</span> <span class="n">been</span> <span class="n">updated</span> <span class="n">to</span> <span class="n">reflect</span> <span class="n">the</span> <span class="n">new</span> <span class="n">request</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">CheckRequest</span> <span class="o">:=</span> <span class="n">nRequestCohort</span> <span class="o">&lt;</span> <span class="n">nCohort</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">RemoveRequest</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nReqID</span>    <span class="p">:</span>    <span class="n">DWORD</span><span class="p">;</span> <span class="o">//</span><span class="n">StateID</span> <span class="n">to</span> <span class="n">remove</span>
<span class="n">END_VAR</span>

<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">RequestBP</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="p">(</span><span class="o">*</span><span class="n">StateID</span> <span class="n">of</span> <span class="n">state</span> <span class="n">requesting</span> <span class="n">beam</span> <span class="n">parameter</span> <span class="nb">set</span><span class="o">*</span><span class="p">)</span>
    <span class="n">nReqID</span>  <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span><span class="n">Requested</span> <span class="n">beam</span> <span class="n">params</span><span class="o">*</span><span class="p">)</span>
    <span class="n">stReqBP</span> <span class="p">:</span> <span class="n">ST_BeamParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">ReqID</span> <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
    <span class="n">Registered</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Check</span> <span class="n">the</span> <span class="n">request</span> <span class="ow">is</span> <span class="n">coming</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">same</span> <span class="n">source</span> <span class="n">we</span><span class="s1">&#39;re used to</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">Registered</span> <span class="n">THEN</span>
    <span class="n">ReqID</span> <span class="o">:=</span> <span class="n">nReqID</span><span class="p">;</span>
    <span class="n">Registered</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="o">//</span> <span class="n">log</span> <span class="n">a</span> <span class="n">complaint</span> <span class="k">if</span> <span class="n">false</span>
<span class="n">RequestBP</span> <span class="o">:=</span> <span class="n">ReqId</span> <span class="o">=</span> <span class="n">nReqId</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Update</span> <span class="n">internal</span> <span class="n">BP</span> <span class="n">request</span> <span class="n">struct</span>
<span class="n">ReqBP</span> <span class="o">:=</span> <span class="n">stReqBP</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Record</span> <span class="n">current</span> <span class="n">cohort</span>

    <span class="n">nRequestCohort</span> <span class="o">:=</span> <span class="n">nCohort</span><span class="p">;</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-arbiter">FB_Arbiter</a></p></li>
<li><p><a class="reference internal" href="#fb-hardwareffoutput">FB_HardwareFFOutput</a></p></li>
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-bptm-test">
<h2>FB_BPTM_Test<a class="headerlink" href="#fb-bptm-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;call_after_init&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_BPTM_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">BPTM_ARR</span> <span class="p">:</span> <span class="n">UDINT</span> <span class="o">:=</span> <span class="n">PMPS_PARAM</span><span class="o">.</span><span class="n">MAX_ASSERTIONS</span><span class="p">;</span>
    <span class="n">cCycle</span> <span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span> <span class="o">//</span> <span class="n">How</span> <span class="n">many</span> <span class="n">cycles</span> <span class="n">does</span> <span class="n">it</span> <span class="n">take</span> <span class="n">to</span> <span class="n">complete</span> <span class="n">a</span> <span class="n">BPTM</span>
<span class="n">END_VAR</span>
<span class="n">BPTMBasicFunction</span><span class="p">();</span>
<span class="n">InterruptAtAllSteps</span><span class="p">();</span>
<span class="n">FullArbError</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">BPTMBasicFunction</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span><span class="n">Final</span> <span class="ow">and</span> <span class="n">transition</span> <span class="n">assertions</span>
    <span class="n">nTransitionID</span>    <span class="p">:</span>    <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">stTransitionAssertion</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="p">(</span><span class="n">nRate</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">nBCRange</span><span class="o">:=</span><span class="mi">0</span><span class="p">);</span>

    <span class="n">nReqID</span>    <span class="p">:</span>    <span class="n">UDINT</span>    <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">stReqAssertion</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="p">(</span><span class="n">nTran</span> <span class="o">:=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">nBCRange</span><span class="o">:=</span><span class="mi">2</span><span class="c1">#0000_0000_0000_0011);</span>

<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbBPTM_TestBasicFunction</span>    <span class="p">:</span>    <span class="n">BeamParameterTransitionManager</span><span class="p">;</span>
    <span class="n">fbArbiter</span>    <span class="p">:</span>    <span class="n">FB_Arbiter</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">ffo</span> <span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="n">fbSubSysIO</span> <span class="p">:</span> <span class="n">FB_DummyArbIO</span><span class="p">;</span>
    <span class="n">xFirstPass</span>    <span class="p">:</span>    <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">eTestStep</span><span class="p">:</span> <span class="n">E_BPTMTestStates</span> <span class="o">:=</span> <span class="n">E_BPTMTestStates</span><span class="o">.</span><span class="n">Init</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Completes</span> <span class="n">arbiter</span> <span class="n">request</span> <span class="n">elevation</span> <span class="n">process</span>
<span class="o">//</span> <span class="n">Necessary</span> <span class="k">for</span> <span class="n">CheckRequest</span> <span class="n">to</span> <span class="k">return</span> <span class="n">true</span><span class="p">,</span> <span class="n">ever</span>
    <span class="n">fbBPTM_TestBasicFunction</span><span class="p">(</span>
        <span class="n">fbArbiter</span> <span class="o">:=</span> <span class="n">fbArbiter</span><span class="p">,</span>
        <span class="p">);</span>

<span class="n">fbSubSysIO</span><span class="p">(</span><span class="n">LA</span> <span class="o">:=</span> <span class="n">fbArbiter</span><span class="p">,</span> <span class="n">FFO</span> <span class="o">:=</span> <span class="n">ffo</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Note</span><span class="p">:</span> <span class="n">this</span> <span class="n">struct</span> <span class="n">may</span> <span class="n">also</span> <span class="n">be</span> <span class="p">(</span><span class="n">over</span><span class="p">)</span><span class="n">written</span> <span class="n">to</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">tests</span> <span class="n">below</span><span class="p">,</span> <span class="n">specifically</span> <span class="n">rate</span><span class="o">.</span>
<span class="n">fbBPTM_TestBasicFunction</span><span class="o">.</span><span class="n">stCurrentBeamParameters</span> <span class="o">:=</span> <span class="n">fbSubSysIO</span><span class="o">.</span><span class="n">q_stSimulatedBPReadback</span><span class="p">;</span>

<span class="o">//</span><span class="n">MG</span><span class="p">:</span> <span class="n">Need</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">the</span> <span class="n">Machine</span> <span class="n">mode</span> <span class="n">testing</span> <span class="n">SC</span>
<span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">stCurrentBeamParameters</span><span class="o">.</span><span class="n">nMachineMode</span> <span class="o">:=</span><span class="mi">0</span><span class="p">;</span>

<span class="n">CASE</span> <span class="n">eTestStep</span> <span class="n">OF</span>

<span class="n">E_BPTMTestStates</span><span class="o">.</span><span class="n">Init</span><span class="p">:</span>

    <span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;BPTMTest&#39;</span><span class="p">);</span>
    <span class="n">eTestStep</span> <span class="o">:=</span> <span class="n">E_BPTMTestStates</span><span class="o">.</span><span class="n">WaitingForBeam</span><span class="p">;</span>

<span class="n">E_BPTMTestStates</span><span class="o">.</span><span class="n">WaitingForBeam</span><span class="p">:</span>
    <span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;BPTM Waits for Beam&#39;</span><span class="p">);</span>

    <span class="n">fbBPTM_TestBasicFunction</span><span class="o">.</span><span class="n">i_TransitionAssertionID</span> <span class="o">:=</span> <span class="n">nTransitionID</span><span class="p">;</span>
    <span class="n">fbBPTM_TestBasicFunction</span><span class="o">.</span><span class="n">i_stTransitionAssertion</span> <span class="o">:=</span> <span class="n">stTransitionAssertion</span><span class="p">;</span>

    <span class="n">fbBPTM_TestBasicFunction</span><span class="o">.</span><span class="n">i_nRequestedAssertionID</span> <span class="o">:=</span> <span class="n">nReqID</span><span class="p">;</span>
    <span class="n">fbBPTM_TestBasicFunction</span><span class="o">.</span><span class="n">i_stRequestedAssertion</span> <span class="o">:=</span> <span class="n">stReqAssertion</span><span class="p">;</span>

    <span class="n">IF</span> <span class="n">fbBPTM_TestBasicFunction</span><span class="o">.</span><span class="n">eBPTMState</span> <span class="o">=</span> <span class="n">E_BPTMState</span><span class="o">.</span><span class="n">WaitForBP</span> <span class="n">AND</span>
        <span class="n">NOT</span> <span class="n">fbBPTM_TestBasicFunction</span><span class="o">.</span><span class="n">xEntry</span> <span class="n">THEN</span>

        <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequestInPool</span><span class="p">(</span><span class="n">nTransitionID</span><span class="p">),</span> <span class="s1">&#39;Arbiter did not accept BPTM transition assertion&#39;</span><span class="p">);</span>

        <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequestInPool</span><span class="p">(</span><span class="n">nReqID</span><span class="p">),</span> <span class="s1">&#39;Arbiter did not accept BPTM transition assertion&#39;</span><span class="p">);</span>

        <span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbBPTM_TestBasicFunction</span><span class="o">.</span><span class="n">q_xTransitionAuthorized</span><span class="p">,</span>
            <span class="s1">&#39;Transition should not be authorized until requests are in and beam is ready&#39;</span><span class="p">);</span>

        <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbBPTM_TestBasicFunction</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span> <span class="s1">&#39;Busy should be true here&#39;</span><span class="p">);</span>
        <span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbBPTM_TestBasicFunction</span><span class="o">.</span><span class="n">bDone</span><span class="p">,</span> <span class="s1">&#39;Done should be false&#39;</span><span class="p">);</span>
        <span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbBPTM_TestBasicFunction</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span> <span class="s1">&#39;Error should be false here&#39;</span><span class="p">);</span>

        <span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="s1">&#39;BPTM Waits for Beam&#39;</span><span class="p">);</span>

        <span class="n">eTestStep</span> <span class="o">:=</span> <span class="n">E_BPTMTestStates</span><span class="o">.</span><span class="n">Transitioning</span><span class="p">;</span>
    <span class="n">END_IF</span>


<span class="n">E_BPTMTestStates</span><span class="o">.</span><span class="n">Transitioning</span><span class="p">:</span>
    <span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;BPTM Authorizes Transition&#39;</span><span class="p">);</span>

    <span class="n">fbBPTM_TestBasicFunction</span><span class="o">.</span><span class="n">stCurrentBeamParameters</span><span class="o">.</span><span class="n">nRate</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">//</span> <span class="n">satisfies</span> <span class="n">the</span> <span class="n">transition</span> <span class="n">request</span>
    <span class="n">fbBPTM_TestBasicFunction</span><span class="o">.</span><span class="n">stCurrentBeamParameters</span><span class="o">.</span><span class="n">nBeamClass</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">//</span> <span class="n">satisfies</span> <span class="n">the</span> <span class="n">transition</span> <span class="n">request</span>

    <span class="n">IF</span> <span class="n">fbBPTM_TestBasicFunction</span><span class="o">.</span><span class="n">eBPTMState</span> <span class="o">=</span> <span class="n">E_BPTMState</span><span class="o">.</span><span class="n">Transitioning</span> <span class="n">AND</span>
        <span class="n">NOT</span> <span class="n">fbBPTM_TestBasicFunction</span><span class="o">.</span><span class="n">xEntry</span> <span class="n">THEN</span>

        <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">(</span><span class="n">nTransitionID</span><span class="p">),</span>
            <span class="s1">&#39;Transition assertion should be in arbiter&#39;</span><span class="p">);</span>

        <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">(</span><span class="n">nReqID</span><span class="p">),</span>
            <span class="s1">&#39;Final assertion should be in arbiter&#39;</span><span class="p">);</span>

        <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbBPTM_TestBasicFunction</span><span class="o">.</span><span class="n">q_xTransitionAuthorized</span><span class="p">,</span>
            <span class="s1">&#39;Transition should be authorized at this point.&#39;</span><span class="p">);</span>

        <span class="n">AssertEquals</span><span class="p">(</span><span class="n">nReqID</span><span class="p">,</span> <span class="n">fbBPTM_TestBasicFunction</span><span class="o">.</span><span class="n">nCurrentAssertionID</span><span class="p">,</span>
            <span class="s1">&#39;nCurrentAssertionID not set.&#39;</span><span class="p">);</span>

        <span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="s1">&#39;BPTM Authorizes Transition&#39;</span><span class="p">);</span>

        <span class="n">eTestStep</span> <span class="o">:=</span> <span class="n">E_BPTMTestStates</span><span class="o">.</span><span class="n">WaitingForFinalAssertion</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="n">E_BPTMTestStates</span><span class="o">.</span><span class="n">WaitingForFinalAssertion</span><span class="p">:</span>
    <span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;BPTM Waits for final BP&#39;</span><span class="p">);</span>

    <span class="n">fbBPTM_TestBasicFunction</span><span class="o">.</span><span class="n">i_xDoneMoving</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="n">IF</span> <span class="n">fbBPTM_TestBasicFunction</span><span class="o">.</span><span class="n">eBPTMState</span> <span class="o">=</span> <span class="n">E_BPTMState</span><span class="o">.</span><span class="n">WaitForFinalBP</span> <span class="n">THEN</span>

        <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">(</span><span class="n">nTransitionID</span><span class="p">),</span>
        <span class="s1">&#39;Transition assertion should be in arbiter&#39;</span><span class="p">);</span>

        <span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="s1">&#39;BPTM Waits for final BP&#39;</span><span class="p">);</span>

        <span class="n">eTestStep</span> <span class="o">:=</span> <span class="n">E_BPTMTestStates</span><span class="o">.</span><span class="n">CleaningUp</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="n">E_BPTMTestStates</span><span class="o">.</span><span class="n">CleaningUp</span><span class="p">:</span>

    <span class="n">fbSubSysIO</span><span class="o">.</span><span class="n">AutoUpdateBP</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;Cleaning up&#39;</span><span class="p">);</span>

    <span class="n">IF</span> <span class="n">fbBPTM_TestBasicFunction</span><span class="o">.</span><span class="n">eBPTMState</span> <span class="o">=</span> <span class="n">E_BPTMState</span><span class="o">.</span><span class="n">Done</span> <span class="n">THEN</span>

        <span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequestInPool</span><span class="p">(</span><span class="n">nTransitionID</span><span class="p">),</span> <span class="s1">&#39;Transition req should be removed from arb now&#39;</span><span class="p">);</span>

        <span class="n">eTestStep</span> <span class="o">:=</span> <span class="n">E_BPTMTestStates</span><span class="o">.</span><span class="n">Done</span><span class="p">;</span>

        <span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="s1">&#39;Cleaning up&#39;</span><span class="p">);</span>
    <span class="n">END_IF</span>

<span class="n">E_BPTMTestStates</span><span class="o">.</span><span class="n">Done</span><span class="p">:</span>


    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbBPTM_TestBasicFunction</span><span class="o">.</span><span class="n">bDone</span><span class="p">,</span> <span class="s1">&#39;Done should be set&#39;</span><span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbBPTM_TestBasicFunction</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span> <span class="s1">&#39;Error should be cleared&#39;</span><span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbBPTM_TestBasicFunction</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span> <span class="s1">&#39;Busy should be false&#39;</span><span class="p">);</span>

    <span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="s1">&#39;BPTMTest&#39;</span><span class="p">);</span>

<span class="n">END_CASE</span>
<span class="n">END_METHOD</span>

<span class="o">//</span> <span class="n">Simulate</span> <span class="n">error</span> <span class="n">due</span> <span class="n">to</span> <span class="n">full</span> <span class="n">arbiter</span>
<span class="n">METHOD</span> <span class="n">FullArbError</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span><span class="n">Final</span> <span class="ow">and</span> <span class="n">transition</span> <span class="n">assertions</span>
    <span class="n">nTransitionID</span>    <span class="p">:</span>    <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">1000</span><span class="p">;</span>
    <span class="n">stTransitionAssertion</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span> <span class="o">:=</span>  <span class="p">(</span> <span class="n">nTran</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">neVRange</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nRate</span>  <span class="o">:=</span> <span class="mi">0</span><span class="p">);</span><span class="o">//</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstSafeBeam</span><span class="p">;</span>

    <span class="n">nReqID</span>    <span class="p">:</span>    <span class="n">UDINT</span>    <span class="o">:=</span> <span class="mi">2000</span><span class="p">;</span>
    <span class="n">stReqAssertion</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="p">(</span> <span class="n">nTran</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">neVRange</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nRate</span>  <span class="o">:=</span> <span class="mi">0</span><span class="p">);</span><span class="o">//</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstSafeBeam</span><span class="p">;</span>

    <span class="n">idx</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>

    <span class="n">nRandID</span> <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
    <span class="n">testReq</span> <span class="p">:</span> <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="p">(</span><span class="n">neVRange</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#FFEE, nRate:=33);</span>

<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbBPTM_TestFullArb</span>    <span class="p">:</span>    <span class="n">BeamParameterTransitionManager</span><span class="p">;</span>
    <span class="n">fbArbFullErr</span>    <span class="p">:</span>    <span class="n">FB_Arbiter</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">ffo</span> <span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="n">fbSubSysIO</span> <span class="p">:</span> <span class="n">FB_DummyArbIO</span><span class="p">;</span>
    <span class="n">fbBPR</span> <span class="p">:</span>  <span class="n">FB_BPRequestor</span><span class="p">;</span>
    <span class="n">xFirstPass</span>    <span class="p">:</span>    <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">eTestStep</span><span class="p">:</span> <span class="n">E_BPTMTestStates</span> <span class="o">:=</span> <span class="n">E_BPTMTestStates</span><span class="o">.</span><span class="n">Init</span><span class="p">;</span>
    <span class="n">tonRetryTimeout</span> <span class="p">:</span> <span class="n">TON</span> <span class="o">:=</span> <span class="p">(</span><span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#5s);</span>
    <span class="n">entryToRetry</span> <span class="p">:</span> <span class="nb">bool</span> <span class="o">:=</span> <span class="n">true</span><span class="p">;</span>
    <span class="n">fbRand</span> <span class="p">:</span> <span class="n">DRAND</span> <span class="o">:=</span> <span class="p">(</span><span class="n">Seed</span> <span class="o">:=</span><span class="mi">1</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">CASE</span> <span class="n">eTestStep</span> <span class="n">OF</span>

<span class="n">E_BPTMTestStates</span><span class="o">.</span><span class="n">Init</span><span class="p">:</span>

    <span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;BPTMErrorFullArb&#39;</span><span class="p">);</span>

    <span class="o">//</span> <span class="n">Fill</span> <span class="n">the</span> <span class="n">arbiter</span>
    <span class="n">FOR</span> <span class="n">idx</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">PMPS_PARAM</span><span class="o">.</span><span class="n">MAX_ASSERTIONS</span> <span class="o">//</span> <span class="n">this</span> <span class="n">fills</span> <span class="n">the</span> <span class="n">arbiter</span>
                    <span class="o">-</span> <span class="n">fbBPTM_TestFullArb</span><span class="o">.</span><span class="n">cReqArbCapacity</span> <span class="o">+</span> <span class="mi">1</span> <span class="n">DO</span> <span class="o">//</span> <span class="n">but</span> <span class="n">test</span> <span class="n">just</span> <span class="n">one</span> <span class="n">over</span> <span class="n">the</span> <span class="n">allowed</span> <span class="n">amount</span>
        <span class="n">fbArbFullErr</span><span class="o">.</span><span class="n">AddRequest</span><span class="p">(</span><span class="n">nReqID</span> <span class="o">:=</span> <span class="n">idx</span><span class="p">,</span> <span class="n">stReqBP</span> <span class="o">:=</span> <span class="n">testReq</span><span class="p">,</span> <span class="n">sDevName</span> <span class="o">:=</span><span class="s1">&#39;Device&#39;</span><span class="p">);</span>
    <span class="n">END_FOR</span>

    <span class="n">fbSubSysIO</span><span class="o">.</span><span class="n">AutoUpdateBP</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">PMPS_PARAM</span><span class="o">.</span><span class="n">MAX_ASSERTIONS</span> <span class="o">-</span> <span class="n">fbArbFullErr</span><span class="o">.</span><span class="n">nEntryCount</span> <span class="o">&lt;</span> <span class="n">fbBPTM_TestFullArb</span><span class="o">.</span><span class="n">cReqArbCapacity</span><span class="p">,</span>
        <span class="s1">&#39;Arbiter is not full enough, rest of tests will be invalid&#39;</span><span class="p">);</span>

    <span class="n">eTestStep</span> <span class="o">:=</span> <span class="n">E_BPTMTestStates</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>

<span class="n">E_BPTMTestStates</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>

    <span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;BPTM Full Error&#39;</span><span class="p">);</span>

    <span class="n">IF</span> <span class="n">fbBPTM_TestFullArb</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>

        <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbBPTM_TestFullArb</span><span class="o">.</span><span class="n">bError</span> <span class="n">AND</span> <span class="n">fbBPTM_TestFullArb</span><span class="o">.</span><span class="n">nErrId</span> <span class="o">=</span> <span class="n">PMPS_CODES</span><span class="o">.</span><span class="n">NoRoomInArb</span><span class="p">,</span>
            <span class="s1">&#39;Incorrect error response from full arbiter.&#39;</span><span class="p">);</span>

        <span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="s1">&#39;BPTM Full Error&#39;</span><span class="p">);</span>

        <span class="n">eTestStep</span> <span class="o">:=</span> <span class="n">E_BPTMTestStates</span><span class="o">.</span><span class="n">Retry</span><span class="p">;</span>

    <span class="n">END_IF</span>

<span class="n">E_BPTMTestStates</span><span class="o">.</span><span class="n">Retry</span><span class="p">:</span>

    <span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;Test Retry Post Failed Final&#39;</span><span class="p">);</span>

    <span class="o">//</span> <span class="n">Clear</span> <span class="n">the</span> <span class="n">arbiter</span>
    <span class="k">if</span> <span class="n">entryToRetry</span> <span class="n">THEN</span>
        <span class="n">FOR</span> <span class="n">idx</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">PMPS_PARAM</span><span class="o">.</span><span class="n">MAX_ASSERTIONS</span> <span class="o">+</span> <span class="mi">1</span> <span class="n">DO</span>
            <span class="n">fbArbFullErr</span><span class="o">.</span><span class="n">RemoveRequest</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
        <span class="n">END_FOR</span>
        <span class="n">entryToRetry</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>

    <span class="o">//</span> <span class="n">Push</span> <span class="n">the</span> <span class="n">retry</span> <span class="n">button</span>
    <span class="n">fbBPTM_TestFullArb</span><span class="o">.</span><span class="n">bRetry</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="n">tonRetryTimeout</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>

    <span class="n">IF</span> <span class="n">tonRetryTimeout</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">fbBPTM_TestFullArb</span><span class="o">.</span><span class="n">q_xTransitionAuthorized</span> <span class="n">THEN</span>
        <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbBPTM_TestFullArb</span><span class="o">.</span><span class="n">q_xTransitionAuthorized</span><span class="p">,</span> <span class="s1">&#39;Transition should have been authorized by now&#39;</span><span class="p">);</span>
        <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbFullErr</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">(</span><span class="n">nTransitionID</span><span class="p">),</span> <span class="s1">&#39;Transition ID is missing from arbiter while transition is authorized&#39;</span><span class="p">);</span>
        <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbFullErr</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">(</span><span class="n">nReqID</span><span class="p">),</span> <span class="s1">&#39;Final ID is missing from arbiter while transition is authorized&#39;</span><span class="p">);</span>

        <span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="s1">&#39;Test Retry Post Failed Final&#39;</span><span class="p">);</span>

        <span class="n">eTestStep</span> <span class="o">:=</span> <span class="n">E_BPTMTestStates</span><span class="o">.</span><span class="n">CleaningUp</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="n">E_BPTMTestStates</span><span class="o">.</span><span class="n">CleaningUp</span><span class="p">:</span>
    <span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="s1">&#39;BPTMErrorFullArb&#39;</span><span class="p">);</span>

<span class="n">END_CASE</span>

<span class="n">fbBPTM_TestFullArb</span><span class="p">(</span>
    <span class="n">fbArbiter</span> <span class="o">:=</span> <span class="n">fbArbFullErr</span><span class="p">,</span>
    <span class="n">i_TransitionAssertionID</span> <span class="o">:=</span> <span class="n">nTransitionID</span><span class="p">,</span>
    <span class="n">i_stTransitionAssertion</span> <span class="o">:=</span> <span class="n">stTransitionAssertion</span><span class="p">,</span>

    <span class="n">i_nRequestedAssertionID</span> <span class="o">:=</span> <span class="n">nReqID</span><span class="p">,</span>
    <span class="n">i_stRequestedAssertion</span> <span class="o">:=</span> <span class="n">stReqAssertion</span><span class="p">,</span>

    <span class="n">stCurrentBeamParameters</span> <span class="o">:=</span> <span class="n">fbSubSysIO</span><span class="o">.</span><span class="n">q_stSimulatedBPReadback</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbSubSysIO</span><span class="p">(</span><span class="n">LA</span> <span class="o">:=</span> <span class="n">fbArbFullErr</span><span class="p">,</span> <span class="n">FFO</span> <span class="o">:=</span> <span class="n">ffo</span><span class="p">);</span>
<span class="n">END_METHOD</span>

<span class="o">//</span> <span class="n">Test</span> <span class="n">the</span> <span class="n">BPTM</span> <span class="n">seamlessly</span> <span class="n">handles</span> <span class="n">new</span> <span class="n">requests</span> <span class="n">at</span> <span class="nb">any</span> <span class="n">stage</span>
<span class="o">//</span> <span class="n">Verify</span> <span class="n">old</span> <span class="n">requests</span> <span class="n">are</span> <span class="n">removed</span> <span class="kn">from</span><span class="w"> </span><span class="nn">arbiter</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_check&#39;</span><span class="p">}</span>
<span class="n">METHOD</span> <span class="n">InterruptAtAllSteps</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span><span class="n">Final</span> <span class="ow">and</span> <span class="n">transition</span> <span class="n">assertions</span>
    <span class="n">nTransitionID</span>    <span class="p">:</span>    <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#DAAD;</span>
    <span class="n">stTranReq</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cst0RateBeam</span><span class="p">;</span>

    <span class="n">nFirstReqID</span>    <span class="p">:</span>    <span class="n">UDINT</span>    <span class="o">:=</span> <span class="mi">16</span><span class="c1">#FEED;</span>
    <span class="n">stFirstReq</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="p">(</span><span class="n">nTran</span> <span class="o">:=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nRate</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#FEED, neVRange :=2#1111_1111_1111_1111_1111_1111_1111_1111);</span>

<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbBPTM_InterruptionTest</span>    <span class="p">:</span>    <span class="n">BeamParameterTransitionManager</span><span class="p">;</span>

    <span class="n">ffo</span> <span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>
    <span class="n">fbSubSysIO</span> <span class="p">:</span> <span class="n">FB_DummyArbIO</span><span class="p">;</span>
    <span class="n">fbBPR</span> <span class="p">:</span>  <span class="n">FB_BPRequestor</span><span class="p">;</span>
    <span class="n">xFirstPass</span>    <span class="p">:</span>    <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">eTestStep</span><span class="p">:</span> <span class="n">E_BPTMTestStates</span> <span class="o">:=</span> <span class="n">E_BPTMTestStates</span><span class="o">.</span><span class="n">Init</span><span class="p">;</span>
    <span class="n">tonRetryTimeout</span> <span class="p">:</span> <span class="n">TON</span> <span class="o">:=</span> <span class="p">(</span><span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#5s);</span>

    <span class="n">fbBPTMDiscCycles</span> <span class="p">:</span> <span class="n">BeamParameterTransitionManager</span><span class="p">;</span>
    <span class="n">fbSubSysIODisc</span> <span class="p">:</span> <span class="n">FB_DummyArbIO</span><span class="p">;</span>
    <span class="n">fbArbDisc</span> <span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

    <span class="n">iCount</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="n">aBPTM</span> <span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">cCycle</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BeamParameterTransitionManager</span><span class="p">;</span>
    <span class="n">BPTMUnderTest</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">BeamParameterTransitionManager</span><span class="p">;</span>
    <span class="n">fbArbiter</span>    <span class="p">:</span>    <span class="n">FB_Arbiter</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">aArbIO</span> <span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">cCycle</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_DummyArbIO</span><span class="p">;</span>
    <span class="n">ArbIO</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">FB_DummyArbIO</span><span class="p">;</span>
    <span class="n">nCycleLim</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nCycle</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">sCurrentTestName</span> <span class="p">:</span> <span class="n">STRING</span> <span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="n">bCycleLimHit</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nAllStepsDone</span> <span class="p">:</span> <span class="n">BYTE</span><span class="p">;</span>
    <span class="n">tTimeOut</span> <span class="p">:</span> <span class="n">TON</span> <span class="o">:=</span> <span class="p">(</span><span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#20ms);</span>

    <span class="n">bTestedOnce</span> <span class="p">:</span> <span class="n">BOOl</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">nNewTarget</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">nRequestBP</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">nWaitForBP</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">nTransitioning</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">nWaitForFinalBP</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">nCleaningUp</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="n">nDone</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">6</span><span class="p">;</span>
    <span class="n">nIdle</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">7</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">These</span> <span class="n">tests</span> <span class="n">will</span> <span class="n">confirm</span> <span class="n">the</span> <span class="n">BPTM</span> <span class="ow">is</span> <span class="n">interruptable</span> <span class="n">at</span> <span class="nb">any</span> <span class="n">step</span><span class="p">,</span>
<span class="n">meaning</span> <span class="n">it</span> <span class="n">will</span> <span class="ow">not</span> <span class="n">deadlock</span> <span class="ow">or</span> <span class="n">stall</span><span class="p">,</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">always</span> <span class="n">complete</span> <span class="k">with</span>
<span class="n">the</span> <span class="n">correct</span> <span class="n">sequencing</span> <span class="o">*</span><span class="p">)</span>

<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">functionality</span> <span class="ow">is</span> <span class="n">crucial</span> <span class="k">as</span> <span class="n">a</span> <span class="n">deadlocked</span> <span class="n">BPTM</span> <span class="n">will</span> <span class="n">need</span> <span class="n">manual</span> <span class="n">intervention</span><span class="p">,</span>
<span class="n">users</span> <span class="n">of</span> <span class="n">the</span> <span class="n">BPTM</span> <span class="n">should</span> <span class="n">always</span> <span class="n">be</span> <span class="n">able</span> <span class="n">to</span> <span class="n">just</span> <span class="nb">set</span> <span class="n">a</span> <span class="n">target</span> <span class="n">BP</span> <span class="n">that</span> <span class="ow">is</span> <span class="n">easy</span> <span class="n">to</span> <span class="n">reach</span>
<span class="n">at</span> <span class="nb">any</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">time</span><span class="p">,</span> <span class="ow">and</span> <span class="n">have</span> <span class="n">the</span> <span class="n">BPTM</span> <span class="n">head</span> <span class="ow">in</span> <span class="n">that</span> <span class="n">direction</span> <span class="ow">and</span> <span class="n">succeed</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>

<span class="o">//</span> <span class="n">Determine</span> <span class="n">how</span> <span class="n">many</span> <span class="n">cycles</span> <span class="n">it</span> <span class="n">would</span> <span class="n">take</span> <span class="n">normally</span><span class="p">,</span> <span class="n">to</span> <span class="n">complete</span> <span class="n">a</span> <span class="n">full</span> <span class="n">BPTM</span> <span class="n">cycle</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">count</span> <span class="n">will</span> <span class="n">be</span> <span class="n">verified</span> <span class="n">against</span> <span class="n">the</span> <span class="n">current</span> <span class="n">count</span> <span class="n">constant</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bTestedOnce</span> <span class="n">THEN</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;CheckBPTM Cycle Count&#39;</span><span class="p">);</span>

<span class="n">WHILE</span> <span class="n">fbBPTMDiscCycles</span><span class="o">.</span><span class="n">eBPTMState</span> <span class="o">&lt;&gt;</span> <span class="n">E_BPTMState</span><span class="o">.</span><span class="n">Idle</span> <span class="n">DO</span>

    <span class="n">fbBPTMDiscCycles</span><span class="o">.</span><span class="n">i_TransitionAssertionID</span> <span class="o">:=</span> <span class="n">nTransitionID</span><span class="p">;</span>
    <span class="n">fbBPTMDiscCycles</span><span class="o">.</span><span class="n">i_stTransitionAssertion</span> <span class="o">:=</span> <span class="n">stTranReq</span><span class="p">;</span>

    <span class="n">fbBPTMDiscCycles</span><span class="o">.</span><span class="n">i_nRequestedAssertionID</span> <span class="o">:=</span> <span class="n">nFirstReqID</span><span class="p">;</span>
    <span class="n">fbBPTMDiscCycles</span><span class="o">.</span><span class="n">i_stRequestedAssertion</span> <span class="o">:=</span> <span class="n">stFirstReq</span><span class="p">;</span>

    <span class="n">fbBPTMDiscCycles</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbDisc</span><span class="p">);</span>
    <span class="n">fbSubSysIODisc</span><span class="p">(</span><span class="n">LA</span><span class="o">:=</span><span class="n">fbArbDisc</span><span class="p">,</span> <span class="n">FFO</span><span class="o">:=</span><span class="n">ffo</span><span class="p">);</span>

    <span class="n">fbBPTMDiscCycles</span><span class="o">.</span><span class="n">stCurrentBeamParameters</span> <span class="o">:=</span> <span class="n">fbSubSysIODisc</span><span class="o">.</span><span class="n">q_stSimulatedBPReadback</span><span class="p">;</span>

    <span class="n">fbSubSysIODisc</span><span class="o">.</span><span class="n">AutoUpdateBP</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="n">fbBPTMDiscCycles</span><span class="o">.</span><span class="n">i_xDoneMoving</span> <span class="n">S</span><span class="o">=</span> <span class="n">fbBPTMDiscCycles</span><span class="o">.</span><span class="n">q_xTransitionAuthorized</span><span class="p">;</span>

    <span class="n">iCount</span> <span class="o">:=</span> <span class="n">iCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">END_WHILE</span>

<span class="n">IF</span> <span class="n">fbBPTMDiscCycles</span><span class="o">.</span><span class="n">eBPTMState</span> <span class="o">=</span> <span class="n">E_BPTMState</span><span class="o">.</span><span class="n">Idle</span> <span class="n">THEN</span>
    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">cCycle</span> <span class="o">&gt;=</span> <span class="n">iCount</span><span class="p">,</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;cCycle is too low, increase it to&#39;</span><span class="p">,</span> <span class="n">INT_TO_STRING</span><span class="p">(</span><span class="n">iCount</span><span class="p">)));</span>
    <span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="s1">&#39;CheckBPTM Cycle Count&#39;</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Run</span> <span class="n">BPTM</span> <span class="k">for</span> <span class="n">nCycleLim</span> <span class="n">cycles</span><span class="p">,</span> <span class="n">switch</span> <span class="n">to</span> <span class="n">a</span> <span class="n">new</span> <span class="n">target</span><span class="p">,</span> <span class="n">verify</span> <span class="n">BPTM</span> <span class="n">completes</span> <span class="n">anyways</span>

<span class="n">FOR</span> <span class="n">nCycleLim</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">cCycle</span> <span class="n">DO</span>

    <span class="n">nCycle</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">bCycleLimHit</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

    <span class="n">BPTMUnderTest</span> <span class="n">REF</span><span class="o">=</span> <span class="n">aBPTM</span><span class="p">[</span><span class="n">nCycleLim</span><span class="p">];</span>
    <span class="n">ArbIO</span> <span class="n">REF</span><span class="o">=</span> <span class="n">aArbIO</span><span class="p">[</span><span class="n">nCycleLim</span><span class="p">];</span>

    <span class="n">BPTMUnderTest</span><span class="o">.</span><span class="n">i_TransitionAssertionID</span> <span class="o">:=</span> <span class="n">nTransitionID</span><span class="p">;</span>
    <span class="n">BPTMUnderTest</span><span class="o">.</span><span class="n">i_stTransitionAssertion</span> <span class="o">:=</span> <span class="n">stTranReq</span><span class="p">;</span>

    <span class="n">ArbIO</span><span class="o">.</span><span class="n">AutoUpdateBP</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Start</span> <span class="n">the</span> <span class="n">test</span> <span class="k">for</span> <span class="n">this</span> <span class="n">Cycle</span> <span class="n">Limit</span>
    <span class="n">sCurrentTestName</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;CycleLimTest:&#39;</span><span class="p">,</span><span class="n">INT_TO_STRING</span><span class="p">(</span><span class="n">nCycleLim</span><span class="p">));</span>
    <span class="n">TEST</span><span class="p">(</span><span class="n">sCurrentTestName</span><span class="p">);</span>

    <span class="n">nAllStepsDone</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">tTimeOut</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>

    <span class="n">WHILE</span> <span class="n">nAllStepsDone</span> <span class="o">&lt;&gt;</span> <span class="mi">16</span><span class="c1">#FF DO</span>

        <span class="n">tTimeOut</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>

        <span class="n">IF</span> <span class="n">tTimeOut</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
            <span class="n">AssertTrue</span><span class="p">(</span><span class="n">FALSE</span><span class="p">,</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Failed &#39;</span><span class="p">,</span> <span class="n">BYTE_TO_HEXSTR</span><span class="p">(</span><span class="n">nAllStepsDone</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">)));</span>
            <span class="n">EXIT</span><span class="p">;</span>
        <span class="n">END_IF</span>

        <span class="o">//</span> <span class="n">Verify</span> <span class="nb">all</span> <span class="n">steps</span> <span class="n">complete</span>
        <span class="n">IF</span> <span class="n">bCycleLimHit</span> <span class="n">THEN</span>
            <span class="n">nAllStepsDone</span><span class="o">.</span><span class="n">nNewTarget</span> <span class="n">S</span><span class="o">=</span> <span class="n">BPTMUnderTest</span><span class="o">.</span><span class="n">eBPTMState</span> <span class="o">=</span> <span class="n">E_BPTMState</span><span class="o">.</span><span class="n">NewTarget</span><span class="p">;</span>
            <span class="n">nAllStepsDone</span><span class="o">.</span><span class="n">nRequestBP</span> <span class="n">S</span><span class="o">=</span> <span class="n">BPTMUnderTest</span><span class="o">.</span><span class="n">eBPTMState</span> <span class="o">=</span> <span class="n">E_BPTMState</span><span class="o">.</span><span class="n">RequestBP</span><span class="p">;</span>
            <span class="n">nAllStepsDone</span><span class="o">.</span><span class="n">nWaitForBP</span> <span class="n">S</span><span class="o">=</span> <span class="n">BPTMUnderTest</span><span class="o">.</span><span class="n">eBPTMState</span> <span class="o">=</span> <span class="n">E_BPTMState</span><span class="o">.</span><span class="n">WaitForBP</span><span class="p">;</span>
            <span class="n">nAllStepsDone</span><span class="o">.</span><span class="n">nTransitioning</span> <span class="n">S</span><span class="o">=</span> <span class="n">BPTMUnderTest</span><span class="o">.</span><span class="n">eBPTMState</span> <span class="o">=</span> <span class="n">E_BPTMState</span><span class="o">.</span><span class="n">Transitioning</span><span class="p">;</span>
            <span class="n">nAllStepsDone</span><span class="o">.</span><span class="n">nWaitForFinalBP</span> <span class="n">S</span><span class="o">=</span> <span class="n">BPTMUnderTest</span><span class="o">.</span><span class="n">eBPTMState</span> <span class="o">=</span> <span class="n">E_BPTMState</span><span class="o">.</span><span class="n">WaitForFinalBP</span><span class="p">;</span>
            <span class="n">nAllStepsDone</span><span class="o">.</span><span class="n">nCleaningUp</span> <span class="n">S</span><span class="o">=</span> <span class="n">BPTMUnderTest</span><span class="o">.</span><span class="n">eBPTMState</span> <span class="o">=</span> <span class="n">E_BPTMState</span><span class="o">.</span><span class="n">CleaningUp</span><span class="p">;</span>
            <span class="n">nAllStepsDone</span><span class="o">.</span><span class="n">nDone</span> <span class="n">S</span><span class="o">=</span> <span class="n">BPTMUnderTest</span><span class="o">.</span><span class="n">eBPTMState</span> <span class="o">=</span> <span class="n">E_BPTMState</span><span class="o">.</span><span class="n">Done</span><span class="p">;</span>
            <span class="n">nAllStepsDone</span><span class="o">.</span><span class="n">nIdle</span> <span class="n">S</span><span class="o">=</span> <span class="n">BPTMUnderTest</span><span class="o">.</span><span class="n">eBPTMState</span> <span class="o">=</span> <span class="n">E_BPTMState</span><span class="o">.</span><span class="n">Idle</span><span class="p">;</span>
        <span class="n">ELSE</span>
            <span class="n">nAllStepsDone</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">END_IF</span>

        <span class="o">//</span> <span class="n">After</span> <span class="n">nCycleLim</span> <span class="n">cycles</span> <span class="p">(</span><span class="n">nCycle</span><span class="p">),</span> <span class="n">change</span> <span class="n">the</span> <span class="n">target</span>
        <span class="n">IF</span> <span class="n">nCycle</span> <span class="o">&gt;=</span> <span class="n">nCycleLim</span> <span class="n">THEN</span>
            <span class="n">BPTMUnderTest</span><span class="o">.</span><span class="n">i_nRequestedAssertionID</span> <span class="o">:=</span> <span class="n">nCycleLim</span><span class="p">;</span>
            <span class="n">BPTMUnderTest</span><span class="o">.</span><span class="n">i_stRequestedAssertion</span><span class="o">.</span><span class="n">nRate</span> <span class="o">:=</span> <span class="n">nCycleLim</span><span class="p">;</span>
            <span class="n">bCycleLimHit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">ELSE</span>
            <span class="n">BPTMUnderTest</span><span class="o">.</span><span class="n">i_nRequestedAssertionID</span> <span class="o">:=</span> <span class="n">nFirstReqID</span><span class="p">;</span>
            <span class="n">BPTMUnderTest</span><span class="o">.</span><span class="n">i_stRequestedAssertion</span> <span class="o">:=</span> <span class="n">stFirstReq</span><span class="p">;</span>
        <span class="n">END_IF</span>

        <span class="n">BPTMUnderTest</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">);</span>
        <span class="n">ArbIO</span><span class="p">(</span><span class="n">LA</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span> <span class="n">FFO</span> <span class="o">:=</span> <span class="n">ffo</span><span class="p">);</span>

        <span class="n">BPTMUnderTest</span><span class="o">.</span><span class="n">stCurrentBeamParameters</span> <span class="o">:=</span> <span class="n">ArbIO</span><span class="o">.</span><span class="n">q_stSimulatedBPReadback</span><span class="p">;</span>

        <span class="n">BPTMUnderTest</span><span class="o">.</span><span class="n">i_xDoneMoving</span> <span class="o">:=</span> <span class="n">BPTMUnderTest</span><span class="o">.</span><span class="n">q_xTransitionAuthorized</span><span class="p">;</span>

        <span class="n">nCycle</span> <span class="o">:=</span> <span class="n">nCycle</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

    <span class="n">END_WHILE</span>

    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequestInPool</span><span class="p">(</span><span class="n">BPTMUnderTest</span><span class="o">.</span><span class="n">i_nRequestedAssertionID</span><span class="p">),</span>
        <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Final req not in pool: &#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">nCycleLim</span><span class="p">)));</span>
    <span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequestInPool</span><span class="p">(</span><span class="n">BPTMUnderTest</span><span class="o">.</span><span class="n">i_TransitionAssertionID</span><span class="p">),</span>
        <span class="s1">&#39;TransReq still in pool&#39;</span><span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequestInPool</span><span class="p">(</span><span class="n">nFirstReqID</span><span class="p">),</span>
        <span class="s1">&#39;First req still in pool&#39;</span><span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">bCycleLimHit</span><span class="p">,</span>
        <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Cycle lim not hit&#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">nCycleLim</span><span class="p">)));</span>
    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">ArbIO</span><span class="o">.</span><span class="n">q_stSimulatedBPReadback</span><span class="o">.</span><span class="n">nRate</span> <span class="o">=</span> <span class="n">BPTMUnderTest</span><span class="o">.</span><span class="n">i_stRequestedAssertion</span><span class="o">.</span><span class="n">nRate</span><span class="p">,</span>
        <span class="s1">&#39;Rates are not equal...&#39;</span><span class="p">);</span>

    <span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="n">sCurrentTestName</span><span class="p">);</span>

    <span class="o">//</span> <span class="n">Clean</span> <span class="n">up</span> <span class="k">for</span> <span class="nb">next</span> <span class="n">test</span>

    <span class="n">fbArbiter</span><span class="o">.</span><span class="n">RemoveRequest</span><span class="p">(</span><span class="n">nFirstReqID</span><span class="p">);</span>
    <span class="n">fbArbiter</span><span class="o">.</span><span class="n">RemoveRequest</span><span class="p">(</span><span class="n">nTransitionID</span><span class="p">);</span>
    <span class="n">fbArbiter</span><span class="o">.</span><span class="n">RemoveRequest</span><span class="p">(</span><span class="n">nCycleLim</span><span class="p">);</span>

<span class="n">END_FOR</span>

<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="o">//</span> <span class="n">Test</span> <span class="n">the</span> <span class="n">BPTM</span> <span class="n">seamlessly</span> <span class="n">handles</span> <span class="n">new</span> <span class="n">requests</span> <span class="n">at</span> <span class="nb">any</span> <span class="n">stage</span>
<span class="o">//</span> <span class="n">Verify</span> <span class="n">old</span> <span class="n">requests</span> <span class="n">are</span> <span class="n">removed</span> <span class="kn">from</span><span class="w"> </span><span class="nn">arbiter</span>
<span class="n">METHOD</span> <span class="n">InterruptedTransition</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span><span class="n">Final</span> <span class="ow">and</span> <span class="n">transition</span> <span class="n">assertions</span>
    <span class="n">nTransitionID</span>    <span class="p">:</span>    <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">stTranReq</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstSafeBeam</span><span class="p">;</span>

    <span class="n">nFirstReqID</span>    <span class="p">:</span>    <span class="n">UDINT</span>    <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">stFirstReq</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="p">(</span><span class="n">nRate</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">);</span>

    <span class="n">nSecondReqID</span>    <span class="p">:</span>    <span class="n">UDINT</span>    <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">stSecReq</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="p">(</span><span class="n">nRate</span><span class="o">:=</span> <span class="mi">200</span><span class="p">);</span>

<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbBPTM_InterruptionTest</span>    <span class="p">:</span>    <span class="n">BeamParameterTransitionManager</span><span class="p">;</span>
    <span class="n">fbArbiter</span>    <span class="p">:</span>    <span class="n">FB_Arbiter</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">ffo</span> <span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="n">fbSubSysIO</span> <span class="p">:</span> <span class="n">FB_DummyArbIO</span><span class="p">;</span>
    <span class="n">fbBPR</span> <span class="p">:</span>  <span class="n">FB_BPRequestor</span><span class="p">;</span>
    <span class="n">xFirstPass</span>    <span class="p">:</span>    <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">eTestStep</span><span class="p">:</span> <span class="n">E_BPTMTestStates</span> <span class="o">:=</span> <span class="n">E_BPTMTestStates</span><span class="o">.</span><span class="n">Init</span><span class="p">;</span>
    <span class="n">tonRetryTimeout</span> <span class="p">:</span> <span class="n">TON</span> <span class="o">:=</span> <span class="p">(</span><span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#5s);</span>
<span class="n">END_VAR</span>
<span class="n">CASE</span> <span class="n">eTestStep</span> <span class="n">OF</span>

<span class="n">E_BPTMTestStates</span><span class="o">.</span><span class="n">Init</span><span class="p">:</span>

    <span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;BPTM Intr Trans&#39;</span><span class="p">);</span>

    <span class="n">fbBPTM_InterruptionTest</span><span class="o">.</span><span class="n">i_TransitionAssertionID</span> <span class="o">:=</span> <span class="n">nTransitionID</span><span class="p">;</span>
    <span class="n">fbBPTM_InterruptionTest</span><span class="o">.</span><span class="n">i_stTransitionAssertion</span> <span class="o">:=</span> <span class="n">stTranReq</span><span class="p">;</span>

    <span class="n">fbBPTM_InterruptionTest</span><span class="o">.</span><span class="n">i_nRequestedAssertionID</span> <span class="o">:=</span> <span class="n">nFirstReqID</span><span class="p">;</span>
    <span class="n">fbBPTM_InterruptionTest</span><span class="o">.</span><span class="n">i_stRequestedAssertion</span> <span class="o">:=</span> <span class="n">stFirstReq</span><span class="p">;</span>

    <span class="n">fbSubSysIO</span><span class="o">.</span><span class="n">AutoUpdateBP</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span> <span class="o">//</span> <span class="n">Enable</span> <span class="n">auto</span> <span class="n">update</span>

    <span class="n">eTestStep</span> <span class="o">:=</span> <span class="n">E_BPTMTestStates</span><span class="o">.</span><span class="n">WaitingForTransitionAssertion</span><span class="p">;</span>

<span class="n">E_BPTMTestStates</span><span class="o">.</span><span class="n">WaitingForBeam</span><span class="p">:</span>

    <span class="n">IF</span> <span class="n">fbBPTM_InterruptionTest</span><span class="o">.</span><span class="n">eBPTMState</span> <span class="o">=</span> <span class="n">E_BPTMState</span><span class="o">.</span><span class="n">WaitingForTransitionAssertion</span> <span class="n">AND</span>
        <span class="n">NOT</span> <span class="n">fbBPTM_InterruptionTest</span><span class="o">.</span><span class="n">xEntry</span> <span class="n">THEN</span> <span class="o">//</span> <span class="n">since</span> <span class="n">we</span><span class="s1">&#39;re not in entry anymore</span>

        <span class="o">//</span><span class="n">change</span> <span class="n">the</span> <span class="n">request</span> <span class="n">to</span> <span class="n">interrupt</span>
        <span class="n">fbBPTM_InterruptionTest</span><span class="o">.</span><span class="n">i_nRequestedAssertionID</span> <span class="o">:=</span> <span class="n">nSecondReqID</span><span class="p">;</span>
        <span class="n">fbBPTM_InterruptionTest</span><span class="o">.</span><span class="n">i_stRequestedAssertion</span> <span class="o">:=</span> <span class="n">stSecReq</span><span class="p">;</span>

        <span class="n">eTestStep</span> <span class="o">:=</span> <span class="n">E_BPTMTestStates</span><span class="o">.</span><span class="n">Transitioning</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="n">E_BPTMTestStates</span><span class="o">.</span><span class="n">Transitioning</span><span class="p">:</span>

    <span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;New Target Gets To Trans Auth&#39;</span><span class="p">);</span>

    <span class="n">tonRetryTimeout</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>

    <span class="n">IF</span> <span class="n">tonRetryTimeout</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">fbBPTM_InterruptionTest</span><span class="o">.</span><span class="n">q_xTransitionAuthorized</span> <span class="n">THEN</span>
        <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbBPTM_InterruptionTest</span><span class="o">.</span><span class="n">q_xTransitionAuthorized</span><span class="p">,</span> <span class="s1">&#39;Transition should have been authorized by now&#39;</span><span class="p">);</span>
        <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">(</span><span class="n">nTransitionID</span><span class="p">),</span> <span class="s1">&#39;Transition ID is missing from arbiter while transition is authorized&#39;</span><span class="p">);</span>
        <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">(</span><span class="n">nSecondReqID</span><span class="p">),</span> <span class="s1">&#39;Final ID is missing from arbiter while transition is authorized&#39;</span><span class="p">);</span>

        <span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="s1">&#39;New Target Gets To Trans Auth&#39;</span><span class="p">);</span>

        <span class="n">eTestStep</span> <span class="o">:=</span> <span class="n">E_BPTMTestStates</span><span class="o">.</span><span class="n">CleaningUp</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="n">E_BPTMTestStates</span><span class="o">.</span><span class="n">CleaningUp</span><span class="p">:</span>
    <span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="s1">&#39;BPTM Intr Trans&#39;</span><span class="p">);</span>

<span class="n">END_CASE</span>

<span class="n">fbBPTM_InterruptionTest</span><span class="p">(</span>
    <span class="n">fbArbiter</span> <span class="o">:=</span> <span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">stCurrentBeamParameters</span> <span class="o">:=</span> <span class="n">fbSubSysIO</span><span class="o">.</span><span class="n">q_stSimulatedBPReadback</span>
<span class="p">);</span>

<span class="n">fbSubSysIO</span><span class="p">(</span><span class="n">LA</span> <span class="o">:=</span> <span class="n">fbArbiter</span><span class="p">,</span> <span class="n">FFO</span> <span class="o">:=</span> <span class="n">ffo</span><span class="p">);</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#beamparametertransitionmanager">BeamParameterTransitionManager</a></p></li>
<li><p><a class="reference internal" href="#e-bptmstate">E_BPTMState</a></p></li>
<li><p><a class="reference internal" href="#e-bptmteststates">E_BPTMTestStates</a></p></li>
<li><p><a class="reference internal" href="#fb-arbiter">FB_Arbiter</a></p></li>
<li><p><a class="reference internal" href="#fb-bprequestor">FB_BPRequestor</a></p></li>
<li><p><a class="reference internal" href="#fb-dummyarbio">FB_DummyArbIO</a></p></li>
<li><p><a class="reference internal" href="#fb-hardwareffoutput">FB_HardwareFFOutput</a></p></li>
<li><p><a class="reference internal" href="#pmps-codes">PMPS_CODES</a></p></li>
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
<li><p><a class="reference internal" href="#pmps-param">PMPS_PARAM</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-ctls-outputs">
<h2>FB_CTLS_Outputs<a class="headerlink" href="#fb-ctls-outputs" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span>
<span class="n">Controls</span> <span class="n">auxiliary</span> <span class="n">beam</span> <span class="k">class</span><span class="w"> </span><span class="nc">outputs</span><span class="o">.</span>

<span class="mi">1</span><span class="o">-</span><span class="mi">3</span> <span class="n">are</span> <span class="n">mapped</span> <span class="n">to</span> <span class="n">control</span> <span class="n">the</span> <span class="n">Cu</span> <span class="n">beamline</span> <span class="n">rate</span> <span class="n">via</span> <span class="n">the</span> <span class="n">LCLS</span> <span class="n">II</span> <span class="n">MPS</span><span class="o">.</span>

<span class="n">Maps</span> <span class="n">beam</span> <span class="n">rate</span> <span class="n">requests</span> <span class="n">to</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="ow">or</span> <span class="n">full</span> <span class="n">rate</span> <span class="n">beam</span> <span class="k">for</span> <span class="n">Cu</span> <span class="n">linac</span><span class="o">.</span>

<span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_CTLS_Outputs</span>
<span class="n">VAR_INPUT</span>
    <span class="n">BP</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: CTLSChannel</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">CTLS</span> <span class="n">Rate</span> <span class="n">Control</span> <span class="n">hardwire</span> <span class="n">channel</span> <span class="n">state</span><span class="s1">&#39;}</span>
    <span class="n">epicsBitmap</span> <span class="p">:</span> <span class="n">WORD</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;[1] := TIIB[PMPS_Premp]^Channel 9^Output;</span>
                              <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">PMPS_Premp</span><span class="p">]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">10</span><span class="o">^</span><span class="n">Output</span><span class="p">;</span>
                              <span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">PMPS_Premp</span><span class="p">]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">11</span><span class="o">^</span><span class="n">Output</span><span class="p">;</span><span class="s1">&#39;}</span>
    <span class="n">q_CLTS_ASSERTION_LINES</span>    <span class="n">AT</span>    <span class="o">%</span><span class="n">Q</span><span class="o">*</span>    <span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1..3</span><span class="p">]</span> <span class="n">OF</span>    <span class="n">BOOL</span><span class="p">;</span>



<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">CLTS</span> <span class="mi">1</span><span class="n">Hz</span>
<span class="n">q_CLTS_ASSERTION_LINES</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">BP</span><span class="o">.</span><span class="n">nRate</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">;</span>
<span class="o">//</span> <span class="n">CLTS</span> <span class="mi">10</span><span class="n">Hz</span>
<span class="n">q_CLTS_ASSERTION_LINES</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">BP</span><span class="o">.</span><span class="n">nRate</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">;</span>
<span class="o">//</span> <span class="n">CLTS</span> <span class="n">Full</span> <span class="n">rate</span>
<span class="n">q_CLTS_ASSERTION_LINES</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">:=</span> <span class="n">BP</span><span class="o">.</span><span class="n">nRate</span> <span class="o">&gt;=</span> <span class="mi">120</span><span class="p">;</span>


<span class="n">epicsBitMap</span><span class="mf">.0</span> <span class="o">:=</span> <span class="n">q_CLTS_ASSERTION_LINES</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">epicsBitMap</span><span class="mf">.1</span> <span class="o">:=</span> <span class="n">q_CLTS_ASSERTION_LINES</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="n">epicsBitMap</span><span class="mf">.2</span> <span class="o">:=</span> <span class="n">q_CLTS_ASSERTION_LINES</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-diffbp-test">
<h2>FB_DiffBP_Test<a class="headerlink" href="#fb-diffbp-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;call_after_init&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_DiffBP_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>

<span class="n">END_VAR</span>
<span class="n">BPDiff</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="o">//</span><span class="n">Verify</span> <span class="n">BP</span> <span class="n">comparison</span> <span class="n">remains</span> <span class="n">logical</span><span class="o">.</span>
<span class="n">METHOD</span> <span class="n">BPDiff</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">BP1</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span>
    <span class="n">BP2</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;BPDiffCheck&#39;</span><span class="p">);</span>

<span class="n">BP2</span><span class="o">.</span><span class="n">nTran</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>

<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">F_DifferentBeamParams</span><span class="p">(</span><span class="n">BP1</span><span class="p">,</span> <span class="n">BP2</span><span class="p">),</span>
    <span class="s1">&#39;DifferentBP eval is broken (True)&#39;</span><span class="p">);</span>

<span class="n">BP1</span><span class="o">.</span><span class="n">nTran</span> <span class="o">:=</span> <span class="n">BP2</span><span class="o">.</span><span class="n">nTran</span><span class="p">;</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">F_DifferentBeamParams</span><span class="p">(</span><span class="n">BP2</span><span class="p">,</span> <span class="n">BP1</span><span class="p">),</span>
    <span class="s1">&#39;DifferentBP eval is broken (False)&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#f-differentbeamparams">F_DifferentBeamParams</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-dummyarbio">
<h2>FB_DummyArbIO<a class="headerlink" href="#fb-dummyarbio" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">Use</span> <span class="n">to</span> <span class="n">test</span> <span class="n">other</span> <span class="n">library</span> <span class="n">integrations</span> <span class="n">of</span> <span class="n">PMPS</span> <span class="n">preemptive</span> <span class="n">functionality</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">block</span> <span class="n">stands</span> <span class="ow">in</span> <span class="k">for</span> <span class="n">the</span> <span class="n">FB_SubSysToArb_IO</span> <span class="n">block</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>

<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_DummyArbIO</span> <span class="n">IMPLEMENTS</span> <span class="n">I_HigherAuthority</span><span class="p">,</span> <span class="n">I_LowerAuthority</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span><span class="n">stCurrentBP</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">ST_BeamParams</span><span class="p">;</span> <span class="o">//</span><span class="n">Set</span> <span class="n">to</span> <span class="n">something</span> <span class="n">to</span> <span class="n">redirect</span> <span class="n">currentBP</span> <span class="n">update</span>
    <span class="n">LA</span> <span class="p">:</span> <span class="n">I_LowerAuthority</span><span class="p">;</span>

    <span class="n">tRateDelay</span> <span class="p">:</span> <span class="n">TIME</span><span class="p">;</span> <span class="o">//</span> <span class="n">Delay</span> <span class="n">until</span> <span class="n">rate</span> <span class="ow">is</span> <span class="n">looped</span> <span class="n">back</span> <span class="n">into</span> <span class="n">q_stSimulatedBPReadback</span>
    <span class="n">tTransDelay</span> <span class="p">:</span> <span class="n">TIME</span><span class="p">;</span> <span class="o">//</span> <span class="n">Delay</span> <span class="n">until</span> <span class="n">transmission</span> <span class="ow">is</span> <span class="n">looped</span> <span class="n">back</span> <span class="n">into</span> <span class="n">q_stSimulatedBPReadback</span>
    <span class="n">tPEDelay</span> <span class="p">:</span> <span class="n">TIME</span><span class="p">;</span> <span class="o">//</span> <span class="n">Delay</span> <span class="n">until</span> <span class="n">PE</span> <span class="ow">is</span> <span class="n">looped</span> <span class="n">back</span> <span class="n">into</span> <span class="n">q_stSimulatedBPReadback</span>
    <span class="n">tAptDelay</span> <span class="p">:</span> <span class="n">TIME</span><span class="p">;</span> <span class="o">//</span> <span class="n">Delay</span> <span class="n">until</span> <span class="n">apertures</span> <span class="n">are</span> <span class="n">looped</span> <span class="n">back</span> <span class="n">into</span> <span class="n">q_stSimulatedBPReadback</span>
    <span class="n">tSattDelay</span> <span class="p">:</span> <span class="n">TIME</span><span class="p">;</span> <span class="o">//</span> <span class="n">Delay</span> <span class="n">until</span> <span class="n">apertures</span> <span class="n">are</span> <span class="n">looped</span> <span class="n">back</span> <span class="n">into</span> <span class="n">q_stSimulatedBPReadback</span>

<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">q_stSimulatedBPReadback</span> <span class="p">:</span> <span class="n">ST_BeamParams</span><span class="p">;</span> <span class="o">//</span> <span class="n">Updated</span> <span class="n">to</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">FFO</span> <span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
   <span class="n">bAutoUpdateBP</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span> <span class="o">//</span> <span class="n">Set</span> <span class="n">by</span> <span class="n">AutoUpdateBP</span> <span class="nb">property</span><span class="p">,</span> <span class="k">if</span> <span class="n">true</span> <span class="n">causes</span> <span class="n">this</span> <span class="n">FB</span> <span class="n">to</span> <span class="n">update</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">stCurrentBP</span> <span class="n">to</span> <span class="n">the</span>
   <span class="o">//</span> <span class="n">requested</span> <span class="n">value</span> <span class="n">automatically</span> <span class="n">within</span> <span class="n">the</span> <span class="n">RequestBP</span> <span class="n">method</span> <span class="ow">and</span> <span class="n">restore</span> <span class="n">it</span> <span class="n">within</span> <span class="n">the</span> <span class="n">RemoveRequest</span> <span class="n">method</span>
   <span class="n">stNewReqBP</span> <span class="p">:</span> <span class="n">ST_BeamParams</span><span class="p">;</span>

   <span class="n">stReqOutBP</span> <span class="p">:</span> <span class="n">ST_BeamParams</span><span class="p">;</span><span class="o">//</span> <span class="n">To</span> <span class="n">be</span> <span class="n">written</span> <span class="n">on</span> <span class="nb">next</span> <span class="n">ApplyBPReq</span> <span class="n">call</span>

   <span class="n">stSaveCurrentBP</span> <span class="p">:</span> <span class="n">ST_BeamParams</span><span class="p">;</span> <span class="o">//</span> <span class="n">Will</span> <span class="n">be</span> <span class="n">restored</span> <span class="n">after</span> <span class="n">RemoveRequest</span> <span class="n">then</span> <span class="n">ApplyBPReq</span> <span class="n">call</span>

   <span class="n">nSavedID</span> <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span> <span class="o">//</span> <span class="n">Used</span> <span class="n">to</span> <span class="n">simulate</span> <span class="n">CheckRequest</span> <span class="n">method</span>

   <span class="n">tonRate</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
   <span class="n">tonTrans</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
   <span class="n">tonPE</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
   <span class="n">tonApt</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
   <span class="n">tonSatt</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
   <span class="n">tonBCRange</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
   <span class="n">tonBC</span> <span class="p">:</span><span class="n">TON</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">LA</span><span class="o">.</span><span class="n">ElevateRequest</span><span class="p">(</span><span class="n">THIS</span><span class="o">^</span><span class="p">);</span>

<span class="n">ApplyBPReq</span><span class="p">(</span><span class="n">FALSE</span><span class="p">);</span> <span class="o">//</span><span class="n">If</span> <span class="n">autoupdate</span> <span class="ow">is</span> <span class="nb">set</span><span class="p">,</span> <span class="n">this</span> <span class="n">will</span> <span class="n">propagate</span> <span class="n">the</span> <span class="n">request</span> <span class="n">to</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">stCurrentBP</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="o">//</span> <span class="n">Call</span> <span class="n">this</span> <span class="n">method</span> <span class="n">to</span> <span class="n">update</span> <span class="n">q_stSimulatedBPReadback</span> <span class="n">at</span> <span class="n">will</span><span class="p">,</span> <span class="n">used</span> <span class="k">if</span> <span class="n">auto</span><span class="o">-</span><span class="n">update</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">false</span>
<span class="n">METHOD</span> <span class="n">ApplyBPReq</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bUpdateBP</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span> <span class="o">//</span> <span class="n">Set</span> <span class="n">true</span> <span class="ow">and</span> <span class="n">call</span> <span class="n">this</span> <span class="n">method</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">q_stSimulatedBPReadback</span> <span class="n">to</span> <span class="n">the</span> <span class="n">request</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">BP</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">ST_BeamParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">bUpdateBP</span> <span class="n">THEN</span>
    <span class="n">stSaveCurrentBP</span> <span class="o">:=</span> <span class="n">q_stSimulatedBPReadback</span><span class="p">;</span>
    <span class="n">q_stSimulatedBPReadback</span> <span class="o">:=</span> <span class="n">stReqOutBP</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">bAutoUpdateBP</span> <span class="n">THEN</span>
    <span class="n">tonApt</span><span class="o">.</span><span class="n">IN</span> <span class="o">:=</span> <span class="mi">0</span> <span class="o">&lt;&gt;</span> <span class="n">MEMCMP</span><span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">stReqOutBP</span><span class="o">.</span><span class="n">astApertures</span><span class="p">),</span> <span class="n">ADR</span><span class="p">(</span><span class="n">q_stSimulatedBPReadback</span><span class="o">.</span><span class="n">astApertures</span><span class="p">),</span> <span class="n">SIZEOF</span><span class="p">(</span><span class="n">q_stSimulatedBPReadback</span><span class="o">.</span><span class="n">astApertures</span><span class="p">));</span>
    <span class="n">tonApt</span><span class="p">(</span><span class="n">PT</span><span class="o">:=</span><span class="n">tAptDelay</span><span class="p">);</span>
    <span class="n">IF</span> <span class="n">tonApt</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">q_stSimulatedBPReadback</span><span class="o">.</span><span class="n">astApertures</span> <span class="o">:=</span> <span class="n">stReqOutBP</span><span class="o">.</span><span class="n">astApertures</span><span class="p">;</span> <span class="n">END_IF</span>

    <span class="n">tonRate</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">stReqOutBP</span><span class="o">.</span><span class="n">nRate</span><span class="o">&lt;&gt;</span><span class="n">q_stSimulatedBPReadback</span><span class="o">.</span><span class="n">nRate</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">tRateDelay</span><span class="p">);</span>
    <span class="n">IF</span> <span class="n">tonRate</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">q_stSimulatedBPReadback</span><span class="o">.</span><span class="n">nRate</span> <span class="o">:=</span> <span class="n">stReqOutBP</span><span class="o">.</span><span class="n">nRate</span><span class="p">;</span> <span class="n">END_IF</span>

    <span class="n">tonTrans</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">stReqOutBP</span><span class="o">.</span><span class="n">nTran</span><span class="o">&lt;&gt;</span><span class="n">q_stSimulatedBPReadback</span><span class="o">.</span><span class="n">nTran</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">tTransDelay</span><span class="p">);</span>
    <span class="n">IF</span> <span class="n">tonTrans</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">q_stSimulatedBPReadback</span><span class="o">.</span><span class="n">nTran</span> <span class="o">:=</span> <span class="n">stReqOutBP</span><span class="o">.</span><span class="n">nTran</span><span class="p">;</span> <span class="n">END_IF</span>

    <span class="n">tonPE</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">stReqOutBP</span><span class="o">.</span><span class="n">neVRange</span><span class="o">&lt;&gt;</span><span class="n">q_stSimulatedBPReadback</span><span class="o">.</span><span class="n">neVRange</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">tPEDelay</span><span class="p">);</span>
    <span class="n">IF</span> <span class="n">tonPE</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
        <span class="n">IF</span> <span class="n">stReqOutBP</span><span class="o">.</span><span class="n">neVRange</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
            <span class="n">q_stSimulatedBPReadback</span><span class="o">.</span><span class="n">neVRange</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">q_stSimulatedBPReadback</span><span class="o">.</span><span class="n">neVRange</span><span class="mf">.0</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">ELSE</span>
            <span class="n">q_stSimulatedBPReadback</span><span class="o">.</span><span class="n">neVRange</span> <span class="o">:=</span> <span class="n">stReqOutBP</span><span class="o">.</span><span class="n">neVRange</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>

    <span class="n">tonBCRange</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">stReqOutBP</span><span class="o">.</span><span class="n">nBCRange</span><span class="o">&lt;&gt;</span><span class="n">q_stSimulatedBPReadback</span><span class="o">.</span><span class="n">nBCRange</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">tPEDelay</span><span class="p">);</span>
     <span class="n">IF</span> <span class="n">tonBCRange</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
        <span class="n">IF</span> <span class="n">stReqOutBP</span><span class="o">.</span><span class="n">nBCRange</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
            <span class="n">q_stSimulatedBPReadback</span><span class="o">.</span><span class="n">nBCRange</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ELSE</span>
            <span class="n">q_stSimulatedBPReadback</span><span class="o">.</span><span class="n">nBCRange</span> <span class="o">:=</span> <span class="n">stReqOutBP</span><span class="o">.</span><span class="n">nBCRange</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>

    <span class="n">tonSatt</span><span class="o">.</span><span class="n">IN</span> <span class="o">:=</span> <span class="mi">0</span> <span class="o">&lt;&gt;</span> <span class="n">MEMCMP</span><span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">stReqOutBP</span><span class="o">.</span><span class="n">astAttenuators</span><span class="p">),</span> <span class="n">ADR</span><span class="p">(</span><span class="n">q_stSimulatedBPReadback</span><span class="o">.</span><span class="n">astAttenuators</span><span class="p">),</span> <span class="n">SIZEOF</span><span class="p">(</span><span class="n">q_stSimulatedBPReadback</span><span class="o">.</span><span class="n">astAttenuators</span><span class="p">));</span>
    <span class="n">tonSatt</span><span class="p">(</span><span class="n">PT</span><span class="o">:=</span><span class="n">tSattDelay</span><span class="p">);</span>
    <span class="n">IF</span> <span class="n">tonSatt</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">q_stSimulatedBPReadback</span><span class="o">.</span><span class="n">astAttenuators</span> <span class="o">:=</span> <span class="n">stReqOutBP</span><span class="o">.</span><span class="n">astAttenuators</span><span class="p">;</span> <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">ffo</span><span class="o">.</span><span class="n">ExecuteNoLog</span><span class="p">();</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">ffo</span><span class="o">.</span><span class="n">q_xFastFaultOut</span> <span class="n">THEN</span> <span class="n">q_stSimulatedBPReadback</span><span class="o">.</span><span class="n">nRate</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">CheckRequest</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nReqID</span>  <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">CheckRequest</span> <span class="o">:=</span> <span class="n">nReqID</span> <span class="o">=</span> <span class="n">nSavedID</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nReqID</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nReqID</span> <span class="o">&lt;&gt;</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">EXCLUDED_ASSERTION_ID</span><span class="p">);</span>
<span class="n">END_METHOD</span>

<span class="o">//</span> <span class="o">&lt;</span><span class="n">Arbiter</span> <span class="n">Internal</span><span class="o">&gt;</span>
<span class="o">//</span> <span class="n">Elevates</span> <span class="n">the</span> <span class="n">arbitrated</span> <span class="n">BP</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">something</span> <span class="n">above</span><span class="o">.</span>
<span class="o">//</span> <span class="n">Could</span> <span class="n">be</span> <span class="n">another</span> <span class="n">arbiter</span><span class="p">,</span> <span class="ow">or</span> <span class="n">a</span> <span class="n">BP</span> <span class="n">requester</span><span class="o">/</span> <span class="n">IO</span><span class="p">,</span>
<span class="o">//</span> <span class="ow">or</span> <span class="n">an</span> <span class="n">FB</span> <span class="n">that</span> <span class="n">locks</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">portion</span> <span class="n">of</span> <span class="n">the</span> <span class="n">BP</span> <span class="nb">set</span><span class="o">.</span>
<span class="n">METHOD</span> <span class="n">ElevateRequest</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">HigherAuthority</span> <span class="p">:</span> <span class="n">I_HigherAuthority</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">RemoveRequest</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="p">(</span><span class="o">*</span><span class="n">StateID</span> <span class="n">to</span> <span class="n">remove</span><span class="o">*</span><span class="p">)</span>
    <span class="n">nReqID</span>  <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">nSavedID</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">stReqOutBP</span> <span class="o">:=</span> <span class="n">stSaveCurrentBP</span><span class="p">;</span>

<span class="n">RemoveRequest</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="o">//</span> <span class="n">Request</span> <span class="n">a</span> <span class="n">BP</span> <span class="kn">from</span><span class="w"> </span><span class="nn">this</span> <span class="n">higher</span> <span class="n">authority</span>
<span class="n">METHOD</span> <span class="n">RequestBP</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="p">(</span><span class="o">*</span><span class="n">StateID</span> <span class="n">of</span> <span class="n">state</span> <span class="n">requesting</span> <span class="n">beam</span> <span class="n">parameter</span> <span class="nb">set</span><span class="o">*</span><span class="p">)</span>
    <span class="n">nReqID</span>  <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span><span class="n">Requested</span> <span class="n">beam</span> <span class="n">params</span><span class="o">*</span><span class="p">)</span>
    <span class="n">stReqBP</span> <span class="p">:</span> <span class="n">ST_BeamParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">nReqID</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">AND</span> <span class="n">nReqID</span> <span class="o">&lt;&gt;</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">EXCLUDED_ASSERTION_ID</span> <span class="n">THEN</span>
    <span class="n">nSavedID</span> <span class="o">:=</span> <span class="n">nReqID</span><span class="p">;</span>
    <span class="n">stReqOutBP</span> <span class="o">:=</span> <span class="n">stReqBP</span><span class="p">;</span>

    <span class="n">RequestBP</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">RequestBP</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">PROPERTY</span> <span class="n">AutoUpdateBP</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">AutoUpdateBP</span> <span class="o">:=</span> <span class="n">bAutoUpdateBP</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">AutoUpdateBP</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">bAutoUpdateBP</span> <span class="o">:=</span> <span class="n">AutoUpdateBP</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">nLowerAuthorityID</span> <span class="p">:</span> <span class="n">DWORD</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">nLowerAuthorityID</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">EXCLUDED_ASSERTION_ID</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-hardwareffoutput">FB_HardwareFFOutput</a></p></li>
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-dummyha">
<h2>FB_DummyHA<a class="headerlink" href="#fb-dummyha" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_DummyHA</span> <span class="n">IMPLEMENTS</span> <span class="n">I_HigherAuthority</span><span class="p">,</span> <span class="n">I_LowerAuthority</span>
<span class="n">VAR_INPUT</span>
    <span class="n">ReqAcknowledged</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span> <span class="o">//</span> <span class="n">Use</span> <span class="n">to</span> <span class="n">control</span> <span class="n">when</span> <span class="n">the</span> <span class="n">HA</span> <span class="n">CHeckRequest</span> <span class="n">Returns</span> <span class="n">TRUE</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>


<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">CheckRequest</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nReqID</span>  <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">CheckRequest</span> <span class="o">:=</span> <span class="n">ReqAcknowledged</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="o">//</span> <span class="o">&lt;</span><span class="n">Arbiter</span> <span class="n">Internal</span><span class="o">&gt;</span>
<span class="o">//</span> <span class="n">Elevates</span> <span class="n">the</span> <span class="n">arbitrated</span> <span class="n">BP</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">something</span> <span class="n">above</span><span class="o">.</span>
<span class="o">//</span> <span class="n">Could</span> <span class="n">be</span> <span class="n">another</span> <span class="n">arbiter</span><span class="p">,</span> <span class="ow">or</span> <span class="n">a</span> <span class="n">BP</span> <span class="n">requester</span><span class="o">/</span> <span class="n">IO</span><span class="p">,</span>
<span class="o">//</span> <span class="ow">or</span> <span class="n">an</span> <span class="n">FB</span> <span class="n">that</span> <span class="n">locks</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">portion</span> <span class="n">of</span> <span class="n">the</span> <span class="n">BP</span> <span class="nb">set</span><span class="o">.</span>
<span class="n">METHOD</span> <span class="n">ElevateRequest</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">HigherAuthority</span> <span class="p">:</span> <span class="n">I_HigherAuthority</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">RemoveRequest</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="p">(</span><span class="o">*</span><span class="n">StateID</span> <span class="n">to</span> <span class="n">remove</span><span class="o">*</span><span class="p">)</span>
    <span class="n">nReqID</span>  <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">RemoveRequest</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">RequestBP</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="p">(</span><span class="o">*</span><span class="n">StateID</span> <span class="n">of</span> <span class="n">state</span> <span class="n">requesting</span> <span class="n">beam</span> <span class="n">parameter</span> <span class="nb">set</span><span class="o">*</span><span class="p">)</span>
    <span class="n">nReqID</span>  <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span><span class="n">Requested</span> <span class="n">beam</span> <span class="n">params</span><span class="o">*</span><span class="p">)</span>
    <span class="n">stReqBP</span> <span class="p">:</span> <span class="n">ST_BeamParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">RequestBP</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">PROPERTY</span> <span class="n">nLowerAuthorityID</span> <span class="p">:</span> <span class="n">DWORD</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">nLowerAuthorityID</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">EXCLUDED_ASSERTION_ID</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-evrangecalculator-test">
<h2>FB_evRangeCalculator_Test<a class="headerlink" href="#fb-evrangecalculator-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;call_after_init&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_evRangeCalculator_Test</span> <span class="n">EXTENDS</span> <span class="n">FB_TestSuite</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">RandomBoundary</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">BasicFunction</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_check&#39;</span><span class="p">}</span>
<span class="n">METHOD</span> <span class="n">BasicFunction</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;displaymode&#39;</span> <span class="o">:=</span> <span class="s1">&#39;binary&#39;</span><span class="p">}</span>
    <span class="n">LastWord</span> <span class="p">:</span> <span class="n">DWORD</span> <span class="o">:=</span> <span class="mi">2</span><span class="c1">#0000_0000_0000_0000_0000_0000_0000_0010;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;displaymode&#39;</span> <span class="o">:=</span> <span class="s1">&#39;binary&#39;</span><span class="p">}</span>
    <span class="n">Result</span> <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;displaymode&#39;</span> <span class="o">:=</span> <span class="s1">&#39;binary&#39;</span><span class="p">}</span>
    <span class="n">TestEV</span> <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;displaymode&#39;</span> <span class="o">:=</span> <span class="s1">&#39;binary&#39;</span><span class="p">}</span>
    <span class="n">tEvW</span> <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
    <span class="n">tEv</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>


    <span class="n">fbStr</span> <span class="p">:</span> <span class="n">FB_FormatString</span><span class="p">;</span>

    <span class="n">MiscNumber</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">nLowerLimitBoundary</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">RandomBoundary</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">MNU</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">;</span> <span class="o">//</span><span class="n">RandomBoundary</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">MND</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="o">//</span><span class="n">RandomBoundary</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">END_VAR</span>
<span class="n">Test</span><span class="p">(</span><span class="s1">&#39;CheckRanges&#39;</span><span class="p">);</span>

<span class="o">//</span><span class="n">Lower</span> <span class="n">limit</span> <span class="n">equal</span>
<span class="n">tEvW</span><span class="o">.</span><span class="n">nLowerLimitBoundary</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">tEv</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_areVBoundaries</span><span class="p">[</span><span class="n">nLowerLimitBoundary</span><span class="p">];</span>
<span class="n">Result</span> <span class="o">:=</span> <span class="n">F_eVRangeCalculator</span><span class="p">(</span><span class="n">tEv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">Result</span> <span class="o">=</span> <span class="n">tEvW</span><span class="p">,</span>
    <span class="s1">&#39;Lower limit not inclusive&#39;</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Lower</span> <span class="nb">range</span> <span class="n">flags</span>
<span class="n">tEvW</span><span class="o">.</span><span class="n">nLowerLimitBoundary</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">tEv</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_areVBoundaries</span><span class="p">[</span><span class="n">nLowerLimitBoundary</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">Result</span> <span class="o">:=</span> <span class="n">F_eVRangeCalculator</span><span class="p">(</span><span class="n">tEv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">Result</span> <span class="o">=</span> <span class="n">tEvW</span><span class="p">,</span>
    <span class="s1">&#39;eV below lower range should come back true&#39;</span><span class="p">);</span>

<span class="o">//</span><span class="n">Mid</span> <span class="nb">range</span>
<span class="n">tEvW</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">tEvW</span><span class="o">.</span><span class="n">RandomBoundary</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="o">//</span><span class="n">ev</span> <span class="n">result</span> <span class="n">that</span> <span class="ow">is</span> <span class="n">smack</span> <span class="n">dab</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">middle</span> <span class="n">of</span> <span class="n">a</span> <span class="nb">range</span>
<span class="n">tEv</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_areVBoundaries</span><span class="p">[</span><span class="n">RandomBoundary</span><span class="p">]</span> <span class="o">-</span> <span class="p">((</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_areVBoundaries</span><span class="p">[</span><span class="n">RandomBoundary</span><span class="p">]</span> <span class="o">-</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_areVBoundaries</span><span class="p">[</span><span class="n">MND</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
<span class="n">Result</span> <span class="o">:=</span> <span class="n">F_eVRangeCalculator</span><span class="p">(</span><span class="n">tEv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">Result</span> <span class="o">=</span> <span class="n">tEvW</span><span class="p">,</span>
    <span class="s1">&#39;In range failed, whatever you did, it broke this really bad.&#39;</span><span class="p">);</span>

<span class="o">//</span><span class="n">Out</span> <span class="n">of</span> <span class="nb">range</span>
<span class="n">tEvW</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">tEvW</span><span class="o">.</span><span class="n">RandomBoundary</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="o">//</span><span class="n">Ev</span> <span class="n">result</span> <span class="n">that</span> <span class="ow">is</span> <span class="n">beyond</span> <span class="n">the</span> <span class="n">current</span> <span class="nb">range</span> <span class="p">(</span><span class="n">midway</span> <span class="n">into</span> <span class="n">the</span> <span class="nb">next</span> <span class="nb">range</span> <span class="n">up</span><span class="p">)</span>
<span class="n">tEv</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_areVBoundaries</span><span class="p">[</span><span class="n">MNU</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_areVBoundaries</span><span class="p">[</span><span class="n">MNU</span><span class="p">]</span><span class="o">-</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_areVBoundaries</span><span class="p">[</span><span class="n">RandomBoundary</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="n">Result</span> <span class="o">:=</span> <span class="n">F_eVRangeCalculator</span><span class="p">(</span><span class="n">tEv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">Result</span> <span class="o">=</span> <span class="n">tEvW</span><span class="p">,</span>
    <span class="s1">&#39;Out of range failed, whatever you did, it broke this really bad.&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>

<span class="n">Test</span><span class="p">(</span><span class="s1">&#39;Negative eV failsafes&#39;</span><span class="p">);</span>
<span class="o">//</span><span class="n">Negative</span> <span class="n">eV</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">F_eVRangeCalculator</span><span class="p">(</span><span class="o">-</span><span class="mi">300</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mi">16</span><span class="c1">#FFFF_FFFF,</span>
    <span class="s1">&#39;Working with antimatter? Negative eV should failsafe to FFFF.&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>

<span class="n">Test</span><span class="p">(</span><span class="s1">&#39;Out of range eV failsafes&#39;</span><span class="p">);</span>
<span class="o">//</span> <span class="n">eV</span> <span class="n">too</span> <span class="n">high</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">F_eVRangeCalculator</span><span class="p">(</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_areVBoundaries</span><span class="p">[</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_cBoundaries</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mi">16</span><span class="c1">#FFFF_FFFF,</span>
    <span class="s1">&#39;eV above the last threshold should failsafe.&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>

<span class="n">Test</span><span class="p">(</span><span class="s1">&#39;Check hyst keeps&#39;</span><span class="p">);</span>

<span class="n">LastWord</span> <span class="o">:=</span> <span class="n">F_eVRangeCalculator</span><span class="p">(</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_areVBoundaries</span><span class="p">[</span><span class="n">RandomBoundary</span><span class="p">],</span> <span class="mi">2</span><span class="c1">#0000_0000_0000_0000_0000_0000_0000_0000);</span>

<span class="o">//</span> <span class="n">Last</span> <span class="n">word</span> <span class="n">should</span> <span class="n">be</span> <span class="mi">2</span><span class="c1">#0000_0000_0000_0100</span>

    <span class="n">Result</span> <span class="o">:=</span> <span class="n">F_eVRangeCalculator</span><span class="p">(</span>
        <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_areVBoundaries</span><span class="p">[</span><span class="n">RandomBoundary</span><span class="p">]</span> <span class="o">+</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">reVHyst</span> <span class="o">-</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">reVHyst</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
         <span class="n">LastWord</span><span class="p">);</span>
    <span class="n">TestEV</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">TestEV</span><span class="o">.</span><span class="n">RandomBoundary</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TestEV</span><span class="o">.</span><span class="n">MNU</span> <span class="o">:=</span> <span class="kc">True</span><span class="p">;</span>

    <span class="n">fbStr</span><span class="o">.</span><span class="n">arg1</span> <span class="o">:=</span> <span class="n">F_DWORD</span><span class="p">(</span><span class="n">Result</span><span class="p">);</span>
    <span class="n">fbStr</span><span class="o">.</span><span class="n">arg2</span> <span class="o">:=</span> <span class="n">F_DWORD</span><span class="p">(</span><span class="n">TestEV</span><span class="p">);</span>
    <span class="n">fbStr</span><span class="o">.</span><span class="n">sFormat</span> <span class="o">:=</span> <span class="s1">&#39;Moving up does not stick. Result: %b vs. Test: %b&#39;</span><span class="p">;</span>
    <span class="n">fbStr</span><span class="p">();</span>

<span class="n">AssertTrue</span><span class="p">(</span><span class="n">Result</span> <span class="o">=</span> <span class="n">TestEV</span><span class="p">,</span>
    <span class="n">fbStr</span><span class="o">.</span><span class="n">sOut</span><span class="p">);</span>

    <span class="n">Result</span> <span class="o">:=</span> <span class="n">F_eVRangeCalculator</span><span class="p">(</span>
        <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_areVBoundaries</span><span class="p">[</span><span class="n">RandomBoundary</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">reVHyst</span> <span class="o">+</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">reVHyst</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">LastWord</span><span class="p">);</span>
    <span class="n">TestEV</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">TestEV</span><span class="o">.</span><span class="n">RandomBoundary</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TestEV</span><span class="o">.</span><span class="n">MND</span> <span class="o">:=</span> <span class="kc">True</span><span class="p">;</span>

    <span class="n">fbStr</span><span class="o">.</span><span class="n">arg1</span> <span class="o">:=</span> <span class="n">F_DWORD</span><span class="p">(</span><span class="n">Result</span><span class="p">);</span>
    <span class="n">fbStr</span><span class="o">.</span><span class="n">arg2</span> <span class="o">:=</span> <span class="n">F_DWORD</span><span class="p">(</span><span class="n">TestEV</span><span class="p">);</span>
    <span class="n">fbStr</span><span class="o">.</span><span class="n">sFormat</span> <span class="o">:=</span> <span class="s1">&#39;Moving down does not stick. Result: %b vs. Test: %b&#39;</span><span class="p">;</span>
    <span class="n">fbStr</span><span class="p">();</span>

<span class="n">AssertTrue</span><span class="p">(</span><span class="n">Result</span> <span class="o">=</span> <span class="n">TestEV</span><span class="p">,</span>
    <span class="n">fbStr</span><span class="o">.</span><span class="n">sOut</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>

<span class="n">Test</span><span class="p">(</span><span class="s1">&#39;Check hyst drops&#39;</span><span class="p">);</span>

    <span class="n">Result</span> <span class="o">:=</span> <span class="n">F_eVRangeCalculator</span><span class="p">(</span>
        <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_areVBoundaries</span><span class="p">[</span><span class="n">MND</span><span class="p">]</span> <span class="o">-</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">reVHyst</span><span class="o">*</span><span class="mf">1.1</span><span class="p">,</span>
        <span class="n">LastWord</span><span class="p">);</span>
    <span class="n">TestEV</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">TestEV</span><span class="o">.</span><span class="n">MND</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="n">fbStr</span><span class="o">.</span><span class="n">arg1</span> <span class="o">:=</span> <span class="n">F_DWORD</span><span class="p">(</span><span class="n">Result</span><span class="p">);</span>
    <span class="n">fbStr</span><span class="o">.</span><span class="n">arg2</span> <span class="o">:=</span> <span class="n">F_DWORD</span><span class="p">(</span><span class="n">TestEV</span><span class="p">);</span>
    <span class="n">fbStr</span><span class="o">.</span><span class="n">sFormat</span> <span class="o">:=</span> <span class="s1">&#39;Moving down does not drop. Result: %b vs. Test: %b&#39;</span><span class="p">;</span>
    <span class="n">fbStr</span><span class="p">();</span>

<span class="n">AssertTrue</span><span class="p">(</span><span class="n">Result</span> <span class="o">=</span> <span class="n">TestEV</span><span class="p">,</span>
    <span class="n">fbStr</span><span class="o">.</span><span class="n">sOut</span><span class="p">);</span>

    <span class="n">Result</span> <span class="o">:=</span> <span class="n">F_eVRangeCalculator</span><span class="p">(</span>
        <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_areVBoundaries</span><span class="p">[</span><span class="n">RandomBoundary</span><span class="p">]</span> <span class="o">+</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">reVHyst</span><span class="o">*</span><span class="mf">1.1</span><span class="p">,</span>
        <span class="n">LastWord</span><span class="p">);</span>
    <span class="n">TestEV</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">TestEV</span><span class="o">.</span><span class="n">MNU</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="n">fbStr</span><span class="o">.</span><span class="n">arg1</span> <span class="o">:=</span> <span class="n">F_DWORD</span><span class="p">(</span><span class="n">Result</span><span class="p">);</span>
    <span class="n">fbStr</span><span class="o">.</span><span class="n">arg2</span> <span class="o">:=</span> <span class="n">F_DWORD</span><span class="p">(</span><span class="n">TestEV</span><span class="p">);</span>
    <span class="n">fbStr</span><span class="o">.</span><span class="n">sFormat</span> <span class="o">:=</span> <span class="s1">&#39;Moving up does not drop. Result: %b vs. Test: %b&#39;</span><span class="p">;</span>
    <span class="n">fbStr</span><span class="p">();</span>

<span class="n">AssertTrue</span><span class="p">(</span><span class="n">Result</span> <span class="o">=</span> <span class="n">TestEV</span><span class="p">,</span>
    <span class="n">fbStr</span><span class="o">.</span><span class="n">sOut</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#f-evrangecalculator">F_eVRangeCalculator</a></p></li>
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-evsimulator">
<h2>FB_eVSimulator<a class="headerlink" href="#fb-evsimulator" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">eV</span> <span class="n">Simulator</span>
<span class="n">A</span><span class="o">.</span> <span class="n">Wallace</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">8</span><span class="o">-</span><span class="mi">30</span>

<span class="n">Adds</span> <span class="n">noise</span> <span class="n">to</span> <span class="n">the</span> <span class="n">eV</span> <span class="ow">and</span> <span class="n">changes</span> <span class="n">eV</span> <span class="n">position</span> <span class="n">occasionally</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_eVSimulator</span>
<span class="n">VAR_INPUT</span>
    <span class="n">NoiseLevel</span>      <span class="p">:</span>       <span class="n">REAL</span>    <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">//</span> <span class="n">eV</span> <span class="n">Noise</span>
    <span class="n">ChangeTime</span> <span class="p">:</span> <span class="n">TIME</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#10S;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">eV</span>      <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">300</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">eVRange</span> <span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">1600</span><span class="p">;</span>
    <span class="n">timer</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">eVRand</span>  <span class="p">:</span>       <span class="n">DRAND</span> <span class="o">:=</span><span class="p">(</span><span class="n">Seed</span><span class="o">:=</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">NoiseRand</span> <span class="p">:</span> <span class="n">DRAND</span> <span class="o">:=</span> <span class="p">(</span><span class="n">Seed</span><span class="o">:=</span><span class="mi">0</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">timer</span><span class="p">(</span><span class="ow">in</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">ChangeTime</span><span class="p">);</span>

<span class="o">//</span><span class="n">Occasionally</span> <span class="n">change</span> <span class="n">eV</span>
<span class="n">IF</span> <span class="n">timer</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">timer</span><span class="p">(</span><span class="ow">in</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
    <span class="n">eVRand</span><span class="p">();</span>
    <span class="n">eV</span> <span class="o">:=</span> <span class="n">LIMIT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">eVRange</span><span class="o">*</span><span class="n">LREAL_TO_REAL</span><span class="p">(</span><span class="n">eVRand</span><span class="o">.</span><span class="n">Num</span><span class="p">),</span> <span class="n">eVRange</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Noise</span> <span class="n">generation</span>
<span class="n">NoiseRand</span><span class="p">();</span>
<span class="n">eV</span> <span class="o">:=</span> <span class="n">eV</span> <span class="o">+</span> <span class="n">NoiseLevel</span><span class="o">*</span><span class="n">LREAL_TO_REAL</span><span class="p">(</span><span class="n">NoiseRand</span><span class="o">.</span><span class="n">Num</span><span class="p">);</span>
<span class="n">NoiseRand</span><span class="p">();</span>
<span class="n">eV</span> <span class="o">:=</span> <span class="n">LIMIT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ev</span> <span class="o">-</span> <span class="n">NoiseLevel</span><span class="o">*</span><span class="n">LREAL_TO_REAL</span><span class="p">(</span><span class="n">NoiseRand</span><span class="o">.</span><span class="n">Num</span><span class="p">),</span> <span class="n">eVRange</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-evwithinspec-test">
<h2>FB_eVWithinSpec_Test<a class="headerlink" href="#fb-evwithinspec-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;call_after_init&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_eVWithinSpec_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">evWithinRangeChecks</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">evWithinRangeChecks</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>

<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;evWithinRangeChecks&#39;</span><span class="p">);</span>

<span class="o">//</span><span class="n">Upper</span> <span class="n">limit</span> <span class="n">equal</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">F_eVWithinSpec</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">2</span><span class="c1">#0000_0000_0000_0010),</span>
    <span class="s1">&#39;Upper limit not inclusive&#39;</span><span class="p">);</span>
<span class="o">//</span><span class="n">Lower</span> <span class="n">limit</span> <span class="n">equal</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">F_eVWithinSpec</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">2</span><span class="c1">#0000_0000_0000_0100),</span>
    <span class="s1">&#39;Lower limit not inclusive&#39;</span><span class="p">);</span>
<span class="o">//</span><span class="n">Out</span> <span class="n">of</span> <span class="nb">range</span>
<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">F_eVWithinSpec</span><span class="p">(</span><span class="mf">300.1</span><span class="p">,</span> <span class="mi">2</span><span class="c1">#0000_0000_0000_0010),</span>
    <span class="s1">&#39;Out of range failed, whatever you did, it broke this really bad.&#39;</span><span class="p">);</span>
<span class="o">//</span><span class="n">Negative</span> <span class="n">eV</span>
<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">F_eVWithinSpec</span><span class="p">(</span><span class="o">-</span><span class="mi">300</span><span class="p">,</span> <span class="mi">16</span><span class="c1">#FFFF),</span>
    <span class="s1">&#39;Working with antimatter? Negative eV should not be acceptable.&#39;</span><span class="p">);</span>
<span class="o">//</span><span class="n">Upper</span> <span class="n">unallocated</span> <span class="nb">range</span>
<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">F_eVWithinSpec</span><span class="p">(</span><span class="mi">1701</span><span class="p">,</span> <span class="mi">2</span><span class="c1">#1000_0000_0000_0000),</span>
    <span class="s1">&#39;eV range should not evaluate past 1.7keV&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#f-evwithinspec">F_eVWithinSpec</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-fastfault">
<h2>FB_FastFault<a class="headerlink" href="#fb-fastfault" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">Fast</span> <span class="n">Fault</span>
<span class="mi">2019</span><span class="o">-</span><span class="mi">9</span><span class="o">-</span><span class="mi">13</span> <span class="n">A</span><span class="o">.</span> <span class="n">Wallace</span>

<span class="n">Use</span> <span class="n">this</span> <span class="n">block</span> <span class="n">to</span> <span class="n">generate</span> <span class="n">a</span> <span class="n">beam</span><span class="o">-</span><span class="n">off</span> <span class="n">fault</span><span class="o">.</span> <span class="n">Connects</span> <span class="n">to</span> <span class="n">a</span> <span class="n">fast</span> <span class="n">fault</span> <span class="n">hardware</span> <span class="n">output</span>
<span class="n">function</span> <span class="n">block</span> <span class="n">to</span> <span class="n">contribute</span> <span class="n">to</span> <span class="n">the</span> <span class="n">state</span> <span class="n">of</span> <span class="n">the</span> <span class="n">fast</span> <span class="n">fault</span> <span class="n">output</span> <span class="p">(</span><span class="n">FFO</span><span class="p">)</span><span class="o">.</span>

<span class="n">If</span> <span class="n">the</span> <span class="n">i_xOK</span> <span class="n">goes</span> <span class="n">false</span><span class="p">,</span> <span class="n">the</span> <span class="n">associated</span> <span class="n">FFO</span> <span class="n">will</span> <span class="n">go</span> <span class="n">false</span><span class="p">,</span> <span class="n">despite</span> <span class="n">the</span> <span class="n">state</span> <span class="n">of</span> <span class="nb">any</span> <span class="n">other</span>
<span class="n">contributing</span> <span class="n">fast</span> <span class="n">faults</span><span class="p">,</span> <span class="n">unless</span> <span class="n">the</span> <span class="n">FFO</span> <span class="ow">is</span> <span class="n">currently</span> <span class="n">vetoed</span><span class="o">.</span>

<span class="o">*</span><span class="p">)</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;reflection&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_FastFault</span>
<span class="n">VAR_INPUT</span>

    <span class="n">i_xOK</span>        <span class="p">:</span>    <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Connect</span> <span class="n">to</span> <span class="n">fast</span><span class="o">-</span><span class="n">fault</span> <span class="n">condition</span> <span class="p">(</span><span class="n">false</span> <span class="n">produces</span> <span class="n">fault</span><span class="p">)</span>
    <span class="n">i_xReset</span>    <span class="p">:</span>    <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Resets</span> <span class="n">when</span> <span class="n">i_xOK</span> <span class="ow">is</span> <span class="n">true</span> <span class="ow">and</span> <span class="n">this</span> <span class="ow">is</span> <span class="n">true</span>
    <span class="n">i_xAutoReset</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span> <span class="o">//</span> <span class="n">Automatically</span> <span class="n">clear</span> <span class="n">fast</span> <span class="n">fault</span> <span class="p">(</span><span class="n">latching</span> <span class="n">vs</span> <span class="n">non</span><span class="o">-</span><span class="n">latching</span><span class="p">)</span>
    <span class="n">i_xVetoable</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span> <span class="o">//</span> <span class="n">Mask</span> <span class="n">this</span> <span class="n">fast</span> <span class="n">fault</span> <span class="k">if</span> <span class="n">the</span> <span class="n">FFO</span> <span class="n">veto</span> <span class="n">device</span> <span class="ow">is</span> <span class="n">true</span>

    <span class="n">i_DevName</span> <span class="p">:</span> <span class="n">T_MaxString</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span> <span class="o">//</span> <span class="n">Device</span> <span class="n">name</span> <span class="k">for</span> <span class="n">diagnostic</span>
    <span class="n">i_Desc</span> <span class="p">:</span> <span class="n">T_MaxString</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span> <span class="o">//</span> <span class="n">Description</span> <span class="n">of</span> <span class="n">fast</span> <span class="n">fault</span> <span class="p">(</span><span class="n">you</span> <span class="n">should</span> <span class="nb">set</span> <span class="n">at</span> <span class="n">init</span><span class="p">)</span>
    <span class="n">i_TypeCode</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">Error</span> <span class="n">code</span> <span class="k">for</span> <span class="n">classifying</span> <span class="n">fast</span> <span class="n">faults</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">o_xFFLine</span>    <span class="p">:</span>    <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Connect</span> <span class="n">to</span> <span class="n">HW</span> <span class="n">output</span> <span class="ow">or</span> <span class="n">another</span> <span class="n">FF</span> <span class="nb">input</span> <span class="k">if</span> <span class="n">you</span> <span class="n">like</span> <span class="p">(</span><span class="n">Optional</span><span class="p">)</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">io_fbFFHWO</span>        <span class="p">:</span>    <span class="n">FB_HardwareFFOutput</span><span class="p">;</span> <span class="o">//</span><span class="n">Point</span> <span class="n">to</span> <span class="n">FB_HardwareFFOutput</span> <span class="n">of</span> <span class="n">your</span> <span class="n">choice</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;instance-path&#39;</span><span class="p">}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;noinit&#39;</span><span class="p">}</span>
    <span class="n">sPath</span>    <span class="p">:</span>    <span class="n">T_MaxString</span><span class="p">;</span>

    <span class="n">FFInfo</span> <span class="p">:</span> <span class="n">ST_FFInfo</span><span class="p">;</span>

    <span class="n">RegistrationIdx</span> <span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="o">//</span> <span class="n">The</span> <span class="n">index</span> <span class="n">this</span> <span class="n">FF</span> <span class="n">was</span> <span class="n">registered</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">FFO</span>

    <span class="n">xInit</span>    <span class="p">:</span>    <span class="n">BOOL</span> <span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>

    <span class="n">InfoStringFmtr</span> <span class="p">:</span> <span class="n">FB_FormatString</span><span class="p">;</span>

    <span class="n">InUse</span> <span class="p">:</span> <span class="n">T_MaxString</span><span class="p">;</span>
    <span class="n">AutoReset</span> <span class="p">:</span> <span class="n">T_MaxString</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">xInit</span>    <span class="n">THEN</span>
    <span class="n">FFInfo</span><span class="o">.</span><span class="n">sPath</span> <span class="o">:=</span> <span class="n">sPath</span><span class="p">;</span>
    <span class="n">FFInfo</span><span class="o">.</span><span class="n">InUse</span> <span class="o">:=</span> <span class="kc">True</span><span class="p">;</span>
    <span class="n">FFInfo</span><span class="o">.</span><span class="n">TypeCode</span> <span class="o">:=</span> <span class="n">i_TypeCode</span><span class="p">;</span>
    <span class="n">FFInfo</span><span class="o">.</span><span class="n">DevName</span> <span class="o">:=</span> <span class="n">i_DevName</span><span class="p">;</span>
    <span class="n">FFInfo</span><span class="o">.</span><span class="n">Desc</span> <span class="o">:=</span> <span class="n">i_Desc</span><span class="p">;</span>
    <span class="n">FFInfo</span><span class="o">.</span><span class="n">AutoReset</span> <span class="o">:=</span> <span class="n">i_xAutoReset</span><span class="p">;</span>
    <span class="n">FFInfo</span><span class="o">.</span><span class="n">Vetoable</span> <span class="o">:=</span> <span class="n">i_xVetoable</span><span class="p">;</span>

    <span class="n">InUse</span> <span class="o">:=</span> <span class="n">BOOL_TO_STRING</span><span class="p">(</span><span class="n">FFInfo</span><span class="o">.</span><span class="n">InUse</span><span class="p">);</span>
    <span class="n">AutoReset</span> <span class="o">:=</span> <span class="n">BOOL_TO_STRING</span><span class="p">(</span><span class="n">FFInfo</span><span class="o">.</span><span class="n">AutoReset</span><span class="p">);</span>
    <span class="n">InfoStringFmtr</span><span class="p">(</span><span class="n">sFormat</span><span class="o">:=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">;</span><span class="si">%s</span><span class="s1">;</span><span class="si">%X</span><span class="s1">;</span><span class="si">%s</span><span class="s1">;</span><span class="si">%s</span><span class="s1">;</span><span class="si">%s</span><span class="s1">;&#39;</span><span class="p">,</span>
        <span class="n">arg1</span> <span class="o">:=</span> <span class="n">F_STRING</span><span class="p">(</span><span class="n">FFinfo</span><span class="o">.</span><span class="n">sPath</span><span class="p">),</span>
        <span class="n">arg2</span> <span class="o">:=</span> <span class="n">F_STRING</span><span class="p">(</span><span class="n">InUse</span><span class="p">),</span>
        <span class="n">arg3</span> <span class="o">:=</span> <span class="n">F_WORD</span><span class="p">(</span><span class="n">FFInfo</span><span class="o">.</span><span class="n">TypeCode</span><span class="p">),</span>
        <span class="n">arg4</span> <span class="o">:=</span> <span class="n">F_STRING</span><span class="p">(</span><span class="n">FFInfo</span><span class="o">.</span><span class="n">DevName</span><span class="p">),</span>
        <span class="n">arg5</span> <span class="o">:=</span> <span class="n">F_STRING</span><span class="p">(</span><span class="n">FFInfo</span><span class="o">.</span><span class="n">Desc</span><span class="p">),</span>
        <span class="n">arg6</span> <span class="o">:=</span> <span class="n">F_STRING</span><span class="p">(</span><span class="n">AutoReset</span><span class="p">),</span>
        <span class="n">sOut</span><span class="o">=&gt;</span><span class="n">FFInfo</span><span class="o">.</span><span class="n">InfoString</span><span class="p">);</span>
    <span class="n">io_fbFFHWO</span><span class="o">.</span><span class="n">Register</span><span class="p">(</span>
        <span class="n">stFFInfo</span><span class="o">:=</span><span class="n">FFInfo</span><span class="p">,</span>
        <span class="n">Idx</span><span class="o">=&gt;</span><span class="n">RegistrationIdx</span><span class="p">);</span>
    <span class="o">//&lt;</span><span class="n">TODO</span><span class="o">&gt;</span> <span class="k">if</span> <span class="n">registration</span> <span class="n">doesn</span><span class="s1">&#39;t succeed, send warning to diagnostic</span>
    <span class="n">xInit</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">io_fbFFHWO</span><span class="o">.</span><span class="n">IdxCheckIn</span><span class="p">(</span><span class="n">Idx</span><span class="o">:=</span><span class="n">RegistrationIdx</span><span class="p">,</span> <span class="n">OK</span> <span class="o">:=</span> <span class="n">i_xOK</span><span class="p">,</span> <span class="n">Reset</span><span class="o">:=</span> <span class="n">i_xReset</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-hardwareffoutput">FB_HardwareFFOutput</a></p></li>
<li><p><a class="reference internal" href="#st-ffinfo">ST_FFInfo</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-fastfault-test">
<h2>FB_FastFault_Test<a class="headerlink" href="#fb-fastfault-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;call_after_init&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_check&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_FastFault_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbTime</span> <span class="p">:</span> <span class="n">FB_LocalSystemTime</span> <span class="o">:=</span> <span class="p">(</span> <span class="n">bEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">dwCycle</span> <span class="o">:=</span> <span class="mi">1</span> <span class="p">);</span> <span class="o">//</span><span class="n">Get</span> <span class="n">current</span> <span class="n">system</span> <span class="n">time</span><span class="p">,</span> <span class="n">used</span> <span class="k">for</span> <span class="n">override</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">OvrdTime</span> <span class="p">:</span> <span class="n">TIME</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#2s;</span>
<span class="n">END_VAR</span>
<span class="n">FFCombinedFunctionality</span><span class="p">();</span>
<span class="n">FFRegistration</span><span class="p">();</span>
<span class="n">FFOvrdAndNextFault</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">FFCombinedFunctionality</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbFF</span>    <span class="p">:</span>    <span class="n">FB_FastFault</span><span class="p">;</span>
    <span class="n">fbFFO</span>    <span class="p">:</span>    <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;FFCombinedFunctionality&#39;</span><span class="p">);</span>

<span class="o">//</span><span class="n">Clear</span> <span class="n">initial</span> <span class="n">faults</span>
<span class="n">fbFFO</span><span class="o">.</span><span class="n">i_xReset</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span> <span class="o">//</span><span class="n">Reset</span> <span class="n">requested</span> <span class="n">at</span> <span class="n">start</span> <span class="n">of</span> <span class="n">cycle</span>

<span class="n">fbFF</span><span class="p">(</span><span class="n">io_fbFFHWO</span> <span class="o">:=</span> <span class="n">fbFFO</span><span class="p">,</span> <span class="o">//</span><span class="n">FF</span> <span class="n">reset</span> <span class="n">somehwere</span> <span class="ow">in</span> <span class="n">code</span>
    <span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">i_xReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>

<span class="n">fbFFO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span> <span class="o">//</span><span class="n">FFO</span> <span class="nb">eval</span> <span class="n">called</span> <span class="n">at</span> <span class="n">end</span> <span class="n">of</span> <span class="n">cycle</span>

<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbFFO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
    <span class="s1">&#39;Fast fault did not clear&#39;</span><span class="p">);</span>


<span class="o">//</span><span class="n">Induce</span> <span class="n">fault</span> <span class="k">with</span> <span class="n">FF</span>

<span class="n">fbFFO</span><span class="p">(</span><span class="n">i_xReset</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">);</span> <span class="o">//</span><span class="n">Reset</span> <span class="n">released</span> <span class="n">at</span> <span class="n">start</span> <span class="n">of</span> <span class="n">cycle</span>

<span class="n">fbFF</span><span class="p">(</span><span class="n">io_fbFFHWO</span> <span class="o">:=</span> <span class="n">fbFFO</span><span class="p">,</span> <span class="o">//</span><span class="n">FF</span> <span class="n">faulted</span>
    <span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">);</span> <span class="o">//</span><span class="n">Reset</span> <span class="ow">is</span> <span class="n">still</span> <span class="nb">set</span> <span class="n">true</span> <span class="kn">from</span><span class="w"> </span><span class="nn">last</span> <span class="n">call</span><span class="o">.</span>

<span class="n">fbFFO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span> <span class="o">//</span><span class="n">FFO</span> <span class="nb">eval</span> <span class="n">called</span> <span class="n">at</span> <span class="n">end</span> <span class="n">of</span> <span class="n">cycle</span>

<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbFFO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
    <span class="s1">&#39;Fast fault did not trip the beam&#39;</span><span class="p">);</span>


<span class="o">//</span><span class="n">FFO</span> <span class="n">remains</span> <span class="n">faulted</span> <span class="n">until</span> <span class="n">local</span> <span class="p">(</span><span class="n">FF</span><span class="p">)</span> <span class="ow">and</span> <span class="n">FFO</span> <span class="n">receieve</span> <span class="n">fresh</span> <span class="n">reset</span> <span class="n">request</span><span class="p">,</span> <span class="ow">and</span> <span class="n">faults</span>
<span class="o">//</span><span class="n">are</span> <span class="n">actually</span> <span class="n">cleared</span>

<span class="o">//</span><span class="n">Attempt</span> <span class="n">to</span> <span class="n">clear</span> <span class="n">FFO</span> <span class="n">fails</span> <span class="n">because</span> <span class="n">FF</span> <span class="n">still</span> <span class="n">faulted</span>
<span class="n">fbFFO</span><span class="o">.</span><span class="n">i_xReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span> <span class="o">//</span><span class="n">Reset</span> <span class="n">requested</span>

<span class="n">fbFF</span><span class="p">(</span><span class="n">io_fbFFHWO</span> <span class="o">:=</span> <span class="n">fbFFO</span><span class="p">,</span> <span class="o">//</span><span class="n">FF</span> <span class="n">faulted</span>
    <span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span>
    <span class="n">i_xReset</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">);</span>

<span class="n">fbFFO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span> <span class="o">//</span><span class="n">FFO</span> <span class="nb">eval</span> <span class="n">called</span> <span class="n">at</span> <span class="n">end</span> <span class="n">of</span> <span class="n">cycle</span>

<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbFFO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
    <span class="s1">&#39;Fast fault output cleared while fault remains, very bad&#39;</span><span class="p">);</span>

<span class="o">//</span><span class="n">Attempt</span> <span class="n">to</span> <span class="n">clear</span> <span class="n">FF</span> <span class="k">while</span> <span class="n">fault</span> <span class="n">remains</span> <span class="n">fails</span>
<span class="n">fbFFO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">(</span><span class="n">i_xReset</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">);</span>

<span class="n">fbFFO</span><span class="o">.</span><span class="n">i_xReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span> <span class="o">//</span><span class="n">Reset</span> <span class="n">requested</span>

<span class="n">fbFF</span><span class="p">(</span><span class="n">io_fbFFHWO</span> <span class="o">:=</span> <span class="n">fbFFO</span><span class="p">,</span> <span class="o">//</span><span class="n">FF</span> <span class="n">faulted</span>
    <span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span>
    <span class="n">i_xReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span> <span class="o">//</span><span class="n">This</span> <span class="n">reset</span> <span class="n">should</span> <span class="n">fail</span><span class="o">.</span>

<span class="n">fbFFO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span> <span class="o">//</span><span class="n">FFO</span> <span class="nb">eval</span> <span class="n">called</span> <span class="n">at</span> <span class="n">end</span> <span class="n">of</span> <span class="n">cycle</span>

<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbFFO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
    <span class="s1">&#39;Fast fault cleared while fault remains, very bad&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_check&#39;</span><span class="p">}</span>
<span class="n">METHOD</span> <span class="n">FFOvrdAndNextFault</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbFF</span>    <span class="p">:</span>    <span class="n">FB_FastFault</span> <span class="o">:=</span><span class="p">(</span>
        <span class="n">i_xAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">fbFFO</span>    <span class="p">:</span>    <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">i_sNetID</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">rFF</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">ST_FF</span><span class="p">;</span>

    <span class="n">FirstPass</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">fbTimePass</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">OvrdActvTstDone</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

    <span class="n">TestsDone</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">Now</span><span class="p">:</span> <span class="n">DATE_AND_TIME</span><span class="p">;</span>
    <span class="n">Expiration</span> <span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">OvdTime</span> <span class="p">:</span> <span class="n">TIME</span> <span class="p">;</span>
    <span class="n">Expire</span><span class="p">:</span> <span class="n">TIMESTRUCT</span><span class="p">;</span>
<span class="o">//</span><span class="n">seconds</span><span class="p">:</span><span class="n">ULINT</span><span class="p">;</span>
    <span class="n">specificLocalTimeToFileTime</span> <span class="p">:</span> <span class="n">FB_TzSpecificLocalTimeToFileTime</span><span class="p">;</span>
    <span class="n">fileTime</span><span class="p">:</span> <span class="n">T_FILETIME</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;FFVetoAndNextFault&#39;</span><span class="p">);</span>
<span class="n">fbTime</span><span class="p">();</span>

<span class="o">//</span> <span class="n">I</span> <span class="n">noticed</span> <span class="n">something</span> <span class="n">weird</span> <span class="n">going</span> <span class="n">on</span> <span class="k">with</span> <span class="n">the</span> <span class="n">PEWatcher</span> <span class="n">on</span> <span class="n">the</span> <span class="n">L</span> <span class="n">line</span><span class="o">.</span> <span class="n">It</span> <span class="n">was</span> <span class="n">faulted</span><span class="p">,</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">fast</span> <span class="n">fault</span>
<span class="o">//</span> <span class="n">was</span> <span class="ow">not</span> <span class="n">tripping</span> <span class="n">off</span> <span class="n">beam</span><span class="o">.</span> <span class="n">It</span> <span class="n">had</span> <span class="n">been</span> <span class="n">previously</span> <span class="n">overridden</span> <span class="n">so</span> <span class="n">I</span> <span class="n">was</span> <span class="n">wondering</span> <span class="n">why</span> <span class="n">it</span> <span class="n">wasn</span><span class="s1">&#39;t causing a trip.</span>

<span class="n">IF</span>  <span class="n">FirstPass</span>  <span class="n">THEN</span>

    <span class="n">fbFF</span><span class="p">(</span><span class="n">io_fbFFHWO</span> <span class="o">:=</span> <span class="n">fbFFO</span><span class="p">,</span> <span class="o">//</span><span class="n">FF</span> <span class="n">reset</span> <span class="n">somehwere</span> <span class="ow">in</span> <span class="n">code</span>
        <span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>

    <span class="n">fbFFO</span><span class="o">.</span><span class="n">ExecuteNoLog</span><span class="p">();</span> <span class="o">//</span><span class="n">FFO</span> <span class="nb">eval</span> <span class="n">called</span> <span class="n">at</span> <span class="n">end</span> <span class="n">of</span> <span class="n">cycle</span>

    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbFFO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
        <span class="s1">&#39;Fast fault did not clear&#39;</span><span class="p">);</span>


    <span class="o">//</span><span class="n">Induce</span> <span class="n">fault</span> <span class="k">with</span> <span class="n">FF</span>

    <span class="n">fbFF</span><span class="p">(</span><span class="n">io_fbFFHWO</span> <span class="o">:=</span> <span class="n">fbFFO</span><span class="p">,</span> <span class="o">//</span><span class="n">FF</span> <span class="n">faulted</span>
        <span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">);</span>

    <span class="n">fbFFO</span><span class="o">.</span><span class="n">ExecuteNoLog</span><span class="p">();</span> <span class="o">//</span><span class="n">FFO</span> <span class="nb">eval</span> <span class="n">called</span> <span class="n">at</span> <span class="n">end</span> <span class="n">of</span> <span class="n">cycle</span>

    <span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbFFO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
        <span class="s1">&#39;Fast fault did not trip the beam&#39;</span><span class="p">);</span>

    <span class="n">rFF</span> <span class="n">REF</span><span class="o">=</span> <span class="n">fbFFO</span><span class="o">.</span><span class="n">astFF</span><span class="p">[</span><span class="n">fbFF</span><span class="o">.</span><span class="n">RegistrationIdx</span><span class="p">];</span>

<span class="n">FirstPass</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">END_IF</span>


<span class="n">IF</span> <span class="n">fbTime</span><span class="o">.</span><span class="n">bValid</span> <span class="n">AND</span> <span class="n">fbTimePass</span>  <span class="n">THEN</span>

    <span class="n">Now</span> <span class="o">:=</span> <span class="n">SystemTime_TO_DT</span><span class="p">(</span><span class="n">fbTime</span><span class="o">.</span><span class="n">systemTime</span><span class="p">);</span>
    <span class="n">Expire</span><span class="o">:=</span> <span class="n">fbTime</span><span class="o">.</span><span class="n">systemTime</span><span class="p">;</span>
    <span class="n">Expire</span><span class="o">.</span><span class="n">wSecond</span><span class="o">:=</span> <span class="n">Expire</span><span class="o">.</span><span class="n">wSecond</span><span class="o">+</span><span class="mi">5</span><span class="p">;</span>
    <span class="n">specificLocalTimeToFileTime</span><span class="p">(</span><span class="ow">in</span> <span class="o">:=</span> <span class="n">Tc2_Utilities</span><span class="o">.</span><span class="n">SYSTEMTIME_TO_FILETIME</span><span class="p">(</span><span class="n">Expire</span><span class="p">),</span> <span class="n">tzInfo</span> <span class="o">:=</span> <span class="p">,</span> <span class="n">out</span> <span class="o">=&gt;</span> <span class="n">fileTime</span><span class="p">);</span>
    <span class="n">Expiration</span> <span class="o">:=</span> <span class="n">TO_DINT</span><span class="p">((</span><span class="n">SHL</span><span class="p">(</span><span class="n">DWORD_TO_ULINT</span><span class="p">(</span><span class="n">fileTime</span><span class="o">.</span><span class="n">dwHighDateTime</span><span class="p">),</span> <span class="mi">32</span><span class="p">)</span> <span class="o">+</span> <span class="n">DWORD_TO_ULINT</span><span class="p">(</span><span class="n">fileTime</span><span class="o">.</span><span class="n">dwLowDateTime</span><span class="p">))</span> <span class="o">/</span> <span class="mi">10000000</span> <span class="o">-</span> <span class="mi">11644473600</span><span class="p">);;</span>

    <span class="n">WRITE_PROTECTED_DINT</span><span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">rFF</span><span class="o">.</span><span class="n">Ovrd</span><span class="o">.</span><span class="n">Expiration</span><span class="p">),</span> <span class="n">Expiration</span> <span class="p">);</span>
    <span class="n">WRITE_PROTECTED_TIME</span><span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">rFF</span><span class="o">.</span><span class="n">Ovrd</span><span class="o">.</span><span class="n">Timer</span><span class="o">.</span><span class="n">PT</span><span class="p">),</span> <span class="n">OvrdTime</span> <span class="p">);</span>
    <span class="n">WRITE_PROTECTED_BOOL</span><span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">rFF</span><span class="o">.</span><span class="n">Ovrd</span><span class="o">.</span><span class="n">Activate</span><span class="p">),</span> <span class="n">TRUE</span><span class="p">);</span>

    <span class="n">fbTimePass</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>

<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">On</span> <span class="n">every</span> <span class="n">cycle</span><span class="p">:</span>
<span class="n">fbFF</span><span class="p">(</span><span class="n">io_fbFFHWO</span> <span class="o">:=</span> <span class="n">fbFFO</span><span class="p">,</span> <span class="o">//</span><span class="n">FF</span> <span class="n">faulted</span>
    <span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">);</span>

<span class="n">fbFFO</span><span class="o">.</span><span class="n">ExecuteNoLog</span><span class="p">();</span> <span class="o">//</span><span class="n">FFO</span> <span class="nb">eval</span> <span class="n">called</span> <span class="n">at</span> <span class="n">end</span> <span class="n">of</span> <span class="n">cycle</span>


<span class="n">IF</span> <span class="n">rFF</span><span class="o">.</span><span class="n">Ovrd</span><span class="o">.</span><span class="n">Active</span> <span class="n">AND</span> <span class="n">rFF</span><span class="o">.</span><span class="n">BeamPermitted</span> <span class="n">THEN</span>

    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbFFO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
        <span class="s1">&#39;Fast fault should be overridden so FFO should be true&#39;</span><span class="p">);</span>

    <span class="n">OvrdActvTstDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">OvrdActvTstDone</span> <span class="ow">and</span> <span class="n">NOT</span> <span class="n">rFF</span><span class="o">.</span><span class="n">Ovrd</span><span class="o">.</span><span class="n">Active</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rff</span><span class="o">.</span><span class="n">BeamPermitted</span> <span class="n">THEN</span>

    <span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbFFO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
        <span class="s1">&#39;Fast fault override expired so beam should be off.&#39;</span><span class="p">);</span>
   <span class="o">//</span> <span class="n">AssertFalse</span><span class="p">(</span><span class="n">rFF</span><span class="o">.</span><span class="n">BeamPermitted</span><span class="p">,</span> <span class="s1">&#39;Beam should not be permitted now&#39;</span><span class="p">);</span>

    <span class="n">TestsDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="n">IF</span> <span class="n">TestsDone</span> <span class="n">THEN</span>
    <span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="s1">&#39;FFVetoAndNextFault&#39;</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_check&#39;</span><span class="p">}</span>
<span class="n">METHOD</span> <span class="n">FFRegistration</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbFF</span>    <span class="p">:</span>    <span class="n">FB_FastFault</span><span class="p">;</span>
    <span class="n">fbFFO</span>    <span class="p">:</span>    <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="n">astFF</span> <span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0..10</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_FF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;FFRegistration&#39;</span><span class="p">);</span>

<span class="n">fbFF</span><span class="p">(</span><span class="n">io_fbFFHWO</span> <span class="o">:=</span> <span class="n">fbFFO</span><span class="p">);</span>

<span class="n">AssertEquals_STRING</span><span class="p">(</span><span class="n">fbFF</span><span class="o">.</span><span class="n">sPath</span><span class="p">,</span> <span class="n">fbFFO</span><span class="o">.</span><span class="n">astFF</span><span class="p">[</span><span class="n">fbFF</span><span class="o">.</span><span class="n">RegistrationIdx</span><span class="p">]</span><span class="o">.</span><span class="n">Info</span><span class="o">.</span><span class="n">sPath</span><span class="p">,</span>
    <span class="s1">&#39;FF registration with FFO did not succeed&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-fastfault">FB_FastFault</a></p></li>
<li><p><a class="reference internal" href="#fb-hardwareffoutput">FB_HardwareFFOutput</a></p></li>
<li><p><a class="reference internal" href="#st-ff">ST_FF</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-hardwareffoutput">
<h2>FB_HardwareFFOutput<a class="headerlink" href="#fb-hardwareffoutput" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>{attribute &#39;reflection&#39;}
{attribute &#39;no_check&#39;}
FUNCTION_BLOCK FB_HardwareFFOutput
VAR CONSTANT
    FF_ARRAY_UPPER_BOUND : UINT := PMPS_PARAM.MAX_FAST_FAULTS;
END_VAR
VAR_INPUT
    {attribute &#39;pytmc&#39; := &#39;
        pv: ClearFault
        io: o
        field: DESC Might be overidden by PLC writes
     &#39;}
    i_xReset    :    BOOL;
    {attribute &#39;pytmc&#39; := &#39;
        pv: EnableVeto
        io: o
     &#39;}
    i_xVeto    :    BOOL;
    bAutoReset : BOOL := FALSE; // Set true for the FFO to automatically permit beam again after all fast faults are cleared
    i_sNetID : T_AmsNetID:=&#39;&#39;; //Set to the Arbiter AmsNetID to be used for the synchronisation. An empty string means the system will sue local time
END_VAR
VAR_OUTPUT
    {attribute &#39;pytmc&#39; := &#39;
        pv: FaultHWO
        io: i
        field: DESC Hardware Output Status
     &#39;}
    q_xFastFaultOut    AT %Q*    :    BOOL;
    q_xValidSyncTime : BOOL;// system time bValid output True when sync is successful
END_VAR
VAR_IN_OUT

END_VAR
VAR
    {attribute &#39;pytmc&#39; := &#39;
        pv: FF
     &#39;}
    astFF : ARRAY[1..FF_ARRAY_UPPER_BOUND] OF ST_FF;

    {attribute &#39;pytmc&#39; := &#39;
        pv: RegistrationFailure
        io: io
     &#39;}
    xFastFaultRegFail  :   BOOL := FALSE; // Set true if a fast fault fails to register. Holds beam off.
    tFFRegFail : F_TRIG;

    {attribute &#39;instance-path&#39;}
    {attribute &#39;noinit&#39;}
    sPath    :    T_MaxString;

    {attribute &#39;pytmc&#39; := &#39;
        pv: OK
        io: i
     &#39;}
    xOK    :    BOOL:= TRUE; // Current internal state of FFO, indicates if FFO will accept a reset

    rtReset    :    R_TRIG;
    rtResetandOK : R_TRIG;

    nIndex    :    UINT := 1;

    IdxOK: BOOL;

    fbTime : FB_LocalSystemTime := ( bEnable := TRUE, dwCycle := 1 ); //Get current system time, used for override
    fbTime_to_UTC: FB_TzSpecificLocalTimeToSystemTime;
    fbGetTimeZone: FB_GetTimeZoneInformation;
    fbJson : FB_JsonSaxWriter;
    pmpsTypeCode : UDINT := 0; // shows up in json as pmps_typecode
    fbLogger : FB_LogMessage := (
        eSevr := TcEventSeverity.Critical,
        eSubsystem := E_Subsystem.MPS,
        nMinTimeViolationAcceptable := PMPS_PARAM.MAX_FAST_FAULTS);

END_VAR
// &lt;TODO&gt; latch off beam if DI card status goes bad

END_FUNCTION_BLOCK

ACTION EvaluateOutput:
////////////////////////////////////////////////////////////////
// Critical code. Do not touch unless you know what you&#39;re doing
////////////////////////////////////////////////////////////////

//&lt;TODO&gt; add diagnostic for success or failure of reset
rtReset(CLK:=i_xReset);
rtResetandOK(CLK:=(rtReset.Q OR bAutoReset) AND xOK);

q_xFastFaultOut S= rtResetandOK.Q;
q_xFastFaultOut R= (NOT xOK OR xFastFaultRegFail);

//Reset OK for next cycle
xOK := True;

////////////////////////////////////////////////////////////////
END_ACTION

ACTION Execute:
EvaluateOverrides();
EvaluateOutput();
ExecuteLogging();
END_ACTION

ACTION ExecuteNoLog:
EvaluateOverrides();
EvaluateOutput();
//ExecuteLogging();
END_ACTION

{attribute &#39;no_check&#39;}
METHOD EvaluateOverrides : BOOL
VAR_INPUT
END_VAR
VAR
    FF : REFERENCE TO ST_FF;
    EvalIdx: DINT := 1;
END_VAR
VAR CONSTANT
    MaxTime : DINT:= 4294080;(*49.7 days*)
END_VAR
//Get local System Time
fbTime(sNetID:=i_sNetID);
//Get Time Zone
fbGetTimeZone(sNetID:=i_sNetID,bExecute:=TRUE,tTimeout:=T#10S);
//change local time to UTC to be compatible with unix time epoch widget
fbTime_to_UTC(in:= fbTime.systemTime , tzInfo:=fbGetTimeZone.tzInfo);
q_xValidSyncTime := fbTime.bValid AND NOT fbGetTimeZone.bError;

FOR EvalIdx := 1 TO FF_ARRAY_UPPER_BOUND DO

    FF REF= astFF[EvalIdx];

    IF NOT FF.Info.InUse THEN
        CONTINUE;
    ELSE
        // Veto timer
        IF FF.Ovrd.Deactivate THEN
            FF.Ovrd.Timer.PT := T#0s; // Only needs to be set zero for one cycle
        ELSIF FF.Ovrd.Activate THEN
            FF.Ovrd.StartDT:= TO_DINT(TO_DT(SystemTime_TO_DT(fbTime_to_UTC.out)));
            IF (FF.Ovrd.StartDT &lt; FF.Ovrd.Expiration) THEN
                FF.Ovrd.Expiration:= LIMIT(0,FF.Ovrd.Expiration, FF.Ovrd.StartDT+MaxTime );
                   FF.Ovrd.Timer.PT := TO_DT(FF.Ovrd.Expiration)- SystemTime_TO_DT(fbTime_to_UTC.out);
            END_IF
        END_IF

        // UDINT conversions for ESS module compatibility.
        FF.Ovrd.Timer(
            IN := FF.Ovrd.Activate, // Rising edge activated
            Q =&gt; FF.Ovrd.Active);

        FF.Ovrd.tOvrdActivate(CLK:=FF.Ovrd.Active);
        FF.Ovrd.OvrdActLogAck S= FF.Ovrd.tOvrdActivate.Q;

        FF.Ovrd.tOvrdExpiring(CLK:=FF.Ovrd.Active);
        FF.Ovrd.OvrdExpLogAck S= FF.Ovrd.tOvrdExpiring.Q;

        FF.Ovrd.ElapsedTime := TIME_TO_UDINT(FF.Ovrd.Timer.ET);

        FF.Ovrd.RemainingTime := MAX(0, TO_DINT(FF.Ovrd.Timer.PT) - FF.Ovrd.ElapsedTime);

        // Clear pushbuttons
        FF.Ovrd.Activate := FALSE;
        FF.Ovrd.Deactivate := FALSE;

    END_IF
END_FOR
END_METHOD

{attribute &#39;obsolete&#39; := &#39;Use EvaluateOverrides instead.&#39;}
METHOD EvaluateVetos : BOOL
VAR_INPUT
END_VAR

END_METHOD

{attribute &#39;no_check&#39;}
METHOD ExecuteLogging : BOOL
VAR_INPUT
END_VAR
VAR
    FF : REFERENCE TO ST_FF;
    logIdx : DINT := 1;
END_VAR
VAR_INST
    HelloTimer : TOF := ( PT:=T#24h );
END_VAR
FOR logIdx := 1 to FF_ARRAY_UPPER_BOUND do

    FF REF= astFF[logIdx];

    IF NOT FF.Info.InUse THEN
        CONTINUE;
    ELSE
        IF FF.FaultAck THEN

            pmpsTypeCode := 1;
            FormulateLogJson(FF);
            fbLogger(sMsg := &#39;Fault, beam off&#39;, eSevr:=TcEventSeverity.Critical);

            FF.FaultAck := FALSE;
        END_IF

        IF FF.Ovrd.OvrdActLogAck THEN

            pmpsTypeCode := 2;
            FormulateLogJson(FF);

            fbLogger(sMsg := &#39;Override activated&#39;, eSevr:=TcEventSeverity.Warning);

            FF.Ovrd.OvrdActLogAck := FALSE;
        END_IF

        IF FF.Ovrd.OvrdExpLogAck THEN

            pmpsTypeCode := 3;
            FormulateLogJson(FF);

            fbLogger(sMsg := &#39;Override released&#39;, eSevr:=TcEventSeverity.Warning);

            FF.Ovrd.OvrdExpLogAck := FALSE;
        END_IF

        IF FF.ClearAck THEN

            pmpsTypeCode := 8;
            FormulateLogJson(FF);

            fbLogger(sMsg := &#39;Fault cleared&#39;, eSevr:=TcEventSeverity.Info);

            FF.ClearAck := FALSE;
        END_IF


    END_IF
END_FOR

// Log registration fault cleared
tFFRegFail(CLK:=xFastFaultRegFail);
IF tFFRegFail.Q THEN
    fbJson.StartObject();
    fbJson.AddKey(&#39;pmps_typecode&#39;);
    fbJson.AddUdint(5);
    fbJson.AddKey(&#39;pmps_path&#39;);
    fbJson.AddString(sPath);
    fbJson.EndObject();
    fbJson.CopyDocument(pDoc:=fbLogger.sJson, SIZEOF(fbLogger.sJson));
    fbLogger(sMsg := &#39;Fast fault registration failure cleared. This may be bad as a fast fault could go unoticed.&#39;,
        eSevr:=TcEventSeverity.Warning);
END_IF

// Say hello
HelloTimer.IN := NOT HelloTimer.Q;
HelloTimer();
IF HelloTimer.IN THEN
    pmpsTypeCode := 10;
    FormulateLogJson(FF);
    fbLogger(eSubsystem:=E_Subsystem.NILVALUE,
        eSevr := TcEventSeverity.Info,
        sMsg := &#39;FFO is alive&#39;);
    fbLogger.eSubsystem := E_Subsystem.MPS;
END_IF
END_METHOD

METHOD INTERNAL FormulateLogJson : STRING
VAR_INPUT
    FF : ST_FF;
END_VAR
fbJson.StartObject();
fbJson.AddKey(&#39;pmps_typecode&#39;);
fbJson.AddUdint(pmpsTypeCode);
fbJson.AddKey(&#39;pmps_path&#39;);
fbJson.AddString(FF.Info.sPath);
fbJson.AddKey(&#39;pmps_device_name&#39;);
fbJson.AddString(FF.Info.DevName);
fbJson.EndObject();
fbLogger.sJson := fbJson.GetDocument();
fbJson.ResetDocument();
END_METHOD

{attribute &#39;no_check&#39;}
METHOD INTERNAL IdxCheckIn : BOOL
VAR_INPUT
    Idx : DINT;
    OK : BOOL;
    Reset : BOOL;
END_VAR
VAR
    stFF : ST_FF;
    BeamPermitted : BOOL;
END_VAR
Idx := LIMIT(1,Idx,FF_ARRAY_UPPER_BOUND);
stFF := THIS^.astFF[Idx];

// Updating internal fault state
stFF.OK := OK;

// Reset and latching logic
stFF.rtReset(CLK:=stFF.Reset (*epics*) OR Reset (*from other PLC logic *) );
stFF.Reset R= stFF.rtReset.Q;
stFF.bsFF(SET := stFF.rtReset.Q OR stFF.Info.AutoReset, RESET1:= NOT OK);

BeamPermitted := stFF.bsFF.Q1 OR stFF.Ovrd.Active OR (i_xVeto AND stFF.Info.Vetoable);

// Fault generation
IF NOT BeamPermitted THEN
    THIS^.xOK := FALSE; //Very clever, thanks Zach!
END_IF

// Fast fault accumulation
stFF.ftCountFault(CLK:=stFF.bsFF.Q1);
IF stFF.ftCountFault.Q THEN PMPS_GVL.AccumulatedFF := PMPS_GVL.AccumulatedFF + 1; END_IF

//Clear pushbuttons
stFF.Reset := FALSE;

// Log when this fault faults
stFF.FaultAck S= stFF.BeamPermitted AND NOT BeamPermitted;

// Log when this fault has cleared
stFF.ClearAck S= BeamPermitted AND NOT stFF.BeamPermitted;

stFF.BeamPermitted := BeamPermitted;

// Copy state back to ff struct
THIS^.astFF[Idx] := stFF;
END_METHOD

{attribute &#39;no_check&#39;}
METHOD INTERNAL Register : BOOL
VAR_INPUT
    stFFInfo : ST_FFInfo := (
        sPath := &#39;&#39;,
        Desc := &#39;&#39;,
        TypeCode := 16#00,
        DevName := &#39;&#39;); // Fast fault information

END_VAR
VAR_OUTPUT
    FFOName : T_MaxString;
    Idx : UINT;
END_VAR
VAR
END_VAR
FFOName := THIS^.sPath;
Idx := THIS^.nIndex;

IF THIS^.nIndex &lt;= FF_ARRAY_UPPER_BOUND THEN

    THIS^.astFF[MIN(THIS^.nIndex,FF_ARRAY_UPPER_BOUND)].Info:=stFFInfo;

    THIS^.nIndex := THIS^.nIndex + 1;

    Register := TRUE; // Add successful
ELSE
    fbJson.StartObject();
    fbJson.AddKey(&#39;pmps_typecode&#39;);
    fbJson.AddUdint(4);
    fbJson.AddKey(&#39;pmps_path&#39;);
    fbJson.AddString(stFFInfo.sPath);
    fbJson.AddKey(&#39;pmps_device_name&#39;);
    fbJson.AddString(stFFInfo.DevName);
    fbJson.EndObject();
    fbLogger.sJson := fbJson.GetDocument();
    fbJson.ResetDocument();
    fbLogger(sMsg:=&#39;Fast fault registration failed. Too many fast faults on this FFO.&#39;,
        eSevr:=TcEventSeverity.Warning,
        eSubsystem:=E_Subsystem.MPS);
    xFastFaultRegFail := TRUE;
    Register := FALSE; // Failed to add name to list
END_IF
END_METHOD
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
<li><p><a class="reference internal" href="#pmps-param">PMPS_PARAM</a></p></li>
<li><p><a class="reference internal" href="#st-ff">ST_FF</a></p></li>
<li><p><a class="reference internal" href="#st-ffinfo">ST_FFInfo</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-hgvpu">
<h2>FB_Hgvpu<a class="headerlink" href="#fb-hgvpu" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_Hgvpu</span> <span class="n">IMPLEMENTS</span> <span class="n">I_UndulatorComplex</span>
<span class="n">VAR_INPUT</span>
    <span class="n">fbElectronEnergy</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">FB_LREALFromEPICS</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">CurrentPhotonEnergy</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Calculated</span> <span class="n">current</span> <span class="n">photon</span> <span class="n">energy</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">PREC</span> <span class="mi">3</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">eV</span>
    <span class="s1">&#39;}</span>
    <span class="n">fCurrentPhotonEnergy</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">TargetPhotonEnergy</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Calculated</span> <span class="n">desired</span> <span class="n">photon</span> <span class="n">energy</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">PREC</span> <span class="mi">3</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">eV</span>
    <span class="s1">&#39;}</span>
    <span class="n">fTargetPhotonEnergy</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">SeedUndulatorNumber</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Seed</span> <span class="n">undulator</span> <span class="n">number</span>
    <span class="s1">&#39;}</span>
    <span class="n">nSeedUndulator</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">Set</span> <span class="n">to</span> <span class="n">zero</span> <span class="n">when</span> <span class="n">no</span> <span class="n">undulators</span> <span class="n">are</span> <span class="n">active</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">TargetSeedUndulatorNumber</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Seed</span> <span class="n">undulator</span> <span class="n">number</span> <span class="k">for</span> <span class="n">target</span> <span class="n">K</span>
    <span class="s1">&#39;}</span>
    <span class="n">nTargetSeedUndulator</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">Set</span> <span class="n">to</span> <span class="n">zero</span> <span class="n">when</span> <span class="n">no</span> <span class="n">undulators</span> <span class="n">are</span> <span class="n">active</span>
<span class="n">END_VAR</span>


<span class="n">VAR</span>
    <span class="o">//</span> <span class="n">From</span> <span class="n">lcls</span><span class="o">-</span><span class="n">srv01</span><span class="p">:</span> <span class="n">grep</span> <span class="o">-</span><span class="n">e</span> <span class="n">KDes</span>  <span class="o">/</span><span class="n">u1</span><span class="o">/</span><span class="n">lcls</span><span class="o">/</span><span class="n">epics</span><span class="o">/</span><span class="n">ioc</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">ioc</span><span class="o">-</span><span class="n">undh</span><span class="o">-</span><span class="n">uc</span><span class="o">*/</span><span class="n">iocInfo</span><span class="o">/</span><span class="n">IOC</span><span class="o">.</span><span class="n">pvlist</span> <span class="o">|</span><span class="n">sort</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 24; link: 2450:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_24</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 25; link: 2550:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_25</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 26; link: 2650:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_26</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 27; link: 2750:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_27</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 29; link: 2950:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_29</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 30; link: 3050:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_30</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 31; link: 3150:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_31</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 32; link: 3250:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_32</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 33; link: 3350:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_33</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 34; link: 3450:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_34</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 35; link: 3550:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_35</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 36; link: 3650:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_36</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 37; link: 3750:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_37</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 38; link: 3850:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_38</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 39; link: 3950:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_39</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 40; link: 4050:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_40</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 41; link: 4150:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_41</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 42; link: 4250:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_42</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 43; link: 4350:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_43</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 44; link: 4450:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_44</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 45; link: 4550:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_45</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 46; link: 4650:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_46</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="n">fbSegment</span> <span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="n">iLowBound_LUnd</span><span class="o">..</span><span class="n">iHighBound_LUnd</span><span class="p">]</span> <span class="n">OF</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>
    <span class="n">fbCurrentSegment</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="n">iIndex</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>

    <span class="n">bInitialized</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">END_VAR</span>

<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">FirstSegment</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">iLowBound_LUnd</span>  <span class="p">:</span> <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">24</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">LastSegment</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">iHighBound_LUnd</span> <span class="p">:</span> <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">46</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Period</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">mm</span>
    <span class="s1">&#39;}</span>
    <span class="n">fPeriod_mm_LUnd</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">26.0</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">LowK</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">fLowK_LUnd</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">0.54</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">HiK</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">fHiK_LUnd</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">2.6</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInitialized</span> <span class="n">THEN</span>
    <span class="n">Init</span><span class="p">();</span>
<span class="n">END_IF</span>

<span class="n">UndAdrUpdate</span><span class="p">();</span>

<span class="n">nSeedUndulator</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">nTargetSeedUndulator</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">FOR</span> <span class="n">iIndex</span> <span class="o">:=</span> <span class="n">iLowBound_LUnd</span> <span class="n">TO</span> <span class="n">iHighBound_LUnd</span> <span class="n">DO</span>
    <span class="n">IF</span> <span class="n">fbSegment</span><span class="p">[</span><span class="n">iIndex</span><span class="p">]</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
        <span class="n">fbCurrentSegment</span> <span class="n">REF</span><span class="o">=</span> <span class="n">fbSegment</span><span class="p">[</span><span class="n">iIndex</span><span class="p">]</span><span class="o">^</span><span class="p">;</span>
        <span class="n">fbCurrentSegment</span><span class="p">(</span><span class="n">fbElectronEnergy</span><span class="o">:=</span><span class="n">fbElectronEnergy</span><span class="p">);</span>

        <span class="o">//</span><span class="n">Mark</span> <span class="n">the</span> <span class="n">seed</span> <span class="n">undulator</span><span class="p">,</span> <span class="n">first</span> <span class="n">undulator</span> <span class="n">operating</span> <span class="n">within</span> <span class="n">K</span> <span class="n">bounds</span>
        <span class="n">IF</span> <span class="n">fbCurrentSegment</span><span class="o">.</span><span class="n">xActive</span> <span class="n">AND</span> <span class="n">nSeedUndulator</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
            <span class="n">nSeedUndulator</span> <span class="o">:=</span> <span class="n">iIndex</span><span class="p">;</span>
            <span class="n">fCurrentPhotonEnergy</span> <span class="o">:=</span> <span class="n">fbCurrentSegment</span><span class="o">.</span><span class="n">fPhotonEnergyAct</span><span class="p">;</span>
        <span class="n">END_IF</span>

        <span class="n">IF</span> <span class="n">fbCurrentSegment</span><span class="o">.</span><span class="n">xTargetActive</span> <span class="n">AND</span> <span class="n">nTargetSeedUndulator</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
            <span class="n">nTargetSeedUndulator</span> <span class="o">:=</span> <span class="n">iIndex</span><span class="p">;</span>
            <span class="n">fTargetPhotonEnergy</span> <span class="o">:=</span> <span class="n">fbCurrentSegment</span><span class="o">.</span><span class="n">fPhotonEnergyDes</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>
<span class="n">END_FOR</span>

<span class="n">IF</span> <span class="n">nSeedUndulator</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">fCurrentPhotonEnergy</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">nTargetSeedUndulator</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">fTargetPhotonEnergy</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">Init</span><span class="p">:</span>
<span class="n">UndAdrUpdate</span><span class="p">();</span>


    <span class="n">FOR</span> <span class="n">iIndex</span> <span class="o">:=</span> <span class="n">iLowBound_LUnd</span> <span class="n">TO</span> <span class="n">iHighBound_LUnd</span> <span class="n">DO</span>
            <span class="n">IF</span> <span class="n">fbSegment</span><span class="p">[</span><span class="n">iIndex</span><span class="p">]</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
            <span class="n">fbCurrentSegment</span> <span class="n">REF</span><span class="o">=</span> <span class="n">fbSegment</span><span class="p">[</span><span class="n">iIndex</span><span class="p">]</span><span class="o">^</span><span class="p">;</span>
            <span class="n">fbCurrentSegment</span><span class="o">.</span><span class="n">fPeriod_mm</span> <span class="o">:=</span> <span class="n">fPeriod_mm_LUnd</span><span class="p">;</span>
            <span class="n">fbCurrentSegment</span><span class="o">.</span><span class="n">fLowK</span> <span class="o">:=</span> <span class="n">fLowK_LUnd</span><span class="p">;</span>
            <span class="n">fbCurrentSegment</span><span class="o">.</span><span class="n">fHiK</span> <span class="o">:=</span> <span class="n">fHiK_LUnd</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_FOR</span>

    <span class="n">bInitialized</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">UndAdrUpdate</span><span class="p">:</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_24</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_25</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_26</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_27</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">29</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_29</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_30</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_31</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_32</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">33</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_33</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">34</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_34</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">35</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_35</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">36</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_36</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">37</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_37</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">38</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_38</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">39</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_39</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">40</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_40</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">41</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_41</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">42</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_42</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">43</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_43</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">44</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_44</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">45</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_45</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">46</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_46</span><span class="p">);</span>
<span class="n">END_ACTION</span>

<span class="n">PROPERTY</span> <span class="n">rCurrentPhotonEnergy</span> <span class="p">:</span> <span class="n">REAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">rCurrentPhotonEnergy</span> <span class="o">:=</span> <span class="n">fCurrentPhotonEnergy</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">rTargetPhotonEnergy</span> <span class="p">:</span> <span class="n">REAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">rTargetPhotonEnergy</span> <span class="o">:=</span> <span class="n">fTargetPhotonEnergy</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-undulatorsegment">FB_UndulatorSegment</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-jsondoctosafebp">
<h2>FB_JsonDocToSafeBP<a class="headerlink" href="#fb-jsondoctosafebp" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_JsonDocToSafeBP</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bExecute</span>             <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Rising</span> <span class="n">Edge</span>
    <span class="n">jsonDoc</span>                 <span class="p">:</span> <span class="n">SJsonValue</span><span class="p">;</span>
    <span class="n">sDeviceName</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">bHasDevice</span>              <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bHasAllStates</span>           <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bHasAllParameters</span> <span class="p">:</span><span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bBusy</span>                <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span>               <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrId</span>               <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">sErrMsg</span>                          <span class="p">:</span><span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span><span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1.</span><span class="o">.</span> <span class="n">MOTION_GVL</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="p">;</span>
    <span class="n">arrStates</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
    <span class="n">io_fbFFHWO</span>    <span class="p">:</span>    <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">JSON</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">fbJson</span>                  <span class="p">:</span> <span class="n">FB_JsonDomParser</span><span class="p">;</span>
    <span class="n">jsonProp</span>                <span class="p">:</span> <span class="n">SJsonValue</span><span class="p">;</span>
    <span class="n">jsonValue</span>               <span class="p">:</span> <span class="n">SJsonValue</span><span class="p">;</span>
    <span class="n">jsonParam</span>               <span class="p">:</span> <span class="n">SJsonValue</span><span class="p">;</span>
    <span class="n">jsonnTran</span>      <span class="p">:</span> <span class="n">SJsonValue</span><span class="p">;</span>
    <span class="n">jsonnRate</span>      <span class="p">:</span> <span class="n">SJsonValue</span><span class="p">;</span>
    <span class="n">Step</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">index</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">nStateCount</span><span class="p">:</span><span class="n">DINT</span><span class="p">;</span>
    <span class="n">RisingEdge</span>           <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span><span class="n">Logger</span><span class="o">*</span><span class="p">)</span>
    <span class="n">tNewMessage</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">fbLogger</span> <span class="p">:</span> <span class="n">FB_LogMessage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">eSubsystem</span><span class="o">:=</span><span class="n">E_SubSystem</span><span class="o">.</span><span class="n">MPS</span><span class="p">,</span> <span class="n">nMinTimeViolationAcceptable</span><span class="o">:=</span><span class="mi">10</span><span class="p">);</span>
    <span class="p">(</span><span class="o">*</span><span class="n">FFO</span><span class="o">*</span><span class="p">)</span>
    <span class="n">FFO</span>    <span class="p">:</span>    <span class="n">FB_FastFault</span> <span class="o">:=</span><span class="p">(</span>
        <span class="n">i_Desc</span> <span class="o">:=</span> <span class="s1">&#39;Fault occurs when there is an error loading safe beam parameters from json file&#39;</span><span class="p">,</span>
        <span class="n">i_TypeCode</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#FF13);</span>
    <span class="n">sbuffReadSmall</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Retrieve</span> <span class="n">JSON</span> <span class="n">content</span> <span class="o">*</span><span class="p">)</span>
<span class="n">RisingEdge</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>

<span class="n">CASE</span> <span class="n">Step</span> <span class="n">OF</span>
    <span class="mi">0</span><span class="p">:</span>     <span class="p">(</span><span class="o">*</span> <span class="n">Idle</span> <span class="n">state</span> <span class="o">*</span><span class="p">)</span>
          <span class="n">IF</span> <span class="n">RisingEdge</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
               <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
               <span class="n">bError</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
               <span class="n">nErrId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
               <span class="n">sErrMsg</span> <span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
               <span class="n">Step</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
               <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Start Parsing Json DOC.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
          <span class="n">END_IF</span>

     <span class="mi">20</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Find</span> <span class="n">the</span> <span class="n">Device</span> <span class="n">Name</span><span class="o">*</span><span class="p">)</span>
        <span class="n">bHasDevice</span> <span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">HasMember</span><span class="p">(</span><span class="n">jsonDoc</span><span class="p">,</span> <span class="n">sDeviceName</span><span class="p">);</span>
        <span class="n">IF</span> <span class="p">(</span><span class="n">bHasDevice</span><span class="p">)</span> <span class="n">THEN</span>
            <span class="n">jsonProp</span> <span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">FindMember</span><span class="p">(</span><span class="n">jsonDoc</span><span class="p">,</span> <span class="n">sDeviceName</span><span class="p">);</span>
            <span class="n">IF</span> <span class="n">jsonProp</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
                <span class="n">Step</span> <span class="o">:=</span> <span class="n">Step</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
                <span class="n">ELSE</span>
                    <span class="n">Step</span> <span class="o">:=</span> <span class="mi">900</span> <span class="o">+</span> <span class="n">Step</span><span class="p">;</span>
                    <span class="n">nErrId</span> <span class="o">:=</span> <span class="n">Step</span><span class="p">;</span>
                    <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
                    <span class="n">sErrMsg</span><span class="o">:=</span>  <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Error device name not found in Json File : &#39;</span><span class="p">,</span><span class="n">sDeviceName</span><span class="p">);</span>
                <span class="n">END_IF</span>
        <span class="n">ELSE</span>
            <span class="n">Step</span> <span class="o">:=</span> <span class="mi">900</span> <span class="o">+</span> <span class="n">Step</span><span class="p">;</span>
            <span class="n">nErrId</span> <span class="o">:=</span> <span class="n">Step</span><span class="p">;</span>
            <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">sErrMsg</span><span class="o">:=</span>  <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Error device name not found in Json File : &#39;</span><span class="p">,</span><span class="n">sDeviceName</span><span class="p">);</span>
        <span class="n">END_IF</span>

     <span class="mi">21</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Check</span> <span class="n">device</span> <span class="n">States</span> <span class="ow">in</span> <span class="n">DOM</span><span class="o">*</span><span class="p">)</span>
             <span class="n">nStateCount</span> <span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
             <span class="n">FOR</span> <span class="n">Index</span><span class="o">:=</span><span class="n">LOWER_BOUND</span><span class="p">(</span><span class="n">arrStates</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="n">TO</span> <span class="n">UPPER_BOUND</span><span class="p">(</span><span class="n">arrStates</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="n">BY</span> <span class="mi">1</span> <span class="n">DO</span>
                  <span class="n">IF</span> <span class="n">NOT</span> <span class="p">((</span><span class="n">arrStates</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span><span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="n">OR</span> <span class="p">(</span><span class="n">arrStates</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span><span class="o">=</span> <span class="s1">&#39;Invalid&#39;</span><span class="p">))</span> <span class="n">THEN</span>
                      <span class="n">IF</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">fbJson</span><span class="o">.</span><span class="n">HasMember</span><span class="p">(</span><span class="n">jsonProp</span><span class="p">,</span> <span class="n">arrStates</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">))</span> <span class="n">THEN</span>
                              <span class="n">Step</span> <span class="o">:=</span> <span class="mi">900</span><span class="o">+</span> <span class="n">Step</span><span class="p">;</span>
                              <span class="n">nErrId</span> <span class="o">:=</span> <span class="n">Step</span><span class="p">;</span>
                              <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
                              <span class="n">sErrMsg</span><span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Error loading device state in Json File : &#39;</span><span class="p">,</span><span class="n">arrStates</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">);</span>
                              <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span> <span class="n">sErrMsg</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
                              <span class="n">EXIT</span><span class="p">;</span>
                        <span class="n">ELSE</span>
                            <span class="n">nStateCount</span> <span class="o">:=</span><span class="n">nStateCount</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
                      <span class="n">END_IF</span>
                   <span class="n">ELSE</span>
                       <span class="n">bHasAllStates</span> <span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
                       <span class="n">EXIT</span><span class="p">;</span>
                  <span class="n">END_IF</span>
            <span class="n">END_FOR</span>

           <span class="n">Step</span> <span class="o">:=</span> <span class="n">Step</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>

     <span class="mi">22</span><span class="p">:</span> <span class="o">//</span><span class="n">Make</span> <span class="n">sure</span> <span class="n">state</span> <span class="n">array</span> <span class="nb">input</span> <span class="n">has</span> <span class="n">State</span> <span class="n">name</span> <span class="n">data</span>
          <span class="n">IF</span> <span class="p">(</span><span class="n">nStateCount</span> <span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="n">THEN</span>
              <span class="n">bHasAllStates</span> <span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
              <span class="n">Step</span> <span class="o">:=</span> <span class="mi">900</span><span class="o">+</span> <span class="n">Step</span><span class="p">;</span>
              <span class="n">nErrId</span> <span class="o">:=</span> <span class="n">Step</span><span class="p">;</span>
              <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
              <span class="n">sErrMsg</span><span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Error Input State array is empty : &#39;</span><span class="p">,</span><span class="n">sDeviceName</span><span class="p">);</span>
         <span class="n">ELSE</span>
             <span class="n">Step</span> <span class="o">:=</span> <span class="n">Step</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
         <span class="n">END_IF</span><span class="p">;</span>

     <span class="mi">23</span><span class="p">:</span>  <span class="p">(</span><span class="o">*</span><span class="n">loop</span> <span class="n">Device</span> <span class="n">State</span> <span class="n">Arrays</span> <span class="n">to</span> <span class="n">find</span> <span class="n">load</span> <span class="nb">all</span> <span class="n">States</span> <span class="n">BP</span><span class="o">*</span><span class="p">)</span>
          <span class="n">FOR</span> <span class="n">Index</span><span class="o">:=</span><span class="n">LOWER_BOUND</span><span class="p">(</span><span class="n">arrStates</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="n">TO</span> <span class="n">UPPER_BOUND</span><span class="p">(</span><span class="n">arrStates</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="n">BY</span> <span class="mi">1</span> <span class="n">DO</span>
              <span class="n">IF</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">arrStates</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span><span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="n">THEN</span>
                  <span class="n">IF</span><span class="p">(</span><span class="n">NOT</span> <span class="n">M_LoadSafeBP</span><span class="p">(</span><span class="n">arrStates</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">,</span> <span class="n">Index</span><span class="p">))</span> <span class="n">THEN</span>
                      <span class="n">Step</span> <span class="o">:=</span> <span class="mi">900</span><span class="o">+</span> <span class="n">Step</span><span class="p">;</span>
                      <span class="n">fbLogger</span><span class="o">.</span><span class="n">sMsg</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Error Parsing beam parameters - Device/States: &#39;</span><span class="p">,</span> <span class="n">arrStates</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">);</span>
                      <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span> <span class="n">sErrMsg</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
                  <span class="n">END_IF</span>
               <span class="n">ELSE</span>
                    <span class="n">EXIT</span><span class="p">;</span>
               <span class="n">END_IF</span>
          <span class="n">END_FOR</span>
          <span class="n">IF</span> <span class="p">(</span><span class="n">bHasAllParameters</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">Step</span> <span class="o">:=</span> <span class="mi">30</span><span class="p">;</span>
              <span class="n">ELSE</span> <span class="n">Step</span> <span class="o">:=</span> <span class="mi">900</span><span class="o">+</span> <span class="n">Step</span><span class="p">;</span>
          <span class="n">END_IF</span>

     <span class="mi">30</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">ALL</span> <span class="n">good</span> <span class="n">here</span><span class="o">*</span><span class="p">)</span>
         <span class="n">fbLogger</span><span class="o">.</span><span class="n">sMsg</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Complete Parsing Json Doc. Device: &#39;</span><span class="p">,</span> <span class="n">sDeviceName</span><span class="p">);</span>
        <span class="n">fbLogger</span><span class="o">.</span><span class="n">sMsg</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">fbLogger</span><span class="o">.</span><span class="n">sMsg</span> <span class="p">,</span><span class="s1">&#39; - States Count: &#39;</span><span class="p">);</span>
        <span class="n">fbLogger</span><span class="o">.</span><span class="n">sMsg</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">fbLogger</span><span class="o">.</span><span class="n">sMsg</span> <span class="p">,</span><span class="n">TO_STRING</span><span class="p">(</span><span class="n">nStateCount</span><span class="p">));</span>
          <span class="n">fbLogger</span><span class="p">(</span><span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
         <span class="n">bExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">bBusy</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
        <span class="n">Step</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">FFO</span><span class="o">.</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_CASE</span>


<span class="o">//</span><span class="n">Fault</span> <span class="ow">in</span> <span class="n">error</span> <span class="n">state</span>
<span class="n">IF</span><span class="p">(</span><span class="n">Step</span><span class="o">&gt;=</span><span class="mi">900</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">FFO</span><span class="o">.</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">Step</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">ACT_FFO</span><span class="p">();</span>
<span class="n">ACT_LOGGER</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">ACT_FFO</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span><span class="n">FAST</span> <span class="n">FAULT</span><span class="o">*</span><span class="p">)</span>
<span class="n">FFO</span><span class="p">(</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="p">,</span>
    <span class="n">i_xReset</span> <span class="o">:=</span> <span class="p">,</span>
    <span class="n">i_xAutoReset</span> <span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">i_DevName</span> <span class="o">:=</span> <span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span> <span class="o">:=</span> <span class="n">io_fbFFHWO</span><span class="p">);</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">ACT_Logger</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Log</span> <span class="n">valve</span> <span class="nb">open</span>
<span class="n">tNewMessage</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="n">NOT</span><span class="p">(</span><span class="n">FbLogger</span><span class="o">.</span><span class="n">sMsg</span> <span class="o">=</span> <span class="n">sErrMsg</span><span class="p">)</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">sErrMsg</span> <span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">));</span>
<span class="n">IF</span> <span class="n">tNewMessage</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span> <span class="n">sErrMsg</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span> <span class="n">END_IF</span>
<span class="n">END_ACTION</span>

<span class="n">METHOD</span> <span class="n">M_LoadSafeBP</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">sStateName</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">Index</span><span class="p">:</span><span class="n">DINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span><span class="n">bHasAllParameters</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">sAperture</span><span class="p">:</span><span class="n">STRING</span><span class="p">;</span>
    <span class="n">nAperture</span><span class="p">:</span><span class="n">INT</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">sEV</span><span class="p">:</span><span class="n">STRING</span><span class="p">;</span>
    <span class="n">sBC</span><span class="p">:</span><span class="n">STRING</span><span class="p">;</span>
    <span class="n">nIndex</span><span class="p">:</span><span class="n">INT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">bHasAllParameters</span> <span class="o">:=</span>  <span class="n">fbJson</span><span class="o">.</span><span class="n">HasMember</span><span class="p">(</span><span class="n">jsonProp</span><span class="p">,</span> <span class="n">sStateName</span><span class="p">);</span>
<span class="n">jsonValue</span> <span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">FindMember</span><span class="p">(</span><span class="n">jsonProp</span><span class="p">,</span> <span class="n">sStateName</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">bHasAllParameters</span> <span class="n">THEN</span>
    <span class="o">//</span><span class="n">nTran</span>
    <span class="n">bHasAllParameters</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">HasMember</span><span class="p">(</span><span class="n">jsonValue</span><span class="p">,</span> <span class="s1">&#39;nTran&#39;</span><span class="p">);</span>
    <span class="n">IF</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">bHasAllParameters</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span> <span class="s1">&#39;Error Loading nTran&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span> <span class="n">END_IF</span>
    <span class="n">jsonnTran</span> <span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">FindMember</span><span class="p">(</span><span class="n">jsonValue</span><span class="p">,</span> <span class="s1">&#39;nTran&#39;</span><span class="p">);</span>
    <span class="n">arrStates</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">nTran</span> <span class="o">:=</span> <span class="n">TO_REAL</span><span class="p">(</span><span class="n">fbJson</span><span class="o">.</span><span class="n">GetString</span><span class="p">(</span><span class="n">jsonnTran</span><span class="p">));</span>

    <span class="o">//</span><span class="n">nRate</span>
    <span class="n">bHasAllParameters</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">HasMember</span><span class="p">(</span><span class="n">jsonValue</span><span class="p">,</span> <span class="s1">&#39;nRate&#39;</span><span class="p">);</span>
    <span class="n">IF</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">bHasAllParameters</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span> <span class="s1">&#39;Error Loading nRate&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span> <span class="n">END_IF</span>
    <span class="n">jsonnRate</span> <span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">FindMember</span><span class="p">(</span><span class="n">jsonValue</span><span class="p">,</span> <span class="s1">&#39;nRate&#39;</span><span class="p">);</span>
    <span class="n">arrStates</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">nRate</span><span class="o">:=</span> <span class="n">TO_UDINT</span><span class="p">(</span><span class="n">fbJson</span><span class="o">.</span><span class="n">GetString</span><span class="p">(</span><span class="n">jsonnRate</span><span class="p">));</span>

    <span class="o">//</span><span class="n">neVRange</span>
    <span class="n">bHasAllParameters</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">HasMember</span><span class="p">(</span><span class="n">jsonValue</span><span class="p">,</span> <span class="s1">&#39;neVRange&#39;</span><span class="p">);</span>
    <span class="n">jsonParam</span> <span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">FindMember</span><span class="p">(</span><span class="n">jsonValue</span><span class="p">,</span> <span class="s1">&#39;neVRange&#39;</span><span class="p">);</span>
    <span class="n">sEV</span><span class="o">:=</span><span class="p">(</span><span class="n">fbJson</span><span class="o">.</span><span class="n">GetString</span><span class="p">(</span><span class="n">jsonParam</span><span class="p">));</span>
    <span class="n">bHasAllParameters</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">LEN</span><span class="p">(</span><span class="n">sEV</span><span class="p">)</span><span class="o">=</span><span class="mi">32</span><span class="p">);</span>
    <span class="n">This</span><span class="o">^.</span><span class="n">arrStates</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">neVRange</span> <span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">IF</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">bHasAllParameters</span><span class="p">)</span> <span class="n">THEN</span>
        <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span> <span class="s1">&#39;Error Loading eVRange&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
        <span class="n">ELSE</span>
            <span class="n">FOR</span> <span class="n">nIndex</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_cBoundaries</span> <span class="n">BY</span> <span class="mi">1</span> <span class="n">DO</span>
                <span class="n">This</span><span class="o">^.</span><span class="n">arrStates</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">neVRange</span> <span class="o">:=</span> <span class="n">SHL</span><span class="p">(</span><span class="n">This</span><span class="o">^.</span><span class="n">arrStates</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">neVRange</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
                <span class="n">This</span><span class="o">^.</span><span class="n">arrStates</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">neVRange</span> <span class="o">:=</span> <span class="n">This</span><span class="o">^.</span><span class="n">arrStates</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">neVRange</span><span class="o">+</span><span class="n">HEXASCNIBBLE_TO_BYTE</span><span class="p">(</span><span class="n">sEV</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]);</span>
            <span class="n">END_FOR</span>
    <span class="n">END_IF</span>

    <span class="o">//</span><span class="n">nBeamClassRange</span>
    <span class="n">bHasAllParameters</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">HasMember</span><span class="p">(</span><span class="n">jsonValue</span><span class="p">,</span> <span class="s1">&#39;nBeamClassRange&#39;</span><span class="p">);</span>
    <span class="n">jsonParam</span> <span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">FindMember</span><span class="p">(</span><span class="n">jsonValue</span><span class="p">,</span> <span class="s1">&#39;nBeamClassRange&#39;</span><span class="p">);</span>
    <span class="n">sBC</span><span class="o">:=</span><span class="p">(</span><span class="n">fbJson</span><span class="o">.</span><span class="n">GetString</span><span class="p">(</span><span class="n">jsonParam</span><span class="p">));</span>
    <span class="n">bHasAllParameters</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">LEN</span><span class="p">(</span><span class="n">sBC</span><span class="p">)</span><span class="o">=</span><span class="mi">15</span><span class="p">);</span>
    <span class="n">arrStates</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">nBCRange</span> <span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">IF</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">bHasAllParameters</span><span class="p">)</span> <span class="n">THEN</span>
            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span> <span class="s1">&#39;Error Loading Beam Class Range. Make sure Bitmask is equal than 15 bits.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
    <span class="n">ELSE</span>
        <span class="n">FOR</span> <span class="n">nIndex</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="mi">14</span> <span class="n">BY</span> <span class="mi">1</span> <span class="n">DO</span>
            <span class="n">arrStates</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">nBCRange</span> <span class="o">:=</span> <span class="n">SHL</span><span class="p">(</span><span class="n">arrStates</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">nBCRange</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
            <span class="n">arrStates</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">nBCRange</span> <span class="o">:=</span> <span class="n">arrStates</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">nBCRange</span><span class="o">+</span><span class="n">HEXASCNIBBLE_TO_BYTE</span><span class="p">(</span><span class="n">sBC</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]);</span>
        <span class="n">END_FOR</span>
     <span class="n">END_IF</span>

    <span class="o">//</span><span class="n">ApertureName</span> <span class="ow">and</span> <span class="n">Values</span>
    <span class="n">bHasAllParameters</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">HasMember</span><span class="p">(</span><span class="n">jsonValue</span><span class="p">,</span> <span class="s1">&#39;ap_name&#39;</span><span class="p">);</span>
    <span class="n">jsonParam</span> <span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">FindMember</span><span class="p">(</span><span class="n">jsonValue</span><span class="p">,</span> <span class="s1">&#39;ap_name&#39;</span><span class="p">);</span>
    <span class="n">sAperture</span> <span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">GetString</span><span class="p">(</span><span class="n">jsonParam</span><span class="p">);</span>
<span class="p">{</span><span class="n">IF</span> <span class="n">defined</span> <span class="p">(</span><span class="n">L</span><span class="p">)}</span>
    <span class="n">IF</span> <span class="p">(</span><span class="s1">&#39;SL1L0&#39;</span> <span class="o">=</span> <span class="n">sAperture</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">nAperture</span> <span class="o">:=</span> <span class="n">L_Apertures</span><span class="o">.</span><span class="n">SL1L0</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="p">(</span><span class="s1">&#39;SL2L0&#39;</span> <span class="o">=</span> <span class="n">sAperture</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">nAperture</span> <span class="o">:=</span> <span class="n">L_Apertures</span><span class="o">.</span><span class="n">SL2L0</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="p">{</span><span class="n">ELSIF</span> <span class="n">defined</span> <span class="p">(</span><span class="n">K</span><span class="p">)}</span> <span class="o">//</span> <span class="n">Attribute</span> <span class="s1">&#39;to_string&#39;</span> <span class="n">only</span> <span class="n">build</span> <span class="mi">4024</span> <span class="n">TO_STRING</span><span class="p">(</span><span class="n">PMPS</span><span class="o">.</span><span class="n">K_Apertures</span><span class="o">.</span><span class="n">SL1K0</span><span class="p">)</span> <span class="o">-</span> <span class="n">need</span> <span class="n">another</span> <span class="n">non</span> <span class="n">hardcoded</span> <span class="n">way</span>
    <span class="n">IF</span> <span class="p">(</span><span class="s1">&#39;SL1K0&#39;</span> <span class="o">=</span> <span class="n">sAperture</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">nAperture</span> <span class="o">:=</span> <span class="n">K_Apertures</span><span class="o">.</span><span class="n">SL1K0</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="p">(</span><span class="s1">&#39;SL2K0&#39;</span> <span class="o">=</span> <span class="n">sAperture</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">nAperture</span> <span class="o">:=</span> <span class="n">K_Apertures</span><span class="o">.</span><span class="n">SL2K0</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="p">{</span><span class="n">END_IF</span><span class="p">}</span>
    <span class="n">IF</span> <span class="p">(</span><span class="n">nAperture</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">)</span> <span class="n">THEN</span>
        <span class="o">//</span><span class="n">Gap</span> <span class="n">Height</span>
        <span class="n">bHasAllParameters</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">HasMember</span><span class="p">(</span><span class="n">jsonValue</span><span class="p">,</span> <span class="s1">&#39;ap_ygap&#39;</span><span class="p">);</span>
        <span class="n">jsonParam</span> <span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">FindMember</span><span class="p">(</span><span class="n">jsonValue</span><span class="p">,</span> <span class="s1">&#39;ap_ygap&#39;</span><span class="p">);</span>
        <span class="n">arrStates</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">astApertures</span><span class="p">[</span><span class="n">nAperture</span><span class="p">]</span><span class="o">.</span><span class="n">Height</span> <span class="o">:=</span> <span class="n">TO_REAL</span><span class="p">(</span><span class="n">fbJson</span><span class="o">.</span><span class="n">GetString</span><span class="p">(</span><span class="n">jsonParam</span><span class="p">));</span>

        <span class="o">//</span><span class="n">Gap</span> <span class="n">Width</span>
        <span class="n">bHasAllParameters</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">HasMember</span><span class="p">(</span><span class="n">jsonValue</span><span class="p">,</span> <span class="s1">&#39;ap_xgap&#39;</span><span class="p">);</span>
        <span class="n">jsonParam</span> <span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">FindMember</span><span class="p">(</span><span class="n">jsonValue</span><span class="p">,</span> <span class="s1">&#39;ap_xgap&#39;</span><span class="p">);</span>
        <span class="n">arrStates</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">astApertures</span><span class="p">[</span><span class="n">nAperture</span><span class="p">]</span><span class="o">.</span><span class="n">Width</span> <span class="o">:=</span> <span class="n">TO_REAL</span><span class="p">(</span><span class="n">fbJson</span><span class="o">.</span><span class="n">GetString</span><span class="p">(</span><span class="n">jsonParam</span><span class="p">));</span>

        <span class="n">IF</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">bHasAllParameters</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span> <span class="s1">&#39;Error Loading aperture gap&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span> <span class="n">END_IF</span>
    <span class="n">END_IF</span>

    <span class="o">//</span><span class="n">Read</span> <span class="n">Transition</span> <span class="n">ID</span> <span class="k">for</span> <span class="n">the</span> <span class="n">State</span>
    <span class="n">bHasAllParameters</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">HasMember</span><span class="p">(</span><span class="n">jsonValue</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">);</span>
    <span class="n">jsonParam</span> <span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">FindMember</span><span class="p">(</span><span class="n">jsonValue</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">);</span>
    <span class="n">IF</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">bHasAllParameters</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span> <span class="s1">&#39;Error Loading Assertion ID&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span> <span class="n">END_IF</span>
    <span class="n">arrStates</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span><span class="o">.</span><span class="n">nRequestAssertionID</span> <span class="o">:=</span> <span class="n">TO_UDINT</span><span class="p">(</span><span class="n">fbJson</span><span class="o">.</span><span class="n">GetInt</span><span class="p">(</span><span class="n">jsonParam</span><span class="p">));</span>

    <span class="o">//</span><span class="n">Set</span> <span class="n">to</span> <span class="kc">True</span> <span class="n">to</span> <span class="n">indicate</span> <span class="n">this</span> <span class="n">state</span> <span class="n">has</span> <span class="n">been</span> <span class="n">initialized</span>
    <span class="n">arrStates</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span><span class="o">.</span><span class="n">bBeamParamsLoaded</span> <span class="o">:=</span> <span class="n">bHasAllParameters</span><span class="p">;</span>

    <span class="o">//</span><span class="n">Read</span> <span class="n">additional</span> <span class="n">Non</span><span class="o">-</span><span class="n">BP</span> <span class="n">Parameters</span>
    <span class="n">bHasAllParameters</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">HasMember</span><span class="p">(</span><span class="n">jsonValue</span><span class="p">,</span> <span class="s1">&#39;reactive_temp&#39;</span><span class="p">);</span>
    <span class="n">jsonParam</span> <span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">FindMember</span><span class="p">(</span><span class="n">jsonValue</span><span class="p">,</span> <span class="s1">&#39;reactive_temp&#39;</span><span class="p">);</span>
    <span class="n">IF</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">bHasAllParameters</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span> <span class="s1">&#39;Error Loading Temperature Threshold&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span> <span class="n">END_IF</span>
    <span class="n">arrStates</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span><span class="o">.</span><span class="n">stReactiveParams</span><span class="o">.</span><span class="n">nTempSP</span> <span class="o">:=</span> <span class="n">TO_REAL</span><span class="p">(</span><span class="n">fbJson</span><span class="o">.</span><span class="n">GetString</span><span class="p">(</span><span class="n">jsonParam</span><span class="p">));</span>

    <span class="n">bHasAllParameters</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">HasMember</span><span class="p">(</span><span class="n">jsonValue</span><span class="p">,</span> <span class="s1">&#39;reactive_pressure&#39;</span><span class="p">);</span>
    <span class="n">jsonParam</span> <span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">FindMember</span><span class="p">(</span><span class="n">jsonValue</span><span class="p">,</span> <span class="s1">&#39;reactive_pressure&#39;</span><span class="p">);</span>
    <span class="n">IF</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">bHasAllParameters</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span> <span class="s1">&#39;Error Loading Pressure Threshold&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span> <span class="n">END_IF</span>
    <span class="n">arrStates</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span><span class="o">.</span><span class="n">stReactiveParams</span><span class="o">.</span><span class="n">nPressSP</span> <span class="o">:=</span> <span class="n">TO_REAL</span><span class="p">(</span><span class="n">fbJson</span><span class="o">.</span><span class="n">GetString</span><span class="p">(</span><span class="n">jsonParam</span><span class="p">));</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">NOT</span><span class="p">(</span>     <span class="n">bHasAllParameters</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">nErrId</span> <span class="o">:=</span> <span class="mi">900</span><span class="o">+</span><span class="n">Step</span><span class="p">;</span>
    <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">sErrMsg</span><span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Error loading BP Data - Device-State: &#39;</span><span class="p">,</span><span class="n">sStateName</span><span class="p">);</span>
    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span> <span class="n">sErrMsg</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="n">M_LoadSafeBP</span><span class="o">:=</span><span class="n">bHasAllParameters</span><span class="p">;</span>



<span class="o">//</span><span class="n">TODO</span>
<span class="o">//</span><span class="n">ADD</span> <span class="n">the</span> <span class="n">rest</span> <span class="n">of</span> <span class="n">the</span> <span class="n">BP</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-fastfault">FB_FastFault</a></p></li>
<li><p><a class="reference internal" href="#fb-hardwareffoutput">FB_HardwareFFOutput</a></p></li>
<li><p><a class="reference internal" href="#k-apertures">K_Apertures</a></p></li>
<li><p><a class="reference internal" href="#l-apertures">L_Apertures</a></p></li>
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
<li><p><a class="reference internal" href="#st-dbstateparams">ST_DbStateParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-jsonfiletojsondoc">
<h2>FB_JsonFileToJsonDoc<a class="headerlink" href="#fb-jsonfiletojsondoc" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_JsonFileToJsonDoc</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bExecute</span>             <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Rising</span> <span class="n">Edge</span>
    <span class="n">sPLCName</span>                         <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">sSrcNetId</span>            <span class="p">:</span> <span class="n">T_AmsNetId</span><span class="p">;</span>
    <span class="n">sSrcPathName</span>         <span class="p">:</span> <span class="n">T_MaxString</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">PMPS_jsonDoc</span>            <span class="p">:</span> <span class="n">SJsonValue</span><span class="p">;</span>
    <span class="n">bHasPLC</span>              <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span>                <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span>               <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrId</span>               <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">sErrMsg</span>                          <span class="p">:</span><span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">io_fbFFHWO</span>    <span class="p">:</span>    <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="p">(</span><span class="o">*</span><span class="n">Get</span> <span class="n">AMS</span> <span class="n">Net</span> <span class="n">ID</span><span class="o">*</span><span class="p">)</span>
    <span class="n">fb_GetLocalAmsNetId</span><span class="p">:</span> <span class="n">FB_GetLocalAmsNetId</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">JSON</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">fbJson</span>                  <span class="p">:</span> <span class="n">FB_JsonDomParser</span><span class="p">;</span>
    <span class="n">jsonDoc</span>                 <span class="p">:</span> <span class="n">SJsonValue</span><span class="p">;</span>
    <span class="n">jsonProp</span>                <span class="p">:</span> <span class="n">SJsonValue</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span><span class="n">File</span><span class="o">*</span><span class="p">)</span>
    <span class="n">fbFileOpen</span>           <span class="p">:</span> <span class="n">FB_FileOpen</span><span class="p">;</span>
    <span class="n">fbFileClose</span>          <span class="p">:</span> <span class="n">FB_FileClose</span><span class="p">;</span>
    <span class="n">fbFileRead</span>           <span class="p">:</span> <span class="n">FB_FileRead</span><span class="p">;</span>
    <span class="n">hSrcFile</span>             <span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;(</span><span class="o">*</span> <span class="n">File</span> <span class="n">handle</span> <span class="n">of</span> <span class="n">the</span> <span class="n">source</span> <span class="n">file</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">Step</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">index</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">RisingEdge</span>           <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Buffer</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">sbuffRead</span>                       <span class="p">:</span><span class="n">STRING</span><span class="p">(</span><span class="mi">100000</span><span class="p">);</span>
    <span class="n">cbReadLength</span>         <span class="p">:</span> <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">nFileLength</span>      <span class="p">:</span> <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">bfbJsonExceptionRaised</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">tTimeOut</span>             <span class="p">:</span> <span class="n">TIME</span> <span class="o">:=</span> <span class="n">DEFAULT_ADS_TIMEOUT</span><span class="p">;</span>
    <span class="n">bInit</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span><span class="n">Logger</span><span class="o">*</span><span class="p">)</span>
    <span class="n">tNewMessage</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">fbLogger</span> <span class="p">:</span> <span class="n">FB_LogMessage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">eSubsystem</span><span class="o">:=</span><span class="n">E_SubSystem</span><span class="o">.</span><span class="n">MPS</span><span class="p">,</span> <span class="n">nMinTimeViolationAcceptable</span><span class="o">:=</span><span class="mi">10</span><span class="p">);</span>
    <span class="p">(</span><span class="o">*</span><span class="n">FFO</span><span class="o">*</span><span class="p">)</span>
    <span class="n">FFO</span>    <span class="p">:</span>    <span class="n">FB_FastFault</span> <span class="o">:=</span><span class="p">(</span>
        <span class="n">i_Desc</span> <span class="o">:=</span> <span class="s1">&#39;Fault occurs when there is an error reading json file&#39;</span><span class="p">,</span>
        <span class="n">i_TypeCode</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#FF13);</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Get</span> <span class="n">Local</span> <span class="n">AMS</span> <span class="n">net</span> <span class="n">ID</span><span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">bInit</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">fb_GetLocalAmsNetId</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bInit</span> <span class="o">:=</span>  <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">fb_GetLocalAmsNetId</span><span class="p">(</span><span class="n">bExecute</span><span class="o">:=</span><span class="p">);</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Retrieve</span> <span class="n">JSON</span> <span class="n">content</span> <span class="o">*</span><span class="p">)</span>
<span class="n">RisingEdge</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">CASE</span> <span class="n">Step</span> <span class="n">OF</span>
    <span class="mi">0</span><span class="p">:</span>     <span class="p">(</span><span class="o">*</span> <span class="n">Idle</span> <span class="n">state</span> <span class="o">*</span><span class="p">)</span>
          <span class="n">IF</span> <span class="n">RisingEdge</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
               <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
               <span class="n">bError</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
               <span class="n">nErrId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
               <span class="n">Step</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
               <span class="n">cbReadLength</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
               <span class="n">hSrcFile</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
               <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Start Reading Json File.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
               <span class="o">//</span><span class="n">Clear</span> <span class="nb">all</span> <span class="n">json</span> <span class="n">values</span> <span class="ow">and</span> <span class="n">read</span> <span class="n">buffer</span><span class="p">;</span>
               <span class="n">PMPS_jsonDoc</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
               <span class="n">jsonDoc</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
               <span class="n">jsonProp</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
               <span class="n">FOR</span> <span class="n">index</span><span class="o">:=</span><span class="mi">1</span>  <span class="n">TO</span> <span class="mi">100000</span> <span class="n">DO</span>
                  <span class="n">sbuffRead</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>   <span class="o">//</span><span class="n">clear</span> <span class="n">buffer</span>
               <span class="n">END_FOR</span>
               <span class="n">sErrMsg</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
               <span class="n">nFileLength</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
               <span class="n">jsonDoc</span> <span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">ParseDocument</span><span class="p">(</span><span class="n">sbuffRead</span><span class="p">);</span>

          <span class="n">END_IF</span>
    <span class="mi">1</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">Open</span> <span class="n">source</span> <span class="n">file</span> <span class="o">*</span><span class="p">)</span>
           <span class="n">sSrcNetId</span> <span class="o">:=</span> <span class="n">fb_GetLocalAmsNetId</span><span class="o">.</span><span class="n">AddrString</span><span class="p">;</span>
          <span class="n">fbFileOpen</span><span class="p">(</span> <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span> <span class="p">);</span>
          <span class="n">fbFileOpen</span><span class="p">(</span> <span class="n">sNetId</span> <span class="o">:=</span> <span class="n">sSrcNetId</span><span class="p">,</span> <span class="n">sPathName</span> <span class="o">:=</span> <span class="n">sSrcPathName</span><span class="p">,</span>
                         <span class="n">nMode</span> <span class="o">:=</span> <span class="n">FOPEN_MODEREAD</span> <span class="n">OR</span> <span class="n">FOPEN_MODETEXT</span><span class="p">,</span>
                         <span class="n">ePath</span> <span class="o">:=</span> <span class="n">PATH_GENERIC</span><span class="p">,</span> <span class="n">tTimeout</span> <span class="o">:=</span> <span class="n">tTimeOut</span><span class="p">,</span> <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">TRUE</span> <span class="p">);</span>
          <span class="n">Step</span> <span class="o">:=</span> <span class="n">Step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

    <span class="mi">2</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">Check</span> <span class="n">Open</span> <span class="n">file</span> <span class="n">was</span> <span class="n">successful</span><span class="o">*</span><span class="p">)</span>
          <span class="n">fbFileOpen</span><span class="p">(</span> <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span> <span class="p">);</span>
          <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbFileOpen</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
               <span class="n">IF</span> <span class="n">fbFileOpen</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
                    <span class="n">nErrId</span> <span class="o">:=</span> <span class="n">fbFileOpen</span><span class="o">.</span><span class="n">nErrId</span><span class="p">;</span>
                    <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
                    <span class="n">sErrMsg</span><span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Error Opening Json File. E:&#39;</span><span class="p">,</span> <span class="n">TO_STRING</span><span class="p">(</span><span class="n">nErrId</span><span class="p">));</span>
                    <span class="n">Step</span> <span class="o">:=</span> <span class="mi">900</span> <span class="o">+</span> <span class="n">Step</span><span class="p">;</span>
               <span class="n">ELSE</span>
                    <span class="n">hSrcFile</span> <span class="o">:=</span> <span class="n">fbFileOpen</span><span class="o">.</span><span class="n">hFile</span><span class="p">;</span>
                    <span class="n">Step</span> <span class="o">:=</span> <span class="n">Step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
               <span class="n">END_IF</span>
          <span class="n">END_IF</span>

    <span class="mi">3</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">Read</span> <span class="n">data</span> <span class="kn">from</span><span class="w"> </span><span class="nn">source</span> <span class="n">file</span> <span class="n">to</span> <span class="n">buffer</span> <span class="n">string</span><span class="o">*</span><span class="p">)</span>
          <span class="n">cbReadLength</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="n">fbFileRead</span><span class="p">(</span> <span class="n">bExecute</span><span class="o">:=</span> <span class="n">FALSE</span> <span class="p">);</span>
          <span class="n">fbFileRead</span><span class="p">(</span> <span class="n">sNetId</span><span class="o">:=</span><span class="n">sSrcNetId</span><span class="p">,</span> <span class="n">hFile</span><span class="o">:=</span><span class="n">hSrcFile</span><span class="p">,</span>
                         <span class="n">pReadBuff</span><span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">sbuffRead</span><span class="p">),</span> <span class="n">cbReadLen</span><span class="o">:=</span> <span class="n">SIZEOF</span><span class="p">(</span><span class="n">sbuffRead</span><span class="p">),</span>
                         <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span> <span class="n">tTimeout</span><span class="o">:=</span><span class="n">tTimeOut</span> <span class="p">);</span>
          <span class="n">Step</span> <span class="o">:=</span> <span class="n">Step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

    <span class="mi">4</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">Check</span> <span class="n">read</span> <span class="n">file</span> <span class="n">was</span> <span class="n">successful</span> <span class="ow">and</span> <span class="n">data</span> <span class="n">read</span> <span class="ow">in</span> <span class="n">buffer</span> <span class="n">string</span><span class="o">*</span><span class="p">)</span>
         <span class="n">fbFileRead</span><span class="p">(</span> <span class="n">bExecute</span><span class="o">:=</span> <span class="n">FALSE</span> <span class="p">);</span>
          <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbFileRead</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
               <span class="n">IF</span> <span class="n">fbFileRead</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
                    <span class="n">nErrId</span> <span class="o">:=</span> <span class="n">fbFileRead</span><span class="o">.</span><span class="n">nErrId</span><span class="p">;</span>
                    <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
                    <span class="n">sErrMsg</span><span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Error reading Json File. E: &#39;</span><span class="p">,</span> <span class="n">TO_STRING</span><span class="p">(</span><span class="n">nErrId</span><span class="p">));</span>
                    <span class="n">Step</span> <span class="o">:=</span> <span class="mi">900</span> <span class="o">+</span><span class="n">Step</span><span class="p">;</span>
               <span class="n">ELSE</span>
                    <span class="n">cbReadLength</span> <span class="o">:=</span> <span class="n">fbFileRead</span><span class="o">.</span><span class="n">cbRead</span><span class="p">;</span>
                    <span class="n">nFileLength</span> <span class="o">:=</span> <span class="n">nFileLength</span> <span class="o">+</span> <span class="n">cbReadLength</span><span class="p">;</span>
                    <span class="n">Step</span> <span class="o">:=</span> <span class="n">Step</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">;</span>
               <span class="n">END_IF</span>
          <span class="n">END_IF</span>

     <span class="mi">5</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">Check</span> <span class="n">Bytes</span> <span class="n">read</span><span class="o">*</span><span class="p">)</span>
         <span class="n">IF</span><span class="p">(</span> <span class="n">nFileLength</span> <span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="n">THEN</span> <span class="o">//</span> <span class="n">oh</span> <span class="n">no</span><span class="p">,</span> <span class="n">we</span> <span class="n">read</span> <span class="n">zero</span> <span class="nb">bytes</span>
            <span class="n">nErrId</span> <span class="o">:=</span> <span class="n">fbFileRead</span><span class="o">.</span><span class="n">nErrId</span><span class="p">;</span>
            <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">sErrMsg</span><span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span> <span class="s1">&#39;Zero bytes were read from the Json File. E:&#39;</span><span class="p">,</span> <span class="n">TO_STRING</span><span class="p">(</span><span class="n">nErrId</span><span class="p">));</span>
            <span class="n">Step</span> <span class="o">:=</span> <span class="mi">900</span> <span class="o">+</span><span class="n">Step</span><span class="p">;</span>
        <span class="n">ELSE</span> <span class="o">//</span> <span class="n">we</span> <span class="n">read</span> <span class="n">something</span><span class="p">,</span> <span class="n">lets</span> <span class="n">log</span> <span class="n">about</span> <span class="n">it</span>
            <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Total numbers of Bytes read from file : &#39;</span><span class="p">,</span> <span class="n">TO_STRING</span><span class="p">(</span><span class="n">nFileLength</span><span class="p">)),</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
            <span class="n">Step</span> <span class="o">:=</span> <span class="n">Step</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">;</span>
       <span class="n">END_IF</span><span class="p">;</span>




     <span class="mi">6</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">Close</span> <span class="n">source</span> <span class="n">file</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">fbFileClose</span><span class="p">(</span> <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span> <span class="p">);</span>
        <span class="n">fbFileClose</span><span class="p">(</span> <span class="n">sNetId</span><span class="o">:=</span><span class="n">sSrcNetId</span><span class="p">,</span> <span class="n">hFile</span><span class="o">:=</span><span class="n">hSrcFile</span><span class="p">,</span> <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span> <span class="n">tTimeout</span><span class="o">:=</span><span class="n">tTimeOut</span> <span class="p">);</span>
          <span class="n">Step</span> <span class="o">:=</span> <span class="n">Step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

     <span class="mi">7</span> <span class="p">:</span>  <span class="p">(</span><span class="o">*</span><span class="n">Check</span> <span class="n">file</span> <span class="n">was</span> <span class="n">closed</span> <span class="n">successfully</span><span class="o">.*</span><span class="p">)</span>
        <span class="n">fbFileClose</span><span class="p">(</span> <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span> <span class="p">);</span>
          <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbFileClose</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
               <span class="n">IF</span> <span class="n">fbFileClose</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
                    <span class="n">nErrId</span> <span class="o">:=</span> <span class="n">fbFileClose</span><span class="o">.</span><span class="n">nErrId</span><span class="p">;</span>
                    <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
                    <span class="n">Step</span><span class="o">:=</span><span class="mi">900</span><span class="o">+</span><span class="n">Step</span><span class="p">;</span>
                    <span class="n">sErrMsg</span><span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Error closing Json File. E:&#39;</span><span class="p">,</span> <span class="n">TO_STRING</span><span class="p">(</span><span class="n">nErrId</span><span class="p">));</span>
               <span class="n">END_IF</span>
               <span class="n">Step</span> <span class="o">:=</span> <span class="n">Step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
               <span class="n">hSrcFile</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="n">END_IF</span>

      <span class="mi">8</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">Error</span> <span class="ow">or</span> <span class="n">ready</span> <span class="o">=&gt;</span> <span class="n">Cleanup</span> <span class="o">*</span><span class="p">)</span>
          <span class="n">IF</span> <span class="p">(</span><span class="n">hSrcFile</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="n">THEN</span>
               <span class="n">Step</span> <span class="o">:=</span> <span class="mi">6</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">Close</span> <span class="n">the</span> <span class="n">source</span> <span class="n">file</span> <span class="o">*</span><span class="p">)</span>
          <span class="n">ELSE</span>
              <span class="p">(</span><span class="o">*</span> <span class="n">Ready</span> <span class="o">*</span><span class="p">)</span>
               <span class="n">Step</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
          <span class="n">END_IF</span>

     <span class="mi">10</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Parse</span> <span class="n">read</span> <span class="n">buffer</span> <span class="n">string</span> <span class="n">to</span> <span class="n">JSON</span> <span class="n">DOM</span> <span class="nb">object</span><span class="o">*</span><span class="p">)</span>
         <span class="o">//</span><span class="n">cbJsonParserLength</span> <span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">CopyDocument</span><span class="p">(</span><span class="n">sbuffRead</span><span class="p">,</span><span class="n">cbReadLength</span><span class="p">);</span>
        <span class="n">jsonDoc</span> <span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">ParseDocument</span><span class="p">(</span><span class="n">sbuffRead</span><span class="p">);</span>
        <span class="n">bfbJsonExceptionRaised</span><span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">ExceptionRaised</span><span class="p">();</span>
        <span class="n">IF</span> <span class="p">(</span><span class="n">jsonDoc</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">bfbJsonExceptionRaised</span><span class="p">)</span> <span class="n">THEN</span>
            <span class="n">Step</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
        <span class="n">ELSE</span>
            <span class="n">Step</span> <span class="o">:=</span> <span class="mi">900</span> <span class="o">+</span> <span class="n">Step</span><span class="p">;</span>
            <span class="n">nErrId</span> <span class="o">:=</span> <span class="n">Step</span><span class="p">;</span>
            <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">sErrMsg</span><span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Error Parsing JSON Data. S:&#39;</span><span class="p">,</span><span class="n">TO_STRING</span><span class="p">(</span><span class="n">nErrId</span><span class="p">));</span>
        <span class="n">END_IF</span>


     <span class="mi">20</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Find</span> <span class="n">the</span> <span class="n">PLC</span> <span class="n">Name</span><span class="o">*</span><span class="p">)</span>
        <span class="n">bHasPLC</span> <span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">HasMember</span><span class="p">(</span><span class="n">jsonDoc</span><span class="p">,</span> <span class="n">sPLCName</span><span class="p">);</span>
        <span class="n">IF</span> <span class="p">(</span><span class="n">bHasPLC</span><span class="p">)</span> <span class="n">THEN</span>
            <span class="n">jsonProp</span> <span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">FindMember</span><span class="p">(</span><span class="n">jsonDoc</span><span class="p">,</span> <span class="n">sPLCName</span><span class="p">);</span>
            <span class="n">IF</span> <span class="n">jsonProp</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
                <span class="n">Step</span> <span class="o">:=</span> <span class="n">Step</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
                <span class="n">ELSE</span>
                    <span class="n">Step</span> <span class="o">:=</span> <span class="mi">900</span> <span class="o">+</span> <span class="n">Step</span><span class="p">;</span>
                    <span class="n">nErrId</span> <span class="o">:=</span> <span class="n">Step</span><span class="p">;</span>
                    <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
                    <span class="n">sErrMsg</span><span class="o">:=</span>  <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Error Loading PLC data from Json File : &#39;</span><span class="p">,</span><span class="n">sPLCName</span><span class="p">);</span>
                <span class="n">END_IF</span>
        <span class="n">ELSE</span>
            <span class="n">Step</span> <span class="o">:=</span> <span class="mi">900</span> <span class="o">+</span> <span class="n">Step</span><span class="p">;</span>
            <span class="n">nErrId</span> <span class="o">:=</span> <span class="n">Step</span><span class="p">;</span>
            <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">sErrMsg</span><span class="o">:=</span>  <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Error PLC name not found in Json File : &#39;</span><span class="p">,</span><span class="n">sPLCName</span><span class="p">);</span>
        <span class="n">END_IF</span>

    <span class="mi">21</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">write</span> <span class="n">to</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">JSonDoc</span> <span class="n">variable</span><span class="o">*</span><span class="p">)</span>
      <span class="n">PMPS_jsonDoc</span> <span class="o">:=</span> <span class="n">jsonProp</span><span class="p">;</span>
      <span class="n">Step</span> <span class="o">:=</span> <span class="mi">30</span><span class="p">;</span>

    <span class="mi">30</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">ALL</span> <span class="n">good</span> <span class="n">here</span><span class="o">*</span><span class="p">)</span>
        <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Reading and Parsing Json File Completed Successfully.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
         <span class="o">//</span> <span class="n">Release</span> <span class="n">allocated</span> <span class="n">memory</span>
        <span class="o">//</span><span class="n">jsonDoc</span> <span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">NewDocument</span><span class="p">();</span>
        <span class="n">bExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">bBusy</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
        <span class="n">FFO</span><span class="o">.</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">Step</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">END_CASE</span>

<span class="o">//</span><span class="n">Fault</span> <span class="ow">in</span> <span class="n">error</span> <span class="n">state</span>
<span class="n">IF</span><span class="p">(</span><span class="n">Step</span><span class="o">&gt;=</span><span class="mi">900</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">FFO</span><span class="o">.</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">Step</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">ACT_FFO</span><span class="p">();</span>
<span class="n">ACT_LOGGER</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">ACT_FFO</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span><span class="n">FAST</span> <span class="n">FAULT</span><span class="o">*</span><span class="p">)</span>
<span class="n">FFO</span><span class="p">(</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="p">,</span>
    <span class="n">i_xReset</span> <span class="o">:=</span> <span class="p">,</span>
    <span class="n">i_xAutoReset</span> <span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">i_DevName</span> <span class="o">:=</span> <span class="n">sPLCName</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span> <span class="o">:=</span> <span class="n">io_fbFFHWO</span><span class="p">);</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">ACT_Logger</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Log</span> <span class="n">valve</span> <span class="nb">open</span>
<span class="n">tNewMessage</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="n">NOT</span><span class="p">(</span><span class="n">FbLogger</span><span class="o">.</span><span class="n">sMsg</span> <span class="o">=</span> <span class="n">sErrMsg</span><span class="p">)</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">sErrMsg</span> <span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">));</span>
<span class="n">IF</span> <span class="n">tNewMessage</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span> <span class="n">sErrMsg</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span> <span class="n">END_IF</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-fastfault">FB_FastFault</a></p></li>
<li><p><a class="reference internal" href="#fb-hardwareffoutput">FB_HardwareFFOutput</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-kphotonenergy">
<h2>FB_KPhotonEnergy<a class="headerlink" href="#fb-kphotonenergy" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_KPhotonEnergy</span> <span class="n">EXTENDS</span> <span class="n">FB_PhotonEnergy</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">eEnrg</span>
        <span class="n">link</span><span class="p">:</span> <span class="n">BEND</span><span class="p">:</span><span class="n">DMPS</span><span class="p">:</span><span class="mi">400</span><span class="p">:</span><span class="n">BACT</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">GeV</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbSxuElectronEnergy</span> <span class="p">:</span> <span class="n">FB_LREALFromEPICS</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">EEnergy</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Electron</span> <span class="n">Energy</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">GeV</span>
    <span class="s1">&#39;}</span>
    <span class="n">fElectronEnergyVal</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">EEnergyValid</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Electron</span> <span class="n">Energy</span> <span class="n">Valid</span>
    <span class="s1">&#39;}</span>
    <span class="n">bElectronEnergyValid</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">UND</span>
        <span class="n">link</span><span class="p">:</span> <span class="n">USEG</span><span class="p">:</span><span class="n">UNDS</span><span class="p">:</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbSxu</span> <span class="p">:</span> <span class="n">FB_SXU</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Update</span> <span class="n">PVs</span>
<span class="n">fbSxuElectronEnergy</span><span class="p">();</span>

<span class="n">fElectronEnergyVal</span> <span class="o">:=</span> <span class="n">fbSxuElectronEnergy</span><span class="o">.</span><span class="n">fValue</span><span class="p">;</span>
<span class="n">bElectronEnergyValid</span> <span class="o">:=</span> <span class="n">fbSxuElectronEnergy</span><span class="o">.</span><span class="n">bValid</span><span class="p">;</span>

<span class="n">fbSxu</span><span class="p">(</span><span class="n">fbElectronEnergy</span><span class="o">:=</span><span class="n">fbSxuElectronEnergy</span><span class="p">);</span>

<span class="n">SUPER</span><span class="o">^</span><span class="p">(</span><span class="n">BP</span><span class="o">:=</span><span class="n">SUPER</span><span class="o">^.</span><span class="n">BP</span><span class="p">,</span> <span class="n">Undulator</span><span class="o">:=</span><span class="n">fbSxu</span> <span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-photonenergy">FB_PhotonEnergy</a></p></li>
<li><p><a class="reference internal" href="#fb-sxu">FB_SXU</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-kstopper">
<h2>FB_KStopper<a class="headerlink" href="#fb-kstopper" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_KStopper</span> <span class="n">EXTENDS</span> <span class="n">FB_StopperWatcher</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">SUPER</span><span class="o">^</span><span class="p">(</span><span class="n">stCurrentBP</span><span class="o">:=</span><span class="n">SUPER</span><span class="o">^.</span><span class="n">stCurrentBP</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">FB_init</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bInitRetains</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="k">if</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">the</span> <span class="n">retain</span> <span class="n">variables</span> <span class="n">are</span> <span class="n">initialized</span> <span class="p">(</span><span class="n">warm</span> <span class="n">start</span> <span class="o">/</span> <span class="n">cold</span> <span class="n">start</span><span class="p">)</span>
    <span class="n">bInCopyCode</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>  <span class="o">//</span> <span class="k">if</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">the</span> <span class="n">instance</span> <span class="n">afterwards</span> <span class="n">gets</span> <span class="n">moved</span> <span class="n">into</span> <span class="n">the</span> <span class="n">copy</span> <span class="n">code</span> <span class="p">(</span><span class="n">online</span> <span class="n">change</span><span class="p">)</span>
    <span class="n">eStopper</span> <span class="p">:</span> <span class="n">K_Stopper</span><span class="p">;</span>
    <span class="n">sStopperName</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">Stopper</span> <span class="o">:=</span> <span class="n">eStopper</span><span class="p">;</span>
<span class="n">StopperName</span> <span class="o">:=</span> <span class="n">sStopperName</span><span class="p">;</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-stopperwatcher">FB_StopperWatcher</a></p></li>
<li><p><a class="reference internal" href="#k-stopper">K_Stopper</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-kvetodevice">
<h2>FB_KVetoDevice<a class="headerlink" href="#fb-kvetodevice" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_KVetoDevice</span> <span class="n">EXTENDS</span> <span class="n">FB_VetoDevice</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">SUPER</span><span class="o">^</span><span class="p">(</span><span class="n">stCurrentBP</span><span class="o">:=</span><span class="n">SUPER</span><span class="o">^.</span><span class="n">stCurrentBP</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">FB_init</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bInitRetains</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="k">if</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">the</span> <span class="n">retain</span> <span class="n">variables</span> <span class="n">are</span> <span class="n">initialized</span> <span class="p">(</span><span class="n">warm</span> <span class="n">start</span> <span class="o">/</span> <span class="n">cold</span> <span class="n">start</span><span class="p">)</span>
    <span class="n">bInCopyCode</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>  <span class="o">//</span> <span class="k">if</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">the</span> <span class="n">instance</span> <span class="n">afterwards</span> <span class="n">gets</span> <span class="n">moved</span> <span class="n">into</span> <span class="n">the</span> <span class="n">copy</span> <span class="n">code</span> <span class="p">(</span><span class="n">online</span> <span class="n">change</span><span class="p">)</span>
    <span class="n">eVetoDeviceIN</span> <span class="p">:</span> <span class="n">K_Stopper</span> <span class="o">:=</span> <span class="n">K_Stopper</span><span class="o">.</span><span class="n">DEFAULT</span><span class="p">;</span>
    <span class="n">eVetoDeviceOUT</span> <span class="p">:</span> <span class="n">K_Stopper</span> <span class="o">:=</span> <span class="n">K_Stopper</span><span class="o">.</span><span class="n">DEFAULT</span><span class="p">;</span>
    <span class="n">sVetoDeviceName</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VetoDevice_IN</span> <span class="o">:=</span> <span class="n">eVetoDeviceIN</span><span class="p">;</span>
<span class="n">VetoDevice_OUT</span> <span class="o">:=</span> <span class="n">eVetoDeviceOUT</span><span class="p">;</span>
<span class="n">VetoDeviceName</span> <span class="o">:=</span> <span class="n">sVetoDeviceName</span><span class="p">;</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-vetodevice">FB_VetoDevice</a></p></li>
<li><p><a class="reference internal" href="#k-stopper">K_Stopper</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-lineardevicestatetable">
<h2>FB_LinearDeviceStateTable<a class="headerlink" href="#fb-lineardevicestatetable" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="n">implements</span> <span class="n">simple</span> <span class="n">database</span><span class="o">.</span> <span class="n">Data</span> <span class="n">element</span> <span class="n">values</span> <span class="n">are</span> <span class="n">stored</span> <span class="ow">in</span> <span class="n">the</span> <span class="nb">hash</span> <span class="n">table</span><span class="o">.</span>  <span class="o">*</span><span class="p">)</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_check&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_LinearDeviceStateTable</span>
<span class="n">VAR_INPUT</span>
    <span class="n">key</span>         <span class="p">:</span> <span class="n">DWORD</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;(</span><span class="o">*</span> <span class="n">Entry</span> <span class="n">key</span><span class="p">:</span> <span class="n">used</span> <span class="n">by</span> <span class="n">A_Lookup</span><span class="p">,</span> <span class="n">A_Remove</span> <span class="n">method</span><span class="p">,</span> <span class="n">the</span> <span class="n">key</span> <span class="n">variable</span> <span class="ow">is</span> <span class="n">also</span> <span class="n">used</span> <span class="n">by</span> <span class="n">A_Add</span> <span class="n">method</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">putPosPtr</span>    <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">T_HashTableEntry</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;(</span><span class="o">*</span> <span class="n">Hash</span> <span class="n">table</span> <span class="n">entry</span> <span class="n">position</span> <span class="n">pointer</span> <span class="p">(</span><span class="n">used</span> <span class="n">by</span> <span class="n">A_Find</span><span class="p">,</span> <span class="n">A_GetNext</span><span class="p">,</span> <span class="n">A_GetPrev</span><span class="p">)</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">putValue</span>     <span class="p">:</span> <span class="n">ST_DeviceState</span><span class="p">;(</span><span class="o">*</span> <span class="n">Hash</span> <span class="n">table</span> <span class="n">entry</span> <span class="n">value</span> <span class="p">(</span><span class="n">used</span> <span class="n">by</span> <span class="n">A_AddHead</span><span class="p">,</span> <span class="n">A_AddTail</span><span class="p">,</span> <span class="n">A_Find</span> <span class="p">)</span><span class="o">*</span><span class="p">)</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">bOk</span>            <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;(</span><span class="o">*</span> <span class="n">TRUE</span> <span class="o">=</span> <span class="n">Success</span><span class="p">,</span> <span class="n">FALSE</span> <span class="o">=</span> <span class="n">Failed</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">getPosPtr</span>    <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">T_HashTableEntry</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;(</span><span class="o">*</span> <span class="n">Returned</span> <span class="nb">hash</span> <span class="n">table</span> <span class="n">entry</span> <span class="n">position</span> <span class="n">pointer</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">getValue</span>     <span class="p">:</span> <span class="n">ST_DeviceState</span><span class="p">;(</span><span class="o">*</span> <span class="n">Returned</span> <span class="nb">hash</span> <span class="n">table</span> <span class="n">entry</span> <span class="n">value</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">nCount</span>        <span class="p">:</span> <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;(</span><span class="o">*</span> <span class="n">Hash</span> <span class="n">table</span> <span class="n">size</span> <span class="p">(</span><span class="n">number</span> <span class="n">of</span> <span class="n">used</span> <span class="n">entries</span><span class="p">,</span> <span class="n">used</span> <span class="n">by</span> <span class="n">A_Count</span><span class="p">)</span> <span class="o">*</span><span class="p">)</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">dataPool</span>    <span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">MAX_DEVICE_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_DeviceState</span><span class="p">;(</span><span class="o">*</span> <span class="n">Structured</span> <span class="n">data</span> <span class="n">element</span> <span class="n">pool</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">entries</span>        <span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">MAX_DEVICE_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">T_HashTableEntry</span><span class="p">;(</span><span class="o">*</span> <span class="n">Max</span><span class="o">.</span> <span class="n">number</span> <span class="n">of</span> <span class="nb">hash</span> <span class="n">table</span> <span class="n">entries</span><span class="o">.</span> <span class="n">The</span> <span class="n">value</span> <span class="n">of</span> <span class="n">table</span> <span class="n">entry</span> <span class="o">=</span> <span class="mi">32</span> <span class="n">bit</span> <span class="n">integer</span> <span class="p">(</span><span class="n">pointer</span> <span class="n">to</span> <span class="n">dataPool</span><span class="o">-</span><span class="n">array</span><span class="o">-</span><span class="n">entry</span><span class="p">)</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">fbTable</span>     <span class="p">:</span> <span class="n">FB_HashTableCtrl</span><span class="p">;(</span><span class="o">*</span> <span class="n">basic</span> <span class="nb">hash</span> <span class="n">table</span> <span class="n">control</span> <span class="n">function</span> <span class="n">block</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">hTable</span>         <span class="p">:</span> <span class="n">T_HHASHTABLE</span><span class="p">;(</span><span class="o">*</span> <span class="nb">hash</span> <span class="n">table</span> <span class="n">handle</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">pRefPtr</span>        <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_DeviceState</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">indexOfElem</span>    <span class="p">:</span> <span class="n">ULINT</span><span class="p">;(</span><span class="o">*</span> <span class="n">Integer</span> <span class="n">value</span> <span class="p">(</span><span class="nb">max</span><span class="o">.</span> <span class="n">size</span><span class="p">:</span> <span class="n">x86</span><span class="o">=&gt;</span><span class="mi">32</span><span class="n">bit</span><span class="p">,</span> <span class="n">x64</span><span class="o">=&gt;</span><span class="mi">64</span><span class="n">bit</span><span class="p">)</span><span class="o">*</span><span class="p">)</span>
<span class="n">END_VAR</span>
<span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">A_Add</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Adds</span> <span class="n">entry</span> <span class="n">to</span> <span class="n">the</span> <span class="n">table</span> <span class="o">*</span><span class="p">)</span>
<span class="n">MEMSET</span><span class="p">(</span> <span class="n">ADR</span><span class="p">(</span> <span class="n">getValue</span> <span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SIZEOF</span><span class="p">(</span> <span class="n">getValue</span> <span class="p">)</span> <span class="p">);</span>
<span class="n">getPosPtr</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">fbTable</span><span class="o">.</span><span class="n">A_Add</span><span class="p">(</span> <span class="n">hTable</span> <span class="o">:=</span> <span class="n">hTable</span><span class="p">,</span> <span class="n">key</span> <span class="o">:=</span> <span class="n">key</span><span class="p">,</span> <span class="n">putValue</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#0000_0000(* we will set this value later *), getPosPtr=&gt;getPosPtr, bOk=&gt;bOk );(* Add new element to the table, getPosPtr points to the new entry *)</span>
<span class="n">IF</span> <span class="n">fbTable</span><span class="o">.</span><span class="n">bOk</span> <span class="n">THEN</span><span class="p">(</span><span class="o">*</span> <span class="n">Success</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">fbTable</span><span class="o">.</span><span class="n">A_GetIndexAtPosPtr</span><span class="p">(</span> <span class="n">hTable</span> <span class="o">:=</span> <span class="n">hTable</span><span class="p">,</span> <span class="n">putPosPtr</span> <span class="o">:=</span> <span class="n">getPosPtr</span><span class="p">,</span> <span class="n">getValue</span> <span class="o">=&gt;</span><span class="n">indexOfElem</span><span class="p">,</span> <span class="n">bOk</span><span class="o">=&gt;</span><span class="n">bOk</span> <span class="p">);(</span><span class="o">*</span> <span class="n">Get</span> <span class="n">array</span> <span class="n">index</span> <span class="n">of</span> <span class="n">getPosPtr</span> <span class="n">entry</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">IF</span> <span class="n">fbTable</span><span class="o">.</span><span class="n">bOk</span> <span class="n">THEN</span><span class="p">(</span><span class="o">*</span> <span class="n">Success</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">pRefPtr</span>     <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span> <span class="n">dataPool</span><span class="p">[</span><span class="n">indexOfElem</span><span class="p">]</span> <span class="p">);(</span><span class="o">*</span> <span class="n">Get</span> <span class="n">pointer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">data</span> <span class="n">element</span> <span class="o">*</span><span class="p">)</span>

        <span class="n">pRefPtr</span><span class="o">^</span> <span class="o">:=</span> <span class="n">putValue</span><span class="p">;(</span><span class="o">*</span> <span class="n">copy</span> <span class="n">application</span> <span class="n">value</span> <span class="o">*</span><span class="p">)</span>

        <span class="n">fbTable</span><span class="o">.</span><span class="n">A_Add</span><span class="p">(</span> <span class="n">hTable</span> <span class="o">:=</span> <span class="n">hTable</span><span class="p">,</span> <span class="n">key</span> <span class="o">:=</span> <span class="n">key</span><span class="p">,</span> <span class="n">putValue</span> <span class="o">:=</span> <span class="n">pRefPtr</span><span class="p">,</span> <span class="n">bOk</span><span class="o">=&gt;</span><span class="n">bOk</span> <span class="p">);(</span><span class="o">*</span> <span class="n">Assign</span> <span class="n">the</span> <span class="n">entry</span> <span class="n">value</span> <span class="o">=</span> <span class="n">pointer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">data</span> <span class="n">element</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">IF</span> <span class="n">fbTable</span><span class="o">.</span><span class="n">bOk</span> <span class="n">THEN</span><span class="p">(</span><span class="o">*</span> <span class="n">Success</span> <span class="o">*</span><span class="p">)</span>
            <span class="n">getValue</span> <span class="o">:=</span> <span class="n">putValue</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">A_Count</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Count</span> <span class="n">number</span> <span class="n">of</span> <span class="n">used</span> <span class="n">entries</span> <span class="o">*</span><span class="p">)</span>
<span class="n">nCount</span> <span class="o">:=</span> <span class="n">hTable</span><span class="o">.</span><span class="n">nCount</span><span class="p">;</span>
<span class="n">bOk</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">A_GetFirst</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Get</span> <span class="n">first</span> <span class="n">entry</span> <span class="n">position</span> <span class="n">pointer</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">*</span><span class="p">)</span>
<span class="n">MEMSET</span><span class="p">(</span> <span class="n">ADR</span><span class="p">(</span> <span class="n">getValue</span> <span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SIZEOF</span><span class="p">(</span> <span class="n">getValue</span> <span class="p">)</span> <span class="p">);</span>
<span class="n">getPosPtr</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">fbTable</span><span class="o">.</span><span class="n">A_GetFirst</span><span class="p">(</span> <span class="n">hTable</span> <span class="o">:=</span> <span class="n">hTable</span><span class="p">,</span> <span class="n">putPosPtr</span> <span class="o">:=</span> <span class="n">putPosPtr</span><span class="p">,</span> <span class="n">getValue</span><span class="o">=&gt;</span><span class="n">pRefPtr</span><span class="p">,</span> <span class="n">getPosPtr</span><span class="o">=&gt;</span><span class="n">getPosPtr</span><span class="p">,</span> <span class="n">bOk</span><span class="o">=&gt;</span><span class="n">bOk</span> <span class="p">);</span>
<span class="n">IF</span> <span class="n">fbTable</span><span class="o">.</span><span class="n">bOk</span> <span class="n">THEN</span>
    <span class="n">getValue</span> <span class="o">:=</span> <span class="n">pRefPtr</span><span class="o">^</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">A_GetNext</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Get</span> <span class="nb">next</span> <span class="n">entry</span> <span class="n">position</span> <span class="n">pointer</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">*</span><span class="p">)</span>
<span class="n">MEMSET</span><span class="p">(</span> <span class="n">ADR</span><span class="p">(</span> <span class="n">getValue</span> <span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SIZEOF</span><span class="p">(</span> <span class="n">getValue</span> <span class="p">)</span> <span class="p">);</span>
<span class="n">getPosPtr</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">bOk</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">putPosPtr</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbTable</span><span class="o">.</span><span class="n">A_GetNext</span><span class="p">(</span> <span class="n">hTable</span> <span class="o">:=</span> <span class="n">hTable</span><span class="p">,</span> <span class="n">putPosPtr</span> <span class="o">:=</span> <span class="n">putPosPtr</span><span class="p">,</span> <span class="n">getValue</span><span class="o">=&gt;</span><span class="n">pRefPtr</span><span class="p">,</span> <span class="n">getPosPtr</span><span class="o">=&gt;</span><span class="n">getPosPtr</span><span class="p">,</span> <span class="n">bOk</span><span class="o">=&gt;</span><span class="n">bOk</span> <span class="p">);</span>
<span class="n">IF</span> <span class="n">fbTable</span><span class="o">.</span><span class="n">bOk</span> <span class="n">THEN</span>
    <span class="n">getValue</span> <span class="o">:=</span> <span class="n">pRefPtr</span><span class="o">^</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">A_Lookup</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Lookup</span> <span class="k">for</span> <span class="n">entry</span> <span class="n">by</span> <span class="n">key</span>  <span class="o">*</span><span class="p">)</span>
<span class="n">MEMSET</span><span class="p">(</span> <span class="n">ADR</span><span class="p">(</span> <span class="n">getValue</span> <span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SIZEOF</span><span class="p">(</span> <span class="n">getValue</span> <span class="p">)</span> <span class="p">);</span>
<span class="n">getPosPtr</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">fbTable</span><span class="o">.</span><span class="n">A_Lookup</span><span class="p">(</span> <span class="n">key</span> <span class="o">:=</span> <span class="n">key</span><span class="p">,</span> <span class="n">hTable</span> <span class="o">:=</span> <span class="n">hTable</span><span class="p">,</span> <span class="n">putPosPtr</span> <span class="o">:=</span> <span class="n">putPosPtr</span><span class="p">,</span> <span class="n">getValue</span><span class="o">=&gt;</span><span class="n">pRefPtr</span><span class="p">,</span> <span class="n">getPosPtr</span><span class="o">=&gt;</span><span class="n">getPosPtr</span><span class="p">,</span> <span class="n">bOk</span><span class="o">=&gt;</span><span class="n">bOk</span> <span class="p">);</span>
<span class="n">IF</span> <span class="n">fbTable</span><span class="o">.</span><span class="n">bOk</span> <span class="n">THEN</span>
    <span class="n">getValue</span> <span class="o">:=</span> <span class="n">pRefPtr</span><span class="o">^</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">A_Remove</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Search</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">and</span> <span class="n">remove</span> <span class="n">it</span> <span class="o">*</span><span class="p">)</span>
<span class="n">MEMSET</span><span class="p">(</span> <span class="n">ADR</span><span class="p">(</span> <span class="n">getValue</span> <span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SIZEOF</span><span class="p">(</span> <span class="n">getValue</span> <span class="p">)</span> <span class="p">);</span>
<span class="n">getPosPtr</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">fbTable</span><span class="o">.</span><span class="n">A_Remove</span><span class="p">(</span> <span class="n">key</span> <span class="o">:=</span> <span class="n">key</span><span class="p">,</span> <span class="n">hTable</span> <span class="o">:=</span> <span class="n">hTable</span><span class="p">,</span> <span class="n">putPosPtr</span> <span class="o">:=</span> <span class="n">putPosPtr</span><span class="p">,</span> <span class="n">getValue</span><span class="o">=&gt;</span><span class="n">pRefPtr</span><span class="p">,</span> <span class="n">getPosPtr</span><span class="o">=&gt;</span><span class="n">getPosPtr</span><span class="p">,</span> <span class="n">bOk</span><span class="o">=&gt;</span><span class="n">bOk</span> <span class="p">);</span>
<span class="n">IF</span> <span class="n">fbTable</span><span class="o">.</span><span class="n">bOk</span> <span class="n">THEN</span>
    <span class="n">getValue</span> <span class="o">:=</span> <span class="n">pRefPtr</span><span class="o">^</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">A_Reset</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Reset</span><span class="o">/</span><span class="n">initialize</span> <span class="n">linked</span> <span class="nb">list</span> <span class="o">*</span><span class="p">)</span>
<span class="n">MEMSET</span><span class="p">(</span> <span class="n">ADR</span><span class="p">(</span> <span class="n">getValue</span> <span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SIZEOF</span><span class="p">(</span> <span class="n">getValue</span> <span class="p">)</span> <span class="p">);</span>
<span class="n">getPosPtr</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">bOk</span> <span class="o">:=</span> <span class="n">F_CreateHashTableHnd</span><span class="p">(</span> <span class="n">ADR</span><span class="p">(</span> <span class="n">entries</span> <span class="p">),</span> <span class="n">SIZEOF</span><span class="p">(</span> <span class="n">entries</span> <span class="p">),</span> <span class="n">hTable</span> <span class="p">);(</span><span class="o">*</span> <span class="n">Intialize</span> <span class="n">table</span> <span class="n">handle</span> <span class="o">*</span><span class="p">)</span>
<span class="n">fbTable</span><span class="o">.</span><span class="n">A_Reset</span><span class="p">(</span> <span class="n">hTable</span> <span class="o">:=</span> <span class="n">hTable</span><span class="p">,</span> <span class="n">bOk</span><span class="o">=&gt;</span><span class="n">bOk</span> <span class="p">);</span>
<span class="n">nCount</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
<li><p><a class="reference internal" href="#st-devicestate">ST_DeviceState</a></p></li>
<li><p><a class="reference internal" href="#t-hashtableentry">T_HashTableEntry</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-lineargovernor">
<h2>FB_LinearGovernor<a class="headerlink" href="#fb-lineargovernor" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(* The governor is meant to check your work and keep you from making mistakes.

Checks:
Does your state match the device position and visa versa?
Are the beam parameters safe for the device state?
Did you properly assert the transition and final beam parameters?

*)
FUNCTION_BLOCK FB_LinearGovernor
VAR_INPUT
    i_stCurrentBeamParams    :    ST_BeamParams; //Link to global beam params
    i_xMPSOverride            :    BOOL; //True releases MPS limits after a delay
    i_xTransitionRequested    :    BOOL; //Set true to request a transition
    i_xResetMPSFault    :    BOOL; //Set true to clear MPS fault
END_VAR
VAR_OUTPUT
     //True when governor has released restrictions
    q_xTransitionPermitted    :    BOOL;
    //Set if MC_Power has an error, or override mode is requested
    q_xFault    :    BOOL;
    // Indicates override mode is active
    q_xMPSLimitsOverridden: BOOL;
END_VAR
VAR_IN_OUT
    stDevice    :    ST_Device; //The governed
    Arbiter    :    FB_Arbiter;
    FastFaultOutput    :    FB_HardwareFFOutput;
END_VAR
VAR
    mcPower    :    MC_Power;

    xActuatorPositiveEnable: BOOL;
    xActuatorNegativeEnable: BOOL;

    xMPSPositiveEnable    :    BOOL;
    xMPSNegativeEnable    :    BOOL;
    lrPosition: LREAL;

    lrLatchedTargetPosition    :    LREAL;
    lrLatchedTargetTolerance    :    LREAL;
    stLatchedTargetState    :    ST_DeviceStateExt;

    lrMPSUpperLimit: LREAL;
    lrMPSLowerLimit: LREAL;
    rtNewState: R_TRIG;
    xTransitionOK: BOOL;

    tonMPSOverrideMode    :    TON := (
        PT := T#5S
    );

    srMPSFault    :    SR;
    // Actuator out of bounds fault
    xActuatorOOB: BOOL;
    //Beam parameters out of spec
    xBeamParamsOOS: BOOL;
    //Beam parameters of currently latched state

    stLatchedBeamParams: ST_BeamParams;
    stTargetState: ST_DeviceStateExt;

    rtLatchNewState    :    R_TRIG;
    xInit: BOOL := TRUE;

    stInitDeviceState: ST_DeviceStateExt;
    // Indicates an error with initialization
    xInitFault: BOOL;
    // Indicates the state could not be found in the state table. There may be something wrong in the device state machine implementation or state table instantiation.
    xStateLookupError: BOOL;
    // A transition needs to be requested at least once before we start latching any state.
    xTransitionHasBeenRequested: BOOL := FALSE;
    ffBeamParamsOK : FB_FastFault;
    ffActuatorBoundsOK    :    FB_FastFault;
END_VAR
lrPosition := stDevice.stAxis.NcToPlc.ActPos; //Actuator position

stDevice.stAxis.ReadStatus();
//Init
(* The init strategy is:
If the device is restored and it&#39;s residing at the safe position,
no PMPS faults. *)
////////////////////////////////
    IF xInit THEN
        xInit := FALSE;
        //Use nSafeSate for initialization.
        stDevice.StateTable.A_Lookup(key := stDevice.nSafeState);
        IF stDevice.StateTable.bOk THEN
            stInitDeviceState := F_DeviceState_To_DeviceStateExt(stDevice.StateTable.getValue, TRUE);
            xInitFault := FALSE;
        ELSE
            xInitFault := TRUE;
            stInitDeviceState.xValid := FALSE;
        END_IF
        lrLatchedTargetPosition := stInitDeviceState.rPosition;
        lrLatchedTargetTolerance := stInitDeviceState.rTolerance;
        stLatchedBeamParams := stInitDeviceState.stReqBeamParam;
    END_IF

// The governor will permit transitions once it verifies the transition assertion is active
// Note the governor does not verify the target state beam params are asserted, perhaps it should &lt;TODO&gt;
////////////////////////////////
    IF i_xTransitionRequested THEN
        xTransitionHasBeenRequested    := TRUE;

        xTransitionOK := Arbiter.CheckRequest( stDevice.stTransitionState.nStateRef) AND F_SafeBPCompare(i_stCurrentBeamParams, stDevice.stTransitionState.stReqBeamParam);

        //Set the target state for evaluation in further logic
        stdevice.StateTable.A_Lookup(key := stDevice.nTargetState);
        IF stDevice.StateTable.bOk THEN
            stTargetState := F_DeviceState_To_DeviceStateExt(stDevice.StateTable.getValue, TRUE);
            xStateLookupError := FALSE;
        ELSE
            xStateLookupError := TRUE;
            stTargetState.xValid := FALSE;
        END_IF
    ELSE
        xTransitionOK := FALSE;
    END_IF

(* Note about TransitionRequested

If TransitionRequested goes false during a transition, an MPS fault may be induced. This occurs
because the Actuator Out of Bounds fault will go back to using the original state limits, which
the axis may have already moved beyond.

To avoid this transient fault, make sure your device state machine is implemented such that the
transition request to the governor block remains high until the target position is reached.
*)

//Determine if a transition is complete and latch the new state
(* A transition is complete when:

Axis at standstill.
Axis within tolerance.
No transition req.

Once these conditions are met, the MPS limits shall re-engage to restrict the
axis motion to the tolerance around the state position and the MPS fault monitors
shall evaluate based on the newly latched target state.
*)

rtLatchNewState(CLK := stDevice.stAxis.Status.StandStill AND
    lrPosition &lt;= stTargetState.rPosition + stTargetState.rTolerance AND
    lrPosition &gt;= stTargetState.rPosition - stTargetState.rTolerance AND
    NOT i_xTransitionRequested AND xTransitionHasBeenRequested);

IF rtLatchNewState.Q THEN
    lrLatchedTargetPosition := stTargetState.rPosition;
    lrLatchedTargetTolerance := stTargetState.rTolerance;
    stLatchedBeamParams := stTargetState.stReqBeamParam;
    stLatchedTargetState := stTargetState;
END_IF

//Let other blocks know the governor won&#39;t interfer with transitions
q_xTransitionPermitted := xTransitionOK;

//Adjust limit ranges based on active state and current target
IF xTransitionOK THEN
    //Extend range to include target state
    lrMPSUpperLimit := MAX(lrMPSUpperLimit, stTargetState.rPosition + stTargetState.rTolerance);
    lrMPSLowerLimit := MIN(lrMPSLowerLimit, stTargetState.rPosition - stTargetState.rTolerance);
ELSE
    //Calculate the limit positions for MPS based on current state
    lrMPSUpperLimit := lrLatchedTargetPosition + lrLatchedTargetTolerance;
    lrMPSLowerLimit := lrLatchedTargetPosition - lrLatchedTargetTolerance;
END_IF


//MPS override
(* In override mode, the device will be free to move anywhere within it&#39;s travel range *)
//Permit motion after a small delay
tonMPSOverrideMode(IN:=i_xMPSOverride OR stDevice.xOverrideMPSLimits, Q=&gt;q_xMPSLimitsOverridden);

//Virtual limit switch evaluation
xActuatorPositiveEnable    := stDevice.i_xHiLim AND lrPosition &lt;= stDevice.lrUpperPositionLimit;
xActuatorNegativeEnable    := stDevice.i_xLoLim AND lrPosition &gt;= stDevice.lrLowerPositionLimit;

//Evaluate MPS limit states
xMPSPositiveEnable := lrPosition &lt;= lrMPSUpperLimit;
xMPSNegativeEnable := lrPosition &gt;= lrMPSLowerLimit;

//Final Limit switch evaluation
mcPower.Enable_Positive := xActuatorPositiveEnable AND (tonMPSOverrideMode.Q OR xMPSPositiveEnable);
mcPower.Enable_Negative := xActuatorNegativeEnable AND (tonMPSOverrideMode.Q OR xMPSNegativeEnable);

mcPower(
    Axis := stDevice.stAxis,
    Enable := stDevice.xEnable //link to device enable &lt;TODO&gt;
);



//MPS Faults
//Fault if the beam is unsafe for current state
ffBeamParamsOK(i_xOK:=F_SafeBPCompare(i_stCurrentBeamParams, stLatchedBeamParams),
                i_xReset:=i_xResetMPSFault,
                io_fbFFHWO := FastFaultOutput);

//Fault if the position is outside of the permitted range
ffActuatorBoundsOK(i_xOK := (lrPosition &lt;= lrMPSUpperLimit AND lrPosition &gt;= lrMPSLowerLimit),
                    i_xReset:=i_xResetMPSFault,
                io_fbFFHWO := FastFaultOutput);



//Collect all other faults
q_xFault := NOT ffBeamParamsOK.o_xFFLine OR
    NOT ffActuatorBoundsOK.o_xFFLine OR
    mcPower.Error    OR
    i_xMPSOverride    OR
    xInitFault;

//Any faults trip the fast fault line for this FB
//FastFaultOutput.CheckIn(NOT q_xFault);

END_FUNCTION_BLOCK
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-arbiter">FB_Arbiter</a></p></li>
<li><p><a class="reference internal" href="#fb-fastfault">FB_FastFault</a></p></li>
<li><p><a class="reference internal" href="#fb-hardwareffoutput">FB_HardwareFFOutput</a></p></li>
<li><p><a class="reference internal" href="#f-devicestate-to-devicestateext">F_DeviceState_To_DeviceStateExt</a></p></li>
<li><p><a class="reference internal" href="#f-safebpcompare">F_SafeBPCompare</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
<li><p><a class="reference internal" href="#st-device">ST_Device</a></p></li>
<li><p><a class="reference internal" href="#st-devicestateext">ST_DeviceStateExt</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-lphotonenergy">
<h2>FB_LPhotonEnergy<a class="headerlink" href="#fb-lphotonenergy" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_LPhotonEnergy</span> <span class="n">EXTENDS</span> <span class="n">FB_PhotonEnergy</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">eEnrg</span>
        <span class="n">link</span><span class="p">:</span> <span class="n">BEND</span><span class="p">:</span><span class="n">DMPH</span><span class="p">:</span><span class="mi">400</span><span class="p">:</span><span class="n">BACT</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">GeV</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbHgvpuElectronEnergy</span> <span class="p">:</span> <span class="n">FB_LREALFromEPICS</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">EEnergy</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Electron</span> <span class="n">Energy</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">GeV</span>
    <span class="s1">&#39;}</span>
    <span class="n">fElectronEnergyVal</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">EEnergyValid</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Electron</span> <span class="n">Energy</span> <span class="n">Valid</span>
    <span class="s1">&#39;}</span>
    <span class="n">bElectronEnergyValid</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">UND</span>
        <span class="n">link</span><span class="p">:</span> <span class="n">USEG</span><span class="p">:</span><span class="n">UNDH</span><span class="p">:</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbHgvpu</span> <span class="p">:</span> <span class="n">FB_Hgvpu</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Update</span> <span class="n">PVs</span>
<span class="n">fbHgvpuElectronEnergy</span><span class="p">();</span>

<span class="n">fElectronEnergyVal</span> <span class="o">:=</span> <span class="n">fbHgvpuElectronEnergy</span><span class="o">.</span><span class="n">fValue</span><span class="p">;</span>
<span class="n">bElectronEnergyValid</span> <span class="o">:=</span> <span class="n">fbHgvpuElectronEnergy</span><span class="o">.</span><span class="n">bValid</span><span class="p">;</span>

<span class="n">fbHgvpu</span><span class="p">(</span><span class="n">fbElectronEnergy</span><span class="o">:=</span><span class="n">fbHgvpuElectronEnergy</span><span class="p">);</span>

<span class="n">SUPER</span><span class="o">^</span><span class="p">(</span><span class="n">BP</span><span class="o">:=</span><span class="n">SUPER</span><span class="o">^.</span><span class="n">BP</span><span class="p">,</span> <span class="n">Undulator</span><span class="o">:=</span><span class="n">fbHgvpu</span> <span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-hgvpu">FB_Hgvpu</a></p></li>
<li><p><a class="reference internal" href="#fb-photonenergy">FB_PhotonEnergy</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-lstopper">
<h2>FB_LStopper<a class="headerlink" href="#fb-lstopper" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_LStopper</span> <span class="n">EXTENDS</span> <span class="n">FB_StopperWatcher</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">SUPER</span><span class="o">^</span><span class="p">(</span><span class="n">stCurrentBP</span><span class="o">:=</span><span class="n">SUPER</span><span class="o">^.</span><span class="n">stCurrentBP</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">FB_init</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bInitRetains</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="k">if</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">the</span> <span class="n">retain</span> <span class="n">variables</span> <span class="n">are</span> <span class="n">initialized</span> <span class="p">(</span><span class="n">warm</span> <span class="n">start</span> <span class="o">/</span> <span class="n">cold</span> <span class="n">start</span><span class="p">)</span>
    <span class="n">bInCopyCode</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>  <span class="o">//</span> <span class="k">if</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">the</span> <span class="n">instance</span> <span class="n">afterwards</span> <span class="n">gets</span> <span class="n">moved</span> <span class="n">into</span> <span class="n">the</span> <span class="n">copy</span> <span class="n">code</span> <span class="p">(</span><span class="n">online</span> <span class="n">change</span><span class="p">)</span>
    <span class="n">eStopper</span> <span class="p">:</span> <span class="n">L_Stopper</span><span class="p">;</span>
    <span class="n">sStopperName</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">Stopper</span> <span class="o">:=</span> <span class="n">eStopper</span><span class="p">;</span>
<span class="n">StopperName</span> <span class="o">:=</span> <span class="n">sStopperName</span><span class="p">;</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-stopperwatcher">FB_StopperWatcher</a></p></li>
<li><p><a class="reference internal" href="#l-stopper">L_Stopper</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-lvetodevice">
<h2>FB_LVetoDevice<a class="headerlink" href="#fb-lvetodevice" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_LVetoDevice</span> <span class="n">EXTENDS</span> <span class="n">FB_VetoDevice</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">SUPER</span><span class="o">^</span><span class="p">(</span><span class="n">stCurrentBP</span><span class="o">:=</span><span class="n">SUPER</span><span class="o">^.</span><span class="n">stCurrentBP</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">FB_init</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bInitRetains</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="k">if</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">the</span> <span class="n">retain</span> <span class="n">variables</span> <span class="n">are</span> <span class="n">initialized</span> <span class="p">(</span><span class="n">warm</span> <span class="n">start</span> <span class="o">/</span> <span class="n">cold</span> <span class="n">start</span><span class="p">)</span>
    <span class="n">bInCopyCode</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>  <span class="o">//</span> <span class="k">if</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">the</span> <span class="n">instance</span> <span class="n">afterwards</span> <span class="n">gets</span> <span class="n">moved</span> <span class="n">into</span> <span class="n">the</span> <span class="n">copy</span> <span class="n">code</span> <span class="p">(</span><span class="n">online</span> <span class="n">change</span><span class="p">)</span>
    <span class="n">eVetoDeviceIN</span> <span class="p">:</span> <span class="n">L_Stopper</span> <span class="o">:=</span> <span class="n">L_Stopper</span><span class="o">.</span><span class="n">DEFAULT</span><span class="p">;</span>
    <span class="n">eVetoDeviceOUT</span> <span class="p">:</span> <span class="n">L_Stopper</span> <span class="o">:=</span> <span class="n">L_Stopper</span><span class="o">.</span><span class="n">DEFAULT</span><span class="p">;</span>
    <span class="n">sVetoDeviceName</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VetoDevice_IN</span> <span class="o">:=</span> <span class="n">eVetoDeviceIN</span><span class="p">;</span>
<span class="n">VetoDevice_OUT</span> <span class="o">:=</span> <span class="n">eVetoDeviceOUT</span><span class="p">;</span>
<span class="n">VetoDeviceName</span> <span class="o">:=</span> <span class="n">sVetoDeviceName</span><span class="p">;</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-vetodevice">FB_VetoDevice</a></p></li>
<li><p><a class="reference internal" href="#l-stopper">L_Stopper</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-machinemodefromepics">
<h2>FB_MachineModeFromEPICS<a class="headerlink" href="#fb-machinemodefromepics" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_MachineModeFromEPICS
(*
Readback options are:

0 – NC (normal conducting, copper linac)

1 – SC (superconducting linac)

2 – Misconfigured (something in link node not set correctly.

*)
VAR_IN_OUT
    BP : ST_BeamParams;
    fbMPS_MachineMode : FB_LREALFromEPICS;
    FFO : FB_HardwareFFOutput;
END_VAR
VAR_OUTPUT
    xError : BOOL;
END_VAR
VAR

    ffModeReadBack : FB_FastFault := (
        i_DevName := &#39;Arbiter&#39;,
        i_Desc := &#39;Issue with Machine mode readback from Accelerator. Gateway or EPICS connection. Must be fixed.&#39;,
        i_TypeCode := 16#313,
        i_xAutoReset:=True);
END_VAR
VAR CONSTANT
    cFailSafeMM : USINT := 3;
END_VAR
fbMPS_MachineMode();

IF fbMPS_MachineMode.bValid THEN
    BP.nMachineMode := LREAL_TO_USINT(fbMPS_MachineMode.fValue);
ELSE
    BP.nMachineMode := cFailSafeMM;
END_IF

ffModeReadBack(i_xOK:=(fbMPS_MachineMode.bValid) AND fbMPS_MachineMode.fValue &lt;2 , io_fbFFHWO:=FFO);

BP.xValid R= NOT fbMPS_MachineMode.bValid;

END_FUNCTION_BLOCK
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-fastfault">FB_FastFault</a></p></li>
<li><p><a class="reference internal" href="#fb-hardwareffoutput">FB_HardwareFFOutput</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-machinesimulator">
<h2>FB_MachineSimulator<a class="headerlink" href="#fb-machinesimulator" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">Simulates</span> <span class="n">the</span> <span class="n">machine</span> <span class="n">responding</span> <span class="n">to</span> <span class="n">requests</span> <span class="n">by</span> <span class="n">adding</span> <span class="n">a</span> <span class="n">bit</span> <span class="n">of</span> <span class="n">delay</span><span class="o">/</span> <span class="n">ramps</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MachineSimulator</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_stAssertedParams</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span>
    <span class="n">i_xFault</span>    <span class="p">:</span>    <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">xEnableAtt</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">xEnablePE</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">xEnableRate</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">iq_stMachineParams</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nTargetTran</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="n">tonTranTimer</span>    <span class="p">:</span>    <span class="n">TON</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">PT</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#2S</span>
        <span class="p">);</span>
    <span class="n">fTargetPP_mJ</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="n">tonPPETimer</span><span class="p">:</span> <span class="n">TON</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">PT</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#2S</span>
    <span class="p">);</span>
<span class="n">END_VAR</span>
<span class="o">//</span><span class="n">Attenuation</span>
<span class="n">IF</span> <span class="n">xEnableAtt</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">i_stAssertedParams</span><span class="o">.</span><span class="n">nTran</span> <span class="o">&lt;&gt;</span> <span class="n">nTargetTran</span> <span class="n">THEN</span>
        <span class="n">tonTranTimer</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
        <span class="n">nTargetTran</span> <span class="o">:=</span> <span class="n">i_stAssertedParams</span><span class="o">.</span><span class="n">nTran</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">tonTranTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
        <span class="n">tonTranTimer</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>
    <span class="n">ELSE</span>
        <span class="n">iq_stMachineParams</span><span class="o">.</span><span class="n">nTran</span> <span class="o">:=</span> <span class="n">nTargetTran</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="o">//</span><span class="n">Pulse</span> <span class="n">Energy</span>
<span class="p">(</span><span class="o">*</span>
<span class="n">IF</span> <span class="n">xEnablePE</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">i_stAssertedParams</span><span class="o">.</span><span class="n">fPP_mJ</span> <span class="o">&lt;&gt;</span> <span class="n">fTargetPP_mJ</span> <span class="n">THEN</span>
        <span class="n">tonPPETimer</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
        <span class="n">fTargetPP_mJ</span> <span class="o">:=</span> <span class="n">i_stAssertedParams</span><span class="o">.</span><span class="n">fPP_mJ</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">tonTranTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
        <span class="n">tonPPETimer</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>
    <span class="n">ELSE</span>
        <span class="n">iq_stMachineParams</span><span class="o">.</span><span class="n">fPP_mJ</span> <span class="o">:=</span> <span class="n">fTargetPP_mJ</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>
<span class="o">*</span><span class="p">)</span>
<span class="o">//</span><span class="n">Rate</span>
<span class="n">IF</span> <span class="n">xEnableRate</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">i_xFault</span> <span class="n">THEN</span>
        <span class="n">iq_stMachineParams</span><span class="o">.</span><span class="n">nRate</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">iq_stMachineParams</span><span class="o">.</span><span class="n">nRate</span> <span class="o">:=</span> <span class="n">i_stAssertedParams</span><span class="o">.</span><span class="n">nRate</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-photonenergy">
<h2>FB_PhotonEnergy<a class="headerlink" href="#fb-photonenergy" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PhotonEnergy</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Undulator</span> <span class="p">:</span> <span class="n">I_UndulatorComplex</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">BP</span> <span class="p">:</span> <span class="n">ST_BeamParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nCurrentPhotonEnergyBitmask</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">nTargetPhotonEnergyBitmask</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span><span class="n">Update</span> <span class="n">BP</span>
<span class="n">nCurrentPhotonEnergyBitmask</span> <span class="o">:=</span> <span class="n">F_eVRangeCalculator</span><span class="p">(</span><span class="n">Undulator</span><span class="o">.</span><span class="n">rCurrentPhotonEnergy</span><span class="p">,</span> <span class="n">nCurrentPhotonEnergyBitmask</span><span class="p">);</span>
<span class="n">nTargetPhotonEnergyBitmask</span> <span class="o">:=</span> <span class="n">F_eVRangeCalculator</span><span class="p">(</span><span class="n">Undulator</span><span class="o">.</span><span class="n">rTargetPhotonEnergy</span><span class="p">,</span> <span class="n">nTargetPhotonEnergyBitmask</span><span class="p">);</span>

<span class="n">BP</span><span class="o">.</span><span class="n">neVRange</span> <span class="o">:=</span> <span class="n">nCurrentPhotonEnergyBitmask</span> <span class="n">OR</span> <span class="n">nTargetPhotonEnergyBitmask</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#f-evrangecalculator">F_eVRangeCalculator</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-photonenergywatcher">
<h2>FB_PhotonEnergyWatcher<a class="headerlink" href="#fb-photonenergywatcher" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span>
<span class="n">A</span><span class="o">.</span> <span class="n">Wallace</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">4</span><span class="o">-</span><span class="mi">22</span>
<span class="n">The</span> <span class="n">photon</span> <span class="n">energy</span> <span class="n">watcher</span> <span class="n">ensures</span> <span class="n">the</span> <span class="n">current</span> <span class="ow">and</span> <span class="n">target</span> <span class="n">photon</span> <span class="n">energy</span> <span class="ow">is</span> <span class="n">within</span>
<span class="n">the</span> <span class="n">arbirated</span> <span class="n">bounds</span><span class="o">.</span> <span class="n">Target</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">case</span> <span class="n">means</span><span class="p">,</span> <span class="n">the</span> <span class="n">calculated</span> <span class="n">target</span> <span class="n">photon</span> <span class="n">energy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">PVs</span> <span class="n">that</span> <span class="n">control</span> <span class="n">the</span> <span class="n">mechatronics</span> <span class="n">of</span> <span class="n">the</span> <span class="n">undulators</span><span class="o">/</span> <span class="n">the</span> <span class="n">electron</span> <span class="n">energy</span><span class="o">.</span>

<span class="n">If</span> <span class="n">there</span> <span class="n">are</span> <span class="n">control</span> <span class="n">PVs</span> <span class="n">that</span> <span class="n">match</span> <span class="n">the</span> <span class="n">monitor</span> <span class="n">PVs</span><span class="p">,</span> <span class="n">the</span> <span class="n">control</span> <span class="n">PVs</span> <span class="n">are</span> <span class="n">used</span> <span class="n">to</span>
<span class="n">calculate</span> <span class="n">a</span> <span class="s2">&quot;target&quot;</span> <span class="n">photon</span> <span class="n">energy</span><span class="o">.</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">supposed</span> <span class="n">to</span> <span class="n">cover</span> <span class="n">when</span> <span class="n">the</span> <span class="n">undulators</span><span class="o">/</span>
<span class="n">electron</span> <span class="n">energy</span> <span class="ow">is</span> <span class="n">transitioning</span><span class="o">.</span>

<span class="n">The</span> <span class="n">abritrated</span> <span class="n">bounds</span> <span class="n">come</span> <span class="kn">from</span><span class="w"> </span><span class="nn">a</span> <span class="n">simple</span> <span class="n">AND</span> <span class="n">of</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">permitted</span> <span class="n">ranges</span><span class="o">.</span> <span class="n">See</span>
<span class="n">the</span> <span class="n">arbitrate</span> <span class="n">action</span> <span class="n">of</span> <span class="n">the</span> <span class="n">arbiter</span> <span class="n">FB</span><span class="o">.</span>

<span class="n">Note</span><span class="p">,</span> <span class="n">this</span> <span class="n">protection</span> <span class="n">logic</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">account</span> <span class="k">for</span> <span class="n">beam</span><span class="o">-</span><span class="n">off</span> <span class="n">when</span> <span class="n">determining</span> <span class="n">fast</span><span class="o">-</span><span class="n">fault</span>
<span class="n">status</span><span class="o">.</span> <span class="n">If</span> <span class="n">a</span> <span class="n">device</span> <span class="ow">is</span> <span class="n">requesting</span> <span class="n">a</span> <span class="n">limited</span> <span class="nb">range</span> <span class="n">of</span> <span class="n">eV</span><span class="p">,</span> <span class="n">this</span> <span class="n">request</span> <span class="n">must</span> <span class="n">be</span> <span class="n">honored</span><span class="p">,</span>
<span class="n">regardless</span> <span class="n">of</span> <span class="n">current</span> <span class="n">beam</span><span class="o">-</span><span class="n">rate</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;reflection&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PhotonEnergyWatcher</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_stCurrentBeamParams</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span> <span class="o">//</span><span class="n">Link</span> <span class="n">to</span> <span class="k">global</span> <span class="n">beam</span> <span class="n">params</span>
    <span class="n">i_stMachineTargetBeamParams</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span> <span class="o">//</span><span class="n">Link</span> <span class="n">to</span> <span class="k">global</span> <span class="n">machine</span> <span class="n">target</span> <span class="n">beam</span> <span class="n">params</span>
    <span class="n">i_stRequestedBeamParams</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span> <span class="o">//</span><span class="n">Link</span> <span class="n">to</span> <span class="n">arbiter</span> <span class="n">output</span> <span class="ow">or</span> <span class="n">beam</span> <span class="n">param</span><span class="o">.</span> <span class="n">requestor</span>
    <span class="o">//</span> <span class="n">Reset</span> <span class="n">fault</span>
    <span class="n">i_xReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">sName</span> <span class="p">:</span> <span class="n">STRING</span> <span class="o">:=</span> <span class="s1">&#39;PhotonEnergyWatcher&#39;</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">io_fbFFHWO</span>    <span class="p">:</span>    <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">xPhotonEnergyWithinBounds</span>    <span class="p">:</span>    <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fbFF</span>    <span class="p">:</span>    <span class="n">FB_FastFault</span> <span class="o">:=</span><span class="p">(</span>
        <span class="n">i_DevName</span> <span class="o">:=</span> <span class="n">sName</span><span class="p">,</span>
        <span class="n">i_Desc</span> <span class="o">:=</span> <span class="s1">&#39;Fault occurs when the calculated machine photon energy (K value calculated by undulator gap, and electron energy) falls outside the permitted range.&#39;</span><span class="p">,</span>
        <span class="n">i_TypeCode</span> <span class="o">:=</span> <span class="mi">7</span> <span class="p">);</span>

   <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ResidualPhotonEnergies</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">archive</span><span class="p">:</span> <span class="mi">1</span><span class="n">Hz</span> <span class="n">monitor</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Portions</span> <span class="n">of</span> <span class="n">beam</span> <span class="n">eV</span> <span class="ow">not</span> <span class="n">permitted</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">eV</span><span class="o">-</span><span class="n">bitmask</span>
    <span class="s1">&#39;}</span>
    <span class="n">evResidual</span> <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>

    <span class="n">fbLog</span> <span class="p">:</span> <span class="n">FB_LogMessage</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">eSubSystem</span> <span class="o">:=</span> <span class="n">E_Subsystem</span><span class="o">.</span><span class="n">MPS</span><span class="p">,</span>
        <span class="n">eSevr</span> <span class="o">:=</span> <span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span>
        <span class="p">);</span>
    <span class="n">bLogOneShot</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">sDevName</span> <span class="p">:</span> <span class="n">T_MaxString</span> <span class="o">:=</span> <span class="s1">&#39;Photon Energy Watcher&#39;</span><span class="p">;</span>

    <span class="n">fbGetHN</span> <span class="p">:</span> <span class="n">FB_GetHostName</span><span class="p">;</span>
    <span class="n">bInit</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;instance-path&#39;</span><span class="p">}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;noinit&#39;</span><span class="p">}</span>
    <span class="n">sPath</span>    <span class="p">:</span>    <span class="n">T_MaxString</span><span class="p">;</span>

    <span class="n">fbStr</span> <span class="p">:</span> <span class="n">FB_FormatString</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">sOut</span> <span class="o">:=</span> <span class="s1">&#39;Non-zero photon energy residual: %32b; Req: %32b; Act: %32b&#39;</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">fbGetHN</span><span class="p">(</span><span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>
    <span class="n">bInit</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">fbGetHN</span><span class="o">.</span><span class="n">bBusy</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">xPhotonEnergyWithinBounds</span> <span class="o">:=</span> <span class="p">(</span><span class="n">i_stCurrentBeamParams</span><span class="o">.</span><span class="n">neVRange</span> <span class="n">AND</span> <span class="n">i_stRequestedBeamParams</span><span class="o">.</span><span class="n">neVRange</span><span class="p">)</span> <span class="o">=</span> <span class="n">i_stCurrentBeamParams</span><span class="o">.</span><span class="n">neVRange</span><span class="p">;</span>

<span class="n">evResidual</span> <span class="o">:=</span> <span class="p">(</span><span class="n">i_stCurrentBeamParams</span><span class="o">.</span><span class="n">neVRange</span> <span class="n">XOR</span> <span class="n">i_stRequestedBeamParams</span><span class="o">.</span><span class="n">neVRange</span><span class="p">)</span> <span class="n">AND</span> <span class="n">i_stCurrentBeamParams</span><span class="o">.</span><span class="n">neVRange</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">evResidual</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">AND</span> <span class="n">bLogOneShot</span> <span class="n">THEN</span>
    <span class="n">fbLog</span><span class="o">.</span><span class="n">sJson</span> <span class="o">:=</span> <span class="n">F_PMPS_JSON</span><span class="p">(</span>
        <span class="n">CONCAT</span><span class="p">(</span><span class="n">fbGetHN</span><span class="o">.</span><span class="n">sHostName</span><span class="p">,</span> <span class="n">sDevName</span><span class="p">),</span>
        <span class="n">sPath</span><span class="p">,</span>
        <span class="n">PMPS_CODES</span><span class="o">.</span><span class="n">PEW_FAULT</span><span class="p">);</span>

    <span class="n">fbStr</span><span class="o">.</span><span class="n">arg1</span> <span class="o">:=</span> <span class="n">F_DWORD</span><span class="p">(</span><span class="n">evResidual</span><span class="p">);</span>
    <span class="n">fbStr</span><span class="o">.</span><span class="n">arg2</span> <span class="o">:=</span> <span class="n">F_DWORD</span><span class="p">(</span><span class="n">i_stCurrentBeamParams</span><span class="o">.</span><span class="n">neVRange</span><span class="p">);</span>
    <span class="n">fbStr</span><span class="o">.</span><span class="n">arg3</span> <span class="o">:=</span> <span class="n">F_DWORD</span><span class="p">(</span><span class="n">i_stRequestedBeamParams</span><span class="o">.</span><span class="n">neVRange</span><span class="p">);</span>

    <span class="n">fbStr</span><span class="p">();</span>

    <span class="n">fbLog</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="n">fbStr</span><span class="o">.</span><span class="n">sOut</span><span class="p">);</span>
    <span class="n">bLogOneShot</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">evResidual</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">bLogOneShot</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbFF</span><span class="p">(</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">xPhotonEnergyWithinBounds</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span> <span class="o">:=</span> <span class="n">io_fbFFHWO</span><span class="p">,);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-fastfault">FB_FastFault</a></p></li>
<li><p><a class="reference internal" href="#fb-hardwareffoutput">FB_HardwareFFOutput</a></p></li>
<li><p><a class="reference internal" href="#f-pmps-json">F_PMPS_JSON</a></p></li>
<li><p><a class="reference internal" href="#pmps-codes">PMPS_CODES</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-photonenergywatcher-test">
<h2>FB_PhotonEnergyWatcher_Test<a class="headerlink" href="#fb-photonenergywatcher-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;call_after_init&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PhotonEnergyWatcher_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>

<span class="n">END_VAR</span>
<span class="n">PEWatcherBasicFunction</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">PEWatcherBasicFunction</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbPEW</span>    <span class="p">:</span>    <span class="n">FB_PhotonEnergyWatcher</span><span class="p">;</span>
    <span class="n">fbFFO</span>    <span class="p">:</span>    <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="n">q_Output</span>    <span class="p">:</span>    <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">stCurBeamParams</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span>
    <span class="n">stMachineTargetBeamParams</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span>
    <span class="n">stReqBeamParams</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;PEWatcherBasicFunction&#39;</span><span class="p">);</span>

<span class="o">//</span><span class="n">Clear</span> <span class="n">FFO</span> <span class="n">fault</span> <span class="n">to</span> <span class="n">start</span>
<span class="n">fbFFO</span><span class="p">(</span><span class="n">i_xReset</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>

<span class="o">//</span><span class="n">All</span> <span class="n">eV</span> <span class="n">OK</span>
<span class="n">stCurBeamParams</span><span class="o">.</span><span class="n">neVRange</span> <span class="o">:=</span> <span class="n">F_eVRangeCalculator</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="n">stMachineTargetBeamParams</span><span class="o">.</span><span class="n">neVRange</span> <span class="o">:=</span> <span class="mi">2</span><span class="c1">#0000_0000_1000_0000;</span>

<span class="n">stReqBeamParams</span><span class="o">.</span><span class="n">neVRange</span> <span class="o">:=</span> <span class="mi">2</span><span class="c1">#1111_1111_1111_1111;</span>

<span class="n">fbFFO</span><span class="p">(</span><span class="n">i_xReset</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span> <span class="o">//</span><span class="n">Reset</span> <span class="n">request</span> <span class="n">released</span>

<span class="n">fbPEW</span><span class="p">(</span><span class="n">i_stCurrentBeamParams</span> <span class="o">:=</span> <span class="n">stCurBeamParams</span><span class="p">,</span>
    <span class="n">i_stMachineTargetBeamParams</span> <span class="o">:=</span> <span class="n">stMachineTargetBeamParams</span><span class="p">,</span>
    <span class="n">i_stRequestedBeamParams</span> <span class="o">:=</span> <span class="n">stReqBeamParams</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span> <span class="o">:=</span> <span class="n">fbFFO</span><span class="p">,</span>
    <span class="n">i_xReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span> <span class="o">//</span><span class="n">Clear</span> <span class="n">local</span> <span class="n">FF</span> <span class="n">within</span> <span class="n">PEW</span>

<span class="n">fbFFO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">(</span><span class="n">q_xFastFaultOut</span><span class="o">=&gt;</span><span class="n">q_Output</span><span class="p">);</span> <span class="o">//</span><span class="n">This</span> <span class="n">simulates</span> <span class="n">a</span> <span class="n">completed</span> <span class="n">PLC</span> <span class="n">cycle</span>
<span class="o">//</span><span class="n">Evaluate</span> <span class="n">output</span> <span class="n">should</span> <span class="n">be</span> <span class="n">called</span> <span class="n">once</span> <span class="n">at</span> <span class="n">the</span> <span class="n">end</span> <span class="n">of</span> <span class="n">a</span> <span class="n">PLC</span> <span class="n">cycle</span><span class="o">.</span>

<span class="n">AssertTrue</span><span class="p">(</span><span class="n">q_Output</span><span class="p">,</span>
    <span class="s1">&#39;Beam within limits, FFO should be true&#39;</span><span class="p">);</span>


<span class="o">//</span><span class="n">Req</span> <span class="n">eV</span> <span class="n">moved</span> <span class="n">out</span> <span class="n">of</span> <span class="nb">range</span>
<span class="n">stCurBeamParams</span><span class="o">.</span><span class="n">neVRange</span> <span class="o">:=</span> <span class="n">F_eVRangeCalculator</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="n">stMachineTargetBeamParams</span><span class="o">.</span><span class="n">neVRange</span> <span class="o">:=</span> <span class="n">F_eVRangeCalculator</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="n">stReqBeamParams</span><span class="o">.</span><span class="n">neVRange</span> <span class="o">:=</span> <span class="mi">2</span><span class="c1">#0000_1111_0011_1111;</span>

<span class="n">fbPEW</span><span class="o">.</span><span class="n">i_xReset</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span> <span class="o">//</span><span class="n">release</span> <span class="n">local</span> <span class="n">FF</span> <span class="n">reset</span> <span class="n">req</span>
<span class="n">fbPEW</span><span class="p">(</span><span class="n">i_stCurrentBeamParams</span> <span class="o">:=</span> <span class="n">stCurBeamParams</span><span class="p">,</span>
    <span class="n">i_stMachineTargetBeamParams</span> <span class="o">:=</span> <span class="n">stMachineTargetBeamParams</span><span class="p">,</span>
    <span class="n">i_stRequestedBeamParams</span> <span class="o">:=</span> <span class="n">stReqBeamParams</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span> <span class="o">:=</span> <span class="n">fbFFO</span><span class="p">);</span>

<span class="n">fbFFO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">(</span><span class="n">q_xFastFaultOut</span><span class="o">=&gt;</span><span class="n">q_Output</span><span class="p">);</span>

<span class="n">AssertFalse</span><span class="p">(</span><span class="n">q_Output</span><span class="p">,</span>
    <span class="s1">&#39;Limits moved beyond current and target beam, should produce a fault.&#39;</span><span class="p">);</span>

<span class="o">//</span><span class="n">Beam</span> <span class="ow">and</span> <span class="n">target</span> <span class="n">eV</span> <span class="n">moved</span> <span class="n">back</span> <span class="n">within</span> <span class="n">permitted</span> <span class="n">ranges</span><span class="p">,</span> <span class="n">reset</span> <span class="n">clears</span> <span class="n">fault</span>
<span class="n">stCurBeamParams</span><span class="o">.</span><span class="n">neVRange</span> <span class="o">:=</span> <span class="n">F_eVRangeCalculator</span><span class="p">(</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="n">stMachineTargetBeamParams</span><span class="o">.</span><span class="n">neVRange</span> <span class="o">:=</span> <span class="n">F_eVRangeCalculator</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="n">stReqBeamParams</span><span class="o">.</span><span class="n">neVRange</span> <span class="o">:=</span> <span class="mi">2</span><span class="c1">#0000_1111_0011_1111;</span>

<span class="n">fbFFO</span><span class="p">(</span><span class="n">i_xReset</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span> <span class="o">//</span><span class="n">New</span> <span class="n">reset</span> <span class="n">request</span>

<span class="n">fbPEW</span><span class="o">.</span><span class="n">i_xReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span> <span class="o">//</span><span class="n">New</span> <span class="n">reset</span> <span class="n">request</span>

<span class="n">fbPEW</span><span class="p">(</span><span class="n">i_stCurrentBeamParams</span> <span class="o">:=</span> <span class="n">stCurBeamParams</span><span class="p">,</span> <span class="o">//</span><span class="n">Beam</span> <span class="n">params</span> <span class="n">are</span> <span class="n">now</span> <span class="n">within</span> <span class="n">spec</span>
    <span class="n">i_stMachineTargetBeamParams</span> <span class="o">:=</span> <span class="n">stMachineTargetBeamParams</span><span class="p">,</span>
    <span class="n">i_stRequestedBeamParams</span> <span class="o">:=</span> <span class="n">stReqBeamParams</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span> <span class="o">:=</span> <span class="n">fbFFO</span><span class="p">);</span>

<span class="n">fbFFO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">(</span><span class="n">q_xFastFaultOut</span><span class="o">=&gt;</span><span class="n">q_Output</span><span class="p">);</span>

<span class="n">AssertTrue</span><span class="p">(</span><span class="n">q_Output</span><span class="p">,</span>
    <span class="s1">&#39;Beam within limits after reset, FFO should be true&#39;</span><span class="p">);</span>

<span class="o">//</span><span class="n">At</span> <span class="n">this</span> <span class="n">point</span><span class="p">,</span> <span class="n">the</span> <span class="n">fast</span> <span class="n">fault</span> <span class="n">would</span> <span class="n">be</span> <span class="n">cleared</span>

<span class="o">//</span><span class="n">Current</span> <span class="n">beam</span> <span class="n">eV</span> <span class="n">moved</span> <span class="n">out</span> <span class="n">of</span> <span class="nb">range</span>
<span class="n">stCurBeamParams</span><span class="o">.</span><span class="n">neVRange</span> <span class="o">:=</span> <span class="n">F_eVRangeCalculator</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="o">//</span><span class="n">Moved</span> <span class="n">out</span> <span class="n">of</span> <span class="nb">range</span>

<span class="n">stMachineTargetBeamParams</span><span class="o">.</span><span class="n">neVRange</span> <span class="o">:=</span> <span class="n">F_eVRangeCalculator</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="o">//</span><span class="n">Still</span> <span class="n">within</span> <span class="nb">range</span>

<span class="n">stReqBeamParams</span><span class="o">.</span><span class="n">neVRange</span> <span class="o">:=</span> <span class="mi">2</span><span class="c1">#0000_1111_0011_1111;</span>

<span class="n">fbPEW</span><span class="p">(</span><span class="n">i_stCurrentBeamParams</span> <span class="o">:=</span> <span class="n">stCurBeamParams</span><span class="p">,</span>
    <span class="n">i_stMachineTargetBeamParams</span> <span class="o">:=</span> <span class="n">stMachineTargetBeamParams</span><span class="p">,</span>
    <span class="n">i_stRequestedBeamParams</span> <span class="o">:=</span> <span class="n">stReqBeamParams</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span> <span class="o">:=</span> <span class="n">fbFFO</span><span class="p">);</span>

<span class="n">fbFFO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">(</span><span class="n">q_xFastFaultOut</span><span class="o">=&gt;</span><span class="n">q_Output</span><span class="p">);</span>

<span class="n">AssertFalse</span><span class="p">(</span><span class="n">q_Output</span><span class="p">,</span>
    <span class="s1">&#39;Current beam moved beyond set limits, should produce a fault&#39;</span><span class="p">);</span>

<span class="o">//</span><span class="n">Target</span> <span class="n">beam</span> <span class="n">eV</span> <span class="n">moved</span> <span class="n">out</span> <span class="n">of</span> <span class="nb">range</span>
<span class="n">fbFFO</span><span class="p">(</span><span class="n">i_xReset</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span> <span class="o">//</span><span class="n">Reset</span> <span class="n">released</span>
<span class="n">fbFFO</span><span class="p">(</span><span class="n">i_xReset</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span> <span class="o">//</span><span class="n">New</span> <span class="n">reset</span> <span class="n">request</span> <span class="n">comes</span> <span class="ow">in</span> <span class="n">at</span> <span class="n">the</span> <span class="n">top</span> <span class="n">of</span> <span class="n">a</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">but</span> <span class="n">will</span> <span class="n">be</span> <span class="n">overridden</span>

<span class="n">stCurBeamParams</span><span class="o">.</span><span class="n">neVRange</span> <span class="o">:=</span> <span class="n">F_eVRangeCalculator</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="o">//</span><span class="n">Now</span> <span class="n">within</span> <span class="nb">range</span>

<span class="n">stMachineTargetBeamParams</span><span class="o">.</span><span class="n">neVRange</span> <span class="o">:=</span> <span class="n">F_eVRangeCalculator</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="o">//</span><span class="n">Moved</span> <span class="n">out</span> <span class="n">of</span> <span class="nb">range</span>

<span class="n">stReqBeamParams</span><span class="o">.</span><span class="n">neVRange</span> <span class="o">:=</span> <span class="mi">2</span><span class="c1">#0000_1111_0011_1111;</span>

<span class="n">fbPEW</span><span class="o">.</span><span class="n">i_xReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span> <span class="o">//</span><span class="n">Attempt</span> <span class="n">to</span> <span class="n">reset</span> <span class="n">local</span> <span class="n">FF</span> <span class="n">will</span> <span class="n">fail</span>
<span class="n">fbPEW</span><span class="p">(</span><span class="n">i_stCurrentBeamParams</span> <span class="o">:=</span> <span class="n">stCurBeamParams</span><span class="p">,</span>
    <span class="n">i_stMachineTargetBeamParams</span> <span class="o">:=</span> <span class="n">stMachineTargetBeamParams</span><span class="p">,</span>
    <span class="n">i_stRequestedBeamParams</span> <span class="o">:=</span> <span class="n">stReqBeamParams</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span> <span class="o">:=</span> <span class="n">fbFFO</span><span class="p">);</span>

<span class="n">fbFFO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">(</span><span class="n">q_xFastFaultOut</span><span class="o">=&gt;</span><span class="n">q_Output</span><span class="p">);</span>

<span class="n">AssertFalse</span><span class="p">(</span><span class="n">q_Output</span><span class="p">,</span>
    <span class="s1">&#39;Target beam moved beyond set limits, should produce a fault&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-hardwareffoutput">FB_HardwareFFOutput</a></p></li>
<li><p><a class="reference internal" href="#fb-photonenergywatcher">FB_PhotonEnergyWatcher</a></p></li>
<li><p><a class="reference internal" href="#f-evrangecalculator">F_eVRangeCalculator</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-presssensor-ffo">
<h2>FB_PressSensor_FFO<a class="headerlink" href="#fb-presssensor-ffo" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PressSensor_FFO</span>
<span class="n">VAR_INPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Press</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">Torr</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">PREC</span> <span class="mi">2</span>
    <span class="s1">&#39;}</span>
    <span class="n">rPress</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">FAULT_SP</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">Torr</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">PREC</span> <span class="mi">2</span>
    <span class="s1">&#39;}</span>
    <span class="n">fFaultThreshold</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span><span class="n">Faults</span> <span class="n">when</span> <span class="n">the</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="n">reached</span><span class="o">.</span> <span class="n">Trigger</span> <span class="n">value</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">FAULT_SP_HYS</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="o">%</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">PREC</span> <span class="mi">2</span>
    <span class="s1">&#39;}</span>
    <span class="n">fHysteresis</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span><span class="mi">1</span><span class="p">;</span> <span class="o">//</span> <span class="n">percentage</span> <span class="n">determining</span> <span class="n">how</span> <span class="n">far</span> <span class="n">below</span> <span class="n">the</span> <span class="n">trigger</span> <span class="n">value</span> <span class="n">the</span> <span class="n">fault</span> <span class="n">should</span> <span class="n">be</span> <span class="n">released</span>
    <span class="n">sDevName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">bVeto</span> <span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span> <span class="o">//</span> <span class="n">This</span> <span class="n">Fault</span> <span class="n">will</span> <span class="n">be</span> <span class="n">will</span> <span class="ow">not</span> <span class="n">trip</span> <span class="n">the</span> <span class="n">beam</span> <span class="k">if</span> <span class="n">the</span> <span class="n">bVeto</span> <span class="ow">is</span> <span class="n">TRUE</span>
    <span class="n">bAutoReset</span> <span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">io_fbFFHWO</span>    <span class="p">:</span>    <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;instance-path&#39;</span><span class="p">}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;noinit&#39;</span><span class="p">}</span>
    <span class="n">sPath</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">bFAULT_OK</span><span class="p">:</span><span class="n">BOOL</span> <span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">FFO</span>    <span class="p">:</span>    <span class="n">FB_FastFault</span> <span class="o">:=</span><span class="p">(</span>
        <span class="n">i_Desc</span> <span class="o">:=</span> <span class="s1">&#39;Fault occurs when the temprature trip point is reached&#39;</span><span class="p">,</span>
        <span class="n">i_TypeCode</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#f700);</span>
    <span class="n">rtRESET</span> <span class="p">:</span>       <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">ftFAULT</span> <span class="p">:</span>       <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">fbLogger</span> <span class="p">:</span> <span class="n">FB_LogMessage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">eSubsystem</span><span class="o">:=</span><span class="n">E_SubSystem</span><span class="o">.</span><span class="n">MPS</span><span class="p">,</span> <span class="n">nMinTimeViolationAcceptable</span><span class="o">:=</span><span class="mi">10</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="o">//</span><span class="n">Verify</span> <span class="n">Hysteresis</span> <span class="ow">is</span> <span class="n">between</span> <span class="mi">1</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="n">Shouldn</span><span class="s1">&#39;t be 0. shouldn&#39;</span><span class="n">t</span> <span class="n">be</span> <span class="n">a</span> <span class="mi">100</span> <span class="n">either</span><span class="o">.</span>
<span class="n">fHysteresis</span><span class="o">:=</span>  <span class="n">LIMIT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">fHysteresis</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Evaluate</span> <span class="n">the</span> <span class="n">threshold</span> <span class="n">trip</span> <span class="n">point</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">rPress</span> <span class="o">&gt;=</span> <span class="n">fFaultThreshold</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">bFAULT_OK</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="p">(</span><span class="n">rPress</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">fFaultThreshold</span> <span class="o">-</span> <span class="n">fFaultThreshold</span><span class="o">*</span><span class="n">fHysteresis</span><span class="o">/</span><span class="mi">100</span><span class="p">))</span> <span class="n">THEN</span>
    <span class="n">bFAULT_OK</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>



<span class="n">ACT_Logger</span><span class="p">();</span>

<span class="p">(</span><span class="o">*</span><span class="n">FAST</span> <span class="n">FAULT</span><span class="o">*</span><span class="p">)</span>
<span class="n">FFO</span><span class="p">(</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">bFAULT_OK</span> <span class="n">OR</span> <span class="n">bVeto</span><span class="p">,</span>
    <span class="n">i_xReset</span> <span class="o">:=</span><span class="p">,</span>
    <span class="n">i_xAutoReset</span> <span class="o">:=</span> <span class="n">bAutoReset</span><span class="p">,</span>
    <span class="n">i_DevName</span> <span class="o">:=</span> <span class="n">sDevName</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span> <span class="o">:=</span> <span class="n">io_fbFFHWO</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">ACT_Logger</span><span class="p">:</span>
<span class="n">ftFAULT</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="n">FFO</span><span class="o">.</span><span class="n">i_xOK</span><span class="p">);</span>
<span class="n">rtRESET</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">FFO</span><span class="o">.</span><span class="n">i_xOK</span><span class="p">);</span>

<span class="n">IF</span><span class="p">(</span><span class="n">ftFAULT</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span> <span class="o">:=</span> <span class="s1">&#39;Temp Threshold Fault, beam off&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="n">IF</span><span class="p">(</span><span class="n">rtRESET</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span> <span class="o">:=</span> <span class="s1">&#39;Temp Threshold Fault condition clear&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-fastfault">FB_FastFault</a></p></li>
<li><p><a class="reference internal" href="#fb-hardwareffoutput">FB_HardwareFFOutput</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-ratefromepics">
<h2>FB_RateFromEPICS<a class="headerlink" href="#fb-ratefromepics" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_RateFromEPICS</span>

<span class="p">(</span><span class="o">*</span>
<span class="n">enum</span> <span class="n">MPSBeamRates</span> <span class="p">{</span>
    <span class="n">MPSRateInvalid</span>            <span class="o">=</span>  <span class="mi">0</span><span class="p">,</span>
    <span class="n">MPSRate0Hz</span>                <span class="o">=</span>  <span class="mi">1</span><span class="p">,</span>
    <span class="o">/*</span> <span class="n">Previously</span> <span class="n">used</span> <span class="mi">2</span> <span class="ow">and</span> <span class="mi">3</span> <span class="k">for</span> <span class="n">single</span> <span class="n">shot</span> <span class="ow">and</span> <span class="n">burst</span> <span class="o">*/</span>
    <span class="n">MPSRate1Hz</span>                <span class="o">=</span>  <span class="mi">4</span><span class="p">,</span>
    <span class="n">MPSRate10Hz</span>               <span class="o">=</span>  <span class="mi">5</span><span class="p">,</span>
    <span class="n">MPSRate30Hz</span>               <span class="o">=</span>  <span class="mi">6</span><span class="p">,</span>
    <span class="n">MPSRate60Hz</span>               <span class="o">=</span>  <span class="mi">7</span><span class="p">,</span>
    <span class="n">MPSRate120Hz</span>              <span class="o">=</span>  <span class="mi">8</span><span class="p">,</span>
    <span class="n">MPSRateUnknown</span>            <span class="o">=</span>  <span class="mi">9</span><span class="p">,</span>
    <span class="n">MPSRateSingleShot</span>         <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">MPSRateBurstMode</span>          <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
    <span class="n">MPSRateBurstModeNotActive</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
    <span class="n">MPSNumberOfBeamRates</span>      <span class="o">=</span> <span class="mi">13</span><span class="p">,</span>
    <span class="n">MPSRateBurstInvalid</span>       <span class="o">=</span> <span class="mi">14</span>
<span class="p">}</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">VAR_IN_OUT</span>
    <span class="n">BP</span> <span class="p">:</span> <span class="n">ST_BeamParams</span><span class="p">;</span>
    <span class="n">fbBYKIK_Rate</span> <span class="p">:</span> <span class="n">FB_LREALFromEPICS</span><span class="p">;</span>
    <span class="n">FFO</span> <span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">xError</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>


    <span class="n">eMPSRate</span> <span class="p">:</span> <span class="n">E_MPSBeamRates</span><span class="p">;</span>

    <span class="n">ffRateReadBack</span> <span class="p">:</span> <span class="n">FB_FastFault</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">i_DevName</span> <span class="o">:=</span> <span class="s1">&#39;Arbiter&#39;</span><span class="p">,</span>
        <span class="n">i_Desc</span> <span class="o">:=</span> <span class="s1">&#39;Issue with rate readback from Accelerator. Gateway or EPICS connection. Must be fixed.&#39;</span><span class="p">,</span>
        <span class="n">i_TypeCode</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#203,</span>
        <span class="n">i_xAutoReset</span><span class="o">:=</span><span class="kc">True</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">cFailSafeRate</span> <span class="p">:</span> <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">1000001</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">fbBYKIK_Rate</span><span class="p">();</span>

<span class="n">IF</span> <span class="n">fbBYKIK_Rate</span><span class="o">.</span><span class="n">bValid</span> <span class="n">THEN</span>
    <span class="n">eMPSRate</span> <span class="o">:=</span> <span class="n">LREAL_TO_UINT</span><span class="p">(</span><span class="n">fbBYKIK_Rate</span><span class="o">.</span><span class="n">fValue</span><span class="p">);</span>
<span class="n">ELSE</span>
    <span class="n">eMPSRate</span> <span class="o">:=</span> <span class="n">E_MPSBeamRates</span><span class="o">.</span><span class="n">MPSRateInvalid</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">CASE</span> <span class="n">eMPSRate</span> <span class="n">OF</span>
    <span class="n">MPSRateInvalid</span><span class="p">:</span>
        <span class="n">BP</span><span class="o">.</span><span class="n">nRate</span> <span class="o">:=</span> <span class="n">cFailSafeRate</span><span class="p">;</span>
    <span class="n">MPSRate0Hz</span><span class="p">:</span>
        <span class="n">BP</span><span class="o">.</span><span class="n">nRate</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">MPSRate1Hz</span><span class="p">:</span>
        <span class="n">BP</span><span class="o">.</span><span class="n">nRate</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">MPSRate10Hz</span><span class="p">:</span>
        <span class="n">BP</span><span class="o">.</span><span class="n">nRate</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">MPSRate30Hz</span><span class="p">:</span>
        <span class="n">BP</span><span class="o">.</span><span class="n">nRate</span> <span class="o">:=</span> <span class="mi">30</span><span class="p">;</span>
    <span class="n">MPSRate60Hz</span><span class="p">:</span>
        <span class="n">BP</span><span class="o">.</span><span class="n">nRate</span> <span class="o">:=</span> <span class="mi">60</span><span class="p">;</span>
    <span class="n">MPSRate120Hz</span><span class="p">:</span>
        <span class="n">BP</span><span class="o">.</span><span class="n">nRate</span> <span class="o">:=</span> <span class="mi">120</span><span class="p">;</span>
    <span class="n">MPSRateUnknown</span><span class="p">:</span>
        <span class="n">BP</span><span class="o">.</span><span class="n">nRate</span> <span class="o">:=</span> <span class="n">cFailSafeRate</span><span class="p">;</span>

<span class="n">ELSE</span>
    <span class="n">BP</span><span class="o">.</span><span class="n">nRate</span> <span class="o">:=</span> <span class="n">cFailSafeRate</span><span class="p">;</span>
<span class="n">END_CASE</span>

<span class="n">ffRateReadback</span><span class="p">(</span><span class="n">i_xOK</span><span class="o">:=</span><span class="n">fbBYKIK_Rate</span><span class="o">.</span><span class="n">bValid</span><span class="p">,</span> <span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">FFO</span><span class="p">);</span>

<span class="n">BP</span><span class="o">.</span><span class="n">xValid</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">fbBYKIK_Rate</span><span class="o">.</span><span class="n">bValid</span> <span class="n">OR</span>
            <span class="n">eMPSRate</span> <span class="o">=</span> <span class="n">MPSRateUnknown</span> <span class="n">OR</span>
            <span class="n">eMPSRate</span> <span class="o">=</span> <span class="n">MPSRateInvalid</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-mpsbeamrates">E_MPSBeamRates</a></p></li>
<li><p><a class="reference internal" href="#fb-fastfault">FB_FastFault</a></p></li>
<li><p><a class="reference internal" href="#fb-hardwareffoutput">FB_HardwareFFOutput</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-safebpcompare-test">
<h2>FB_SafeBPCompare_Test<a class="headerlink" href="#fb-safebpcompare-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;call_after_init&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_SafeBPCompare_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>

<span class="n">END_VAR</span>
<span class="n">BeamOffIsSafe</span><span class="p">();</span>
<span class="n">BPComparisonCheck</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="o">//</span><span class="n">Verify</span> <span class="n">beam</span> <span class="n">off</span> <span class="ow">is</span> <span class="n">considered</span> <span class="n">safe</span><span class="o">.</span>
<span class="n">METHOD</span> <span class="n">BeamOffIsSafe</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">stBeamOn_MoreConservative</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span>
    <span class="n">stBeamOff_LessConservative</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span>
    <span class="n">stBeam0Rate</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span>
    <span class="n">stBeam0BC</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span>
    <span class="n">fb_BeamClassOutputs_BCD</span><span class="p">:</span><span class="n">FB_BeamClassOutputs_BCD</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">stBeamOn_MoreConservative</span>  <span class="o">:=</span> <span class="n">F_SetBeamParams</span><span class="p">(</span>
    <span class="mi">0</span><span class="p">,</span> <span class="o">//</span><span class="mi">0</span><span class="o">%</span> <span class="n">transmission</span> <span class="ow">is</span> <span class="n">more</span> <span class="n">conservative</span> <span class="n">than</span> <span class="mi">50</span>
    <span class="mi">16</span><span class="c1">#FFFF_FFFF,</span>
    <span class="mi">120</span><span class="p">,</span> <span class="o">//</span><span class="n">rate</span>
    <span class="mi">16</span><span class="c1">#0001,</span>
    <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">DUMMY_AUX_ATT_ARRAY</span><span class="p">);</span>

<span class="n">stBeamOff_LessConservative</span><span class="o">:=</span> <span class="n">F_SetBeamParams</span><span class="p">(</span>
    <span class="mf">0.5</span><span class="p">,</span> <span class="o">//</span><span class="mi">50</span><span class="o">%</span> <span class="n">transmission</span><span class="p">,</span> <span class="n">less</span> <span class="n">conservative</span><span class="p">,</span> <span class="n">without</span> <span class="mi">0</span><span class="o">-</span><span class="n">rate</span> <span class="n">this</span> <span class="n">beam</span> <span class="n">parameter</span> <span class="nb">set</span> <span class="n">would</span> <span class="n">be</span> <span class="n">less</span> <span class="n">safe</span> <span class="n">than</span> <span class="n">above</span>
    <span class="mi">16</span><span class="c1">#FFFF_FFFF,</span>
    <span class="mi">0</span><span class="p">,</span> <span class="o">//</span><span class="n">rate</span><span class="p">,</span> <span class="n">hence</span><span class="p">,</span> <span class="n">more</span> <span class="n">conservative</span>
    <span class="mi">16</span><span class="c1">#000F,</span>
    <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">DUMMY_AUX_ATT_ARRAY</span><span class="p">);</span> <span class="o">//</span><span class="mi">0</span> <span class="n">beam</span> <span class="n">rate</span> <span class="n">means</span> <span class="n">this</span> <span class="n">bps</span> <span class="ow">is</span> <span class="n">actually</span> <span class="n">safer</span> <span class="n">than</span> <span class="n">BeamOn</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">Machine</span> <span class="n">Mode</span> <span class="n">to</span> <span class="n">NC</span>
<span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">stCurrentBeamParameters</span><span class="o">.</span><span class="n">nMachineMode</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;BeamOffIsSafeNC&#39;</span><span class="p">);</span>

<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">F_SafeBPCompare0Rate</span><span class="p">(</span><span class="n">stBeamOff_LessConservative</span><span class="p">,</span> <span class="n">stBeamOn_MoreConservative</span><span class="p">),</span>
    <span class="s1">&#39;SafeBPCompare in NC does not think beam rate = 0 is safer than anything else.&#39;</span><span class="p">);</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>


<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;BeamClass0IsNOTSafeNC&#39;</span><span class="p">);</span>


<span class="n">stBeam0BC</span>  <span class="o">:=</span> <span class="n">F_SetBeamParams</span><span class="p">(</span>
    <span class="mi">1</span><span class="p">,</span> <span class="o">//</span><span class="mi">0</span><span class="o">%</span> <span class="n">transmission</span> <span class="ow">is</span> <span class="n">more</span> <span class="n">conservative</span> <span class="n">than</span> <span class="mi">50</span>
    <span class="mi">16</span><span class="c1">#FFFF_FFFF,</span>
    <span class="mi">1000</span><span class="p">,</span> <span class="o">//</span><span class="n">rate</span>
    <span class="mi">16</span><span class="c1">#0000,</span>
    <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">DUMMY_AUX_ATT_ARRAY</span><span class="p">);</span>


<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">F_SafeBPCompare0Rate</span><span class="p">(</span><span class="n">stBeam0BC</span><span class="p">,</span> <span class="n">stBeamOn_MoreConservative</span><span class="p">),</span>
    <span class="s1">&#39;SafeBPCompare beam class = 0 is NOT safer than anything else in NC mode.&#39;</span><span class="p">);</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>




<span class="o">//</span><span class="n">SC</span> <span class="n">tests</span>
<span class="n">stBeamOn_MoreConservative</span>  <span class="o">:=</span> <span class="n">F_SetBeamParams</span><span class="p">(</span>
    <span class="mi">0</span><span class="p">,</span> <span class="o">//</span><span class="mi">0</span><span class="o">%</span> <span class="n">transmission</span> <span class="ow">is</span> <span class="n">more</span> <span class="n">conservative</span> <span class="n">than</span> <span class="mi">50</span>
    <span class="mi">16</span><span class="c1">#FFFF_FFFF,</span>
    <span class="mi">0</span><span class="p">,</span> <span class="o">//</span><span class="n">rate</span>
    <span class="mi">16</span><span class="c1">#000F,</span>
    <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">DUMMY_AUX_ATT_ARRAY</span><span class="p">);</span>

<span class="n">stBeamOff_LessConservative</span><span class="o">:=</span> <span class="n">F_SetBeamParams</span><span class="p">(</span>
    <span class="mf">0.5</span><span class="p">,</span> <span class="o">//</span><span class="mi">50</span><span class="o">%</span> <span class="n">transmission</span><span class="p">,</span> <span class="n">less</span> <span class="n">conservative</span><span class="p">,</span> <span class="n">without</span> <span class="mi">0</span><span class="o">-</span><span class="n">rate</span> <span class="n">this</span> <span class="n">beam</span> <span class="n">parameter</span> <span class="nb">set</span> <span class="n">would</span> <span class="n">be</span> <span class="n">less</span> <span class="n">safe</span> <span class="n">than</span> <span class="n">above</span>
    <span class="mi">16</span><span class="c1">#FFFF_FFFF,</span>
    <span class="mi">1000</span><span class="p">,</span>
    <span class="mi">16</span><span class="c1">#0000, //zero beam, hence, more conservative</span>
    <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">DUMMY_AUX_ATT_ARRAY</span><span class="p">);</span> <span class="o">//</span><span class="mi">0</span> <span class="n">beam</span> <span class="n">rate</span> <span class="n">means</span> <span class="n">this</span> <span class="n">bps</span> <span class="ow">is</span> <span class="n">actually</span> <span class="n">safer</span> <span class="n">than</span> <span class="n">BeamOn</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">Machine</span> <span class="n">Mode</span> <span class="n">to</span> <span class="n">SC</span>
<span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">stCurrentBeamParameters</span><span class="o">.</span><span class="n">nMachineMode</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;BeamOffIsSafeSC&#39;</span><span class="p">);</span>

<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">F_SafeBPCompare0Rate</span><span class="p">(</span><span class="n">stBeamOff_LessConservative</span><span class="p">,</span> <span class="n">stBeamOn_MoreConservative</span><span class="p">),</span>
    <span class="s1">&#39;SafeBPCompare in SC mode does not think beam class = 0 is safer than anything else.&#39;</span><span class="p">);</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;Beam0RateIsNOTSafeSC&#39;</span><span class="p">);</span>


<span class="n">stBeam0Rate</span>  <span class="o">:=</span> <span class="n">F_SetBeamParams</span><span class="p">(</span>
    <span class="mi">1</span><span class="p">,</span> <span class="o">//</span><span class="mi">0</span><span class="o">%</span> <span class="n">transmission</span> <span class="ow">is</span> <span class="n">more</span> <span class="n">conservative</span> <span class="n">than</span> <span class="mi">50</span>
    <span class="mi">16</span><span class="c1">#FFFF_FFFF,</span>
    <span class="mi">0</span><span class="p">,</span> <span class="o">//</span><span class="n">rate</span>
    <span class="mi">16</span><span class="c1">#00FF,</span>
    <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">DUMMY_AUX_ATT_ARRAY</span><span class="p">);</span>


<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">F_SafeBPCompare0Rate</span><span class="p">(</span><span class="n">stBeam0Rate</span><span class="p">,</span> <span class="n">stBeamOn_MoreConservative</span><span class="p">),</span>
    <span class="s1">&#39;SafeBPCompare beam rate = 0 is NOT safer than anything else in SC mode.&#39;</span><span class="p">);</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>


<span class="o">//</span> <span class="n">Set</span> <span class="n">Machine</span> <span class="n">Mode</span> <span class="n">to</span> <span class="n">Misconfigured</span>
<span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">stCurrentBeamParameters</span><span class="o">.</span><span class="n">nMachineMode</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;WrongMachineMode&#39;</span><span class="p">);</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">F_SafeBPCompare0Rate</span><span class="p">(</span><span class="n">stBeam0Rate</span><span class="p">,</span> <span class="n">stBeam0BC</span><span class="p">),</span>
    <span class="s1">&#39;SafeBPCompare in Misconfigured mode does not think beam rate = 0 is safer than anything else.&#39;</span><span class="p">);</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">F_SafeBPCompare0Rate</span><span class="p">(</span><span class="n">stBeam0BC</span><span class="p">,</span> <span class="n">stBeam0Rate</span><span class="p">),</span>
    <span class="s1">&#39;SafeBPCompare in Misconfiigured mode does not think beam class = 0 is safer than anything else.&#39;</span><span class="p">);</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="o">//</span><span class="n">Verify</span> <span class="n">BP</span> <span class="n">comparison</span> <span class="n">remains</span> <span class="n">logical</span><span class="o">.</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_check&#39;</span><span class="p">}</span>
<span class="n">METHOD</span> <span class="n">BPComparisonCheck</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">stSafer</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span>
    <span class="n">stNotSoSafe</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span><span class="p">;</span>
    <span class="n">idx</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="n">xResult</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">xFailedTest</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">To</span> <span class="n">exit</span> <span class="n">loops</span> <span class="n">early</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Test</span> <span class="ow">in</span> <span class="n">NC</span> <span class="n">mode</span>
<span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">stCurrentBeamParameters</span><span class="o">.</span><span class="n">nMachineMode</span> <span class="o">:=</span><span class="mi">0</span><span class="p">;</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;BPComparisonTran&#39;</span><span class="p">);</span>
<span class="o">//</span><span class="n">Attenuation</span>
<span class="n">stSafer</span> <span class="o">:=</span> <span class="n">F_SetBeamParams</span><span class="p">(</span>
    <span class="mf">0.51</span><span class="p">,</span> <span class="o">//</span>
    <span class="mi">16</span><span class="c1">#FFFFFFFF,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">16</span><span class="c1">#0000,</span>
    <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">DUMMY_AUX_ATT_ARRAY</span><span class="p">);</span>

<span class="n">stNotSoSafe</span> <span class="o">:=</span> <span class="n">F_SetBeamParams</span><span class="p">(</span>
    <span class="mf">0.61</span><span class="p">,</span> <span class="o">//</span>
    <span class="mi">16</span><span class="c1">#FFFFFFFF,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">16</span><span class="c1">#0000,</span>
    <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">DUMMY_AUX_ATT_ARRAY</span><span class="p">);</span>

<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">F_SafeBPCompare</span><span class="p">(</span><span class="n">stSafer</span><span class="p">,</span> <span class="n">stNotSoSafe</span><span class="p">),</span>
    <span class="s1">&#39;Attenuation eval is broken (True)&#39;</span><span class="p">);</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">F_SafeBPCompare</span><span class="p">(</span><span class="n">stNotSoSafe</span><span class="p">,</span> <span class="n">stSafer</span><span class="p">),</span>
    <span class="s1">&#39;Attenuation eval is broken (False)&#39;</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Check</span> <span class="n">at</span> <span class="n">margin</span> <span class="n">threshold</span>
<span class="n">stSafer</span><span class="o">.</span><span class="n">nTran</span> <span class="o">:=</span> <span class="n">stNotSoSafe</span><span class="o">.</span><span class="n">nTran</span><span class="o">*</span><span class="p">(</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">TRANS_SCALING_FACTOR</span> <span class="o">+</span> <span class="n">PMPS_PARAM</span><span class="o">.</span><span class="n">TRANS_MARGIN</span><span class="p">)</span><span class="o">/</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">TRANS_SCALING_FACTOR</span><span class="p">;</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">F_SafeBPCompare</span><span class="p">(</span><span class="n">stSafer</span><span class="p">,</span> <span class="n">stNotSoSafe</span><span class="p">),</span>
    <span class="s1">&#39;Attenuation eval is broken: should be safe up to margin.&#39;</span><span class="p">);</span>

<span class="n">stSafer</span><span class="o">.</span><span class="n">nTran</span> <span class="o">:=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">stNotSoSafe</span><span class="o">.</span><span class="n">nTran</span><span class="o">*</span><span class="p">(</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">TRANS_SCALING_FACTOR</span> <span class="o">+</span> <span class="n">PMPS_PARAM</span><span class="o">.</span><span class="n">TRANS_MARGIN</span><span class="p">)</span><span class="o">/</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">TRANS_SCALING_FACTOR</span><span class="p">;</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">F_SafeBPCompare</span><span class="p">(</span><span class="n">stSafer</span><span class="p">,</span> <span class="n">stNotSoSafe</span><span class="p">),</span>
    <span class="s1">&#39;Attenuation eval is broken (False): should not be safe at all past margin&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>



<span class="o">//</span><span class="n">Attenuator</span> <span class="n">array</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;BPComparisonTranArray&#39;</span><span class="p">);</span>

<span class="n">stSafer</span> <span class="o">:=</span> <span class="n">F_SetBeamParams</span><span class="p">(</span>
    <span class="mi">0</span><span class="p">,</span> <span class="o">//</span>
    <span class="mi">16</span><span class="c1">#FFFFFFFF,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">16</span><span class="c1">#0000,</span>
    <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">DUMMY_AUX_ATT_ARRAY</span><span class="p">);</span>

<span class="n">stNotSoSafe</span> <span class="o">:=</span> <span class="n">F_SetBeamParams</span><span class="p">(</span>
    <span class="mi">0</span><span class="p">,</span> <span class="o">//</span>
    <span class="mi">16</span><span class="c1">#FFFFFFFF,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">16</span><span class="c1">#000F,</span>
    <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">DUMMY_AUX_ATT_ARRAY</span><span class="p">);</span>

<span class="n">FOR</span> <span class="n">idx</span><span class="o">:=</span><span class="mi">1</span> <span class="n">TO</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">AUX_ATTENUATORS</span> <span class="n">DO</span>
    <span class="n">stSafer</span><span class="o">.</span><span class="n">astAttenuators</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">nTran</span> <span class="o">:=</span> <span class="mf">0.00500</span><span class="p">;</span>
    <span class="n">stNotSoSafe</span><span class="o">.</span><span class="n">astAttenuators</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">nTran</span> <span class="o">:=</span> <span class="mf">0.00600</span><span class="p">;</span>

    <span class="n">xResult</span> <span class="o">:=</span> <span class="n">F_SafeBPCompare</span><span class="p">(</span><span class="n">stSafer</span><span class="p">,</span> <span class="n">stNotSoSafe</span><span class="p">);</span>

    <span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">xResult</span><span class="p">,</span>
    <span class="s1">&#39;Attenuation array eval is broken (True)&#39;</span><span class="p">);</span>

    <span class="n">xFailedTest</span> <span class="n">S</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">xResult</span><span class="p">;</span>

    <span class="n">xResult</span> <span class="o">:=</span> <span class="n">F_SafeBPCompare</span><span class="p">(</span><span class="n">stNotSoSafe</span><span class="p">,</span> <span class="n">stSafer</span><span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">xResult</span><span class="p">,</span>
    <span class="s1">&#39;Attenuation array eval is broken (False)&#39;</span><span class="p">);</span>

    <span class="n">xFailedTest</span> <span class="n">S</span><span class="o">=</span> <span class="n">xResult</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Check</span> <span class="n">at</span> <span class="n">margin</span> <span class="n">threshold</span>
        <span class="n">stSafer</span><span class="o">.</span><span class="n">astAttenuators</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">nTran</span> <span class="o">:=</span> <span class="n">stNotSoSafe</span><span class="o">.</span><span class="n">astAttenuators</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">nTran</span><span class="o">*</span><span class="p">(</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">TRANS_SCALING_FACTOR</span> <span class="o">+</span> <span class="n">PMPS_PARAM</span><span class="o">.</span><span class="n">TRANS_MARGIN</span><span class="p">)</span><span class="o">/</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">TRANS_SCALING_FACTOR</span><span class="p">;</span>

        <span class="n">xResult</span> <span class="o">:=</span> <span class="n">F_SafeBPCompare</span><span class="p">(</span><span class="n">stSafer</span><span class="p">,</span> <span class="n">stNotSoSafe</span><span class="p">);</span>

        <span class="n">AssertTrue</span><span class="p">(</span>
            <span class="n">xResult</span><span class="p">,</span>
            <span class="s1">&#39;Attenuation eval is broken: should be safe up to margin.&#39;</span><span class="p">);</span>
        <span class="n">xFailedTest</span> <span class="n">S</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">xResult</span><span class="p">;</span>

        <span class="n">stSafer</span><span class="o">.</span><span class="n">astAttenuators</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">nTran</span> <span class="o">:=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">stNotSoSafe</span><span class="o">.</span><span class="n">astAttenuators</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">nTran</span><span class="o">*</span><span class="p">(</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">TRANS_SCALING_FACTOR</span> <span class="o">+</span> <span class="n">PMPS_PARAM</span><span class="o">.</span><span class="n">TRANS_MARGIN</span><span class="p">)</span><span class="o">/</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">TRANS_SCALING_FACTOR</span><span class="p">;</span>

        <span class="n">xResult</span> <span class="o">:=</span> <span class="n">F_SafeBPCompare</span><span class="p">(</span><span class="n">stSafer</span><span class="p">,</span> <span class="n">stNotSoSafe</span><span class="p">);</span>
        <span class="n">AssertFalse</span><span class="p">(</span>
            <span class="n">xResult</span><span class="p">,</span>
            <span class="s1">&#39;Attenuation eval is broken (False): should not be safe at all past margin&#39;</span><span class="p">);</span>
        <span class="n">xFailedTest</span> <span class="n">S</span><span class="o">=</span> <span class="n">xResult</span><span class="p">;</span>
    <span class="o">//////////////////////</span>
    <span class="n">IF</span> <span class="n">xFailedTest</span> <span class="n">THEN</span>
        <span class="n">stSafer</span><span class="o">.</span><span class="n">astAttenuators</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">nTran</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">stNotSoSafe</span><span class="o">.</span><span class="n">astAttenuators</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">nTran</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">xFailedTest</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">EXIT</span><span class="p">;</span> <span class="o">//</span> <span class="n">Exit</span> <span class="n">this</span> <span class="n">loop</span> <span class="n">on</span> <span class="n">the</span> <span class="n">first</span> <span class="n">failure</span><span class="o">.</span>
    <span class="n">END_IF</span>

    <span class="n">stSafer</span><span class="o">.</span><span class="n">astAttenuators</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">nTran</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">stNotSoSafe</span><span class="o">.</span><span class="n">astAttenuators</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">nTran</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">END_FOR</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>

<span class="n">stSafer</span><span class="o">.</span><span class="n">astAttenuators</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">nTran</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">stNotSoSafe</span><span class="o">.</span><span class="n">astAttenuators</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">nTran</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

<span class="o">//</span><span class="n">Aperture</span> <span class="n">array</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;BPComparisonApertureArray&#39;</span><span class="p">);</span>

<span class="n">FOR</span> <span class="n">idx</span><span class="o">:=</span><span class="mi">1</span> <span class="n">TO</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">MAX_APERTURES</span> <span class="n">DO</span>
    <span class="o">//</span> <span class="n">Height</span>
    <span class="n">stSafer</span><span class="o">.</span><span class="n">astApertures</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">Height</span> <span class="o">:=</span> <span class="mi">30</span><span class="p">;</span> <span class="o">//</span> <span class="n">narrower</span> <span class="ow">is</span> <span class="n">safer</span>
    <span class="n">stNotSoSafe</span><span class="o">.</span><span class="n">astApertures</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">Height</span> <span class="o">:=</span> <span class="mi">50</span><span class="p">;</span>

    <span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">F_SafeBPCompare</span><span class="p">(</span><span class="n">stSafer</span><span class="p">,</span> <span class="n">stNotSoSafe</span><span class="p">),</span>
    <span class="s1">&#39;Aperture array eval is broken on height (True)&#39;</span><span class="p">);</span>

    <span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">F_SafeBPCompare</span><span class="p">(</span><span class="n">stNotSoSafe</span><span class="p">,</span> <span class="n">stSafer</span><span class="p">),</span>
    <span class="s1">&#39;Aperture array eval is broken on height (False)&#39;</span><span class="p">);</span>

    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">F_SafeBPCompare</span><span class="p">(</span><span class="n">stSafer</span><span class="p">,</span> <span class="n">stNotSoSafe</span><span class="p">)</span> <span class="ow">or</span> <span class="n">F_SafeBPCompare</span><span class="p">(</span><span class="n">stNotSoSafe</span><span class="p">,</span> <span class="n">stSafer</span><span class="p">)</span> <span class="n">THEN</span>
        <span class="n">EXIT</span><span class="p">;</span> <span class="o">//</span> <span class="n">Exit</span> <span class="n">this</span> <span class="n">loop</span> <span class="n">on</span> <span class="n">the</span> <span class="n">first</span> <span class="n">failure</span><span class="o">.</span>
    <span class="n">END_IF</span>

    <span class="n">stSafer</span><span class="o">.</span><span class="n">astApertures</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">Height</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">stNotSoSafe</span><span class="o">.</span><span class="n">astApertures</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">Height</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Width</span>
    <span class="n">stSafer</span><span class="o">.</span><span class="n">astApertures</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">Width</span> <span class="o">:=</span> <span class="mi">30</span><span class="p">;</span> <span class="o">//</span> <span class="n">narrower</span> <span class="ow">is</span> <span class="n">safer</span>
    <span class="n">stNotSoSafe</span><span class="o">.</span><span class="n">astApertures</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">Width</span> <span class="o">:=</span> <span class="mi">50</span><span class="p">;</span>

    <span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">F_SafeBPCompare</span><span class="p">(</span><span class="n">stSafer</span><span class="p">,</span> <span class="n">stNotSoSafe</span><span class="p">),</span>
    <span class="s1">&#39;Aperture array eval is broken on width (True)&#39;</span><span class="p">);</span>

    <span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">F_SafeBPCompare</span><span class="p">(</span><span class="n">stNotSoSafe</span><span class="p">,</span> <span class="n">stSafer</span><span class="p">),</span>
    <span class="s1">&#39;Aperture array eval is broken on width (False)&#39;</span><span class="p">);</span>

    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">F_SafeBPCompare</span><span class="p">(</span><span class="n">stSafer</span><span class="p">,</span> <span class="n">stNotSoSafe</span><span class="p">)</span> <span class="ow">or</span> <span class="n">F_SafeBPCompare</span><span class="p">(</span><span class="n">stNotSoSafe</span><span class="p">,</span> <span class="n">stSafer</span><span class="p">)</span> <span class="n">THEN</span>
        <span class="n">EXIT</span><span class="p">;</span> <span class="o">//</span> <span class="n">Exit</span> <span class="n">this</span> <span class="n">loop</span> <span class="n">on</span> <span class="n">the</span> <span class="n">first</span> <span class="n">failure</span><span class="o">.</span>
    <span class="n">END_IF</span>

    <span class="n">stSafer</span><span class="o">.</span><span class="n">astApertures</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">Width</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">stNotSoSafe</span><span class="o">.</span><span class="n">astApertures</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">Width</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>


<span class="n">END_FOR</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>

<span class="o">//</span><span class="n">Rate</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;BPComparisonRate&#39;</span><span class="p">);</span>
<span class="n">stSafer</span> <span class="o">:=</span> <span class="n">F_SetBeamParams</span><span class="p">(</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="mi">16</span><span class="c1">#FFFF_FFFF,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">16</span><span class="c1">#0000,</span>
    <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">DUMMY_AUX_ATT_ARRAY</span><span class="p">);</span> <span class="o">//</span>

<span class="n">stNotSoSafe</span> <span class="o">:=</span> <span class="n">F_SetBeamParams</span><span class="p">(</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="mi">16</span><span class="c1">#FFFF_FFFF,</span>
    <span class="mi">10</span><span class="p">,</span>
    <span class="mi">16</span><span class="c1">#0001,</span>
    <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">DUMMY_AUX_ATT_ARRAY</span><span class="p">);</span> <span class="o">//</span>

<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">F_SafeBPCompare</span><span class="p">(</span><span class="n">stSafer</span><span class="p">,</span> <span class="n">stNotSoSafe</span><span class="p">),</span>
    <span class="s1">&#39;Rate eval is broken (True)&#39;</span><span class="p">);</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">F_SafeBPCompare</span><span class="p">(</span><span class="n">stNotSoSafe</span><span class="p">,</span> <span class="n">stSafer</span><span class="p">),</span>
    <span class="s1">&#39;Rate eval is broken (False)&#39;</span><span class="p">);</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>

<span class="o">//</span><span class="n">Pulse</span> <span class="n">energy</span>
<span class="p">(</span><span class="o">*</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;BPComparisonPulseEnergy&#39;</span><span class="p">);</span>
<span class="n">stSafer</span> <span class="o">:=</span> <span class="n">F_SetBeamParams</span><span class="p">(</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span> <span class="o">//</span>
    <span class="mi">16</span><span class="c1">#FFFF,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">DUMMY_AUX_ATT_ARRAY</span><span class="p">);</span>

<span class="n">stNotSoSafe</span> <span class="o">:=</span> <span class="n">F_SetBeamParams</span><span class="p">(</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">,</span> <span class="o">//</span>
    <span class="mi">16</span><span class="c1">#FFFF,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">DUMMY_AUX_ATT_ARRAY</span><span class="p">);</span>
    <span class="o">*</span><span class="p">)</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">F_SafeBPCompare</span><span class="p">(</span><span class="n">stSafer</span><span class="p">,</span> <span class="n">stNotSoSafe</span><span class="p">),</span>
    <span class="s1">&#39;Pulse energy eval is broken (True)&#39;</span><span class="p">);</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">F_SafeBPCompare</span><span class="p">(</span><span class="n">stNotSoSafe</span><span class="p">,</span> <span class="n">stSafer</span><span class="p">),</span>
    <span class="s1">&#39;Pulse energy eval is broken (False)&#39;</span><span class="p">);</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>

<span class="o">//</span><span class="n">Photon</span> <span class="n">energy</span>
<span class="o">//</span><span class="n">More</span> <span class="n">extensive</span> <span class="n">tests</span> <span class="n">elsewhere</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;BPComparisonPhotonEnergy&#39;</span><span class="p">);</span>
<span class="n">stSafer</span> <span class="o">:=</span> <span class="n">F_SetBeamParams</span><span class="p">(</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="mi">2</span><span class="c1">#0000_0000_0000_0000_0000_0000_0000_0010,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">16</span><span class="c1">#0000,</span>
    <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">DUMMY_AUX_ATT_ARRAY</span><span class="p">);</span>

<span class="n">stNotSoSafe</span> <span class="o">:=</span> <span class="n">F_SetBeamParams</span><span class="p">(</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="mi">2</span><span class="c1">#0000_0000_0000_0000_0000_0000_0000_0110,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">16</span><span class="c1">#0001,</span>
    <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">DUMMY_AUX_ATT_ARRAY</span><span class="p">);</span>

<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">F_SafeBPCompare</span><span class="p">(</span><span class="n">stSafer</span><span class="p">,</span> <span class="n">stNotSoSafe</span><span class="p">),</span>
    <span class="s1">&#39;Photon energy eval is broken (True)&#39;</span><span class="p">);</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">F_SafeBPCompare</span><span class="p">(</span><span class="n">stNotSoSafe</span><span class="p">,</span> <span class="n">stSafer</span><span class="p">),</span>
    <span class="s1">&#39;Photon energy eval is broken (False)&#39;</span><span class="p">);</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-beamclassoutputs-bcd">FB_BeamClassOutputs_BCD</a></p></li>
<li><p><a class="reference internal" href="#f-safebpcompare">F_SafeBPCompare</a></p></li>
<li><p><a class="reference internal" href="#f-safebpcompare0rate">F_SafeBPCompare0Rate</a></p></li>
<li><p><a class="reference internal" href="#f-setbeamparams">F_SetBeamParams</a></p></li>
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
<li><p><a class="reference internal" href="#pmps-param">PMPS_PARAM</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-solidattenuator">
<h2>FB_SolidAttenuator<a class="headerlink" href="#fb-solidattenuator" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_SolidAttenuator</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_rRequestedAttenuation</span>    <span class="p">:</span>    <span class="n">REAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">q_xFault</span>    <span class="p">:</span>    <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_rCurrentAttenuation</span>    <span class="p">:</span>    <span class="n">REAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Arbiter</span>    <span class="p">:</span>    <span class="n">FB_Arbiter</span><span class="p">;</span> <span class="o">//</span><span class="n">Higher</span> <span class="n">level</span> <span class="n">arbiter</span> <span class="kn">from</span><span class="w"> </span><span class="nn">which</span> <span class="n">upstream</span> <span class="n">attenuation</span> <span class="n">can</span> <span class="n">be</span> <span class="n">requested</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">stAttenuator</span>    <span class="p">:</span>    <span class="n">ST_BinarySolidAttenuator</span><span class="p">;</span>
    <span class="n">nSearchStart</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">nArrayLength</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">axNewBladeStates</span>    <span class="p">:</span>    <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">0..9</span><span class="p">]</span>    <span class="n">OF</span>    <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nTryIndex</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">rCurrentAccumulatedAttenuation</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="n">rTryFilter</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="n">rTryAttenuation</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="n">rRequestedAttenuation</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span>

<span class="o">//</span><span class="n">Assuming</span> <span class="n">the</span> <span class="n">blades</span> <span class="n">are</span> <span class="n">ordered</span> <span class="n">thickest</span> <span class="n">to</span> <span class="n">thinnest</span>
<span class="n">REPEAT</span>
    <span class="n">rTryAttenuation</span> <span class="o">:=</span> <span class="n">rCurrentAccumulatedAttenuation</span> <span class="o">+</span> <span class="n">stAttenuator</span><span class="o">.</span><span class="n">axBlades</span><span class="p">[</span><span class="n">nTryIndex</span><span class="p">]</span><span class="o">.</span><span class="n">rThickness</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">rRequestedAttenuation</span> <span class="o">&gt;=</span> <span class="n">rTryAttenuation</span> <span class="n">THEN</span>
        <span class="n">rCurrentAccumulatedAttenuation</span> <span class="o">:=</span> <span class="n">rTryAttenuation</span><span class="p">;</span>
        <span class="n">axNewBladeStates</span><span class="p">[</span><span class="n">nTryIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">axNewBladeStates</span><span class="p">[</span><span class="n">nTryIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">UNTIL</span>
    <span class="n">nTryIndex</span> <span class="o">&gt;=</span> <span class="n">nArrayLength</span>
<span class="n">END_REPEAT</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-arbiter">FB_Arbiter</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-stopperwatcher">
<h2>FB_StopperWatcher<a class="headerlink" href="#fb-stopperwatcher" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Relays</span> <span class="n">stopper</span> <span class="n">state</span> <span class="ow">and</span> <span class="n">sends</span> <span class="n">a</span> <span class="n">message</span> <span class="n">when</span> <span class="n">stopper</span> <span class="n">state</span> <span class="n">changes</span><span class="o">.</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_StopperWatcher</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stCurrentBP</span> <span class="p">:</span> <span class="n">ST_BeamParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">i_StopperOutLS</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">i_StopperInLS</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">q_StopperOUT_Relay</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_StopperIN_Relay</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">Stopper</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">StopperName</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;instance-path&#39;</span><span class="p">}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;noinit&#39;</span><span class="p">}</span>
    <span class="n">sPath</span>    <span class="p">:</span>    <span class="n">T_MaxString</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Logging</span>
    <span class="n">fbLogMsg</span> <span class="p">:</span> <span class="n">FB_LogMessage</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">eSubSystem</span> <span class="o">:=</span> <span class="n">E_Subsystem</span><span class="o">.</span><span class="n">MPS</span><span class="p">);</span>

    <span class="n">rtIn</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rtOut</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>

    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">fbLogMsg</span><span class="o">.</span><span class="n">sJson</span> <span class="o">:=</span> <span class="n">F_PMPS_JSON</span><span class="p">(</span><span class="n">StopperName</span><span class="p">,</span> <span class="n">sPath</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="n">rtIn</span><span class="p">(</span><span class="n">CLK</span> <span class="o">:=</span> <span class="n">i_StopperInLS</span><span class="p">);</span>
<span class="n">rtOut</span><span class="p">(</span><span class="n">CLK</span> <span class="o">:=</span> <span class="n">i_StopperOutLS</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">rtIn</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">fbLogMsg</span><span class="o">.</span><span class="n">sMsg</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">StopperName</span><span class="p">,</span> <span class="s1">&#39; moved IN&#39;</span><span class="p">);</span>
    <span class="n">fbLogMsg</span><span class="p">();</span>
<span class="n">ELSIF</span> <span class="n">rtOut</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">fbLogMsg</span><span class="o">.</span><span class="n">sMsg</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">StopperName</span><span class="p">,</span> <span class="s1">&#39; moved OUT&#39;</span><span class="p">);</span>
    <span class="n">fbLogMsg</span><span class="p">();</span>
<span class="n">END_IF</span>

<span class="n">q_StopperOUT_Relay</span> <span class="o">:=</span> <span class="n">i_StopperOutLS</span><span class="p">;</span>
<span class="n">q_StopperIN_Relay</span> <span class="o">:=</span> <span class="n">i_StopperInLS</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Update</span> <span class="n">current</span> <span class="n">beam</span> <span class="n">parameters</span>
<span class="n">stCurrentBP</span><span class="o">.</span><span class="n">aVetoDevices</span><span class="p">[</span><span class="n">Stopper</span><span class="p">]</span> <span class="o">:=</span> <span class="n">i_StopperInLS</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#f-pmps-json">F_PMPS_JSON</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-subsystoarb-test">
<h2>FB_SubsysToArb_Test<a class="headerlink" href="#fb-subsystoarb-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;call_after_init&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_SubsysToArb_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">BasicFunction</span><span class="p">();</span>
<span class="n">VetoFunction</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_check&#39;</span><span class="p">}</span>
<span class="n">METHOD</span> <span class="n">BasicFunction</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nId</span>    <span class="p">:</span>    <span class="n">DWORD</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">stReq</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="p">(</span><span class="n">nTran</span><span class="o">:=</span><span class="mi">12</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbArbiter</span>    <span class="p">:</span>    <span class="n">FB_Arbiter</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="n">fbSubSysToArb</span> <span class="p">:</span> <span class="n">FB_SubSysToArbiter_IO</span><span class="p">;</span> <span class="o">//</span> <span class="n">Subsystem</span> <span class="n">interface</span> <span class="k">with</span> <span class="n">beamline</span> <span class="n">arbiter</span> <span class="n">PLC</span>
    <span class="n">pBPC</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_BeamParams_IO</span><span class="p">;</span>

    <span class="n">ioCurrentBP</span> <span class="p">:</span> <span class="n">ST_BeamParams_IO</span><span class="p">;</span>

    <span class="n">FFO</span> <span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span> <span class="o">//</span> <span class="n">Dummy</span> <span class="n">FFO</span> <span class="ow">not</span> <span class="n">important</span> <span class="k">for</span> <span class="n">these</span> <span class="n">tests</span>

    <span class="n">nCohortScratch</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">SysID</span> <span class="p">:</span> <span class="n">DWORD</span> <span class="o">:=</span> <span class="mi">42</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">simulates</span> <span class="n">a</span> <span class="n">synchronous</span> <span class="n">cycle</span> <span class="n">between</span> <span class="n">the</span> <span class="n">subsystem</span> <span class="ow">and</span> <span class="n">arbiter</span> <span class="n">PLC</span> <span class="n">cycles</span><span class="o">.</span> <span class="n">Ie</span><span class="o">.</span> <span class="n">phase</span> <span class="ow">is</span> <span class="n">locked</span><span class="p">,</span> <span class="ow">and</span> <span class="n">cycle</span> <span class="n">time</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">same</span><span class="o">.</span> <span class="n">This</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">always</span> <span class="n">the</span> <span class="n">case</span><span class="p">,</span> <span class="n">so</span> <span class="n">these</span> <span class="n">tests</span> <span class="n">should</span> <span class="n">be</span>
<span class="o">//</span> <span class="n">trusted</span> <span class="k">with</span> <span class="n">a</span> <span class="n">grain</span> <span class="n">of</span> <span class="n">salt</span><span class="o">.</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;Add to arbiter&#39;</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequestInPool</span><span class="p">(</span><span class="n">nID</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">AddRequest</span><span class="p">(</span><span class="n">nId</span><span class="p">,</span> <span class="n">stReq</span><span class="p">,</span><span class="s1">&#39;Device&#39;</span><span class="p">),</span> <span class="s1">&#39;Arbiter returned false from AddRequest&#39;</span><span class="p">);</span> <span class="o">//</span> <span class="n">some</span> <span class="n">device</span> <span class="n">asking</span> <span class="n">its</span> <span class="n">local</span> <span class="n">arbiter</span> <span class="k">for</span> <span class="n">some</span> <span class="n">beam</span> <span class="n">parameters</span>
<span class="n">END_IF</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>

<span class="o">///////////////////////////////////////</span>
<span class="o">//</span><span class="n">Sub</span> <span class="n">system</span> <span class="n">cycle</span>
<span class="n">fbSubSysToArb</span><span class="p">(</span><span class="n">Arbiter</span> <span class="o">:=</span> <span class="n">fbArbiter</span><span class="p">,</span> <span class="n">fbFFHWO</span> <span class="o">:=</span> <span class="n">FFO</span><span class="p">);</span>
<span class="o">//</span><span class="n">END</span> <span class="n">of</span> <span class="n">sub</span> <span class="n">system</span> <span class="n">cycle</span>
<span class="o">///////////////////////////////////////</span>


<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;Initial Elevation&#39;</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbSubSysToArb</span><span class="o">.</span><span class="n">nRequestCohort</span> <span class="o">=</span> <span class="n">fbSubSysToArb</span><span class="o">.</span><span class="n">q_stRequestedBP</span><span class="o">.</span><span class="n">nCohortInt</span><span class="p">,</span> <span class="s1">&#39;ReqCohort and qBP Cohort do not match&#39;</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">nActiveCohort</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Arbiter indicates it is included in arbitration prematurely&#39;</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbSubSysToArb</span><span class="o">.</span><span class="n">nRequestCohort</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Cohort index should move to 1 with first request&#39;</span><span class="p">);</span>
<span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="s1">&#39;Initial Elevation&#39;</span><span class="p">);</span>

<span class="n">nCohortScratch</span> <span class="o">:=</span> <span class="n">fbSubSysToArb</span><span class="o">.</span><span class="n">nRequestCohort</span><span class="p">;</span>

<span class="o">//</span><span class="n">Ethercat</span> <span class="n">transfer</span> <span class="n">simulation</span>
<span class="o">//</span> <span class="n">Transfer</span> <span class="n">of</span> <span class="n">requested</span> <span class="n">BP</span> <span class="n">to</span> <span class="n">arbiter</span> <span class="n">PLC</span>
<span class="o">//</span> <span class="n">pBPR</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbArbToSubSys</span><span class="o">.</span><span class="n">i_RequestedBP</span><span class="p">);</span>
<span class="o">//</span> <span class="n">pBPR</span><span class="o">^</span> <span class="o">:=</span> <span class="n">fbSubSysToArb</span><span class="o">.</span><span class="n">q_stRequestedBP</span><span class="p">;</span>

<span class="n">ioCurrentBP</span> <span class="o">:=</span> <span class="n">fbSubSysToArb</span><span class="o">.</span><span class="n">q_stRequestedBP</span><span class="p">;</span>
<span class="o">//</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">Setting</span> <span class="n">the</span> <span class="n">returning</span> <span class="n">cohort</span> <span class="n">number</span> <span class="n">to</span> <span class="n">something</span> <span class="n">less</span> <span class="n">than</span> <span class="n">the</span> <span class="n">request</span> <span class="n">cohort</span> <span class="n">number</span>
<span class="o">//</span> <span class="n">will</span> <span class="n">prevent</span> <span class="n">the</span> <span class="n">sub</span> <span class="n">system</span> <span class="n">arbiter</span> <span class="n">FB</span> <span class="kn">from</span><span class="w"> </span><span class="nn">considering</span> <span class="n">itself</span> <span class="n">active</span> <span class="ow">in</span> <span class="n">arbitration</span><span class="o">.</span>
<span class="o">//</span> <span class="n">The</span> <span class="nb">next</span> <span class="nb">set</span> <span class="n">of</span> <span class="n">tests</span> <span class="n">verify</span> <span class="n">this</span><span class="o">.</span>
<span class="n">ioCurrentBP</span><span class="o">.</span><span class="n">nCohortInt</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Transfer</span> <span class="n">of</span> <span class="n">current</span> <span class="n">BP</span> <span class="n">to</span> <span class="n">sub</span> <span class="n">system</span> <span class="n">PLC</span>
<span class="n">pBPC</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSubSysToArb</span><span class="o">.</span><span class="n">i_stCurrentBP</span><span class="p">);</span>
<span class="n">pBPC</span><span class="o">^</span> <span class="o">:=</span> <span class="n">ioCurrentBP</span><span class="p">;</span>

<span class="o">///////////////////////////////////////</span>
<span class="o">//</span><span class="n">Sub</span> <span class="n">system</span> <span class="n">cycle</span>
<span class="n">fbSubSysToArb</span><span class="p">(</span><span class="n">Arbiter</span> <span class="o">:=</span> <span class="n">fbArbiter</span><span class="p">,</span> <span class="n">fbFFHWO</span> <span class="o">:=</span> <span class="n">FFO</span><span class="p">);</span>
<span class="o">//</span><span class="n">END</span> <span class="n">of</span> <span class="n">sub</span> <span class="n">system</span> <span class="n">cycle</span>
<span class="o">///////////////////////////////////////</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;Not yet active in arbitration&#39;</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbSubSysToArb</span><span class="o">.</span><span class="n">nActiveCohort</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Active cohort should still be zero, per ioCurrentBP.nCohortInt setting above.&#39;</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">nActiveCohort</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Arbiter indicates it is included in arbitration prematurely, checkrequest might be broken&#39;</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbSubSysToArb</span><span class="o">.</span><span class="n">nRequestCohort</span> <span class="o">=</span> <span class="n">nCohortScratch</span><span class="p">,</span> <span class="s1">&#39;Cohort index should not have changed because there have been no additional requests added to the arbiter&#39;</span><span class="p">);</span>
<span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="s1">&#39;Not yet active in arbitration&#39;</span><span class="p">);</span>

<span class="o">//</span><span class="n">Ethercat</span> <span class="n">transfer</span> <span class="n">simulation</span>
<span class="o">//</span> <span class="n">Transfer</span> <span class="n">of</span> <span class="n">requested</span> <span class="n">BP</span> <span class="n">to</span> <span class="n">arbiter</span> <span class="n">PLC</span>
<span class="o">//</span> <span class="n">pBPR</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbArbToSubSys</span><span class="o">.</span><span class="n">i_RequestedBP</span><span class="p">);</span>
<span class="o">//</span> <span class="n">pBPR</span><span class="o">^</span> <span class="o">:=</span> <span class="n">fbSubSysToArb</span><span class="o">.</span><span class="n">q_stRequestedBP</span><span class="p">;</span>

<span class="n">ioCurrentBP</span> <span class="o">:=</span> <span class="n">fbSubSysToArb</span><span class="o">.</span><span class="n">q_stRequestedBP</span><span class="p">;</span>
<span class="o">//</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">Now</span> <span class="n">we</span> <span class="n">simulate</span> <span class="n">the</span> <span class="n">FB_ArbiterToSubSys_IO</span> <span class="n">updating</span> <span class="n">the</span> <span class="n">cohort</span> <span class="n">number</span> <span class="n">to</span> <span class="n">the</span> <span class="n">same</span> <span class="n">value</span> <span class="k">as</span> <span class="n">the</span> <span class="n">request</span> <span class="n">cohort</span><span class="p">,</span> <span class="n">indicating</span> <span class="n">that</span> <span class="n">cohort</span> <span class="n">has</span> <span class="n">been</span> <span class="n">included</span>
<span class="n">ioCurrentBP</span><span class="o">.</span><span class="n">nCohortInt</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Transfer</span> <span class="n">of</span> <span class="n">current</span> <span class="n">BP</span> <span class="n">to</span> <span class="n">sub</span> <span class="n">system</span> <span class="n">PLC</span>
<span class="n">pBPC</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSubSysToArb</span><span class="o">.</span><span class="n">i_stCurrentBP</span><span class="p">);</span>
<span class="n">pBPC</span><span class="o">^</span> <span class="o">:=</span> <span class="n">ioCurrentBP</span><span class="p">;</span>

<span class="o">///////////////////////////////////////</span>
<span class="o">//</span><span class="n">Sub</span> <span class="n">system</span> <span class="n">cycle</span>
<span class="n">fbSubSysToArb</span><span class="p">(</span><span class="n">Arbiter</span> <span class="o">:=</span> <span class="n">fbArbiter</span><span class="p">,</span> <span class="n">fbFFHWO</span> <span class="o">:=</span> <span class="n">FFO</span><span class="p">);</span>
<span class="o">//</span><span class="n">END</span> <span class="n">of</span> <span class="n">sub</span> <span class="n">system</span> <span class="n">cycle</span>
<span class="o">///////////////////////////////////////</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;Active in arbitration&#39;</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbSubSysToArb</span><span class="o">.</span><span class="n">nActiveCohort</span> <span class="o">=</span> <span class="n">fbSubSysToArb</span><span class="o">.</span><span class="n">nRequestCohort</span><span class="p">,</span> <span class="s1">&#39;Active cohort and request cohort do not match&#39;</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">nActiveCohort</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Arbiter does not indicate it is included in higher arbitration&#39;</span><span class="p">);</span>
<span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="s1">&#39;Active in arbitration&#39;</span><span class="p">);</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">VetoFunction</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nId</span>    <span class="p">:</span>    <span class="n">DWORD</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">stReq</span>    <span class="p">:</span>    <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="p">(</span><span class="n">nTran</span><span class="o">:=</span><span class="mi">12</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbArbiter</span>    <span class="p">:</span>    <span class="n">FB_Arbiter</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="n">fbSubSysToArb</span> <span class="p">:</span> <span class="n">FB_SubSysToArbiter_IO</span><span class="p">;</span> <span class="o">//</span> <span class="n">Subsystem</span> <span class="n">interface</span> <span class="k">with</span> <span class="n">beamline</span> <span class="n">arbiter</span> <span class="n">PLC</span>
    <span class="n">fbArbToSubSys</span> <span class="p">:</span> <span class="n">FB_ArbiterToSubSys_IO</span><span class="p">;</span>

    <span class="n">pBPC</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_BeamParams_IO</span><span class="p">;</span>
    <span class="n">pBPR</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_BeamParams_IO</span><span class="p">;</span>

    <span class="n">ioCurrentBP</span> <span class="p">:</span> <span class="n">ST_BeamParams_IO</span><span class="p">;</span>

    <span class="n">FFO</span> <span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span> <span class="o">//</span> <span class="n">Dummy</span> <span class="n">FFO</span> <span class="ow">not</span> <span class="n">important</span> <span class="k">for</span> <span class="n">these</span> <span class="n">tests</span>

<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">SysID</span> <span class="p">:</span> <span class="n">DWORD</span> <span class="o">:=</span> <span class="mi">42</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">simulates</span> <span class="n">a</span> <span class="n">synchronous</span> <span class="n">cycle</span> <span class="n">between</span> <span class="n">the</span> <span class="n">subsystem</span> <span class="ow">and</span> <span class="n">arbiter</span> <span class="n">PLC</span> <span class="n">cycles</span><span class="o">.</span> <span class="n">Ie</span><span class="o">.</span> <span class="n">phase</span> <span class="ow">is</span> <span class="n">locked</span><span class="p">,</span> <span class="ow">and</span> <span class="n">cycle</span> <span class="n">time</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">same</span><span class="o">.</span> <span class="n">This</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">always</span> <span class="n">the</span> <span class="n">case</span><span class="p">,</span> <span class="n">so</span> <span class="n">these</span> <span class="n">tests</span> <span class="n">should</span> <span class="n">be</span>
<span class="o">//</span> <span class="n">trusted</span> <span class="k">with</span> <span class="n">a</span> <span class="n">grain</span> <span class="n">of</span> <span class="n">salt</span><span class="o">.</span>

<span class="n">fbArbiter</span><span class="o">.</span><span class="n">AddRequest</span><span class="p">(</span><span class="n">nId</span><span class="p">,</span> <span class="n">stReq</span><span class="p">,</span><span class="s1">&#39;Device&#39;</span><span class="p">);</span> <span class="o">//</span> <span class="n">some</span> <span class="n">device</span> <span class="n">asking</span> <span class="n">its</span> <span class="n">local</span> <span class="n">arbiter</span> <span class="k">for</span> <span class="n">some</span> <span class="n">beam</span> <span class="n">parameters</span>


<span class="o">///////////////////////////////////////</span>
<span class="o">//</span><span class="n">Sub</span> <span class="n">system</span> <span class="n">cycle</span>
<span class="n">fbSubSysToArb</span><span class="p">(</span><span class="n">Arbiter</span> <span class="o">:=</span> <span class="n">fbArbiter</span><span class="p">,</span> <span class="n">fbFFHWO</span> <span class="o">:=</span> <span class="n">FFO</span><span class="p">);</span>
<span class="o">//</span><span class="n">END</span> <span class="n">of</span> <span class="n">sub</span> <span class="n">system</span> <span class="n">cycle</span>
<span class="o">///////////////////////////////////////</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;Request propagated&#39;</span><span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbSubSysToArb</span><span class="o">.</span><span class="n">q_stRequestedBP</span><span class="o">.</span><span class="n">nTran</span> <span class="o">=</span> <span class="n">stReq</span><span class="o">.</span><span class="n">nTran</span><span class="p">,</span> <span class="s1">&#39;Request not propagated&#39;</span><span class="p">);</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>

<span class="o">//</span> <span class="n">Veto</span> <span class="n">activated</span>
<span class="o">///////////////////////////////////////</span>
<span class="o">//</span><span class="n">Sub</span> <span class="n">system</span> <span class="n">cycle</span>
<span class="n">fbSubSysToArb</span><span class="p">(</span><span class="n">Arbiter</span> <span class="o">:=</span> <span class="n">fbArbiter</span><span class="p">,</span> <span class="n">fbFFHWO</span> <span class="o">:=</span> <span class="n">FFO</span><span class="p">,</span> <span class="n">i_bVeto</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>
<span class="o">//</span><span class="n">END</span> <span class="n">of</span> <span class="n">sub</span> <span class="n">system</span> <span class="n">cycle</span>
<span class="o">///////////////////////////////////////</span>

<span class="o">//</span> <span class="n">Veto</span> <span class="n">activated</span>
<span class="o">///////////////////////////////////////</span>
<span class="o">//</span><span class="n">Sub</span> <span class="n">system</span> <span class="n">cycle</span>
<span class="n">fbSubSysToArb</span><span class="p">(</span><span class="n">Arbiter</span> <span class="o">:=</span> <span class="n">fbArbiter</span><span class="p">,</span> <span class="n">fbFFHWO</span> <span class="o">:=</span> <span class="n">FFO</span><span class="p">,</span> <span class="n">i_bVeto</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>
<span class="o">//</span><span class="n">END</span> <span class="n">of</span> <span class="n">sub</span> <span class="n">system</span> <span class="n">cycle</span>
<span class="o">///////////////////////////////////////</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;Request sustained&#39;</span><span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbSubSysToArb</span><span class="o">.</span><span class="n">q_stRequestedBP</span><span class="o">.</span><span class="n">nTran</span> <span class="o">=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstFullBeam</span><span class="o">.</span><span class="n">nTran</span><span class="p">,</span> <span class="s1">&#39;Request still being propagated&#39;</span><span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">(</span><span class="n">nId</span><span class="p">),</span> <span class="s1">&#39;Request still not valid&#39;</span><span class="p">);</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>

<span class="o">//</span> <span class="n">Veto</span> <span class="n">activated</span>
<span class="o">///////////////////////////////////////</span>
<span class="o">//</span><span class="n">Sub</span> <span class="n">system</span> <span class="n">cycle</span>
<span class="n">fbSubSysToArb</span><span class="p">(</span><span class="n">Arbiter</span> <span class="o">:=</span> <span class="n">fbArbiter</span><span class="p">,</span> <span class="n">fbFFHWO</span> <span class="o">:=</span> <span class="n">FFO</span><span class="p">,</span> <span class="n">i_bVeto</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
<span class="o">//</span><span class="n">END</span> <span class="n">of</span> <span class="n">sub</span> <span class="n">system</span> <span class="n">cycle</span>
<span class="o">///////////////////////////////////////</span>

<span class="o">//</span> <span class="n">Veto</span> <span class="n">activated</span>
<span class="o">///////////////////////////////////////</span>
<span class="o">//</span><span class="n">Sub</span> <span class="n">system</span> <span class="n">cycle</span>
<span class="n">fbSubSysToArb</span><span class="p">(</span><span class="n">Arbiter</span> <span class="o">:=</span> <span class="n">fbArbiter</span><span class="p">,</span> <span class="n">fbFFHWO</span> <span class="o">:=</span> <span class="n">FFO</span><span class="p">,</span> <span class="n">i_bVeto</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
<span class="n">fbSubSysToArb</span><span class="p">(</span><span class="n">Arbiter</span> <span class="o">:=</span> <span class="n">fbArbiter</span><span class="p">,</span> <span class="n">fbFFHWO</span> <span class="o">:=</span> <span class="n">FFO</span><span class="p">,</span> <span class="n">i_bVeto</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
<span class="n">fbSubSysToArb</span><span class="p">(</span><span class="n">Arbiter</span> <span class="o">:=</span> <span class="n">fbArbiter</span><span class="p">,</span> <span class="n">fbFFHWO</span> <span class="o">:=</span> <span class="n">FFO</span><span class="p">,</span> <span class="n">i_bVeto</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
<span class="o">//</span><span class="n">END</span> <span class="n">of</span> <span class="n">sub</span> <span class="n">system</span> <span class="n">cycle</span>
<span class="o">///////////////////////////////////////</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;Request restored&#39;</span><span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbSubSysToArb</span><span class="o">.</span><span class="n">q_stRequestedBP</span><span class="o">.</span><span class="n">nTran</span> <span class="o">=</span> <span class="n">stReq</span><span class="o">.</span><span class="n">nTran</span><span class="p">,</span> <span class="s1">&#39;Request still being sustained&#39;</span><span class="p">);</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-arbiter">FB_Arbiter</a></p></li>
<li><p><a class="reference internal" href="#fb-arbitertosubsys-io">FB_ArbiterToSubSys_IO</a></p></li>
<li><p><a class="reference internal" href="#fb-hardwareffoutput">FB_HardwareFFOutput</a></p></li>
<li><p><a class="reference internal" href="#fb-subsystoarbiter-io">FB_SubSysToArbiter_IO</a></p></li>
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-subsystoarbiter-io">
<h2>FB_SubSysToArbiter_IO<a class="headerlink" href="#fb-subsystoarbiter-io" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Use</span> <span class="n">on</span> <span class="n">a</span> <span class="n">subsystem</span> <span class="n">PLC</span> <span class="n">to</span> <span class="n">request</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">arbiter</span>
<span class="o">//</span> <span class="n">Run</span> <span class="n">at</span> <span class="n">the</span> <span class="n">top</span> <span class="n">of</span> <span class="n">your</span> <span class="n">cycle</span> <span class="n">to</span> <span class="n">receive</span> <span class="n">the</span> <span class="n">latest</span> <span class="n">BP</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_SubSysToArbiter_IO</span> <span class="n">IMPLEMENTS</span> <span class="n">I_HigherAuthority</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Reset</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Fast</span> <span class="n">fault</span> <span class="n">reset</span>
    <span class="n">sName</span> <span class="p">:</span> <span class="n">STRING</span> <span class="o">:=</span> <span class="s1">&#39;SubSysToArbiter&#39;</span><span class="p">;</span>
    <span class="n">i_bVeto</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Arbiter</span> <span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">;</span>
    <span class="n">fbFFHWO</span> <span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;TIIB[PMPS_PRE]^IO Inputs^CurrentBP&#39;</span><span class="p">}</span>
    <span class="n">i_stCurrentBP</span>    <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span>    <span class="n">ST_BeamParams_IO</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;TIIB[PMPS_PRE]^IO Outputs^RequestedBP&#39;</span><span class="p">}</span>
    <span class="n">q_stRequestedBP</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span>    <span class="n">ST_BeamParams_IO</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: TxPDO_toggle</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="s1">&#39;}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;TIIB[PMPS_PRE]^SYNC Inputs^TxPDO toggle&#39;</span><span class="p">}</span>
    <span class="n">xTxPDO_toggle</span>    <span class="n">AT</span>     <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span>    <span class="n">BIT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: TxPDO_state</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="s1">&#39;}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;TIIB[PMPS_PRE]^SYNC Inputs^TxPDO state&#39;</span><span class="p">}</span>
    <span class="n">xTxPDO_state</span>    <span class="n">AT</span>    <span class="o">%</span><span class="n">I</span><span class="o">*</span>    <span class="p">:</span>    <span class="n">BIT</span><span class="p">;</span>


    <span class="o">//</span> <span class="n">Fast</span> <span class="n">faults</span>
    <span class="n">ffPMPSIO_Disconnect</span> <span class="p">:</span> <span class="n">FB_FastFault</span> <span class="o">:=</span> <span class="p">(</span><span class="n">i_Desc</span><span class="o">:=</span><span class="s1">&#39;Arbiter network interface disconnected or not OP&#39;</span><span class="p">,</span><span class="n">i_DevName</span> <span class="o">:=</span> <span class="n">sName</span><span class="p">);</span>

    <span class="o">//</span> <span class="n">A</span> <span class="n">request</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">considered</span> <span class="n">included</span> <span class="n">until</span> <span class="n">the</span> <span class="n">active</span> <span class="n">cohort</span> <span class="n">number</span> <span class="ow">is</span> <span class="o">&gt;=</span> <span class="n">the</span> <span class="n">request</span> <span class="n">cohort</span> <span class="n">number</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: RequestCohort</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="s1">&#39;}</span>
    <span class="n">nRequestCohort</span> <span class="p">:</span> <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">//</span> <span class="n">Request</span> <span class="n">cohort</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: ActiveCohort</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="s1">&#39;}</span>
    <span class="n">nActiveCohort</span> <span class="p">:</span> <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">//</span> <span class="n">Active</span> <span class="n">cohort</span><span class="p">,</span> <span class="n">updated</span> <span class="n">by</span> <span class="n">incoming</span> <span class="n">BP</span> <span class="kn">from</span><span class="w"> </span><span class="nn">arbiter</span> <span class="n">PLC</span><span class="p">,</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">ElevateRequest</span> <span class="n">arbiter</span> <span class="n">call</span>

    <span class="n">fbVetoArb</span> <span class="p">:</span> <span class="n">FB_VetoArbiter</span><span class="p">;</span>

    <span class="n">fbLog</span> <span class="p">:</span> <span class="n">FB_LogMessage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span><span class="n">Receiving</span> <span class="n">current</span> <span class="n">BP</span> <span class="n">state</span>
<span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">stCurrentBeamParameters</span> <span class="o">:=</span> <span class="n">IO_TO_BP</span><span class="p">(</span><span class="n">i_stCurrentBP</span><span class="p">);</span>
<span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">stCurrentBeamParameters</span><span class="o">.</span><span class="n">xValidToggle</span> <span class="o">:=</span> <span class="n">xTxPDO_toggle</span><span class="p">;</span> <span class="o">//</span> <span class="n">This</span> <span class="n">line</span> <span class="n">must</span> <span class="n">follow</span> <span class="n">the</span> <span class="n">one</span> <span class="n">above</span><span class="o">.</span> <span class="n">Sequence</span> <span class="ow">is</span> <span class="n">important</span><span class="o">.</span>

<span class="o">//</span> <span class="n">Forwarding</span> <span class="n">BP</span> <span class="n">request</span> <span class="k">for</span> <span class="n">the</span> <span class="n">subsystem</span>
<span class="n">fbVetoArb</span><span class="o">.</span><span class="n">bVeto</span> <span class="o">:=</span> <span class="n">i_bVeto</span><span class="p">;</span>
<span class="n">fbVetoArb</span><span class="p">(</span><span class="n">HigherAuthority</span><span class="o">:=</span><span class="n">THIS</span><span class="o">^</span><span class="p">,</span> <span class="n">LowerAuthority</span><span class="o">:=</span><span class="n">Arbiter</span><span class="p">,</span> <span class="n">FFO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">);</span>

<span class="o">//</span><span class="n">Broadcasting</span> <span class="n">current</span> <span class="n">request</span>
<span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">stRequestedBeamParameters</span> <span class="o">:=</span> <span class="n">IO_TO_BP</span><span class="p">(</span><span class="n">q_stRequestedBP</span><span class="p">);</span>


<span class="n">q_stRequestedBP</span><span class="o">.</span><span class="n">xValid</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span> <span class="o">//</span> <span class="n">This</span> <span class="ow">is</span> <span class="nb">set</span> <span class="ow">and</span> <span class="n">held</span> <span class="n">true</span> <span class="n">here</span> <span class="n">every</span> <span class="n">cycle</span> <span class="n">to</span> <span class="n">prove</span> <span class="n">the</span> <span class="n">PLC</span> <span class="n">on</span> <span class="n">this</span> <span class="n">side</span> <span class="ow">is</span> <span class="n">still</span> <span class="n">running</span>

<span class="n">ffPMPSIO_Disconnect</span><span class="p">(</span>
    <span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">xTxPDO_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span> <span class="o">:=</span> <span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">i_xReset</span> <span class="o">:=</span> <span class="n">Reset</span><span class="p">,</span>
    <span class="n">i_DevName</span> <span class="o">:=</span> <span class="n">sName</span><span class="p">,</span>
    <span class="n">i_TypeCode</span> <span class="o">:=</span> <span class="mi">6</span><span class="p">,</span>
    <span class="n">i_xVetoable</span> <span class="o">:=</span> <span class="n">FALSE</span>
    <span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">CheckRequest</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nReqID</span>  <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">xFirstTime</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nId</span> <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Check</span> <span class="n">this</span> <span class="nb">id</span> <span class="n">matches</span> <span class="n">what</span> <span class="n">we</span><span class="s1">&#39;ve seen before</span>
<span class="n">IF</span> <span class="n">xFirstTime</span> <span class="n">THEN</span>
    <span class="n">nId</span> <span class="o">:=</span> <span class="n">nReqId</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">nId</span> <span class="o">&lt;&gt;</span> <span class="n">nReqId</span> <span class="n">THEN</span>
    <span class="n">fbLog</span><span class="p">(</span><span class="n">sMsg</span> <span class="o">:=</span> <span class="s1">&#39;SubSysToArbiter Check mismatched with a different ID&#39;</span><span class="p">,</span> <span class="n">eSevr</span> <span class="o">:=</span> <span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Error</span><span class="p">);</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">nActiveCohort</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="n">i_stCurrentBP</span><span class="o">.</span><span class="n">nCohortInt</span><span class="p">);</span>

<span class="o">//</span> <span class="n">i_stCurrentBP</span><span class="o">.</span><span class="n">nCohortInt</span> <span class="ow">is</span> <span class="n">incremented</span> <span class="n">by</span> <span class="n">the</span> <span class="n">FB_ArbiterToSubSys</span> <span class="n">block</span> <span class="n">on</span> <span class="n">the</span> <span class="n">other</span> <span class="n">side</span> <span class="n">of</span> <span class="n">the</span> <span class="n">EL669</span><span class="o">*</span> <span class="n">interface</span>
<span class="n">CheckRequest</span> <span class="o">:=</span> <span class="n">nRequestCohort</span> <span class="o">&lt;=</span> <span class="n">nActiveCohort</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">RemoveRequest</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nReqID</span>    <span class="p">:</span>    <span class="n">DWORD</span><span class="p">;</span> <span class="o">//</span><span class="n">StateID</span> <span class="n">to</span> <span class="n">remove</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Update</span> <span class="n">internal</span> <span class="n">BP</span> <span class="n">request</span> <span class="n">struct</span>
<span class="n">q_stRequestedBP</span> <span class="o">:=</span> <span class="n">BP_TO_IO</span><span class="p">(</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstFullBeam</span><span class="p">);</span>

<span class="n">nRequestCohort</span> <span class="o">:=</span> <span class="n">nRequestCohort</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Mark</span> <span class="n">the</span> <span class="n">current</span> <span class="n">cohort</span> <span class="nb">id</span>
<span class="n">q_stRequestedBP</span><span class="o">.</span><span class="n">nCohortInt</span> <span class="o">:=</span> <span class="n">nRequestCohort</span><span class="p">;</span>

<span class="n">RemoveRequest</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">RequestBP</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="p">(</span><span class="o">*</span><span class="n">StateID</span> <span class="n">of</span> <span class="n">state</span> <span class="n">requesting</span> <span class="n">beam</span> <span class="n">parameter</span> <span class="nb">set</span><span class="o">*</span><span class="p">)</span>
    <span class="n">nReqID</span>  <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span><span class="n">Requested</span> <span class="n">beam</span> <span class="n">params</span><span class="o">*</span><span class="p">)</span>
    <span class="n">stReqBP</span> <span class="p">:</span> <span class="n">ST_BeamParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Check</span> <span class="n">the</span> <span class="n">request</span> <span class="ow">is</span> <span class="n">coming</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">same</span> <span class="n">source</span> <span class="n">we</span><span class="s1">&#39;re used to</span>

<span class="o">//</span> <span class="n">Update</span> <span class="n">internal</span> <span class="n">BP</span> <span class="n">request</span> <span class="n">struct</span>
<span class="n">q_stRequestedBP</span> <span class="o">:=</span> <span class="n">BP_TO_IO</span><span class="p">(</span><span class="n">stReqBP</span><span class="p">);</span>

<span class="n">nRequestCohort</span> <span class="o">:=</span> <span class="n">nRequestCohort</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Mark</span> <span class="n">the</span> <span class="n">current</span> <span class="n">cohort</span> <span class="nb">id</span>
<span class="n">q_stRequestedBP</span><span class="o">.</span><span class="n">nCohortInt</span> <span class="o">:=</span> <span class="n">nRequestCohort</span><span class="p">;</span>

<span class="n">RequestBP</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#bp-to-io">BP_TO_IO</a></p></li>
<li><p><a class="reference internal" href="#fb-arbiter">FB_Arbiter</a></p></li>
<li><p><a class="reference internal" href="#fb-fastfault">FB_FastFault</a></p></li>
<li><p><a class="reference internal" href="#fb-hardwareffoutput">FB_HardwareFFOutput</a></p></li>
<li><p><a class="reference internal" href="#fb-vetoarbiter">FB_VetoArbiter</a></p></li>
<li><p><a class="reference internal" href="#io-to-bp">IO_TO_BP</a></p></li>
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-sxu">
<h2>FB_SXU<a class="headerlink" href="#fb-sxu" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_SXU</span> <span class="n">IMPLEMENTS</span> <span class="n">I_UndulatorComplex</span>
<span class="n">VAR_INPUT</span>
    <span class="n">fbElectronEnergy</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">FB_LREALFromEPICS</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">CurrentPhotonEnergy</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Calculated</span> <span class="n">current</span> <span class="n">photon</span> <span class="n">energy</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">PREC</span> <span class="mi">3</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">eV</span>
    <span class="s1">&#39;}</span>
    <span class="n">fCurrentPhotonEnergy</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">TargetPhotonEnergy</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Calculated</span> <span class="n">desired</span> <span class="n">photon</span> <span class="n">energy</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">PREC</span> <span class="mi">3</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">eV</span>
    <span class="s1">&#39;}</span>
    <span class="n">fTargetPhotonEnergy</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
        <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">SeedUndulatorNumber</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Seed</span> <span class="n">undulator</span> <span class="n">number</span>
    <span class="s1">&#39;}</span>
    <span class="n">nSeedUndulator</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">Set</span> <span class="n">to</span> <span class="n">zero</span> <span class="n">when</span> <span class="n">no</span> <span class="n">undulators</span> <span class="n">are</span> <span class="n">active</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">TargetSeedUndulatorNumber</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Seed</span> <span class="n">undulator</span> <span class="n">number</span> <span class="k">for</span> <span class="n">target</span> <span class="n">K</span>
    <span class="s1">&#39;}</span>
    <span class="n">nTargetSeedUndulator</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">Set</span> <span class="n">to</span> <span class="n">zero</span> <span class="n">when</span> <span class="n">no</span> <span class="n">undulators</span> <span class="n">are</span> <span class="n">active</span>
<span class="n">END_VAR</span>



<span class="n">VAR</span>
    <span class="o">//</span> <span class="n">From</span> <span class="n">lcls</span><span class="o">-</span><span class="n">srv01</span><span class="p">:</span> <span class="n">grep</span> <span class="o">-</span><span class="n">e</span> <span class="n">KDes</span>  <span class="o">/</span><span class="n">u1</span><span class="o">/</span><span class="n">lcls</span><span class="o">/</span><span class="n">epics</span><span class="o">/</span><span class="n">ioc</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sioc</span><span class="o">-</span><span class="n">unds</span><span class="o">-</span><span class="n">uc</span><span class="o">*/</span><span class="n">iocInfo</span><span class="o">/</span><span class="n">IOC</span><span class="o">.</span><span class="n">pvlist</span> <span class="o">|</span><span class="n">sort</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 21; link: 2150:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_21</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 22; link: 2250:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_22</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 23; link: 2350:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_23</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 24; link: 2450:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_24</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 25; link: 2550:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_25</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 26; link: 2650:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_26</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 27; link: 2750:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_27</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 28; link: 2850:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_28</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 29; link: 2950:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_29</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 30; link: 3050:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_30</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 31; link: 3150:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_31</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 32; link: 3250:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_32</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 33; link: 3350:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_33</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 34; link: 3450:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_34</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 36; link: 3650:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_36</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 37; link: 3750:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_37</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 38; link: 3850:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_38</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 39; link: 3950:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_39</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 40; link: 4050:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_40</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 41; link: 4150:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_41</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 42; link: 4250:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_42</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 43; link: 4350:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_43</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 44; link: 4450:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_44</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 45; link: 4550:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_45</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 46; link: 4650:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_46</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: 47; link: 4750:&#39;</span><span class="p">}</span>
    <span class="n">fbSegment_47</span> <span class="p">:</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>



    <span class="n">fbSegment</span> <span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="n">iLowBound</span><span class="o">..</span><span class="n">iHighBound</span><span class="p">]</span> <span class="n">OF</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>
    <span class="n">fbCurrentSegment</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">FB_UndulatorSegment</span><span class="p">;</span>

    <span class="n">iIndex</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>

    <span class="n">bInitialized</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">END_VAR</span>

<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">FirstSegment</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="s1">&#39;}</span>
    <span class="n">iLowBound</span>  <span class="p">:</span> <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">21</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">LastSegment</span>
         <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="s1">&#39;}</span>
    <span class="n">iHighBound</span> <span class="p">:</span> <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">47</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Period_Short</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">mm</span>
    <span class="s1">&#39;}</span>
    <span class="n">fPeriod_39_mm</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">39.0</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Period_Long</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">mm</span>
    <span class="s1">&#39;}</span>
    <span class="n">fPeriod_56_mm</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">56.0</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">LowK</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">fLowK</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">0.8</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">HiK</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">fHiK</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">5.7</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInitialized</span> <span class="n">THEN</span>
    <span class="n">Init</span><span class="p">();</span>
<span class="n">END_IF</span>

<span class="n">UndAdrUpdate</span><span class="p">();</span>

<span class="n">nSeedUndulator</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">nTargetSeedUndulator</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">FOR</span> <span class="n">iIndex</span> <span class="o">:=</span> <span class="n">iLowBound</span> <span class="n">TO</span> <span class="n">iHighBound</span> <span class="n">DO</span>
    <span class="n">IF</span> <span class="n">fbSegment</span><span class="p">[</span><span class="n">iIndex</span><span class="p">]</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
        <span class="n">fbCurrentSegment</span> <span class="n">REF</span><span class="o">=</span> <span class="n">fbSegment</span><span class="p">[</span><span class="n">iIndex</span><span class="p">]</span><span class="o">^</span><span class="p">;</span>
        <span class="n">fbCurrentSegment</span><span class="p">(</span><span class="n">fbElectronEnergy</span><span class="o">:=</span><span class="n">fbElectronEnergy</span><span class="p">);</span>
        <span class="n">fbCurrentSegment</span><span class="o">.</span><span class="n">fPeriod_mm</span> <span class="o">:=</span> <span class="n">fbCurrentSegment</span><span class="o">.</span><span class="n">fLambda_U</span><span class="o">*</span><span class="mi">1000</span><span class="p">;</span>

        <span class="o">//</span><span class="n">Mark</span> <span class="n">the</span> <span class="n">seed</span> <span class="n">undulator</span><span class="p">,</span> <span class="n">first</span> <span class="n">undulator</span> <span class="n">operating</span> <span class="n">within</span> <span class="n">K</span> <span class="n">bounds</span>
        <span class="n">IF</span> <span class="n">fbCurrentSegment</span><span class="o">.</span><span class="n">xActive</span> <span class="n">AND</span> <span class="n">nSeedUndulator</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
            <span class="n">nSeedUndulator</span> <span class="o">:=</span> <span class="n">iIndex</span><span class="p">;</span>
            <span class="n">fCurrentPhotonEnergy</span> <span class="o">:=</span> <span class="n">fbCurrentSegment</span><span class="o">.</span><span class="n">fPhotonEnergyAct</span><span class="p">;</span>
        <span class="n">END_IF</span>

        <span class="n">IF</span> <span class="n">fbCurrentSegment</span><span class="o">.</span><span class="n">xTargetActive</span> <span class="n">AND</span> <span class="n">nTargetSeedUndulator</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
            <span class="n">nTargetSeedUndulator</span> <span class="o">:=</span> <span class="n">iIndex</span><span class="p">;</span>
            <span class="n">fTargetPhotonEnergy</span> <span class="o">:=</span> <span class="n">fbCurrentSegment</span><span class="o">.</span><span class="n">fPhotonEnergyDes</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>
<span class="n">END_FOR</span>

<span class="n">IF</span> <span class="n">nSeedUndulator</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">fCurrentPhotonEnergy</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">nTargetSeedUndulator</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">fTargetPhotonEnergy</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">Init</span><span class="p">:</span>
<span class="n">UndAdrUpdate</span><span class="p">();</span>

<span class="n">FOR</span> <span class="n">iIndex</span> <span class="o">:=</span> <span class="n">iLowBound</span> <span class="n">TO</span> <span class="n">iHighBound</span> <span class="n">DO</span>
        <span class="n">IF</span> <span class="n">fbSegment</span><span class="p">[</span><span class="n">iIndex</span><span class="p">]</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
        <span class="n">fbCurrentSegment</span> <span class="n">REF</span><span class="o">=</span> <span class="n">fbSegment</span><span class="p">[</span><span class="n">iIndex</span><span class="p">]</span><span class="o">^</span><span class="p">;</span>
        <span class="n">fbCurrentSegment</span><span class="o">.</span><span class="n">fLowK</span> <span class="o">:=</span> <span class="n">fLowK</span><span class="p">;</span>
        <span class="n">fbCurrentSegment</span><span class="o">.</span><span class="n">fHiK</span> <span class="o">:=</span> <span class="n">fHiK</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_FOR</span>
<span class="n">bInitialized</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">UndAdrUpdate</span><span class="p">:</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_22</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_23</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_24</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_25</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_26</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_27</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_28</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">29</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_29</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_30</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_31</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_32</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">33</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_33</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">34</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_34</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">35</span><span class="p">]</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">36</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_36</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">37</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_37</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">38</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_38</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">39</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_39</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">40</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_40</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">41</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_41</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">42</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_42</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">43</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_43</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">44</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_44</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">45</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_45</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">46</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_46</span><span class="p">);</span>
<span class="n">fbSegment</span><span class="p">[</span><span class="mi">47</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbSegment_47</span><span class="p">);</span>
<span class="n">END_ACTION</span>

<span class="n">PROPERTY</span> <span class="n">rCurrentPhotonEnergy</span> <span class="p">:</span> <span class="n">REAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">rCurrentPhotonEnergy</span> <span class="o">:=</span> <span class="n">fCurrentPhotonEnergy</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">rTargetPhotonEnergy</span> <span class="p">:</span> <span class="n">REAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">rTargetPhotonEnergy</span> <span class="o">:=</span> <span class="n">fTargetPhotonEnergy</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-undulatorsegment">FB_UndulatorSegment</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-tempsensor-ffo">
<h2>FB_TempSensor_FFO<a class="headerlink" href="#fb-tempsensor-ffo" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_TempSensor_FFO</span> <span class="n">EXTENDS</span> <span class="n">FB_TempSensor</span>
<span class="n">VAR_INPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">FAULT_SP</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">C</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">PREC</span> <span class="mi">2</span>
    <span class="s1">&#39;}</span>
    <span class="n">fFaultThreshold</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span><span class="n">Faults</span> <span class="n">when</span> <span class="n">the</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="n">reached</span><span class="o">.</span> <span class="n">Trigger</span> <span class="n">value</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">FAULT_SP_HYS</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="o">%</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">PREC</span> <span class="mi">2</span>
    <span class="s1">&#39;}</span>
    <span class="n">fHysteresis</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span><span class="mi">1</span><span class="p">;</span> <span class="o">//</span> <span class="n">percentage</span> <span class="n">determining</span> <span class="n">how</span> <span class="n">far</span> <span class="n">below</span> <span class="n">the</span> <span class="n">trigger</span> <span class="n">value</span> <span class="n">the</span> <span class="n">fault</span> <span class="n">should</span> <span class="n">be</span> <span class="n">released</span>
    <span class="n">sDevName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">bVeto</span> <span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span> <span class="o">//</span> <span class="n">This</span> <span class="n">Fault</span> <span class="n">will</span> <span class="n">be</span> <span class="n">will</span> <span class="ow">not</span> <span class="n">trip</span> <span class="n">the</span> <span class="n">beam</span> <span class="k">if</span> <span class="n">the</span> <span class="n">bVeto</span> <span class="ow">is</span> <span class="n">TRUE</span>
    <span class="n">bAutoReset</span> <span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">io_fbFFHWO</span>    <span class="p">:</span>    <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;instance-path&#39;</span><span class="p">}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;noinit&#39;</span><span class="p">}</span>
    <span class="n">sPath</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">bFAULT_OK</span><span class="p">:</span><span class="n">BOOL</span> <span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">FFO</span>    <span class="p">:</span>    <span class="n">FB_FastFault</span> <span class="o">:=</span><span class="p">(</span>
        <span class="n">i_Desc</span> <span class="o">:=</span> <span class="s1">&#39;Fault occurs when the temprature trip point is reached&#39;</span><span class="p">,</span>
        <span class="n">i_TypeCode</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#f700);</span>
    <span class="n">rtRESET</span> <span class="p">:</span>       <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">ftFAULT</span> <span class="p">:</span>       <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">ftConnected</span>     <span class="p">:</span>       <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">fbLogger</span> <span class="p">:</span> <span class="n">FB_LogMessage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">eSubsystem</span><span class="o">:=</span><span class="n">E_SubSystem</span><span class="o">.</span><span class="n">MPS</span><span class="p">,</span> <span class="n">nMinTimeViolationAcceptable</span><span class="o">:=</span><span class="mi">10</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">The</span> <span class="n">manual</span> <span class="n">states</span> <span class="n">that</span> <span class="n">we</span> <span class="n">are</span> <span class="n">disconnected</span> <span class="k">if</span> <span class="n">we</span> <span class="n">are</span> <span class="n">both</span> <span class="n">overrange</span> <span class="ow">and</span> <span class="ow">in</span> <span class="n">an</span> <span class="n">error</span> <span class="n">state</span>
<span class="n">bConnected</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">bOverrange</span> <span class="n">AND</span> <span class="n">bError</span><span class="p">);</span>
<span class="n">fTemp</span> <span class="o">:=</span> <span class="n">INT_TO_LREAL</span><span class="p">(</span><span class="n">iRaw</span><span class="p">)</span> <span class="o">*</span> <span class="n">fResolution</span><span class="p">;</span>

<span class="o">//</span><span class="n">Verify</span> <span class="n">Hysteresis</span> <span class="ow">is</span> <span class="n">between</span> <span class="mi">1</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="n">Shouldn</span><span class="s1">&#39;t be 0. shouldn&#39;</span><span class="n">t</span> <span class="n">be</span> <span class="n">a</span> <span class="mi">100</span> <span class="n">either</span><span class="o">.</span>
<span class="n">fHysteresis</span><span class="o">:=</span>  <span class="n">LIMIT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">fHysteresis</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Evaluate</span> <span class="n">the</span> <span class="n">threshold</span> <span class="n">trip</span> <span class="n">point</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">fTemp</span> <span class="o">&gt;=</span> <span class="n">fFaultThreshold</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">bFAULT_OK</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="p">(</span><span class="n">fTemp</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">fFaultThreshold</span> <span class="o">-</span> <span class="n">fFaultThreshold</span><span class="o">*</span><span class="n">fHysteresis</span><span class="o">/</span><span class="mi">100</span><span class="p">))</span> <span class="n">THEN</span>
    <span class="n">bFAULT_OK</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">bFAULT_OK</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">bConnected</span><span class="p">;</span>


<span class="n">ACT_Logger</span><span class="p">();</span>

<span class="p">(</span><span class="o">*</span><span class="n">FAST</span> <span class="n">FAULT</span><span class="o">*</span><span class="p">)</span>
<span class="n">FFO</span><span class="p">(</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">bFAULT_OK</span> <span class="n">OR</span> <span class="n">bVeto</span><span class="p">,</span>
    <span class="n">i_xReset</span> <span class="o">:=</span><span class="p">,</span>
    <span class="n">i_xAutoReset</span> <span class="o">:=</span> <span class="n">bAutoReset</span><span class="p">,</span>
    <span class="n">i_DevName</span> <span class="o">:=</span> <span class="n">sDevName</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span> <span class="o">:=</span> <span class="n">io_fbFFHWO</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">ACT_Logger</span><span class="p">:</span>
<span class="n">ftFAULT</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="n">FFO</span><span class="o">.</span><span class="n">i_xOK</span><span class="p">);</span>
<span class="n">rtRESET</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">FFO</span><span class="o">.</span><span class="n">i_xOK</span><span class="p">);</span>
<span class="n">ftConnected</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="n">bConnected</span><span class="p">);</span>

<span class="n">IF</span><span class="p">(</span><span class="n">ftConnected</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span> <span class="o">:=</span> <span class="s1">&#39;Sensor Connection Fault, beam off&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="n">IF</span><span class="p">(</span><span class="n">ftFAULT</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span> <span class="o">:=</span> <span class="s1">&#39;Temp Threshold Fault, beam off&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="n">IF</span><span class="p">(</span><span class="n">rtRESET</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span> <span class="o">:=</span> <span class="s1">&#39;Temp Threshold Fault condition clear&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-fastfault">FB_FastFault</a></p></li>
<li><p><a class="reference internal" href="#fb-hardwareffoutput">FB_HardwareFFOutput</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-undulatorsegment">
<h2>FB_UndulatorSegment<a class="headerlink" href="#fb-undulatorsegment" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_UndulatorSegment</span>
<span class="n">VAR_INPUT</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Undulator</span> <span class="n">period</span> <span class="ow">in</span> <span class="n">millimeters</span><span class="p">,</span> <span class="n">to</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">by</span> <span class="n">subclasses</span> <span class="k">for</span> <span class="n">HXR</span><span class="p">,</span> <span class="n">read</span> <span class="n">by</span> <span class="n">pv</span> <span class="k">for</span> <span class="n">SXR</span><span class="p">,</span> <span class="n">left</span> <span class="n">here</span> <span class="k">for</span> <span class="n">backward</span> <span class="n">compatability</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">fPeriod_mm</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">1.0</span><span class="p">;</span>

    <span class="n">fbElectronEnergy</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">FB_LREALFromEPICS</span><span class="p">;</span>

    <span class="n">fLowK</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">fHiK</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">6</span><span class="p">;</span>
    <span class="n">fKRangeHyst</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">0.01</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">eVAct</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Calculated</span> <span class="n">photon</span> <span class="n">energy</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">PREC</span> <span class="mi">3</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">eV</span>
    <span class="s1">&#39;}</span>
    <span class="n">fPhotonEnergyAct</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">eVDes</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Calculated</span> <span class="n">desired</span> <span class="n">photon</span> <span class="n">energy</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">PREC</span> <span class="mi">3</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">eV</span>
    <span class="s1">&#39;}</span>
    <span class="n">fPhotonEnergyDes</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Active</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Undulator</span> <span class="ow">is</span> <span class="n">considered</span> <span class="n">active</span>
    <span class="s1">&#39;}</span>
    <span class="n">xActive</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Undulator</span> <span class="ow">is</span> <span class="n">considered</span> <span class="n">active</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">TargetActive</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Target</span> <span class="n">K</span> <span class="n">would</span> <span class="n">make</span> <span class="n">und</span> <span class="n">active</span>
    <span class="s1">&#39;}</span>
    <span class="n">xTargetActive</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Undulator</span> <span class="ow">is</span> <span class="n">considered</span> <span class="n">active</span> <span class="n">at</span> <span class="n">this</span> <span class="n">target</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">KAct</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Current</span> <span class="n">K</span>
    <span class="s1">&#39;}</span>
    <span class="n">fKAct</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">KDes</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Target</span> <span class="n">K</span>
    <span class="s1">&#39;}</span>
    <span class="n">fKDes</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Lambda_U</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Period</span> <span class="ow">in</span> <span class="n">m</span>
    <span class="s1">&#39;}</span>
    <span class="n">fLambda_U</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">KActValid</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Current</span> <span class="n">K</span> <span class="n">Readback</span> <span class="n">Valid</span>
    <span class="s1">&#39;}</span>
    <span class="n">bKActValid</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">KDesValid</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Target</span> <span class="n">K</span> <span class="n">Readback</span> <span class="n">Valid</span>
    <span class="s1">&#39;}</span>
    <span class="n">bKDesValid</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

     <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">lambdaValid</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">lambda_U</span> <span class="n">Readback</span> <span class="n">Valid</span>
    <span class="s1">&#39;}</span>
    <span class="n">blambdaValid</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>


<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">KDes</span>
        <span class="n">link</span><span class="p">:</span> <span class="n">KDes</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbKDesired</span> <span class="p">:</span> <span class="n">FB_LREALFromEPICS</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">KAct</span>
        <span class="n">link</span><span class="p">:</span> <span class="n">KAct</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbKActual</span> <span class="p">:</span> <span class="n">FB_LREALFromEPICS</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">lambda_U</span>
        <span class="n">link</span><span class="p">:</span> <span class="n">lambda_U</span>
    <span class="s1">&#39;}</span>
    <span class="n">fblambda_U</span> <span class="p">:</span> <span class="n">FB_LREALFromEPICS</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">fbKDesired</span><span class="p">();</span>
<span class="n">fbKActual</span><span class="p">();</span>
<span class="n">fblambda_U</span><span class="p">();</span>

<span class="n">fKAct</span> <span class="o">:=</span> <span class="n">fbKActual</span><span class="o">.</span><span class="n">fValue</span><span class="p">;</span>
<span class="n">bKActValid</span> <span class="o">:=</span> <span class="n">fbKActual</span><span class="o">.</span><span class="n">bValid</span><span class="p">;</span>
<span class="n">fKDes</span> <span class="o">:=</span> <span class="n">fbKDesired</span><span class="o">.</span><span class="n">fValue</span><span class="p">;</span>
<span class="n">bKDesValid</span> <span class="o">:=</span> <span class="n">fbKDesired</span><span class="o">.</span><span class="n">bvalid</span><span class="p">;</span>
<span class="n">fLambda_U</span> <span class="o">:=</span> <span class="n">fblambda_U</span><span class="o">.</span><span class="n">fValue</span><span class="p">;</span>
<span class="n">blambdaValid</span><span class="o">:=</span> <span class="n">fblambda_U</span><span class="o">.</span><span class="n">bValid</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">__ISVALIDREF</span><span class="p">(</span><span class="n">fbElectronEnergy</span><span class="p">)</span> <span class="n">THEN</span>

    <span class="n">IF</span> <span class="n">fbKActual</span><span class="o">.</span><span class="n">bValid</span> <span class="n">AND</span> <span class="n">fblambda_U</span><span class="o">.</span><span class="n">bValid</span> <span class="n">AND</span> <span class="n">fbElectronEnergy</span><span class="o">.</span><span class="n">bValid</span> <span class="n">THEN</span>
        <span class="n">fPhotonEnergyAct</span> <span class="o">:=</span> <span class="n">F_CalculatePhotonEnergy</span><span class="p">(</span>
            <span class="n">fElectronEnergy_GeV</span><span class="o">:=</span><span class="n">fbElectronEnergy</span><span class="o">.</span><span class="n">fValue</span><span class="p">,</span>
            <span class="n">fUndulatorPeriod_mm</span><span class="o">:=</span><span class="n">fPeriod_mm</span><span class="p">,</span>
            <span class="n">fUndulatorStrength</span><span class="o">:=</span><span class="n">fbKActual</span><span class="o">.</span><span class="n">fValue</span>
        <span class="p">);</span>

        <span class="o">//</span><span class="n">Set</span> <span class="n">this</span> <span class="n">undulator</span> <span class="n">active</span> <span class="k">if</span> <span class="n">actual</span> <span class="n">K</span> <span class="ow">is</span> <span class="n">within</span> <span class="n">operational</span> <span class="nb">range</span>
        <span class="n">xActive</span> <span class="n">S</span><span class="o">=</span> <span class="n">fLowK</span> <span class="o">&lt;=</span> <span class="n">fbKActual</span><span class="o">.</span><span class="n">fValue</span> <span class="n">AND</span> <span class="n">fbKActual</span><span class="o">.</span><span class="n">fValue</span> <span class="o">&lt;=</span> <span class="n">fHiK</span> <span class="n">AND</span>
        <span class="p">(</span><span class="n">fbKActual</span><span class="o">.</span><span class="n">bValid</span> <span class="n">AND</span> <span class="n">fbKActual</span><span class="o">.</span><span class="n">bValid</span><span class="p">);</span>
        <span class="n">xActive</span> <span class="n">R</span><span class="o">=</span> <span class="p">(</span><span class="n">fLowK</span> <span class="o">-</span> <span class="n">fKRangeHyst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">fbKActual</span><span class="o">.</span><span class="n">fValue</span> <span class="n">OR</span> <span class="n">fbKActual</span><span class="o">.</span><span class="n">fValue</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">fHiK</span> <span class="o">+</span> <span class="n">fKRangeHyst</span><span class="p">)</span> <span class="n">OR</span>
                    <span class="p">(</span><span class="n">NOT</span> <span class="n">fbKActual</span><span class="o">.</span><span class="n">bValid</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">fbKActual</span><span class="o">.</span><span class="n">bValid</span><span class="p">);</span>

        <span class="o">//</span><span class="n">Set</span> <span class="n">this</span> <span class="n">undulator</span> <span class="n">active</span> <span class="k">if</span> <span class="n">target</span> <span class="n">K</span> <span class="ow">is</span> <span class="n">within</span> <span class="n">operational</span> <span class="nb">range</span>
        <span class="n">xTargetActive</span> <span class="n">S</span><span class="o">=</span> <span class="n">fLowK</span> <span class="o">&lt;=</span> <span class="n">fbKDesired</span><span class="o">.</span><span class="n">fValue</span> <span class="n">AND</span> <span class="n">fbKDesired</span><span class="o">.</span><span class="n">fValue</span> <span class="o">&lt;=</span> <span class="n">fHiK</span> <span class="n">AND</span>
        <span class="p">(</span><span class="n">fbKDesired</span><span class="o">.</span><span class="n">bValid</span> <span class="n">AND</span> <span class="n">fbKDesired</span><span class="o">.</span><span class="n">bValid</span><span class="p">);</span>
        <span class="n">xTargetActive</span> <span class="n">R</span><span class="o">=</span> <span class="p">(</span><span class="n">fLowK</span> <span class="o">-</span> <span class="n">fKRangeHyst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">fbKDesired</span><span class="o">.</span><span class="n">fValue</span> <span class="n">OR</span> <span class="n">fbKDesired</span><span class="o">.</span><span class="n">fValue</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">fHiK</span> <span class="o">+</span> <span class="n">fKRangeHyst</span><span class="p">)</span> <span class="n">OR</span>
                    <span class="p">(</span><span class="n">NOT</span> <span class="n">fbKDesired</span><span class="o">.</span><span class="n">bValid</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">fbKDesired</span><span class="o">.</span><span class="n">bValid</span><span class="p">);</span>
    <span class="n">END_IF</span>

    <span class="n">IF</span> <span class="n">fbKDesired</span><span class="o">.</span><span class="n">bValid</span> <span class="n">AND</span> <span class="n">fblambda_U</span><span class="o">.</span><span class="n">bValid</span> <span class="n">AND</span> <span class="n">fbElectronEnergy</span><span class="o">.</span><span class="n">bValid</span> <span class="n">THEN</span>
        <span class="n">fPhotonEnergyDes</span> <span class="o">:=</span> <span class="n">F_CalculatePhotonEnergy</span><span class="p">(</span>
            <span class="n">fElectronEnergy_GeV</span><span class="o">:=</span><span class="n">fbElectronEnergy</span><span class="o">.</span><span class="n">fValue</span><span class="p">,</span>
            <span class="n">fUndulatorPeriod_mm</span><span class="o">:=</span><span class="n">fPeriod_mm</span><span class="p">,</span>
            <span class="n">fUndulatorStrength</span><span class="o">:=</span><span class="n">fbKDesired</span><span class="o">.</span><span class="n">fValue</span>
        <span class="p">);</span>
    <span class="n">END_IF</span>

<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#f-calculatephotonenergy">F_CalculatePhotonEnergy</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-vetoarbiter">
<h2>FB_VetoArbiter<a class="headerlink" href="#fb-vetoarbiter" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_VetoArbiter</span> <span class="n">IMPLEMENTS</span> <span class="n">I_HigherAuthority</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bVeto</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span> <span class="o">//</span> <span class="n">Rising</span> <span class="n">edge</span> <span class="n">clears</span> <span class="n">request</span><span class="p">,</span> <span class="n">hold</span> <span class="n">true</span> <span class="n">to</span> <span class="n">veto</span> <span class="n">continuously</span><span class="p">,</span> <span class="n">falling</span> <span class="n">edge</span> <span class="n">restores</span> <span class="n">request</span>
    <span class="n">HigherAuthority</span> <span class="p">:</span> <span class="n">I_HigherAuthority</span><span class="p">;</span> <span class="o">//</span> <span class="n">Typically</span> <span class="n">connected</span> <span class="n">to</span> <span class="n">a</span> <span class="n">higher</span><span class="o">-</span><span class="n">level</span> <span class="n">arbiter</span><span class="o">.</span>
    <span class="n">LowerAuthority</span> <span class="p">:</span> <span class="n">I_LowerAuthority</span><span class="p">;</span> <span class="o">//</span> <span class="n">Lower</span> <span class="n">authority</span> <span class="n">to</span> <span class="n">be</span> <span class="n">vetoed</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">FFO</span> <span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span> <span class="o">//</span> <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">the</span> <span class="n">FFO</span> <span class="n">upstream</span> <span class="n">of</span> <span class="n">the</span> <span class="n">veto</span> <span class="n">device</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">ffKeepItSecretKeepItSafe</span> <span class="p">:</span> <span class="n">FB_FastFault</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">i_xAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">i_Desc</span> <span class="o">:=</span> <span class="s1">&#39;Holds beam off until request is back in arbitration&#39;</span><span class="p">,</span>
        <span class="n">i_TypeCode</span> <span class="o">:=</span> <span class="mi">200</span><span class="p">,</span>
        <span class="n">i_xVetoable</span> <span class="o">:=</span> <span class="n">TRUE</span>
    <span class="p">);</span>

    <span class="n">stStandbyBP</span> <span class="p">:</span> <span class="n">ST_BeamParams</span><span class="p">;</span>


    <span class="n">rtVeto</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">ftVeto</span> <span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">rtVeto</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bVeto</span><span class="p">);</span>
<span class="n">ftVeto</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bVeto</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">rtVeto</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">HigherAuthority</span><span class="o">.</span><span class="n">RemoveRequest</span><span class="p">(</span><span class="n">LowerAuthority</span><span class="o">.</span><span class="n">nLowerAuthorityID</span><span class="p">);</span>
    <span class="n">HigherAuthority</span><span class="o">.</span><span class="n">RequestBP</span><span class="p">(</span><span class="n">LowerAuthority</span><span class="o">.</span><span class="n">nLowerAuthorityID</span><span class="p">,</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstFullBeam</span><span class="p">);</span>
<span class="n">ELSIF</span> <span class="n">ftVeto</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">HigherAuthority</span><span class="o">.</span><span class="n">RemoveRequest</span><span class="p">(</span><span class="n">LowerAuthority</span><span class="o">.</span><span class="n">nLowerAuthorityID</span><span class="p">);</span>
    <span class="n">HigherAuthority</span><span class="o">.</span><span class="n">RequestBP</span><span class="p">(</span><span class="n">LowerAuthority</span><span class="o">.</span><span class="n">nLowerAuthorityID</span><span class="p">,</span> <span class="n">stStandbyBP</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="n">LowerAuthority</span><span class="o">.</span><span class="n">ElevateRequest</span><span class="p">(</span><span class="n">THIS</span><span class="o">^</span><span class="p">);</span>

<span class="o">//</span><span class="n">Fast</span> <span class="n">fault</span> <span class="n">that</span> <span class="n">holds</span> <span class="n">beam</span> <span class="n">off</span> <span class="n">until</span> <span class="n">the</span> <span class="n">request</span> <span class="ow">is</span> <span class="n">added</span> <span class="n">back</span> <span class="n">into</span> <span class="n">the</span> <span class="n">system</span>
<span class="o">//</span> <span class="n">when</span> <span class="n">bVeto</span> <span class="n">goes</span> <span class="n">false</span><span class="o">.</span>
<span class="n">ffKeepItSecretKeepItSafe</span><span class="o">.</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">HigherAuthority</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">(</span><span class="n">LowerAuthority</span><span class="o">.</span><span class="n">nLowerAuthorityID</span><span class="p">)</span> <span class="n">OR</span> <span class="n">bVeto</span><span class="p">;</span>
<span class="n">ffKeepItSecretKeepItSafe</span><span class="p">(</span><span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">FFO</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">CheckRequest</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nReqID</span>  <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">bVeto</span> <span class="n">THEN</span>
    <span class="n">CheckRequest</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">CheckRequest</span> <span class="o">:=</span> <span class="n">HigherAuthority</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">(</span><span class="n">nReqID</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">RemoveRequest</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="p">(</span><span class="o">*</span><span class="n">StateID</span> <span class="n">to</span> <span class="n">remove</span><span class="o">*</span><span class="p">)</span>
    <span class="n">nReqID</span>  <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">bVeto</span> <span class="n">THEN</span>
    <span class="n">RemoveRequest</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">RemoveRequest</span> <span class="o">:=</span> <span class="n">HigherAuthority</span><span class="o">.</span><span class="n">RemoveRequest</span><span class="p">(</span><span class="n">nReqID</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">RequestBP</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="p">(</span><span class="o">*</span><span class="n">StateID</span> <span class="n">of</span> <span class="n">state</span> <span class="n">requesting</span> <span class="n">beam</span> <span class="n">parameter</span> <span class="nb">set</span><span class="o">*</span><span class="p">)</span>
    <span class="n">nReqID</span>  <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span><span class="n">Requested</span> <span class="n">beam</span> <span class="n">params</span><span class="o">*</span><span class="p">)</span>
    <span class="n">stReqBP</span> <span class="p">:</span> <span class="n">ST_BeamParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bVeto</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Pass</span> <span class="n">request</span> <span class="n">along</span> <span class="n">to</span> <span class="n">higher</span> <span class="n">authority</span>
    <span class="n">RequestBP</span> <span class="o">:=</span> <span class="n">HigherAuthority</span><span class="o">.</span><span class="n">RequestBP</span><span class="p">(</span><span class="n">nReqID</span><span class="p">,</span> <span class="n">stReqBP</span><span class="p">);</span>
<span class="n">ELSE</span>
    <span class="n">RequestBP</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">RequestBP</span> <span class="n">THEN</span>
    <span class="n">stStandbyBP</span> <span class="o">:=</span> <span class="n">stReqBP</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-fastfault">FB_FastFault</a></p></li>
<li><p><a class="reference internal" href="#fb-hardwareffoutput">FB_HardwareFFOutput</a></p></li>
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-vetoarbiter-test">
<h2>FB_VetoArbiter_Test<a class="headerlink" href="#fb-vetoarbiter-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;call_after_init&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_VetoArbiter_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">ArbID</span> <span class="p">:</span> <span class="n">DWORD</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">HigherArbID</span> <span class="p">:</span> <span class="n">DWORD</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VetoArbiter</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">VetoArbiter</span>

<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nId</span>    <span class="p">:</span>    <span class="n">DWORD</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">nId2</span> <span class="p">:</span> <span class="n">DWORD</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">stReq</span>    <span class="p">:</span>  <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="p">(</span><span class="n">nTran</span><span class="o">:=</span><span class="mf">0.12</span><span class="p">);</span>
    <span class="n">stReq2</span>  <span class="p">:</span>       <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="p">(</span><span class="n">nTran</span><span class="o">:=</span><span class="mf">0.10</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbArbiter</span>    <span class="p">:</span>    <span class="n">FB_Arbiter</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="n">fbHigherArb</span> <span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

    <span class="n">ArbBP</span> <span class="p">:</span> <span class="n">ST_BeamParams</span><span class="o">:=</span><span class="p">(</span><span class="n">nTran</span><span class="o">:=</span><span class="mi">1</span><span class="p">);</span>

    <span class="n">VetoArb</span> <span class="p">:</span> <span class="n">FB_VetoArbiter</span><span class="p">;</span>

    <span class="n">FFO</span> <span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>

    <span class="n">fbHA</span> <span class="p">:</span> <span class="n">FB_DummyHA</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;VetoNotIn&#39;</span><span class="p">);</span>
<span class="n">fbArbiter</span><span class="o">.</span><span class="n">AddRequest</span><span class="p">(</span><span class="n">nReqID</span><span class="o">:=</span><span class="n">nId</span><span class="p">,</span> <span class="n">stReqBP</span><span class="o">:=</span><span class="n">stReq</span><span class="p">,</span> <span class="n">sDevName</span> <span class="o">:=</span><span class="s1">&#39;Device&#39;</span><span class="p">);</span>

<span class="o">////////////////////</span> <span class="n">Cycle</span>
<span class="n">fbHigherArb</span><span class="o">.</span><span class="n">ElevateRequest</span><span class="p">(</span><span class="n">fbHA</span><span class="p">);</span>

<span class="n">VetoArb</span><span class="o">.</span><span class="n">bVeto</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">VetoArb</span><span class="p">(</span><span class="n">HigherAuthority</span><span class="o">:=</span><span class="n">fbHigherArb</span><span class="p">,</span>
    <span class="n">LowerAuthority</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">FFO</span><span class="o">:=</span><span class="n">FFO</span><span class="p">);</span>

<span class="o">////////////////////</span> <span class="n">Cycle</span>
<span class="n">fbHigherArb</span><span class="o">.</span><span class="n">ElevateRequest</span><span class="p">(</span><span class="n">fbHA</span><span class="p">);</span>

<span class="n">VetoArb</span><span class="o">.</span><span class="n">bVeto</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">VetoArb</span><span class="p">(</span><span class="n">HigherAuthority</span><span class="o">:=</span><span class="n">fbHigherArb</span><span class="p">,</span>
    <span class="n">LowerAuthority</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">FFO</span><span class="o">:=</span><span class="n">FFO</span><span class="p">);</span>

<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbHigherArb</span><span class="o">.</span><span class="n">q_stBeamParams</span><span class="o">.</span><span class="n">nTran</span> <span class="o">=</span> <span class="n">stReq</span><span class="o">.</span><span class="n">nTran</span><span class="p">,</span> <span class="s1">&#39;We should see the transmission number here, veto device is not in&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;VetoIn&#39;</span><span class="p">);</span>
<span class="o">//</span> <span class="n">Veto</span> <span class="n">device</span> <span class="ow">is</span> <span class="ow">in</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">should</span> <span class="n">effectively</span> <span class="n">remove</span> <span class="n">the</span> <span class="n">fbArbiter</span> <span class="n">request</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">higher</span> <span class="n">arbiter</span> <span class="n">pool</span>

<span class="o">////////////////////</span> <span class="n">Cycle</span>
<span class="n">fbHigherArb</span><span class="o">.</span><span class="n">ElevateRequest</span><span class="p">(</span><span class="n">fbHA</span><span class="p">);</span>

<span class="n">VetoArb</span><span class="o">.</span><span class="n">bVeto</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">VetoArb</span><span class="p">(</span><span class="n">HigherAuthority</span><span class="o">:=</span><span class="n">fbHigherArb</span><span class="p">,</span> <span class="o">//</span> <span class="n">Veto</span> <span class="n">removed</span>
    <span class="n">LowerAuthority</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">FFO</span><span class="o">:=</span><span class="n">FFO</span><span class="p">);</span>

<span class="o">////////////////////</span> <span class="n">Cycle</span>
<span class="n">fbHigherArb</span><span class="o">.</span><span class="n">ElevateRequest</span><span class="p">(</span><span class="n">fbHA</span><span class="p">);</span>

<span class="n">VetoArb</span><span class="o">.</span><span class="n">bVeto</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">VetoArb</span><span class="p">(</span><span class="n">HigherAuthority</span><span class="o">:=</span><span class="n">fbHigherArb</span><span class="p">,</span> <span class="o">//</span> <span class="n">Veto</span> <span class="n">removed</span>
    <span class="n">LowerAuthority</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">FFO</span><span class="o">:=</span><span class="n">FFO</span><span class="p">);</span>

<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbHigherArb</span><span class="o">.</span><span class="n">q_stBeamParams</span><span class="o">.</span><span class="n">nTran</span> <span class="o">=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstFullBeam</span><span class="o">.</span><span class="n">nTran</span><span class="p">,</span> <span class="s1">&#39;Veto device is in, trans should be restored to 100&#39;</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">(</span><span class="n">nId</span><span class="p">),</span> <span class="s1">&#39;Request should still be considered valid (1)&#39;</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbHigherArb</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">(</span><span class="n">ArbID</span><span class="p">),</span> <span class="s1">&#39;Lower arb request should be gone from the higher pool&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;AnotherRequest&#39;</span><span class="p">);</span>
<span class="o">//</span> <span class="n">Another</span> <span class="n">request</span> <span class="ow">is</span> <span class="n">added</span><span class="p">,</span> <span class="n">should</span> <span class="n">be</span> <span class="n">approved</span> <span class="n">immediately</span><span class="p">,</span> <span class="ow">and</span> <span class="k">with</span> <span class="n">no</span> <span class="n">effect</span> <span class="n">on</span> <span class="n">the</span> <span class="n">final</span> <span class="nb">set</span>
<span class="n">fbArbiter</span><span class="o">.</span><span class="n">RequestBP</span><span class="p">(</span><span class="n">nReqID</span> <span class="o">:=</span> <span class="n">nId2</span><span class="p">,</span> <span class="n">stReqBP</span><span class="o">:=</span><span class="n">stReq2</span><span class="p">);</span>

<span class="o">////////////////////</span> <span class="n">Cycle</span>
<span class="n">fbHigherArb</span><span class="o">.</span><span class="n">ElevateRequest</span><span class="p">(</span><span class="n">fbHA</span><span class="p">);</span>

<span class="n">VetoArb</span><span class="o">.</span><span class="n">bVeto</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">VetoArb</span><span class="p">(</span><span class="n">HigherAuthority</span><span class="o">:=</span><span class="n">fbHigherArb</span><span class="p">,</span> <span class="o">//</span> <span class="n">Veto</span> <span class="n">removed</span>
    <span class="n">LowerAuthority</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">FFO</span><span class="o">:=</span><span class="n">FFO</span><span class="p">);</span>

<span class="o">////////////////////</span> <span class="n">Cycle</span>
<span class="n">fbHigherArb</span><span class="o">.</span><span class="n">ElevateRequest</span><span class="p">(</span><span class="n">fbHA</span><span class="p">);</span>

<span class="n">VetoArb</span><span class="o">.</span><span class="n">bVeto</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">VetoArb</span><span class="p">(</span><span class="n">HigherAuthority</span><span class="o">:=</span><span class="n">fbHigherArb</span><span class="p">,</span> <span class="o">//</span> <span class="n">Veto</span> <span class="n">removed</span>
    <span class="n">LowerAuthority</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">FFO</span><span class="o">:=</span><span class="n">FFO</span><span class="p">);</span>

<span class="n">AssertTrue</span><span class="p">(</span><span class="n">ArbBP</span><span class="o">.</span><span class="n">nTran</span> <span class="o">=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstFullBeam</span><span class="o">.</span><span class="n">nTran</span><span class="p">,</span> <span class="s1">&#39;Veto device remained in, trans should still be 100&#39;</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">(</span><span class="n">nId</span><span class="p">),</span> <span class="s1">&#39;Request should still be considered valid (2)&#39;</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">(</span><span class="n">nId2</span><span class="p">),</span> <span class="s1">&#39;2nd Request should be considered valid&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;RemoveVeto&#39;</span><span class="p">);</span>
<span class="o">//</span> <span class="n">Removal</span> <span class="n">of</span> <span class="n">veto</span> <span class="n">device</span><span class="p">,</span> <span class="n">should</span> <span class="n">produce</span> <span class="n">a</span> <span class="n">fault</span>
<span class="o">////////////////////</span> <span class="n">Cycle</span>
<span class="n">fbHigherArb</span><span class="o">.</span><span class="n">ElevateRequest</span><span class="p">(</span><span class="n">fbHA</span><span class="p">);</span>

<span class="n">VetoArb</span><span class="o">.</span><span class="n">bVeto</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">VetoArb</span><span class="p">(</span><span class="n">HigherAuthority</span><span class="o">:=</span><span class="n">fbHigherArb</span><span class="p">,</span> <span class="o">//</span> <span class="n">Veto</span> <span class="n">removed</span>
    <span class="n">LowerAuthority</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">FFO</span><span class="o">:=</span><span class="n">FFO</span><span class="p">);</span>

<span class="n">AssertFalse</span><span class="p">(</span><span class="n">VetoArb</span><span class="o">.</span><span class="n">ffKeepItSecretKeepItSafe</span><span class="o">.</span><span class="n">i_xOK</span><span class="p">,</span> <span class="s1">&#39;Should produce a fast fault at this point because the request is not yet back in the pool&#39;</span><span class="p">);</span>

<span class="o">////////////////////</span> <span class="n">Cycle</span>
<span class="n">fbHigherArb</span><span class="o">.</span><span class="n">ElevateRequest</span><span class="p">(</span><span class="n">fbHA</span><span class="p">);</span>

<span class="n">VetoArb</span><span class="o">.</span><span class="n">bVeto</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">VetoArb</span><span class="p">(</span><span class="n">HigherAuthority</span><span class="o">:=</span><span class="n">fbHigherArb</span><span class="p">,</span> <span class="o">//</span> <span class="n">Veto</span> <span class="n">removed</span>
    <span class="n">LowerAuthority</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">FFO</span><span class="o">:=</span><span class="n">FFO</span><span class="p">);</span>

<span class="o">////////////////////</span> <span class="n">Cycle</span>
<span class="n">fbHigherArb</span><span class="o">.</span><span class="n">ElevateRequest</span><span class="p">(</span><span class="n">fbHA</span><span class="p">);</span>

<span class="n">VetoArb</span><span class="o">.</span><span class="n">bVeto</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">VetoArb</span><span class="p">(</span><span class="n">HigherAuthority</span><span class="o">:=</span><span class="n">fbHigherArb</span><span class="p">,</span> <span class="o">//</span> <span class="n">Veto</span> <span class="n">removed</span>
    <span class="n">LowerAuthority</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">FFO</span><span class="o">:=</span><span class="n">FFO</span><span class="p">);</span>

<span class="o">////////////////////</span> <span class="n">Cycle</span>
<span class="n">fbHigherArb</span><span class="o">.</span><span class="n">ElevateRequest</span><span class="p">(</span><span class="n">fbHA</span><span class="p">);</span>

<span class="n">VetoArb</span><span class="o">.</span><span class="n">bVeto</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">VetoArb</span><span class="p">(</span><span class="n">HigherAuthority</span><span class="o">:=</span><span class="n">fbHigherArb</span><span class="p">,</span> <span class="o">//</span> <span class="n">Veto</span> <span class="n">removed</span>
    <span class="n">LowerAuthority</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">FFO</span><span class="o">:=</span><span class="n">FFO</span><span class="p">);</span>

<span class="n">AssertTrue</span><span class="p">(</span><span class="n">VetoArb</span><span class="o">.</span><span class="n">ffKeepItSecretKeepItSafe</span><span class="o">.</span><span class="n">i_xOK</span><span class="p">,</span> <span class="s1">&#39;Fault should be gone.&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-arbiter">FB_Arbiter</a></p></li>
<li><p><a class="reference internal" href="#fb-dummyha">FB_DummyHA</a></p></li>
<li><p><a class="reference internal" href="#fb-hardwareffoutput">FB_HardwareFFOutput</a></p></li>
<li><p><a class="reference internal" href="#fb-vetoarbiter">FB_VetoArbiter</a></p></li>
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-vetodevice">
<h2>FB_VetoDevice<a class="headerlink" href="#fb-vetodevice" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Relays</span> <span class="n">veto</span> <span class="n">device</span> <span class="n">state</span><span class="p">,</span> <span class="n">updates</span> <span class="n">current</span> <span class="n">BP</span> <span class="ow">and</span> <span class="n">sends</span> <span class="n">a</span> <span class="n">message</span> <span class="n">when</span> <span class="n">veto</span> <span class="n">state</span> <span class="n">changes</span><span class="o">.</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_VetoDevice</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_bIn</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">i_bOut</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">q_bIn</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_bOut</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stCurrentBP</span> <span class="p">:</span> <span class="n">ST_BeamParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>

    <span class="n">VetoDevice_IN</span> <span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">MAX_VETO_DEVICES</span><span class="p">;</span> <span class="o">//</span> <span class="n">Veto</span> <span class="n">device</span> <span class="n">state</span> <span class="n">array</span> <span class="n">index</span>
    <span class="n">VetoDevice_OUT</span> <span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">MAX_VETO_DEVICES</span><span class="p">;</span> <span class="o">//</span> <span class="n">Veto</span> <span class="n">device</span> <span class="n">state</span> <span class="n">array</span> <span class="n">index</span>

    <span class="n">VetoDeviceName</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;instance-path&#39;</span><span class="p">}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;noinit&#39;</span><span class="p">}</span>
    <span class="n">sPath</span>    <span class="p">:</span>    <span class="n">T_MaxString</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Logging</span>
        <span class="n">fbLogMsg</span> <span class="p">:</span> <span class="n">FB_LogMessage</span> <span class="o">:=</span> <span class="p">(</span>
            <span class="n">eSubSystem</span> <span class="o">:=</span> <span class="n">E_Subsystem</span><span class="o">.</span><span class="n">MPS</span><span class="p">);</span>

        <span class="n">rtIn</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
        <span class="n">rtOut</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="o">////////////////////////////////</span>

    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">fbLogMsg</span><span class="o">.</span><span class="n">sJson</span> <span class="o">:=</span> <span class="n">F_PMPS_JSON</span><span class="p">(</span><span class="n">VetoDeviceName</span><span class="p">,</span> <span class="n">sPath</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Log</span>
<span class="o">/////////////////////////////</span>
    <span class="n">rtIn</span><span class="p">(</span><span class="n">CLK</span> <span class="o">:=</span> <span class="n">i_bIn</span><span class="p">);</span>
    <span class="n">rtOut</span><span class="p">(</span><span class="n">CLK</span> <span class="o">:=</span> <span class="n">i_bOut</span><span class="p">);</span>

    <span class="n">IF</span> <span class="n">rtIn</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
        <span class="n">fbLogMsg</span><span class="o">.</span><span class="n">sMsg</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">VetoDeviceName</span><span class="p">,</span> <span class="s1">&#39; moved IN&#39;</span><span class="p">);</span>
        <span class="n">fbLogMsg</span><span class="p">();</span>
    <span class="n">ELSIF</span> <span class="n">rtOut</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
        <span class="n">fbLogMsg</span><span class="o">.</span><span class="n">sMsg</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">VetoDeviceName</span><span class="p">,</span> <span class="s1">&#39; moved OUT&#39;</span><span class="p">);</span>
        <span class="n">fbLogMsg</span><span class="p">();</span>
    <span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Relay</span>
<span class="o">///////////////////////</span>
    <span class="n">q_bIn</span> <span class="o">:=</span> <span class="n">i_bIn</span><span class="p">;</span>
    <span class="n">q_bOut</span> <span class="o">:=</span> <span class="n">i_bOut</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Update</span> <span class="n">current</span> <span class="n">beam</span> <span class="n">parameters</span>
<span class="o">/////////////////////////////////////</span>
    <span class="n">stCurrentBP</span><span class="o">.</span><span class="n">aVetoDevices</span><span class="p">[</span><span class="n">VetoDevice_IN</span><span class="p">]</span> <span class="o">:=</span> <span class="n">i_bIn</span><span class="p">;</span>
    <span class="n">stCurrentBP</span><span class="o">.</span><span class="n">aVetoDevices</span><span class="p">[</span><span class="n">VetoDevice_OUT</span><span class="p">]</span> <span class="o">:=</span> <span class="n">i_bOut</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#f-pmps-json">F_PMPS_JSON</a></p></li>
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="io-to-apt">
<h2>IO_TO_APT<a class="headerlink" href="#io-to-apt" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">IO_TO_APT</span> <span class="p">:</span> <span class="n">ST_PMPS_Aperture</span>
<span class="n">VAR_INPUT</span>
    <span class="n">IO</span> <span class="p">:</span> <span class="n">ST_PMPS_Aperture_IO</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">IO_TO_APT</span><span class="o">.</span><span class="n">Height</span> <span class="o">:=</span> <span class="n">IO</span><span class="o">.</span><span class="n">Height</span><span class="p">;</span>
<span class="n">IO_TO_APT</span><span class="o">.</span><span class="n">Width</span> <span class="o">:=</span> <span class="n">IO</span><span class="o">.</span><span class="n">Width</span><span class="p">;</span>
<span class="n">IO_TO_APT</span><span class="o">.</span><span class="n">xOK</span> <span class="o">:=</span> <span class="n">IO</span><span class="o">.</span><span class="n">xOK</span><span class="p">;</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-pmps-aperture">ST_PMPS_Aperture</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="io-to-att">
<h2>IO_TO_ATT<a class="headerlink" href="#io-to-att" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">IO_TO_ATT</span> <span class="p">:</span> <span class="n">ST_PMPS_Attenuator</span>
<span class="n">VAR_INPUT</span>
    <span class="n">IO</span> <span class="p">:</span> <span class="n">ST_PMPS_Attenuator_IO</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">IO_TO_ATT</span><span class="o">.</span><span class="n">nTran</span> <span class="o">:=</span> <span class="n">IO</span><span class="o">.</span><span class="n">nTran</span><span class="p">;</span>
<span class="n">IO_TO_ATT</span><span class="o">.</span><span class="n">xAttOK</span> <span class="o">:=</span> <span class="n">IO</span><span class="o">.</span><span class="n">xAttOK</span><span class="p">;</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-pmps-attenuator">ST_PMPS_Attenuator</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="io-to-bp">
<h2>IO_TO_BP<a class="headerlink" href="#io-to-bp" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_check&#39;</span><span class="p">}</span>
<span class="n">FUNCTION</span> <span class="n">IO_TO_BP</span> <span class="p">:</span> <span class="n">ST_BeamParams</span>
<span class="n">VAR_INPUT</span>
    <span class="n">IO</span> <span class="p">:</span> <span class="n">ST_BeamParams_IO</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">idx</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">FOR</span> <span class="n">idx</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">AUX_ATTENUATORS</span> <span class="n">DO</span>
    <span class="n">IO_TO_BP</span><span class="o">.</span><span class="n">astAttenuators</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">:=</span> <span class="n">IO_TO_ATT</span><span class="p">(</span><span class="n">IO</span><span class="o">.</span><span class="n">astAttenuators</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
<span class="n">END_FOR</span>

<span class="n">FOR</span> <span class="n">idx</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">MAX_APERTURES</span> <span class="n">DO</span>
    <span class="n">IO_TO_BP</span><span class="o">.</span><span class="n">astApertures</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">:=</span> <span class="n">IO_TO_APT</span><span class="p">(</span><span class="n">IO</span><span class="o">.</span><span class="n">astApertures</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
<span class="n">END_FOR</span>

<span class="n">IO_TO_BP</span><span class="o">.</span><span class="n">aVetoDevices</span> <span class="o">:=</span> <span class="n">IO</span><span class="o">.</span><span class="n">aVetoDevices</span><span class="p">;</span>
<span class="n">IO_TO_BP</span><span class="o">.</span><span class="n">nTran</span> <span class="o">:=</span> <span class="n">IO</span><span class="o">.</span><span class="n">nTran</span><span class="p">;</span>
<span class="n">IO_TO_BP</span><span class="o">.</span><span class="n">nCohortInt</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="n">IO</span><span class="o">.</span><span class="n">nCohortInt</span><span class="p">);</span>
<span class="n">IO_TO_BP</span><span class="o">.</span><span class="n">neVRange</span> <span class="o">:=</span> <span class="n">IO</span><span class="o">.</span><span class="n">neVRange</span><span class="p">;</span>
<span class="n">IO_TO_BP</span><span class="o">.</span><span class="n">neV</span> <span class="o">:=</span> <span class="n">IO</span><span class="o">.</span><span class="n">neV</span><span class="p">;</span>
<span class="n">IO_TO_BP</span><span class="o">.</span><span class="n">nBCRange</span> <span class="o">:=</span> <span class="n">IO</span><span class="o">.</span><span class="n">nBCRange</span><span class="p">;</span>
<span class="n">IO_TO_BP</span><span class="o">.</span><span class="n">nBeamClass</span> <span class="o">:=</span> <span class="n">IO</span><span class="o">.</span><span class="n">nBeamClass</span><span class="p">;</span>
<span class="n">IO_TO_BP</span><span class="o">.</span><span class="n">nMachineMode</span> <span class="o">:=</span> <span class="n">IO</span><span class="o">.</span><span class="n">nMachineMode</span><span class="p">;</span>
<span class="n">IO_TO_BP</span><span class="o">.</span><span class="n">nRate</span> <span class="o">:=</span> <span class="n">IO</span><span class="o">.</span><span class="n">nRate</span><span class="p">;</span>
<span class="n">IO_TO_BP</span><span class="o">.</span><span class="n">xValid</span> <span class="o">:=</span> <span class="n">IO</span><span class="o">.</span><span class="n">xValid</span><span class="p">;</span>
<span class="n">IO_TO_BP</span><span class="o">.</span><span class="n">xValidToggle</span> <span class="o">:=</span> <span class="n">IO</span><span class="o">.</span><span class="n">xValidToggle</span><span class="p">;</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#io-to-apt">IO_TO_APT</a></p></li>
<li><p><a class="reference internal" href="#io-to-att">IO_TO_ATT</a></p></li>
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
<li><p><a class="reference internal" href="#st-beamparams">ST_BeamParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="main">
<h2>MAIN<a class="headerlink" href="#main" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROGRAM</span> <span class="n">MAIN</span>
<span class="n">VAR</span>
    <span class="n">fbSetPERanges</span> <span class="p">:</span> <span class="n">PE_Ranges</span><span class="p">;</span>

    <span class="n">fbDiffBPTest</span>    <span class="p">:</span>    <span class="n">FB_DiffBP_Test</span><span class="p">;</span>
    <span class="n">fbBPTMTest</span>    <span class="p">:</span>    <span class="n">FB_BPTM_Test</span><span class="p">;</span>
    <span class="n">fbSafeBPCompareTest</span>    <span class="p">:</span>    <span class="n">FB_SafeBPCompare_Test</span><span class="p">;</span>
    <span class="o">////</span><span class="n">fbevWithinSpecTest</span>    <span class="p">:</span>    <span class="n">FB_evWithinSpec_Test</span><span class="p">;</span><span class="o">---</span>
    <span class="o">////</span><span class="n">fbPEWTest</span>    <span class="p">:</span>    <span class="n">FB_PhotonEnergyWatcher_Test</span><span class="p">;</span><span class="o">---</span>
    <span class="n">fbFFTest</span>    <span class="p">:</span>    <span class="n">FB_FastFault_Test</span><span class="p">;</span>
    <span class="n">fbArbiterTest</span>    <span class="p">:</span>    <span class="n">FB_Arbiter_Test</span><span class="p">;</span>
    <span class="n">fbVetoArbiterTest</span> <span class="p">:</span> <span class="n">FB_VetoArbiter_Test</span><span class="p">;</span>
    <span class="n">fbevRangeCalcTest</span> <span class="p">:</span> <span class="n">FB_evRangeCalculator_Test</span><span class="p">;</span>
    <span class="n">fbSubSysToArbTest</span> <span class="p">:</span> <span class="n">FB_SubsysToArb_Test</span><span class="p">;</span>
    <span class="n">fbArbToSubSysTest</span> <span class="p">:</span> <span class="n">FB_ArbToSubsys_Test</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TcUnit</span><span class="o">.</span><span class="n">RUN</span><span class="p">();</span>

<span class="n">END_PROGRAM</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-arbtosubsys-test">FB_ArbToSubsys_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-arbiter-test">FB_Arbiter_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-bptm-test">FB_BPTM_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-diffbp-test">FB_DiffBP_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-fastfault-test">FB_FastFault_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-photonenergywatcher-test">FB_PhotonEnergyWatcher_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-safebpcompare-test">FB_SafeBPCompare_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-subsystoarb-test">FB_SubsysToArb_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-vetoarbiter-test">FB_VetoArbiter_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-evrangecalculator-test">FB_evRangeCalculator_Test</a></p></li>
<li><p><a class="reference internal" href="#pe-ranges">PE_Ranges</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="pe-ranges">
<h2>PE_Ranges<a class="headerlink" href="#pe-ranges" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Does</span> <span class="n">nothing</span> <span class="n">other</span> <span class="n">than</span> <span class="nb">set</span> <span class="n">the</span> <span class="n">gvl</span> <span class="k">for</span> <span class="n">photon</span> <span class="n">energy</span> <span class="n">bitmask</span> <span class="n">to</span> <span class="n">one</span> <span class="n">of</span> <span class="n">two</span> <span class="n">constants</span><span class="p">,</span> <span class="n">K</span> <span class="ow">or</span> <span class="n">L</span><span class="o">.</span>
<span class="o">//</span> <span class="n">Workaround</span> <span class="k">for</span> <span class="nb">compile</span> <span class="n">defines</span> <span class="ow">not</span> <span class="n">fully</span> <span class="n">working</span> <span class="k">for</span> <span class="n">libraries</span> <span class="n">at</span> <span class="n">the</span> <span class="n">time</span> <span class="n">of</span> <span class="n">writing</span> <span class="n">this</span><span class="o">.</span>
<span class="o">//</span> <span class="n">Otherwise</span> <span class="n">I</span> <span class="n">would</span> <span class="n">have</span> <span class="n">just</span> <span class="n">used</span> <span class="n">the</span> <span class="nb">compile</span> <span class="n">define</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">GVL</span> <span class="n">declaration</span><span class="o">.</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">PE_Ranges</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>


<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">FB_init</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bInitRetains</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="k">if</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">the</span> <span class="n">retain</span> <span class="n">variables</span> <span class="n">are</span> <span class="n">initialized</span> <span class="p">(</span><span class="n">warm</span> <span class="n">start</span> <span class="o">/</span> <span class="n">cold</span> <span class="n">start</span><span class="p">)</span>
    <span class="n">bInCopyCode</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>  <span class="o">//</span> <span class="k">if</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">the</span> <span class="n">instance</span> <span class="n">afterwards</span> <span class="n">gets</span> <span class="n">moved</span> <span class="n">into</span> <span class="n">the</span> <span class="n">copy</span> <span class="n">code</span> <span class="p">(</span><span class="n">online</span> <span class="n">change</span><span class="p">)</span>
<span class="n">END_VAR</span>
<span class="p">{</span><span class="n">IF</span> <span class="n">defined</span> <span class="p">(</span><span class="n">L</span><span class="p">)}</span>
    <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_areVBoundaries</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_areVBoundariesL</span><span class="p">;</span>
<span class="p">{</span><span class="n">ELSIF</span> <span class="n">defined</span> <span class="p">(</span><span class="n">K</span><span class="p">)}</span>
    <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_areVBoundaries</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">g_areVBoundariesK</span><span class="p">;</span>
<span class="p">{</span><span class="n">END_IF</span><span class="p">}</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#pmps-gvl">PMPS_GVL</a></p></li>
</ul>
</dd>
</dl>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="lcls-twincat-pmps_PMPS_epics.html" class="btn btn-neutral float-left" title="Data Types" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, SLAC National Accelerator Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>